<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appraisal Wizard - Harken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'harken-dark': '#1c3643',
                        'harken-accent': '#0da1c7',
                        'harken-accent-light': '#38bfd9',
                        'harken-success': '#2e7d32',
                        'harken-text': '#687F8B',
                    }
                }
            }
        }
    </script>
    <style>
        .step-item {
            transition: all 0.3s ease;
        }
        .step-item.active {
            background-color: #0da1c7; /* harken-accent */
            color: white;
        }
        .step-item.completed {
            background-color: #2e7d32; /* harken-success */
            color: white;
        }
        .section-expanded .section-content {
            max-height: 1000px;
        }
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .icon {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
            display: inline-block;
            vertical-align: middle;
        }
        
        /* Editable Table Styling */
        .editable-table thead th {
            background-color: #f3f4f6;
            border-bottom: 2px solid #d1d5db;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1rem;
        }
        
        .editable-table tbody tr {
            transition: background-color 150ms;
        }
        
        .editable-table tbody tr:hover {
            background-color: #eff6ff;
        }
        
        .editable-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        
        .editable-table tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        
        .editable-table tbody td {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            color: #111827;
        }
        
        .editable-table tfoot td {
            background-color: rgba(13, 161, 199, 0.1);
            border-top: 2px solid #0da1c7;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 700;
            color: #0c4a6e;
        }
        
        /* Accordion Transitions */
        .accordion-content-transition {
            transition: all 200ms ease-in-out;
        }
        
        /* Tab Styling */
        .building-tab {
            transition: all 150ms ease;
        }
        
        .building-tab:hover {
            background-color: rgba(13, 161, 199, 0.05);
        }
        
        .building-tab.active {
            border-bottom-color: #0da1c7;
            color: #0da1c7;
            background-color: rgba(13, 161, 199, 0.05);
        }
        
        /* Row hover effects for delete button */
        .editable-table tbody tr:hover button {
            opacity: 1;
        }
        
        .editable-table tbody button {
            opacity: 0.3;
            transition: opacity 200ms;
        }
        
        /* Scenario & Approach Card Enhancements */
        .scenario-block {
            background: #ffffff;
            border: 1px solid #E5E7EB;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .scenario-block:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .scenario-name-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .scenario-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }
        .scenario-pill:hover {
            border-color: #0da1c7;
            color: #0da1c7;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(13, 161, 199, 0.2);
        }
        .scenario-pill.selected {
            border-color: #0da1c7;
            background: #0da1c7;
            color: white;
            font-weight: 600;
        }
        .scenario-pill.custom {
            border-style: dashed;
        }
        .scenario-custom-input {
            margin-top: 0.75rem;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .approach-grid {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        @media (min-width: 640px) {
            .approach-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }
        .approach-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
            text-align: center;
            position: relative;
            min-height: 120px;
        }
        .approach-card:hover {
            border-color: #D1D5DB;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .approach-card.selected {
            border-color: #0da1c7;
            background-color: rgba(13, 161, 199, 0.05);
        }
        .approach-card .approach-icon {
            margin-bottom: 0.75rem;
            color: #9CA3AF;
            transition: color 0.2s;
        }
        .approach-card.selected .approach-icon {
            color: #0da1c7;
        }
        .approach-card .approach-label {
            font-weight: 600;
            font-size: 0.875rem;
            color: #374151;
        }
        .approach-card.selected .approach-label {
            color: #0e7490;
        }
        .approach-card .check-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: #0da1c7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .approach-card.selected .check-badge {
            opacity: 1;
            transform: scale(1);
        }
        .btn-add-scenario {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: #F9FAFB;
            border: 2px dashed #D1D5DB;
            color: #6B7280;
            padding: 1rem;
            border-radius: 0.5rem;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        .btn-add-scenario:hover {
            background: #F3F4F6;
            border-color: #9CA3AF;
            color: #374151;
        }
        
        /* Property Status Card Enhancements */
        .property-status-btn {
            position: relative;
            transition: all 0.2s ease;
        }
        .property-status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .property-status-btn.selected::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: #0da1c7;
            border-radius: 50%;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-size: 14px 14px;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* Scenario block with required state */
        .scenario-block.required {
            border-left: 4px solid #EF4444;
        }
        .scenario-block.recommended {
            border-left: 4px solid #3B82F6;
        }
        
        /* Auto-config notification */
        .auto-config-toast {
            animation: fadeInUp 0.3s ease-out;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- Main Container -->
<div class="flex h-screen" id="main-container">
    
    <!-- Pre-Wizard Fullscreen Container (for template selection, setup, overview) -->
    <div id="pre-wizard-container" class="hidden w-full h-screen flex flex-col" style="background-color: #f9f9f9;">
        <!-- UNIFIED NAVIGATION COMPONENT -->
        <style>.unified-navbar{background:url(https://app.harkenbov.com/assets/img/accent-white-bright.png) top left/contain #1c3643;background-color:#1c3643!important;height:84px;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 32px;box-shadow:0 2px 8px rgba(0,0,0,0.1);position:sticky;top:0;z-index:1000}.nav-logo{height:40px;width:auto;cursor:pointer}.nav-center{display:flex;align-items:center;gap:8px;flex:1;justify-content:center}.nav-core-features{display:flex;align-items:center;gap:4px;background:rgba(13, 161, 199, 0.08);border-radius:25px;padding:4px 8px;margin-right:16px}.nav-link{color:white;text-decoration:none;padding:10px 20px;border-radius:25px;transition:all 0.2s;border:1px solid transparent;font-weight:500;font-size:14px;white-space:nowrap}.nav-link:hover{background-color:rgba(255,255,255,0.08)}.nav-link.core-feature{font-weight:500;font-size:14px;color:white}.nav-link.core-feature:hover{background-color:rgba(13, 161, 199, 0.2);color:white}.nav-link.core-feature.active{background-color:transparent;border:1px solid #0da1c7;color:#0da1c7;box-shadow:0 2px 4px rgba(13, 161, 199, 0.2)}.nav-link.active{background-color:transparent;border:1px solid #0da1c7;color:#0da1c7}.nav-separator{width:1px;height:24px;background:rgba(255, 255, 255, 0.2);margin:0 8px}.nav-user{display:flex;align-items:center;gap:12px}.nav-user-name{font-size:14px;font-weight:500;color:white}.nav-user-avatar{width:36px;height:36px;border-radius:50%;border:2px solid #0da1c7}</style><nav class="unified-navbar"><img src="assets/harken.png" alt="Harken CRE" class="nav-logo" onclick="window.location.href='super-admin-dashboard.html'"><div class="nav-center"><div class="nav-core-features"><a href="super-admin-comps.html" class="nav-link core-feature" id="nav-comps">COMPS</a><a href="super-admin-appraisals-list.html" class="nav-link core-feature active" id="nav-appraisals">APPRAISAL</a><a href="super-admin-evaluations-list.html" class="nav-link core-feature" id="nav-evaluations">EVALUATION</a></div><div class="nav-separator"></div><a href="super-admin-dashboard.html" class="nav-link" id="nav-dashboard">Dashboard</a><a href="super-admin-users.html" class="nav-link" id="nav-users">Users</a><a href="super-admin-clients.html" class="nav-link" id="nav-clients">Clients</a><a href="super-admin-accounts.html" class="nav-link" id="nav-accounts">Accounts</a><a href="super-admin-reports.html" class="nav-link" id="nav-reports">Reports</a><a href="super-admin-support-tickets.html" class="nav-link" id="nav-support">Support</a><a href="super-admin-audit-logs.html" class="nav-link" id="nav-audit">Audit Logs</a><a href="super-admin-settings.html" class="nav-link" id="nav-settings">Settings</a></div><div class="nav-user"><span class="nav-user-name">Harken Admin</span><img src="https://i.pravatar.cc/150?img=33" alt="User" class="nav-user-avatar"></div></nav>
        
        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto" style="padding: 35px 50px;">
            <div style="max-width: 1200px; margin: 0 auto;">
                <!-- Page Title -->
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 style="font-size: 23px; font-weight: 600; color: #1c3643;">CREATE NEW APPRAISAL</h2>
                    <div style="margin-top: 8px; color: #687F8B; font-size: 14px;">
                        Follow the steps below to create your appraisal report
                    </div>
                </div>

                <!-- Wizard Steps -->
                <div style="display: flex; justify-content: center; margin-bottom: 40px; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="pre-progress-step-1" style="width: 40px; height: 40px; border-radius: 50%; background: #0da1c7; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">1</div>
                        <div id="pre-progress-label-1" style="font-size: 14px; font-weight: 600; color: #1c3643;">Template</div>
                    </div>
                    <div style="color: #e0e0e0; font-size: 20px;">→</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="pre-progress-step-2" style="width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #687F8B; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">2</div>
                        <div id="pre-progress-label-2" style="font-size: 14px; font-weight: 600; color: #687F8B;">Setup</div>
                    </div>
                    <div style="color: #e0e0e0; font-size: 20px;">→</div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="pre-progress-step-3" style="width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #687F8B; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">3</div>
                        <div id="pre-progress-label-3" style="font-size: 14px; font-weight: 600; color: #687F8B;">Overview</div>
                    </div>
                </div>
                
                <!-- Dynamic Content -->
                <div id="pre-wizard-content"></div>
                
                <!-- Bottom Navigation -->
                <div style="display: flex; justify-content: space-between; margin-top: 32px;">
                    <button id="pre-back-btn" style="padding: 12px 24px; border-radius: 4px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; background-color: #e0e0e0; color: #687F8B; display: none;" onclick="handlePreWizardBack()">
                        ← Back
                    </button>
                    <button id="pre-continue-btn" style="padding: 12px 24px; border-radius: 4px; font-size: 14px; font-weight: 600; border: none; cursor: pointer; background-color: #0da1c7; color: white; margin-left: auto;" onclick="handlePreWizardContinue()" disabled>
                        Continue →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="add-client-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-harken-dark">Add New Client</h2>
                    <button onclick="closeAddClientModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <form id="add-client-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Client Name <span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="new-client-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" placeholder="Enter client name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Attention To</label>
                        <input type="text" id="new-client-attention" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" placeholder="Optional">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address <span class="text-red-500 ml-1">*</span></label>
                        <textarea id="new-client-address" rows="3" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" placeholder="Street address"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">City, State, ZIP <span class="text-red-500 ml-1">*</span></label>
                        <input type="text" id="new-client-city-state-zip" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" placeholder="City, State ZIP">
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="closeAddClientModal()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light">Add Client</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Left Sidebar - Navigation (Hidden during pre-wizard) -->
    <div class="w-80 bg-white border-r border-gray-200 overflow-y-auto" id="wizard-sidebar">
        <div class="p-6 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-harken-dark">Appraisal Wizard</h1>
            <p class="text-sm text-harken-text mt-1" id="property-type-display">Select Property Type</p>
            <div class="mt-2 flex items-center gap-2">
                <span class="text-xs text-harken-text" id="subtype-display"></span>
            </div>
        </div>

        <!-- Navigation Sections -->
        <nav class="p-4">
            
            <!-- Section 1: Report Header & Identification -->
            <div class="mb-2 section-item section-expanded">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-dark flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        1. Report Header & Identification
                    </span>
                    <svg class="w-5 h-5 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item completed px-3 py-2 rounded text-sm cursor-pointer flex items-center justify-between">
                        <span>1.1 Cover Page & Title</span>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="step-item completed px-3 py-2 rounded text-sm cursor-pointer flex items-center justify-between">
                        <span>1.2 Client & Property Info</span>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="step-item active px-3 py-2 rounded text-sm cursor-pointer">
                        1.3 Value Dates & Types
                    </div>
                </div>
            </div>

            <!-- Section 2: Transmittal Letter -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" /></svg>
                        2. Transmittal Letter
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        2.1 Letter of Transmittal
                    </div>
                </div>
            </div>

            <!-- Section 3: Summary of Appraisal -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        3. Summary of Appraisal
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        3.1 Basic Property Information
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        3.2 Site Information
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        3.3 Improvements Description
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        3.4 Highest and Best Use
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        3.5 Value Summary
                    </div>
                </div>
            </div>

            <!-- Section 4: Purpose & Scope -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
                        4. Purpose & Scope
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        4.1 Purpose of the Appraisal
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        4.2 Intended Use & Users
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        4.3 Interest Valued
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        4.4 Effective Dates
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        4.5 Assumptions & Conditions
                    </div>
                </div>
            </div>

            <!-- Section 5: Appraisal Development & Reporting Process -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v12.75c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>
                        5. Development & Reporting Process
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        5.1 Development Process
                    </div>
                </div>
            </div>

            <!-- Section 6: General Area Analysis -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>
                        6. General Area Analysis
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        6.1 City/County Overview
                    </div>
                </div>
            </div>

            <!-- Section 7: Neighborhood Analysis -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21M3 3h12m6 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5m-1.5 0h-1.5" /></svg>
                        7. Neighborhood Analysis
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        7.1 Neighborhood Definition
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        7.2 Access & Infrastructure
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        7.3 Land Uses & Development
                    </div>
                </div>
            </div>

            <!-- Section 8: Site Analysis -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>
                        8. Site Analysis
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        8.1 Detailed Site Description
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        8.2 Site Dimensions & Characteristics
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        8.3 Improvements
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        8.4 Site Conditions
                    </div>
                </div>
            </div>

            <!-- Section 9: Improvement Analysis -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6h1.5m-1.5 3h1.5m-1.5 3h1.5M15 21v-3.375c0-.621-.504-1.125-1.125-1.125h-2.75c-.621 0-1.125.504-1.125 1.125V21" /></svg>
                        9. Improvement Analysis
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        9.1 Description of Improvements
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        9.2 Unit Mix (Per Building)
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        9.3 Additional Improvement Details
                    </div>
                </div>
            </div>

            <!-- Section 10: Taxes & Assessments -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v12.75c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" /></svg>
                        10. Taxes & Assessments
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        10.1 Property Tax Information
                    </div>
                </div>
            </div>

            <!-- Section 11: Property Ownership & Transaction History -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                        11. Property Ownership & History
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        11.1 Current Ownership
                    </div>
                </div>
            </div>

            <!-- Section 12: Highest and Best Use Analysis -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
                        12. Highest and Best Use
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        12.1 Highest & Best Use - As Vacant
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        12.2 Highest & Best Use - As Improved
                    </div>
                </div>
            </div>

            <!-- Section 13: Cost Approach -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        13. Cost Approach
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        13.1 Land Valuation
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        13.2 Improvement Valuation
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        13.3 Depreciation
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        13.4 Cost Approach Conclusion
                    </div>
                </div>
            </div>

            <!-- Section 14: Sales Comparison Approach -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15.75c0-.621.504-1.125 1.125-1.125h.375M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
                        14. Sales Comparison Approach
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.1 Comparable Sales Search
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.2 Market Conditions Analysis
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.3 Comparable Sales Data
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.4 Sales Comparison Grid
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.5 Adjustment Analysis
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        14.6 Sales Comparison Conclusion
                    </div>
                </div>
            </div>

            <!-- Section 15: Income Approach -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15.75c0-.621.504-1.125 1.125-1.125h.375M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
                        15. Income Approach
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.1 Income Approach Method Selection
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.2 Rental Income Analysis
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.3 Operating Expenses
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.4 Capitalization Rate
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.5 Income Approach Conclusion
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.5.1 GRM Analysis
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        15.5.2 Amenity Analysis
                    </div>
                </div>
            </div>

            <!-- Section 17: Correlation Analysis and Final Value -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0012 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 01-2.036.243c-2.132 0-4.14-.354-6.042-.983m12.75-12.75l-2.62 10.726c-.122.499.106 1.028.589 1.202a5.989 5.989 0 012.036.243c2.132 0 4.14-.354 6.042-.983" /></svg>
                        17. Correlation & Final Value
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        17.1 Reconciliation of Approaches
                    </div>
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        17.2 Final Value Conclusion
                    </div>
                </div>
            </div>

            <!-- Section 18: Certification -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" /></svg>
                        18. Certification
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        18.1 Certification Statement
                    </div>
                </div>
            </div>

            <!-- Section 19: Qualifications -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                        19. Qualifications
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        19.1 Appraiser Qualifications
                    </div>
                </div>
            </div>

            <!-- Section 20: Assumptions & Limiting Conditions -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>
                        20. Assumptions & Limiting Conditions
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        20.1 Standard Assumptions
                    </div>
                </div>
            </div>

            <!-- Section 21: Addenda -->
            <div class="mb-2 section-item">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-text flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81" /></svg>
                        21. Addenda
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600">
                        21.1 Supporting Documentation
                    </div>
                </div>
            </div>

            <!-- Review & Finalize Section -->
            <div class="mb-2 section-item border-t-2 border-harken-accent mt-4 pt-4">
                <button class="w-full text-left px-3 py-2 rounded flex items-center justify-between hover:bg-gray-100">
                    <span class="font-medium text-harken-dark flex items-center">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Review & Finalize
                    </span>
                    <svg class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
                <div class="section-content ml-8 mt-1 space-y-1">
                    <div class="step-item px-3 py-2 rounded text-sm cursor-pointer text-gray-600" id="review-step">
                        Review Report
                    </div>
                </div>
            </div>

        </nav>

        <!-- Save Status -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex items-center text-sm text-gray-600">
                <svg class="w-4 h-4 mr-2 text-harken-success" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                All changes saved
            </div>
            <p class="text-xs text-gray-500 mt-1">Last saved: 2 minutes ago</p>
        </div>
    </div>

    <!-- Main Content Area (Hidden during pre-wizard) -->
    <div class="flex-1 flex flex-col overflow-hidden" id="wizard-main">
        
        <!-- Top Bar -->
        <div class="bg-white border-b border-gray-200">
            <!-- Progress Bar at Top -->
            <div class="px-8 py-4 border-b border-gray-200">
                <div class="flex items-center justify-center space-x-4">
                    <div class="flex items-center">
                        <div id="progress-step-1" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-harken-accent border-harken-accent text-white">1</div>
                        <span id="progress-label-1" class="ml-3 text-sm font-medium text-harken-accent">Template</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div id="progress-step-2" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400">2</div>
                        <span id="progress-label-2" class="ml-3 text-sm font-medium text-gray-400">Setup</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div id="progress-step-3" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400">3</div>
                        <span id="progress-label-3" class="ml-3 text-sm font-medium text-gray-400">Overview</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div id="progress-step-4" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400">4</div>
                        <span id="progress-label-4" class="ml-3 text-sm font-medium text-gray-400">Sales Approach</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div id="progress-step-5" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400">5</div>
                        <span id="progress-label-5" class="ml-3 text-sm font-medium text-gray-400">Exhibits</span>
                    </div>
                    <div class="w-12 h-0.5 bg-gray-300"></div>
                    <div class="flex items-center">
                        <div id="progress-step-6" class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400">6</div>
                        <span id="progress-label-6" class="ml-3 text-sm font-medium text-gray-400">Review</span>
                    </div>
                </div>
            </div>
            
            <!-- Title and Actions -->
            <div class="px-8 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-semibold text-harken-dark">1.3 Value Dates & Types</h2>
                        <p class="text-sm text-harken-text mt-1">Step 3 of 51 • Section 1: Report Header & Identification</p>
                    </div>
                    <div class="flex space-x-3">
                        <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                            </svg>
                            Save Draft
                        </button>
                        <button id="continue-btn" class="px-4 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light flex items-center disabled:opacity-50 disabled:cursor-not-allowed" onclick="handleContinue()" disabled>
                            Continue
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto">
            <div class="max-w-4xl mx-auto p-8" id="content-area">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <div class="bg-white border-t border-gray-200 px-8 py-4">
            <div class="max-w-4xl mx-auto flex items-center justify-between">
                <button class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 flex items-center" id="prev-btn">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Previous
                </button>

                <div class="flex items-center space-x-4">
                    <button class="px-4 py-2 text-gray-600 hover:text-gray-900" id="save-exit-btn">
                        Save & Exit
                    </button>
                    <button class="px-6 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light flex items-center" id="save-continue-btn">
                        Save & Continue
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                    <button class="px-6 py-2 bg-harken-success text-white rounded-lg hover:bg-green-700 flex items-center" id="review-btn" style="display: none;">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Review & Finalize
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Right Sidebar - Help & Context -->
    <div class="w-80 bg-white border-l border-gray-200 overflow-y-auto">
        <div class="p-6" id="help-sidebar">
            <!-- Dynamic help content will be loaded here -->
        </div>
    </div>

</div>

<script>
    // Property Type Configuration
    const propertyTypeConfig = {
        commercial: {
            subtypes: ['Industrial', 'Office', 'Retail', 'Medical', 'Mixed-Use', 'Specialized'],
            defaultApproaches: { cost: true, sales: true, income: true },
            description: 'Commercial properties including office buildings, retail centers, industrial facilities, and specialized properties.'
        },
        residential: {
            subtypes: ['Single-Family', 'Multi-Family (2-4)', 'Multi-Family (5+)', 'Condo', 'Manufactured Housing'],
            defaultApproaches: { cost: true, sales: true, income: false },
            description: 'Residential properties including single-family homes, multi-family buildings, condominiums, and manufactured housing.'
        },
        land: {
            subtypes: ['Finished Lot', 'Entitled Land', 'Agricultural', 'Transitional', 'Special Use'],
            defaultApproaches: { cost: true, sales: true, income: false },
            description: 'Land properties including finished lots, entitled land, agricultural properties, and special use parcels.'
        }
    };

    // Assignment Context
    let assignmentContext = {
        propertyType: null,
        subType: null,
        // Scenario Trigger Fields
        propertyStatus: null,        // 'existing', 'under_construction', 'proposed', 'recently_completed'
        plannedChanges: 'none',      // 'none', 'minor', 'major', 'change_of_use'
        occupancyStatus: 'not_applicable', // 'stabilized', 'lease_up', 'vacant', 'not_applicable'
        loanPurpose: 'purchase',     // 'purchase', 'refinance', 'construction', 'bridge', 'internal'
        // Scenarios and Approaches
        scenarios: [
            { id: 1, name: 'As Is', nameSelect: 'As Is', customName: '', approaches: ['Sales Comparison'], isRequired: true, requirementSource: 'Current market value' }
        ],
        approaches: {
            cost: { enabled: true, required: false },
            sales: { enabled: true, required: false },
            income: { enabled: false, required: false }
        }
    };

    // Scenario Trigger Options
    const propertyStatusOptions = [
        { value: 'existing', label: 'Existing / Completed', description: 'Property is built and operational', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
        { value: 'under_construction', label: 'Under Construction', description: 'Currently being built or renovated', icon: 'M19 21l-7-5-7 5V5a2 2 0 012-2h10a2 2 0 012 2z M12 11V7m0 0L9 10m3-3l3 3' },
        { value: 'proposed', label: 'Proposed / Not Yet Started', description: 'Plans exist but construction has not begun', icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' },
        { value: 'recently_completed', label: 'Recently Completed', description: 'Finished within the last 12 months', icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' }
    ];

    const plannedChangesOptions = [
        { value: 'none', label: 'No planned changes', description: 'Property will remain as-is' },
        { value: 'minor', label: 'Minor repairs/updates', description: 'Less than 10% of property value' },
        { value: 'major', label: 'Major renovation or expansion', description: 'Significant capital improvements planned' },
        { value: 'change_of_use', label: 'Change of use / Conversion', description: 'Property will be converted to different use' }
    ];

    const occupancyStatusOptions = [
        { value: 'stabilized', label: 'Stabilized (>90% occupied)', description: 'At or near market occupancy' },
        { value: 'lease_up', label: 'In lease-up phase', description: 'Currently filling vacancies' },
        { value: 'vacant', label: 'Vacant or under-occupied', description: 'Below 70% occupied' },
        { value: 'not_applicable', label: 'N/A (owner-occupied)', description: 'Not an income property' }
    ];

    const loanPurposeOptions = [
        { value: 'purchase', label: 'Purchase financing', description: 'Acquisition of existing property' },
        { value: 'refinance', label: 'Refinance', description: 'Refinancing existing debt' },
        { value: 'construction', label: 'Construction loan', description: 'Financing new construction' },
        { value: 'bridge', label: 'Bridge / interim financing', description: 'Short-term financing, often for value-add' },
        { value: 'internal', label: 'Internal / portfolio review', description: 'Not for lending purposes' }
    ];

    // Scenario Name Options
    const scenarioOptions = [
        { label: 'As Is', value: 'As Is' },
        { label: 'As Completed', value: 'As Completed' },
        { label: 'As Stabilized', value: 'As Stabilized' },
        { label: 'As Proposed', value: 'As Proposed' },
        { label: 'Type my own', value: 'Type my own' }
    ];

    // ==========================================
    // AUTOMATIC SCENARIO DETERMINATION LOGIC
    // Per Interagency Appraisal Guidelines and USPAP
    // ==========================================
    function determineRequiredScenarios() {
        const scenarios = [];
        const { propertyStatus, plannedChanges, occupancyStatus, loanPurpose, propertyType, subType } = assignmentContext;
        
        // If no property status selected yet, return default
        if (!propertyStatus) {
            return [{ 
                id: 1, 
                name: 'As Is', 
                nameSelect: 'As Is', 
                customName: '', 
                approaches: [], 
                isRequired: true, 
                requirementSource: 'Current market value' 
            }];
        }
        
        // === RULE 1: Property Status Drives Primary Scenarios ===
        if (propertyStatus === 'proposed') {
            // No existing property to value "As Is" - start with As Proposed
            scenarios.push({
                id: 1,
                name: 'As Proposed',
                nameSelect: 'As Proposed',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Proposed development - no existing improvements'
            });
            scenarios.push({
                id: 2,
                name: 'As Completed',
                nameSelect: 'As Completed',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Interagency Guidelines - construction/development'
            });
            scenarios.push({
                id: 3,
                name: 'As Stabilized',
                nameSelect: 'As Stabilized',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Interagency Guidelines - income property stabilization'
            });
        } 
        else if (propertyStatus === 'under_construction') {
            scenarios.push({
                id: 1,
                name: 'As Is',
                nameSelect: 'As Is',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Current value of partially-complete improvements'
            });
            scenarios.push({
                id: 2,
                name: 'As Completed',
                nameSelect: 'As Completed',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Interagency Guidelines - construction loan'
            });
            scenarios.push({
                id: 3,
                name: 'As Stabilized',
                nameSelect: 'As Stabilized',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Interagency Guidelines - post-construction lease-up'
            });
        }
        else if (propertyStatus === 'recently_completed') {
            scenarios.push({
                id: 1,
                name: 'As Is',
                nameSelect: 'As Is',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Current market value'
            });
            
            // Check if property needs stabilization
            if (occupancyStatus !== 'stabilized' && occupancyStatus !== 'not_applicable') {
                scenarios.push({
                    id: 2,
                    name: 'As Stabilized',
                    nameSelect: 'As Stabilized',
                    customName: '',
                    approaches: [],
                    isRequired: true,
                    requirementSource: 'Property not yet at stabilized occupancy'
                });
            }
        }
        else {
            // Existing property - baseline
            scenarios.push({
                id: 1,
                name: 'As Is',
                nameSelect: 'As Is',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Current market value'
            });
        }
        
        // === RULE 2: Planned Changes Add Scenarios ===
        if (plannedChanges === 'major' || plannedChanges === 'change_of_use') {
            if (!scenarios.some(s => s.name === 'As Completed')) {
                scenarios.push({
                    id: scenarios.length + 1,
                    name: 'As Completed',
                    nameSelect: 'As Completed',
                    customName: '',
                    approaches: [],
                    isRequired: true,
                    requirementSource: 'Major renovation/change of use planned'
                });
            }
            
            // If income property, may need stabilization after renovation
            if (occupancyStatus !== 'not_applicable' && !scenarios.some(s => s.name === 'As Stabilized')) {
                scenarios.push({
                    id: scenarios.length + 1,
                    name: 'As Stabilized',
                    nameSelect: 'As Stabilized',
                    customName: '',
                    approaches: [],
                    isRequired: false,
                    requirementSource: 'Recommended for income property after renovation'
                });
            }
        }
        
        // === RULE 3: Occupancy Adjustments ===
        if (occupancyStatus === 'lease_up' && !scenarios.some(s => s.name === 'As Stabilized')) {
            scenarios.push({
                id: scenarios.length + 1,
                name: 'As Stabilized',
                nameSelect: 'As Stabilized',
                customName: '',
                approaches: [],
                isRequired: true,
                requirementSource: 'Property currently in lease-up phase'
            });
        }
        
        // === RULE 4: Loan Purpose Overrides ===
        if (loanPurpose === 'construction') {
            if (!scenarios.some(s => s.name === 'As Completed')) {
                scenarios.push({
                    id: scenarios.length + 1,
                    name: 'As Completed',
                    nameSelect: 'As Completed',
                    customName: '',
                    approaches: [],
                    isRequired: true,
                    requirementSource: 'Interagency Guidelines - construction loan requirement'
                });
            }
            if (!scenarios.some(s => s.name === 'As Stabilized')) {
                scenarios.push({
                    id: scenarios.length + 1,
                    name: 'As Stabilized',
                    nameSelect: 'As Stabilized',
                    customName: '',
                    approaches: [],
                    isRequired: true,
                    requirementSource: 'Interagency Guidelines - construction loan requirement'
                });
            }
        }
        
        if (loanPurpose === 'bridge') {
            if (plannedChanges !== 'none' && !scenarios.some(s => s.name === 'As Completed')) {
                scenarios.push({
                    id: scenarios.length + 1,
                    name: 'As Completed',
                    nameSelect: 'As Completed',
                    customName: '',
                    approaches: [],
                    isRequired: false,
                    requirementSource: 'Recommended for bridge financing with planned improvements'
                });
            }
        }
        
        // Reassign IDs to be sequential
        scenarios.forEach((s, idx) => s.id = idx + 1);
        
        return scenarios;
    }

    // Update scenarios when triggers change
    function updateScenarioTrigger(field, value) {
        assignmentContext[field] = value;
        
        // Auto-determine scenarios based on new triggers
        const newScenarios = determineRequiredScenarios();
        
        // Preserve any custom scenarios the user added
        const customScenarios = assignmentContext.scenarios.filter(s => 
            !['As Is', 'As Completed', 'As Stabilized', 'As Proposed'].includes(s.name)
        );
        
        // Merge: use new auto-determined scenarios + keep custom ones
        assignmentContext.scenarios = [...newScenarios, ...customScenarios];
        
        // Re-render the setup page
        loadPreWizardStep(preWizardStep);
    }

    // Check if occupancy question should be shown
    function shouldShowOccupancyQuestion() {
        const { propertyType, subType } = assignmentContext;
        if (propertyType === 'commercial') return true;
        if (subType && (subType.includes('Multi-Family') || subType.includes('Condo'))) return true;
        return false;
    }

    // Scenario Management Functions
    function addScenario() {
        const newId = assignmentContext.scenarios.length > 0 ? Math.max(...assignmentContext.scenarios.map(s => s.id)) + 1 : 1;
        assignmentContext.scenarios.push({ id: newId, name: '', nameSelect: '', customName: '', approaches: [] });
        loadStep('appraisal-setup'); // Re-render
    }

    function removeScenario(id) {
        assignmentContext.scenarios = assignmentContext.scenarios.filter(s => s.id !== id);
        loadStep('appraisal-setup'); // Re-render
    }

    function updateScenarioName(id, type, value) {
        const scenario = assignmentContext.scenarios.find(s => s.id === id);
        if (!scenario) return;

        if (type === 'pill') {
            if (value === 'Type my own') {
                scenario.nameSelect = 'Type my own';
                scenario.name = scenario.customName || '';
            } else {
                scenario.nameSelect = value;
                scenario.name = value;
                scenario.customName = '';
            }
        } else if (type === 'custom') {
            scenario.customName = value;
            scenario.name = value;
        }
        loadStep('appraisal-setup'); // Re-render
    }

    function toggleScenarioApproach(id, approach) {
        const scenario = assignmentContext.scenarios.find(s => s.id === id);
        if (!scenario) return;

        const index = scenario.approaches.indexOf(approach);
        if (index === -1) {
            scenario.approaches.push(approach);
        } else {
            scenario.approaches.splice(index, 1);
        }
        
        // Update global approaches for backward compatibility
        const allApproaches = new Set();
        assignmentContext.scenarios.forEach(s => {
            s.approaches.forEach(a => allApproaches.add(a));
        });
        
        const approachMap = {
            'Sales Comparison': 'sales',
            'Cost Approach': 'cost',
            'Income Approach': 'income'
        };

        Object.keys(approachMap).forEach(key => {
            const globalKey = approachMap[key];
            assignmentContext.approaches[globalKey].enabled = allApproaches.has(key);
        });

        loadStep('appraisal-setup'); // Re-render
    }

    // Building Management State
    let buildingsData = [];
    let activeBuildingIndex = 0;

    // Initialize buildings array
    function initializeBuildings(count) {
        buildingsData = [];
        for (let i = 0; i < count; i++) {
            buildingsData.push({
                id: i,
                name: `Building ${i + 1}`,
                locationOnSite: '',
                units: [{
                    unit: '1',
                    unitSize: '',
                    officeSF: '',
                    shopSF: '',
                    restrooms: '',
                    ohDoors: ''
                }],
                constructionDetails: {}
            });
        }
        activeBuildingIndex = 0;
    }

    // Add a new building
    function addBuilding() {
        const newIndex = buildingsData.length;
        buildingsData.push({
            id: newIndex,
            name: `Building ${newIndex + 1}`,
            locationOnSite: '',
            units: [{
                unit: '1',
                unitSize: '',
                officeSF: '',
                shopSF: '',
                restrooms: '',
                ohDoors: ''
            }],
            constructionDetails: {}
        });
        activeBuildingIndex = newIndex;
        renderBuildingTabs();
        loadBuildingData(newIndex);
    }

    // Remove current building
    function removeBuilding() {
        if (buildingsData.length <= 1) {
            alert('Cannot remove the last building. At least one building is required.');
            return;
        }
        
        if (confirm(`Are you sure you want to remove ${buildingsData[activeBuildingIndex].name}?`)) {
            buildingsData.splice(activeBuildingIndex, 1);
            // Re-index buildings
            buildingsData.forEach((building, idx) => {
                building.id = idx;
                if (building.name.startsWith('Building ')) {
                    building.name = `Building ${idx + 1}`;
                }
            });
            activeBuildingIndex = Math.min(activeBuildingIndex, buildingsData.length - 1);
            renderBuildingTabs();
            loadBuildingData(activeBuildingIndex);
        }
    }

    // Duplicate current building
    function duplicateBuilding() {
        const currentBuilding = buildingsData[activeBuildingIndex];
        const newBuilding = JSON.parse(JSON.stringify(currentBuilding)); // Deep clone
        const newIndex = buildingsData.length;
        newBuilding.id = newIndex;
        newBuilding.name = `${currentBuilding.name} (Copy)`;
        buildingsData.push(newBuilding);
        activeBuildingIndex = newIndex;
        renderBuildingTabs();
        loadBuildingData(newIndex);
    }

    // Switch to a specific building
    function switchBuilding(index) {
        if (index >= 0 && index < buildingsData.length) {
            saveBuildingData(activeBuildingIndex); // Save current before switching
            activeBuildingIndex = index;
            renderBuildingTabs();
            loadBuildingData(index);
        }
    }

    // Render building tabs
    function renderBuildingTabs() {
        const tabsContainer = document.getElementById('building-tabs');
        if (!tabsContainer) return;
        
        let html = '<div class="flex items-center gap-2 border-b border-gray-200 mb-6 overflow-x-auto">';
        
        // Building tabs
        buildingsData.forEach((building, index) => {
            const isActive = index === activeBuildingIndex;
            html += `<button type="button" class="px-6 py-3 font-medium text-sm whitespace-nowrap border-b-2 transition-colors ${isActive ? 'border-harken-accent text-harken-accent bg-harken-accent/5' : 'border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300'}" onclick="switchBuilding(${index})">`;
            html += `<svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>`;
            html += `</svg>`;
            html += building.name;
            html += `</button>`;
        });
        
        // Action buttons
        html += `<button type="button" class="px-4 py-3 text-sm text-harken-accent hover:bg-harken-accent/5 rounded-lg flex items-center whitespace-nowrap ml-2" onclick="addBuilding()">`;
        html += `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>`;
        html += `</svg>`;
        html += `Add Building`;
        html += `</button>`;
        
        html += `<button type="button" class="px-4 py-3 text-sm text-gray-600 hover:bg-gray-100 rounded-lg flex items-center whitespace-nowrap" onclick="duplicateBuilding()">`;
        html += `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>`;
        html += `</svg>`;
        html += `Duplicate`;
        html += `</button>`;
        
        if (buildingsData.length > 1) {
            html += `<button type="button" class="px-4 py-3 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center whitespace-nowrap" onclick="removeBuilding()">`;
            html += `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>`;
            html += `</svg>`;
            html += `Remove`;
            html += `</button>`;
        }
        
        html += '</div>';
        
        tabsContainer.innerHTML = html;
    }

    // Save current building data
    function saveBuildingData(index) {
        if (index < 0 || index >= buildingsData.length) return;
        
        const building = buildingsData[index];
        
        // Save building name if editable input exists
        const nameInput = document.getElementById('building-name-input');
        if (nameInput) {
            building.name = nameInput.value || building.name;
        }
        
        // Save location
        const locationInput = document.getElementById('building-location-input');
        if (locationInput) {
            building.locationOnSite = locationInput.value;
        }
        
        // Save unit mix table data
        const unitsTable = document.getElementById('tbody-units');
        if (unitsTable) {
            building.units = [];
            unitsTable.querySelectorAll('tr').forEach(row => {
                const unit = {};
                row.querySelectorAll('input[data-col]').forEach(input => {
                    const col = input.getAttribute('data-col');
                    unit[col] = input.value;
                });
                building.units.push(unit);
            });
        }
        
        // TODO: Save construction details from accordions
    }

    // Load building data into form
    function loadBuildingData(index) {
        if (index < 0 || index >= buildingsData.length) return;
        
        const building = buildingsData[index];
        
        // Load building name
        const nameInput = document.getElementById('building-name-input');
        if (nameInput) {
            nameInput.value = building.name;
        }
        
        // Load location
        const locationInput = document.getElementById('building-location-input');
        if (locationInput) {
            locationInput.value = building.locationOnSite || '';
        }
        
        // Load unit mix table data
        const unitsTable = document.getElementById('tbody-units');
        if (unitsTable && building.units) {
            unitsTable.innerHTML = '';
            building.units.forEach((unit, rowIndex) => {
                const row = document.createElement('tr');
                row.className = `hover:bg-blue-50 ${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
                row.setAttribute('data-row', rowIndex);
                
                // Render row HTML (simplified - would use renderTableRow in production)
                let rowHTML = '';
                const columns = ['unit', 'unitSize', 'officeSF', 'shopSF', 'restrooms', 'ohDoors'];
                columns.forEach(col => {
                    rowHTML += `<td class="px-4 py-2"><input type="${col.includes('SF') || col === 'ohDoors' ? 'number' : 'text'}" class="w-full px-2 py-1 text-sm border border-gray-300 rounded" data-col="${col}" value="${unit[col] || ''}" onblur="calculateRow(999, ${rowIndex})"></td>`;
                });
                rowHTML += `<td class="px-4 py-2"><button type="button" class="text-red-500" onclick="deleteTableRow(999, ${rowIndex})"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></td>`;
                
                row.innerHTML = rowHTML;
                unitsTable.appendChild(row);
            });
        }
        
        // TODO: Load construction details into accordions
    }

    // Logged-in User Session Data (would come from backend in production)
    const loggedInUser = {
        companyName: 'Harken Appraisal Services',
        appraiserName: 'John Smith',
        credentials: 'MAI, SRA',
        address: '123 Main Street, Suite 100',
        cityStateZip: 'Denver, CO 80202',
        phone: '(303) 555-1234'
    };

    // Appraisal Wizard Data Structure - All Steps
    const wizardSteps = {
        'template-selection': {
            title: 'Select Report Template',
            section: 'Template Selection',
            customRender: true,
            isPreWizard: true
        },
        'appraisal-setup': {
            title: 'Appraisal Setup',
            section: 'Setup',
            customRender: true,
            isPreWizard: true
        },
        'overview': {
            title: 'Appraisal Overview',
            section: 'Overview',
            customRender: true,
            isPreWizard: true
        },
        '1.1': {
            title: 'Cover Page & Title',
            section: 'Report Header & Identification',
            helpBanner: {
                title: 'Cover Page Information',
                content: 'Enter the basic property identification and title information that will appear on the cover page of your appraisal report.'
            },
            fields: [
                { type: 'text', label: 'Property Name/Description', required: true, placeholder: 'e.g., Proposed Canyon Creek Industrial Shop Complex' },
                { type: 'text', label: 'City', required: true },
                { type: 'text', label: 'County', required: true },
                { type: 'select', label: 'State', required: true, options: ['Alabama', 'Alaska', 'Arizona', 'Arkansas', 'California', 'Colorado', 'Connecticut', 'Delaware', 'Florida', 'Georgia', 'Hawaii', 'Idaho', 'Illinois', 'Indiana', 'Iowa', 'Kansas', 'Kentucky', 'Louisiana', 'Maine', 'Maryland', 'Massachusetts', 'Michigan', 'Minnesota', 'Mississippi', 'Missouri', 'Montana', 'Nebraska', 'Nevada', 'New Hampshire', 'New Jersey', 'New Mexico', 'New York', 'North Carolina', 'North Dakota', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'Rhode Island', 'South Carolina', 'South Dakota', 'Tennessee', 'Texas', 'Utah', 'Vermont', 'Virginia', 'Washington', 'West Virginia', 'Wisconsin', 'Wyoming'] },
                { type: 'date', label: 'Date of Inspection', required: true },
                { type: 'date', label: 'Date of Report', required: true },
                { type: 'select-with-add', label: 'Client Name', required: true, options: ['Acme Corporation', 'Smith Realty Group', 'Johnson Development LLC', 'Metro Properties Inc'], addNewLabel: 'Add New Client', addNewAction: 'openClientModal' },
                { type: 'text', label: 'Attention To' },
                { type: 'textarea', label: 'Client Address', required: true, rows: 3 },
                { type: 'text', label: 'City, State, ZIP', required: true },
                { type: 'text', label: 'Appraiser Company Name', required: true, readonly: true, defaultValue: 'loggedInUser.companyName', autoFill: true },
                { type: 'text', label: 'Appraiser Name', required: true, readonly: true, defaultValue: 'loggedInUser.appraiserName', autoFill: true },
                { type: 'text', label: 'Credentials', placeholder: 'e.g., MAI, SRA', readonly: true, defaultValue: 'loggedInUser.credentials', autoFill: true },
                { type: 'text', label: 'Appraiser Address', required: true, readonly: true, defaultValue: 'loggedInUser.address', autoFill: true },
                { type: 'tel', label: 'Phone', required: true, readonly: true, defaultValue: 'loggedInUser.phone', autoFill: true }
            ],
            help: {
                about: 'The cover page establishes the basic identification of the property, client, and appraiser. This information must be accurate and complete as it forms the foundation of the appraisal report.',
                uspap: 'USPAP Standards Rule 2-2(a)(i) requires identification of the client and other intended users.',
                definitions: [
                    { term: 'Date of Inspection', definition: 'The date when the appraiser physically inspected the property' },
                    { term: 'Date of Report', definition: 'The date when the appraisal report is completed and signed' }
                ],
                bestPractices: [
                    'Ensure all dates are accurate and reflect actual inspection and completion dates',
                    'Use full legal names for client and appraiser',
                    'Include all relevant credentials and certifications'
                ]
            }
        },
        '1.2': {
            title: 'Client & Property Info',
            section: 'Report Header & Identification',
            helpBanner: {
                title: 'Additional Property Details',
                content: 'Provide comprehensive property identification information including legal descriptions and ownership details.'
            },
            fields: [
                { type: 'text', label: 'Property Address', required: true },
                { type: 'text', label: 'Legal Description', required: true, placeholder: 'Lots, Block, Subdivision' },
                { type: 'text', label: 'Tax ID Number', required: true },
                { type: 'text', label: 'Owner of Record', required: true },
                { type: 'select', label: 'Entity Type', options: ['LLC', 'Corporation', 'Individual', 'Trust', 'Partnership', 'Other'] },
                { type: 'textarea', label: 'Property Description', rows: 4 }
            ],
            help: {
                about: 'Complete property identification ensures the appraisal report clearly identifies the subject property and all parties involved.',
                definitions: [
                    { term: 'Legal Description', definition: 'A detailed description of the property boundaries and location as recorded in public records' },
                    { term: 'Tax ID Number', definition: 'The parcel number or tax identification number assigned by the local assessor' }
                ],
                bestPractices: [
                    'Verify legal description matches current deed records',
                    'Include all parcels if property consists of multiple tax lots',
                    'Confirm owner of record matches current title records'
                ]
            }
        },
        '1.3': {
            title: 'Value Dates & Types',
            section: 'Report Header & Identification',
            helpBanner: {
                title: 'About Effective Dates',
                content: 'For proposed or under-construction properties, you\'ll need to provide multiple value dates: "As Is" (current), "As Completed" (upon construction completion), and "As Stabilized" (after reaching market occupancy).'
            },
            fields: [
                { type: 'date', label: 'Date of Inspection', required: true },
                { type: 'date', label: 'Date of Report', required: true },
                { type: 'checkbox-group', label: 'Value Type Selection', options: [
                    { label: '"As Is" Value', description: 'Current market value in existing condition' },
                    { label: '"As Completed" Value', description: 'Prospective value upon completion of construction/improvements' },
                    { label: '"As Stabilized" Value', description: 'Prospective value upon achieving stabilized occupancy' }
                ]},
                { type: 'date', label: 'Effective Date of "As Is" Value', required: true, note: 'Typically matches inspection date' },
                { type: 'date', label: 'Effective Date of "As Completed" Value', required: true, note: 'Future date' },
                { type: 'date', label: 'Effective Date of "As Stabilized" Value', required: true, note: 'Future date after completion' },
                { type: 'number', label: 'Estimated Exposure Period', unit: 'select', unitOptions: ['Months', 'Days', 'Years'] }
            ],
            help: {
                about: 'Effective dates are critical for establishing when the opinion of value applies. For proposed properties, multiple value scenarios are typically required.',
                uspap: 'Standards Rule 2-2(a)(vii) requires the effective date of the appraisal to be clearly stated. For prospective value opinions, the projected time frame must be disclosed.',
                definitions: [
                    { term: 'Effective Date', definition: 'The date to which the value opinion applies' },
                    { term: '"As Is" Value', definition: 'The value of real property in its current physical condition and as of the effective date' },
                    { term: 'Prospective Value', definition: 'A value opinion effective as of a specified future date' },
                    { term: 'Exposure Period', definition: 'The estimated length of time the property would have been offered on the market prior to sale' }
                ],
                bestPractices: [
                    '"As Is" date typically matches inspection date',
                    'Confirm projected completion dates with developer',
                    'Allow reasonable time for lease-up/stabilization',
                    'Exposure period should reflect current market conditions'
                ]
            }
        },
        '2.1': {
            title: 'Letter of Transmittal',
            section: 'Transmittal Letter',
            helpBanner: {
                title: 'Letter of Transmittal',
                content: 'The transmittal letter formally presents the appraisal report to the client and summarizes the key findings, including property identification, value conclusions, and effective dates.'
            },
            fields: [
                { type: 'date', label: 'Date of Letter', required: true },
                { type: 'heading', label: 'Recipient Information' },
                { type: 'text', label: 'Recipient Name', required: true, placeholder: 'e.g., John Doe' },
                { type: 'text', label: 'Recipient Title', placeholder: 'e.g., Vice President' },
                { type: 'text', label: 'Organization', required: true, placeholder: 'e.g., First National Bank' },
                { type: 'textarea', label: 'Recipient Address', required: true, rows: 2, placeholder: '123 Bank Street\nDenver, CO 80202' },
                { type: 'heading', label: 'Letter Content' },
                { type: 'text', label: 'Subject Line (RE:)', required: true, placeholder: 'Auto-populated from property description', note: 'This will auto-fill from the property address entered in Section 1' },
                { type: 'text', label: 'Salutation', required: true, placeholder: 'Dear [Recipient Name]', note: 'Auto-fills based on recipient name above' },
                { type: 'select', label: 'Purpose of Appraisal', required: true, options: ['Market Value Estimate', 'Financing', 'Litigation Support', 'Estate Planning', 'Insurance', 'Tax Assessment', 'Other (specify)'] },
                { type: 'heading', label: 'Value Type' },
                { type: 'checkbox-group', label: 'Select applicable value type(s):', options: [
                    { value: 'as-is', label: '"As Is" Market Value' },
                    { value: 'prospective-completion', label: '"Prospective" Market Value (As of Completion)' },
                    { value: 'prospective-stabilization', label: '"Prospective" Market Value (As of Stabilization)' }
                ]},
                { type: 'heading', label: 'Inspection Confirmation' },
                { type: 'checkbox', label: 'I personally inspected the subject property', required: true },
                { type: 'date', label: 'Date of Inspection', required: true },
                { type: 'heading', label: 'Value Conclusions', highlight: true },
                { type: 'currency', label: '"Prospective" Value as of Completion Date', placeholder: '$0.00' },
                { type: 'date', label: 'Completion Date' },
                { type: 'currency', label: '"Prospective" Value as of Stabilization Date', placeholder: '$0.00' },
                { type: 'date', label: 'Stabilization Date' },
                { type: 'currency', label: '"As Is" Market Value', required: true, placeholder: '$0.00' },
                { type: 'date', label: 'Effective Date of "As Is" Value', required: true },
                { type: 'heading', label: 'Exposure Period' },
                { type: 'number', label: 'Estimated Exposure Period', required: true, unit: true, unitOptions: ['Days', 'Months', 'Years'], placeholder: 'Enter number' },
                { type: 'heading', label: 'Report Details' },
                { type: 'number', label: 'Total Pages', readonly: true, note: 'Auto-calculated based on report sections' },
                { type: 'number', label: 'Total Exhibits', readonly: true, note: 'Auto-calculated based on uploaded exhibits' },
                { type: 'heading', label: 'Closing' },
                { type: 'textarea', label: 'Additional Comments (Optional)', rows: 3, placeholder: 'Any additional notes or context for the client...' },
                { type: 'text', label: 'Closing Salutation', required: true, defaultValue: 'Respectfully submitted,' },
                { type: 'text', label: 'Signature Line', required: true, readonly: true, defaultValue: 'loggedInUser.appraiserName', autoFill: true },
                { type: 'text', label: 'Credentials', readonly: true, defaultValue: 'loggedInUser.credentials', autoFill: true }
            ],
            help: `
                <div class="space-y-4">
                    <div>
                        <h4 class="font-semibold text-harken-dark mb-2">Purpose</h4>
                        <p class="text-sm text-gray-700">The Letter of Transmittal serves as the formal cover letter for your appraisal report. It provides a professional introduction and summarizes the key findings for the client.</p>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-harken-dark mb-2">Key Components</h4>
                        <ul class="text-sm text-gray-700 space-y-2 list-disc list-inside">
                            <li><strong>Recipient Information:</strong> Ensure all client contact details are accurate</li>
                            <li><strong>Subject Line:</strong> Clearly identifies the property being appraised</li>
                            <li><strong>Purpose:</strong> States the reason for the appraisal assignment</li>
                            <li><strong>Value Conclusions:</strong> Highlights the final value estimates (this is often the most important section for clients)</li>
                            <li><strong>Inspection Confirmation:</strong> Documents your physical inspection of the property</li>
                            <li><strong>Exposure Period:</strong> Estimates the reasonable marketing time for the property</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-harken-dark mb-2">Value Types</h4>
                        <ul class="text-sm text-gray-700 space-y-2">
                            <li><strong>"As Is" Market Value:</strong> The value of the property in its current condition as of the effective date</li>
                            <li><strong>"Prospective" Value (Completion):</strong> The anticipated value upon completion of construction or improvements</li>
                            <li><strong>"Prospective" Value (Stabilization):</strong> The anticipated value when the property reaches stabilized occupancy and income</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-harken-dark mb-2">Best Practices</h4>
                        <ul class="text-sm text-gray-700 space-y-1 list-disc list-inside">
                            <li>Keep the letter concise and professional (typically 1-2 pages)</li>
                            <li>Ensure all dates are consistent throughout the report</li>
                            <li>Double-check that value conclusions match those in the body of the report</li>
                            <li>Use formal business letter formatting</li>
                            <li>Include your professional credentials in the signature block</li>
                        </ul>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mt-4">
                        <p class="text-sm text-yellow-800">
                            <strong>Important:</strong> The transmittal letter is often the first (and sometimes only) section clients read. Ensure all information is accurate and clearly presented.
                        </p>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-harken-accent p-3 mt-4">
                        <p class="text-sm text-harken-dark">
                            <strong>USPAP Compliance:</strong> Standards Rule 2-2(a)(viii) requires a summary of the value conclusion and the date(s) of value in the transmittal letter.
                        </p>
                    </div>
                </div>
            `
        },
        '3.1': {
            title: 'Basic Property Information',
            section: 'Summary of Appraisal',
            helpBanner: {
                title: 'Property Summary',
                content: 'Provide a comprehensive summary of the property including interest appraised, property type, location, and ownership information.'
            },
            fields: [
                { type: 'select', label: 'Interest Appraised', required: true, options: ['Fee Simple', 'Leased Fee Estate', 'Leasehold Estate', 'Other'] },
                { type: 'select', label: 'Type of Property', required: true, options: ['Light Industrial', 'Heavy Industrial', 'Office', 'Retail', 'Multi-Family', 'Other'] },
                { type: 'textarea', label: 'Detailed Description', rows: 4 },
                { type: 'text', label: 'Full Address', required: true },
                { type: 'textarea', label: 'Proximity Description', rows: 2 },
                { type: 'checkbox', label: 'Physical Address TBD' },
                { type: 'text', label: 'Physical Address' },
                { type: 'text', label: 'Tax ID - Parcel 1', required: true },
                { type: 'text', label: 'Tax ID - Parcel 2' },
                { type: 'text', label: 'Tax ID - Parcel 3' },
                { type: 'text', label: 'Legal Description - Lots' },
                { type: 'text', label: 'Legal Description - Block' },
                { type: 'text', label: 'Legal Description - Subdivision Name' },
                { type: 'text', label: 'Legal Description - Filing' },
                { type: 'text', label: 'Legal Description - Document Number' },
                { type: 'text', label: 'Legal Description - County' },
                { type: 'textarea', label: 'Replat Information', rows: 2 },
                { type: 'text', label: 'Owner of Record', required: true },
                { type: 'select', label: 'Entity Type', options: ['LLC', 'Corporation', 'Individual', 'Trust', 'Partnership', 'Other'] }
            ],
            help: {
                about: 'The summary section provides a comprehensive overview of the property being appraised, including all identification and classification information.',
                definitions: [
                    { term: 'Interest Appraised', definition: 'The type of property interest being valued (e.g., fee simple, leased fee)' },
                    { term: 'Fee Simple', definition: 'Absolute ownership of real property' }
                ],
                bestPractices: [
                    'Ensure property type classification is accurate',
                    'Include complete legal description',
                    'Verify all tax ID numbers',
                    'Confirm current ownership information'
                ]
            }
        },
        '3.2': {
            title: 'Site Information',
            section: 'Summary of Appraisal',
            helpBanner: {
                title: 'Site Characteristics',
                content: 'Document the physical characteristics of the site including size, shape, zoning, and utility availability.'
            },
            fields: [
                { type: 'number', label: 'Total Site Area (Acres)', required: true, step: '0.01' },
                { type: 'number', label: 'Total Site Area (Square Feet)', readonly: true, note: 'Auto-calculated' },
                { type: 'select', label: 'Shape', options: ['Rectangular', 'Irregular', 'Square', 'Triangular', 'Other'] },
                { type: 'number', label: 'Improved Area (SF)' },
                { type: 'number', label: 'Remainder Area (SF)' },
                { type: 'number', label: 'Frontage (feet)' },
                { type: 'text', label: 'Frontage Street' },
                { type: 'text', label: 'Zoning Classification', required: true },
                { type: 'textarea', label: 'Zoning Description', rows: 3 },
                { type: 'checkbox', label: 'Permitted Use Confirmed' },
                { type: 'checkbox-group', label: 'Utilities Available', options: [
                    { label: 'All city services' },
                    { label: 'Water' },
                    { label: 'Sewer' },
                    { label: 'Electric' },
                    { label: 'Gas' },
                    { label: 'Phone' },
                    { label: 'Cable/Internet' }
                ]}
            ],
            help: {
                about: 'Site information is critical for understanding the physical characteristics and development potential of the property.',
                definitions: [
                    { term: 'Frontage', definition: 'The linear measurement of property along a street or road' },
                    { term: 'Zoning', definition: 'Local government regulations that control land use and development' }
                ],
                bestPractices: [
                    'Verify zoning classification with local planning department',
                    'Confirm all utility availability',
                    'Measure frontage accurately',
                    'Document any zoning restrictions or special conditions'
                ]
            }
        },
        '3.3': {
            title: 'Improvements Description',
            section: 'Summary of Appraisal',
            helpBanner: {
                title: 'Building Improvements',
                content: 'Describe all improvements on the property including buildings, structures, and site improvements.'
            },
            fields: [
                { type: 'number', label: 'Number of Buildings', required: true, min: 1 },
                { type: 'repeater', label: 'Building Details', fields: [
                    { type: 'text', label: 'Building Number/ID', required: true },
                    { type: 'number', label: 'Square Footage', required: true },
                    { type: 'number', label: 'Number of Units' },
                    { type: 'text', label: 'Unit Size Range', placeholder: 'e.g., 1,500 - 4,400 SF' }
                ]},
                { type: 'checkbox-group', label: 'Interior Finishes - Walls', options: [
                    { label: 'Metal liner paneling' },
                    { label: 'Painted drywall' },
                    { label: 'Plywood' },
                    { label: 'Other' }
                ]},
                { type: 'checkbox-group', label: 'Interior Finishes - Ceilings', options: [
                    { label: 'Exposed structure' },
                    { label: 'Suspended ceiling' },
                    { label: 'Other' }
                ]},
                { type: 'checkbox-group', label: 'Interior Finishes - Floor', options: [
                    { label: 'Concrete' },
                    { label: 'Epoxy coating' },
                    { label: 'Other' }
                ]},
                { type: 'number', label: 'Overhead Doors per Unit' },
                { type: 'number', label: 'Man Doors per Unit' },
                { type: 'checkbox-group', label: 'Door Types', options: [
                    { label: 'Roll-up' },
                    { label: 'Sectional' },
                    { label: 'Other' }
                ]}
            ],
            help: {
                about: 'A detailed description of improvements is essential for understanding the property\'s physical characteristics and value.',
                definitions: [
                    { term: 'Building Footprint', definition: 'The area covered by a building at ground level' },
                    { term: 'Site Coverage', definition: 'The percentage of the site covered by buildings' }
                ],
                bestPractices: [
                    'Measure all buildings accurately',
                    'Document construction quality and condition',
                    'Note any special features or improvements',
                    'Include photos of improvements'
                ]
            }
        },
        '3.4': {
            title: 'Highest and Best Use',
            section: 'Summary of Appraisal',
            helpBanner: {
                title: 'Highest and Best Use Analysis',
                content: 'Determine the most profitable, legally permissible, physically possible, and financially feasible use of the property.'
            },
            fields: [
                { type: 'textarea', label: '"As Vacant" Analysis - Conclusion', rows: 4, required: true },
                { type: 'textarea', label: '"As Vacant" Analysis - Reasoning', rows: 4 },
                { type: 'textarea', label: '"As Improved" Analysis - Conclusion', rows: 4, required: true },
                { type: 'textarea', label: 'Proposed Use Description', rows: 3 }
            ],
            help: {
                about: 'Highest and best use analysis determines the most profitable use of the property that is legally permissible, physically possible, and financially feasible.',
                uspap: 'USPAP requires analysis of highest and best use as part of the valuation process.',
                definitions: [
                    { term: 'Highest and Best Use', definition: 'The most profitable use of a property that is legally permissible, physically possible, and financially feasible' },
                    { term: 'As Vacant', definition: 'Analysis assuming the land is vacant and available for development' },
                    { term: 'As Improved', definition: 'Analysis considering existing improvements on the property' }
                ],
                bestPractices: [
                    'Consider all four tests: legal permissibility, physical possibility, financial feasibility, and maximum productivity',
                    'Analyze both as vacant and as improved scenarios',
                    'Support conclusions with market data',
                    'Consider current market conditions'
                ]
            }
        },
        '3.5': {
            title: 'Value Summary',
            section: 'Summary of Appraisal',
            helpBanner: {
                title: 'Value Conclusions',
                content: 'Summarize the final value conclusions from all valuation approaches used in the appraisal.'
            },
            fields: [
                { type: 'currency', label: 'Land Value', required: true },
                { type: 'currency', label: 'Remainder Parcel Value' },
                { type: 'currency', label: 'Value by Cost Approach' },
                { type: 'currency', label: 'Value by Sales Comparison Approach' },
                { type: 'currency', label: 'Value by Income Approach' },
                { type: 'currency', label: 'Final "As Completed" Market Value', required: true },
                { type: 'currency', label: 'Final "As Stabilized" Market Value', required: true },
                { type: 'currency', label: 'Final "As Is" Market Value', required: true },
                { type: 'date', label: 'Date of "As Stabilized" Value', required: true },
                { type: 'date', label: 'Date of "As Completed" Value', required: true },
                { type: 'date', label: 'Date of "As Is" Value', required: true },
                { type: 'date', label: 'Date of Report', required: true },
                { type: 'text', label: 'Estimated Exposure Period' }
            ],
            help: {
                about: 'The value summary presents the final conclusions from all valuation approaches and reconciles them into final value opinions.',
                definitions: [
                    { term: 'Reconciliation', definition: 'The process of analyzing and weighing the results from different valuation approaches to reach a final value conclusion' },
                    { term: 'Indicated Value', definition: 'The value conclusion from a specific valuation approach' }
                ],
                bestPractices: [
                    'Reconcile all applicable approaches',
                    'Explain the reasoning for final value conclusions',
                    'Ensure all dates are consistent',
                    'Document any adjustments or weighting applied'
                ]
            }
        },
        // Placeholder entries for remaining steps - can be expanded with full definitions
        '4.1': {
            title: 'Purpose of the Appraisal',
            section: 'Purpose & Scope',
            helpBanner: {
                title: 'Appraisal Purpose',
                content: 'Define the purpose and intended use of this appraisal.'
            },
            fields: [
                { type: 'select', label: 'Purpose of Appraisal', required: true, options: ['Market Value Estimate', 'Financing', 'Purchase/Sale Decision', 'Litigation Support', 'Estate Planning', 'Other'] },
                { type: 'textarea', label: 'Custom Purpose Description', rows: 3, placeholder: 'If "Other" selected, provide details' }
            ],
            help: {
                about: 'The purpose statement establishes why the appraisal is being performed and how it will be used. This is a critical element that guides the entire appraisal process.',
                uspap: 'Standards Rule 2-2(a)(vii) requires a clear statement of the purpose of the appraisal.',
                definitions: [
                    { term: 'Purpose', definition: 'The reason why an appraisal is being performed' },
                    { term: 'Intended Use', definition: 'How the appraisal report will be used by the client' }
                ],
                bestPractices: [
                    'Be specific about the purpose',
                    'Ensure purpose aligns with intended use',
                    'Consider regulatory requirements'
                ]
            }
        },
        '4.2': {
            title: 'Intended Use & Users',
            section: 'Purpose & Scope',
            helpBanner: {
                title: 'Intended Users',
                content: 'Identify who will use this appraisal and for what purpose.'
            },
            fields: [
                { type: 'text', label: 'Primary Intended User', required: true },
                { type: 'checkbox', label: 'Sole and Exclusive Use' },
                { type: 'textarea', label: 'Authorization for Unnamed Third Parties', rows: 3, placeholder: 'Describe any authorization for additional users' }
            ],
            help: {
                about: 'Clearly identifying intended users ensures the report meets their needs and complies with USPAP requirements.',
                uspap: 'Standards Rule 2-2(a)(i) requires identification of the client and other intended users.',
                definitions: [
                    { term: 'Intended User', definition: 'The client and any other party identified by name or type as users of the appraisal' },
                    { term: 'Client', definition: 'The party who engages the appraiser' }
                ],
                bestPractices: [
                    'Name all intended users specifically',
                    'Clarify if use is sole and exclusive',
                    'Document any third-party authorizations'
                ]
            }
        },
        '4.3': {
            title: 'Interest Valued',
            section: 'Purpose & Scope',
            helpBanner: {
                title: 'Property Interest',
                content: 'Specify the type of property interest being appraised.'
            },
            fields: [
                { type: 'select', label: 'Interest Type', required: true, options: ['Fee Simple', 'Leased Fee Estate', 'Leasehold Estate', 'Other'] },
                { type: 'textarea', label: 'Interest Definition', rows: 3, readonly: true, note: 'Auto-populated based on selection' },
                { type: 'text', label: 'Definition Source', readonly: true, note: 'Auto-populated' }
            ],
            help: {
                about: 'The interest appraised determines the scope and methodology of the valuation. Different property interests have different rights and limitations.',
                uspap: 'Standards Rule 2-2(a)(iv) requires identification of the property interest appraised.',
                definitions: [
                    { term: 'Fee Simple', definition: 'Absolute ownership unencumbered by any other interest or estate' },
                    { term: 'Leased Fee', definition: 'Ownership interest held by the lessor with rights of use and occupancy conveyed by lease to others' },
                    { term: 'Leasehold', definition: 'The interest held by the lessee (tenant) by virtue of the lease' }
                ],
                bestPractices: [
                    'Ensure interest matches assignment scope',
                    'Provide clear definitions',
                    'Consider impact on value'
                ]
            }
        },
        '4.4': {
            title: 'Effective Dates',
            section: 'Purpose & Scope',
            helpBanner: {
                title: 'Effective Dates',
                content: 'Establish the effective dates for all value opinions.'
            },
            fields: [
                { type: 'date', label: 'Date of Inspection', required: true },
                { type: 'date', label: 'Effective Date of "AS IS" Value', required: true },
                { type: 'date', label: 'Effective Date of "AS COMPLETED" Value', note: 'Future date validation' },
                { type: 'date', label: 'Effective Date of "AS STABILIZED" Value', note: 'Future date validation' },
                { type: 'date', label: 'Date of Report', required: true }
            ],
            help: {
                about: 'Effective dates are critical for establishing when value opinions apply. Different value scenarios may have different effective dates.',
                uspap: 'Standards Rule 2-2(a)(viii) requires the effective date of the appraisal.',
                definitions: [
                    { term: 'Effective Date', definition: 'The date as of which the opinion of value applies' },
                    { term: 'Date of Inspection', definition: 'The date the appraiser physically inspected the property' },
                    { term: 'Date of Report', definition: 'The date the report is completed and signed' }
                ],
                bestPractices: [
                    'Ensure dates are logical and sequential',
                    'Document reason for retrospective or prospective dates',
                    'Match effective dates to value scenarios'
                ]
            }
        },
        '4.5': {
            title: 'Assumptions & Conditions',
            section: 'Purpose & Scope',
            helpBanner: {
                title: 'Assumptions',
                content: 'Document any extraordinary assumptions or hypothetical conditions.'
            },
            fields: [
                { type: 'heading', label: 'Extraordinary Assumptions', highlight: true },
                { type: 'textarea', label: 'Extraordinary Assumption Definition', rows: 2, readonly: true, defaultValue: 'An assumption, directly related to a specific assignment, as of the effective date of the assignment results, which, if found to be false, could alter the appraiser\'s opinions or conclusions.' },
                { type: 'checkbox', label: 'Improvement Completion Assumption' },
                { type: 'date', label: 'Expected Completion Date' },
                { type: 'textarea', label: 'Completion Description', rows: 3 },
                { type: 'checkbox', label: 'Platting/Re-platting Assumption' },
                { type: 'textarea', label: 'Platting Description', rows: 3 },
                { type: 'heading', label: 'Hypothetical Conditions', highlight: true },
                { type: 'textarea', label: 'Hypothetical Condition Definition', rows: 2, readonly: true, defaultValue: 'A condition, directly related to a specific assignment, which is contrary to what is known by the appraiser to exist on the effective date of the assignment results, but is used for the purpose of analysis.' },
                { type: 'checkbox', label: 'No Hypothetical Conditions' },
                { type: 'textarea', label: 'Hypothetical Conditions (if applicable)', rows: 4 }
            ],
            help: {
                about: 'Assumptions and conditions must be clearly stated to avoid misunderstandings. Extraordinary assumptions and hypothetical conditions require special disclosure.',
                uspap: 'Standards Rule 2-2(a)(x) requires disclosure of extraordinary assumptions and hypothetical conditions.',
                definitions: [
                    { term: 'Extraordinary Assumption', definition: 'An assumption that if found to be false could alter opinions or conclusions' },
                    { term: 'Hypothetical Condition', definition: 'A condition contrary to known facts used for analysis purposes' }
                ],
                bestPractices: [
                    'Clearly identify each assumption',
                    'Explain why assumption is necessary',
                    'Disclose potential impact on value'
                ]
            }
        },
        '5.1': {
            title: 'Development Process',
            section: 'Development & Reporting Process',
            helpBanner: {
                title: 'Appraisal Process',
                content: 'Document the appraisal development and reporting process.'
            },
            fields: [
                { type: 'heading', label: 'Inspection Details', highlight: true },
                { type: 'checkbox', label: 'Site Inspected' },
                { type: 'checkbox', label: 'Plans Reviewed' },
                { type: 'checkbox', label: 'Costs Reviewed' },
                { type: 'checkbox', label: 'Specifications Reviewed' },
                { type: 'checkbox', label: 'Broker Interviews Conducted' },
                { type: 'heading', label: 'Data Gathering', highlight: true },
                { type: 'checkbox', label: 'Land Sales Researched' },
                { type: 'checkbox', label: 'Improved Sales Researched' },
                { type: 'checkbox', label: 'Rental Survey Conducted' },
                { type: 'text', label: 'Survey Location/Area' },
                { type: 'heading', label: 'Approaches Used', highlight: true },
                { type: 'checkbox', label: 'Sales Comparison (As Is)' },
                { type: 'checkbox', label: 'Cost Approach (As Completed)' },
                { type: 'checkbox', label: 'Sales Comparison (As Completed)' },
                { type: 'checkbox', label: 'Income Approach (As Stabilized)' },
                { type: 'checkbox', label: 'Sales Comparison (Remainder)' },
                { type: 'select', label: 'Income Capitalization Method', options: ['Direct Capitalization', 'DCF (Discounted Cash Flow)', 'Other'] }
            ],
            help: {
                about: 'The development process section explains how the appraisal was conducted, including inspection methods, data sources, and approaches applied.',
                uspap: 'Standards Rule 2-2(a)(ix) requires a summary of the information analyzed, the appraisal methods and techniques employed, and the reasoning that supports the analyses, opinions, and conclusions.',
                definitions: [
                    { term: 'Development Process', definition: 'The steps taken to gather and analyze data to form an opinion of value' },
                    { term: 'Reporting Process', definition: 'The communication of the appraisal and its results' }
                ],
                bestPractices: [
                    'Document all inspection activities',
                    'List all data sources',
                    'Explain approach selection rationale'
                ]
            }
        },
        '6.1': {
            title: 'City/County Overview',
            section: 'General Area Analysis',
            helpBanner: {
                title: 'Area Analysis',
                content: 'Provide an overview of the city and county where the property is located.'
            },
            fields: [
                { type: 'heading', label: 'Location Description', highlight: true },
                { type: 'text', label: 'City', required: true },
                { type: 'text', label: 'County', required: true },
                { type: 'text', label: 'State', required: true },
                { type: 'textarea', label: 'Geographic Position', rows: 3, placeholder: 'Describe location relative to major cities and landmarks' },
                { type: 'text', label: 'Distance to Major Cities', placeholder: 'e.g., 25 miles north of Denver' },
                { type: 'heading', label: 'Population Statistics', highlight: true },
                { type: 'number', label: 'Current Year', required: true },
                { type: 'number', label: 'Current Population', required: true },
                { type: 'number', label: 'Base Year' },
                { type: 'number', label: 'Base Population' },
                { type: 'number', label: 'Growth Percentage', readonly: true, note: 'Auto-calculated' },
                { type: 'number', label: 'County Population' },
                { type: 'heading', label: 'Economic Characteristics', highlight: true },
                { type: 'textarea', label: 'Economic Description', rows: 5, placeholder: 'Describe the local economy, major industries, and economic trends' },
                { type: 'textarea', label: 'Major Industries', rows: 3, placeholder: 'List major industries (one per line)' },
                { type: 'textarea', label: 'Key Employers', rows: 3, placeholder: 'List key employers (one per line)' },
                { type: 'heading', label: 'Notable Features', highlight: true },
                { type: 'textarea', label: 'Medical Facilities', rows: 2 },
                { type: 'textarea', label: 'Tourism', rows: 2 },
                { type: 'textarea', label: 'Other Notable Features', rows: 2 }
            ],
            help: {
                about: 'Area analysis provides context for understanding the property\'s market environment. It establishes the broader economic and demographic trends affecting property values.',
                uspap: 'Market area analysis is part of the scope of work necessary to produce credible assignment results.',
                definitions: [
                    { term: 'Market Area', definition: 'The geographic region from which a property draws its users, tenants, or buyers' },
                    { term: 'Economic Base', definition: 'The industries and employment sectors that drive the local economy' }
                ],
                bestPractices: [
                    'Use current, reliable data sources',
                    'Identify economic trends',
                    'Consider impact on subject property'
                ]
            }
        },
        '7.1': {
            title: 'Neighborhood Definition',
            section: 'Neighborhood Analysis',
            helpBanner: {
                title: 'Neighborhood',
                content: 'Define and describe the neighborhood characteristics.'
            },
            fields: [
                { type: 'heading', label: 'Neighborhood Boundaries', highlight: true },
                { type: 'text', label: 'North Boundary', required: true },
                { type: 'text', label: 'South Boundary', required: true },
                { type: 'text', label: 'East Boundary', required: true },
                { type: 'text', label: 'West Boundary', required: true },
                { type: 'file', label: 'Neighborhood Map Upload', accept: 'image/*,application/pdf' },
                { type: 'heading', label: 'Location Description', highlight: true },
                { type: 'text', label: 'Street/Address', required: true },
                { type: 'number', label: 'Distance from CBD (miles)', step: '0.1' },
                { type: 'select', label: 'Direction from CBD', options: ['North', 'South', 'East', 'West', 'Northeast', 'Northwest', 'Southeast', 'Southwest'] },
                { type: 'heading', label: 'Neighborhood Characteristics', highlight: true },
                { type: 'select', label: 'Development Stage', options: ['Developing', 'Fully Developed', 'Mixed', 'Declining', 'Revitalizing'] },
                { type: 'checkbox-group', label: 'Primary Uses', options: [
                    { label: 'Warehouse', description: '' },
                    { label: 'Light Industrial', description: '' },
                    { label: 'Retail', description: '' },
                    { label: 'Office', description: '' },
                    { label: 'Residential', description: '' },
                    { label: 'Other', description: '' }
                ]},
                { type: 'textarea', label: 'Neighborhood Description', rows: 5, placeholder: 'Provide a detailed description of the neighborhood' }
            ],
            help: {
                about: 'Neighborhood analysis helps understand the property\'s competitive environment and the factors that influence its value.',
                uspap: 'Neighborhood analysis is essential for understanding market conditions and comparable property selection.',
                definitions: [
                    { term: 'Neighborhood', definition: 'A group of complementary land uses; a congruous grouping of inhabitants, buildings, or business enterprises' },
                    { term: 'CBD', definition: 'Central Business District - the commercial and business center of a city' }
                ],
                bestPractices: [
                    'Define boundaries clearly',
                    'Identify development trends',
                    'Note competitive properties'
                ]
            }
        },
        '7.2': {
            title: 'Access & Infrastructure',
            section: 'Neighborhood Analysis',
            helpBanner: {
                title: 'Access',
                content: 'Document access routes and infrastructure.'
            },
            fields: [
                { type: 'heading', label: 'Primary Access Routes', highlight: true },
                { type: 'text', label: 'Primary Route 1', required: true },
                { type: 'text', label: 'Primary Route 2' },
                { type: 'text', label: 'Primary Route 3' },
                { type: 'text', label: 'Interstate Access', placeholder: 'Distance and access points' },
                { type: 'heading', label: 'Traffic Counts', highlight: true },
                { type: 'text', label: 'Location 1' },
                { type: 'number', label: 'Count (VPD)', placeholder: 'Vehicles Per Day' },
                { type: 'text', label: 'Location 2' },
                { type: 'number', label: 'Count (VPD)', placeholder: 'Vehicles Per Day' },
                { type: 'text', label: 'Traffic Data Source' },
                { type: 'date', label: 'Traffic Data Date' },
                { type: 'heading', label: 'Development Activity', highlight: true },
                { type: 'textarea', label: 'Recent Development', rows: 3, placeholder: 'Describe recent development activity' },
                { type: 'textarea', label: 'Planned Development', rows: 3, placeholder: 'Describe planned or proposed development' },
                { type: 'textarea', label: 'Infrastructure Improvements', rows: 3, placeholder: 'Describe infrastructure improvements' }
            ],
            help: {
                about: 'Access and infrastructure significantly impact property value, especially for commercial and industrial properties.',
                uspap: 'Access analysis is part of site and neighborhood analysis required for credible valuation.',
                definitions: [
                    { term: 'VPD', definition: 'Vehicles Per Day - a measure of traffic volume' },
                    { term: 'Infrastructure', definition: 'Basic physical systems including roads, utilities, and public services' }
                ],
                bestPractices: [
                    'Document all major access routes',
                    'Include traffic count data',
                    'Note planned improvements'
                ]
            }
        },
        '7.3': {
            title: 'Land Uses & Development',
            section: 'Neighborhood Analysis',
            helpBanner: {
                title: 'Land Uses',
                content: 'Analyze current and planned land uses in the area.'
            },
            fields: [
                { type: 'heading', label: 'Current Build-Out', highlight: true },
                { type: 'number', label: 'Build-Out Percentage', min: '0', max: '100', placeholder: '0-100' },
                { type: 'textarea', label: 'Build-Out Description', rows: 3 },
                { type: 'heading', label: 'Existing Land Uses', highlight: true },
                { type: 'textarea', label: 'Retail', rows: 2, placeholder: 'Describe retail uses and percentages' },
                { type: 'textarea', label: 'Industrial', rows: 2, placeholder: 'Describe industrial uses and percentages' },
                { type: 'textarea', label: 'Office', rows: 2, placeholder: 'Describe office uses and percentages' },
                { type: 'textarea', label: 'Residential', rows: 2, placeholder: 'Describe residential uses and percentages' },
                { type: 'textarea', label: 'Other', rows: 2, placeholder: 'Describe other uses and percentages' },
                { type: 'heading', label: 'Future Development', highlight: true },
                { type: 'textarea', label: 'Planned Land Uses', rows: 4, placeholder: 'Describe planned future development' },
                { type: 'textarea', label: 'Zoning Changes', rows: 3, placeholder: 'Note any planned or proposed zoning changes' }
            ],
            help: {
                about: 'Understanding land uses helps assess future development potential and market trends affecting the subject property.',
                uspap: 'Land use analysis is part of neighborhood and market analysis.',
                definitions: [
                    { term: 'Build-Out', definition: 'The extent to which an area has been developed relative to its capacity' },
                    { term: 'Land Use', definition: 'The employment of a site or holding to produce revenue or other benefits' }
                ],
                bestPractices: [
                    'Quantify land use percentages',
                    'Identify trends',
                    'Consider impact on subject'
                ]
            }
        },
        '8.1': {
            title: 'Detailed Site Description',
            section: 'Site Analysis',
            helpBanner: {
                title: 'Site Description',
                content: 'Provide detailed information about the subject site.'
            },
            fields: [
                { type: 'select', label: 'Proposed site plan', required: true, options: ['Public record', 'Site Inspection', 'Type my own'], placeholder: 'Select source' },
                { type: 'textarea', label: 'Location:', rows: 5, required: true, placeholder: 'Provide a comprehensive description of the site' },
                { type: 'text', label: 'Site Address', required: true },
                { type: 'text', label: 'Legal Description', required: true },
                { type: 'text', label: 'Tax Parcel ID(s)', required: true },
                { type: 'repeatable-group', label: 'Proposed Plat / Land Parcels', addButtonText: '+ Add Land Parcel', showTotals: true, fields: [
                    { type: 'text', label: 'Parcel Name/ID', placeholder: 'e.g., Lot 3A', required: true },
                    { type: 'number', label: 'Acres', step: '0.001', required: true },
                    { type: 'number', label: 'Square Feet', readonly: true, note: 'Auto-calculated from acres' }
                ]},
                { type: 'textarea', label: 'Note to reader:', rows: 4, placeholder: 'Add any notes about the proposed improvements, phasing, or land allocation (e.g., "The proposed improvements are to be located on the eastmost portion of Lot 5A...")' },
                { type: 'select-or-custom', label: 'Site Shape', options: ['Irregular - see plat in addenda', 'Rectangular - see plat in addenda', 'Approximately Rectangular - see plat in addenda', 'Type My Own'] },
                { type: 'select-or-custom', label: 'Topography', options: ['Level', 'Gently Sloping', 'Moderately Sloping', 'Steeply Sloping', 'Rolling', 'Type My Own'] },
                { type: 'select-or-custom', label: 'Flood Hazard', options: ['The subject is not located in an identified flood hazard area', 'The subject is located in an identified flood hazard area', 'Type My Own'] }
            ],
            help: {
                about: 'Site description documents the physical characteristics of the property, which are fundamental to understanding its utility and value.',
                uspap: 'Standards Rule 2-2(a)(iii) requires identification of the real estate and property characteristics relevant to the assignment.',
                definitions: [
                    { term: 'Site', definition: 'Land that is improved so that it is ready to be used for a specific purpose' },
                    { term: 'Topography', definition: 'The contour or surface features of land' }
                ],
                bestPractices: [
                    'Describe site comprehensively',
                    'Note any unusual features',
                    'Consider impact on development'
                ]
            }
        },
        '8.2': {
            title: 'Site Dimensions & Characteristics',
            section: 'Site Analysis',
            helpBanner: {
                title: 'Site Characteristics',
                content: 'Document frontages, improvements, easements, and zoning information.'
            },
            fields: [
                { type: 'textarea', label: 'Frontages:', rows: 2, placeholder: 'Describe all street frontages (e.g., 475 51\' – South 30th Street West)' },
                { type: 'textarea', label: 'Improvmnts:', rows: 8, placeholder: 'Describe proposed or existing improvements, building areas, site coverage ratios, parking, landscaping, etc.' },
                { type: 'select-or-custom', label: 'Easements:', options: ['There are no existing or proposed easements that adversely impact value', 'Type My Own'] },
                { type: 'select-or-custom', label: 'Zoning:', options: ['Light Industrial', 'Heavy Industrial', 'Commercial', 'Residential', 'Mixed-Use', 'CBD', 'Type My Own'], note: 'Future: Will integrate with Cotality API for automatic zoning data' },
                { type: 'textarea', label: 'Zoning Description:', rows: 6, placeholder: 'Describe the zoning classification, permitted uses, and confirm the proposed use is allowed' },
                { type: 'textarea', label: 'Utilities:', rows: 3, placeholder: 'Describe utility availability and connections (e.g., Upon completion of construction, all city services will be extended to the site)' },
                { type: 'textarea', label: 'Access:', rows: 8, placeholder: 'Describe access via roadways, including road names, conditions, traffic patterns, improvements, and intersection controls' },
                { type: 'textarea', label: 'Topography:', rows: 4, placeholder: 'Describe site topography, grade, and landscaping (e.g., The subject is level and at street grade...)' }
            ],
            help: {
                about: 'This section documents critical site characteristics including frontages, improvements, easements, zoning, utilities, access, and topography. These factors significantly impact property value and development potential.',
                uspap: 'Standards Rule 2-2(a)(iii) requires identification of all real estate characteristics relevant to the assignment, including access, utilities, zoning, and physical attributes.',
                definitions: [
                    { term: 'Frontage', definition: 'The linear extent of a property along a street or waterway' },
                    { term: 'Site Coverage Ratio', definition: 'The percentage of the site covered by building footprints' },
                    { term: 'Easement', definition: 'A right to use another\'s property for a specific purpose' },
                    { term: 'Zoning', definition: 'Government regulation of land use and development' },
                    { term: 'Permitted Use', definition: 'Uses allowed under current zoning classification' },
                    { term: 'Principal Arterial', definition: 'A major roadway designed to move large volumes of traffic' }
                ],
                bestPractices: [
                    'Verify all frontages and access routes',
                    'Confirm zoning permits intended use',
                    'Document all easements that impact value',
                    'Verify utility availability and capacity',
                    'Note road conditions and traffic patterns',
                    'Document site topography and drainage',
                    'Calculate site coverage ratios for improvements'
                ]
            }
        },
        '8.3': {
            title: 'Adjacent Properties',
            section: 'Site Analysis',
            helpBanner: {
                title: 'Adjacent Properties',
                content: 'Document the properties adjacent to the subject in all four directions.'
            },
            fields: [
                { type: 'textarea', label: 'North:', rows: 2, placeholder: 'Describe property to the north (e.g., Vacant commercial development land)' },
                { type: 'textarea', label: 'South:', rows: 2, placeholder: 'Describe property to the south (e.g., Industrial yard space)' },
                { type: 'textarea', label: 'East:', rows: 2, placeholder: 'Describe property to the east (e.g., Across South 30th Street West is industrial yard space)' },
                { type: 'textarea', label: 'West:', rows: 2, placeholder: 'Describe property to the west (e.g., Industrial yard space)' }
            ],
            help: {
                about: 'Adjacent properties can significantly impact the subject property\'s value, marketability, and highest and best use.',
                uspap: 'Description of surrounding properties is part of neighborhood analysis and helps establish market context.',
                definitions: [
                    { term: 'Adjacent Properties', definition: 'Properties that share a boundary or are immediately across a street from the subject' },
                    { term: 'External Obsolescence', definition: 'Loss in value caused by factors outside the property boundaries' }
                ],
                bestPractices: [
                    'Note all four directions',
                    'Identify compatible/incompatible uses',
                    'Consider impact on subject value'
                ]
            }
        },
        '8.4': {
            title: 'Environmental Conditions',
            section: 'Site Analysis',
            helpBanner: {
                title: 'Environmental Conditions',
                content: 'Document flood hazard status and hazardous materials conditions.'
            },
            fields: [
                { type: 'editable-select', label: 'Flood Hazard:', options: ['The subject is not located in an identified flood hazard area', 'The subject is located in an identified flood hazard area'], placeholder: 'Select and edit as needed', note: 'Select a template, then edit the text to customize (e.g., add "along a flood fringe")' },
                { type: 'collapsible-boilerplate', label: 'Hazardous or Toxic Materials:', content: 'A visual inspection of the site did not reveal any unusual soil conditions or hazardous waste materials that may be in or under the site. We are not aware of a Phase I or under the site Environmental Assessment that has been made of the site; therefore, we cannot comment on actual soil conditions or the existence of hazardous wastes, if any, on/under the site. We are not experts in detecting hazardous materials that may be present on/under the site, which materials may affect the value of the property.\n\nThe value estimate is predicated upon the assumption there is no such material on the property. Any such environmental risk discovered at a later date may require a revised estimate of value that may or may not be simply a reduction of the value by the estimated cost to cure the environmental condition. Properties known to have environmental risk may also carry a stigma in the marketplace that may or may not affect the value. If future soil tests should reveal the existence of any unusual soil conditions or hazardous waste, we reserve the right to review and adjust this appraisal accordingly.' }
            ],
            help: {
                about: 'Environmental conditions, particularly flood hazard and hazardous materials, can have significant impacts on property value, insurability, and marketability.',
                uspap: 'Standards Rule 1-4(e) requires appraisers to identify environmental conditions that affect the property. If specialized expertise is needed, the appraiser must disclose limitations.',
                definitions: [
                    { term: 'Flood Hazard Area', definition: 'Areas identified by FEMA as having flood risk, requiring flood insurance' },
                    { term: 'Flood Fringe', definition: 'The portion of the floodplain outside the floodway' },
                    { term: 'Phase I ESA', definition: 'Environmental Site Assessment to identify potential contamination' },
                    { term: 'Hazardous Materials', definition: 'Substances that pose risk to health, safety, or the environment' }
                ],
                bestPractices: [
                    'Verify flood zone with FEMA maps',
                    'Note any environmental assessments',
                    'Disclose limitations of visual inspection',
                    'Include standard environmental disclaimers',
                    'Recommend Phase I ESA if concerns exist'
                ]
            }
        },
        '9.1': {
            title: 'Description of Improvements',
            section: 'Improvement Analysis',
            helpBanner: {
                title: 'Improvement Analysis Overview',
                content: 'Provide a comprehensive description of all improvements on the subject property.'
            },
            fields: [
                { type: 'textarea', label: 'Overall Property Description', rows: 6, required: true, placeholder: 'e.g., The subject is to be improved with three light industrial buildings, to be Phase 1 of a 5 Phase industrial park. These buildings are referred to as Buildings #1478, #1482, and #1486...', note: 'Provide a comprehensive narrative description of all improvements' },
                { type: 'number', label: 'Number of Buildings', required: true, min: 1, placeholder: '3', note: 'This will configure the building tabs in the next steps' },
                { type: 'text', label: 'Combined Total Square Footage', readonly: true, placeholder: 'Auto-calculated from building data', note: 'This value will be calculated automatically based on individual building areas entered in Section 9.2' }
            ],
            help: {
                about: 'The Improvement Analysis section is critical for establishing the condition, quality, and contributory value of all structures on the property. This overview provides context for the detailed building-by-building analysis that follows.',
                uspap: 'Standards Rule 1-4(a) requires appraisers to identify the real estate and personal property characteristics relevant to the assignment. Standards Rule 2-2(a)(iii) requires identification of physical and economic property characteristics relevant to the assignment.',
                definitions: [
                    { term: 'Improvements', definition: 'Buildings and other structures permanently attached to the land' },
                    { term: 'Gross Building Area (GBA)', definition: 'Total floor area of a building measured from exterior walls, including all finished and unfinished areas' },
                    { term: 'Rentable Area', definition: 'The area for which tenants pay rent, typically excluding common areas in multi-tenant buildings' },
                    { term: 'Effective Age', definition: 'The age of a structure based on its condition and utility, which may differ from actual age' },
                    { term: 'Remaining Economic Life', definition: 'The estimated period over which improvements will continue to contribute to property value' }
                ],
                bestPractices: [
                    'Provide clear, detailed descriptions that paint a picture of the property',
                    'Use consistent terminology throughout the report',
                    'Note any unique or specialized features that affect value',
                    'Describe the property as it exists or will exist (if proposed construction)',
                    'Reference architectural plans or drawings when applicable',
                    'Be specific about unit configurations and mixed-use allocations'
                ]
            }
        },
        '9.2': {
            title: 'Building Configuration & Unit Mix',
            section: 'Improvement Analysis',
            helpBanner: {
                title: 'Building Configuration & Unit Mix',
                content: 'Configure each building and document the unit mix for properties with multiple units.'
            },
            customRender: true, // This step uses custom rendering for building tabs
            fields: [
                // This will be rendered with building tabs interface
                { type: 'building-tabs-header' },
                { type: 'text', label: 'Building Name/ID', required: true, id: 'building-name-input', placeholder: 'e.g., Building #1478' },
                { type: 'text', label: 'Location on Site', id: 'building-location-input', placeholder: 'e.g., Northern portion of Lot 5A' },
                { 
                    type: 'editable-table',
                    label: 'Unit Mix',
                    id: 'unit-mix-table',
                    columns: [
                        { key: 'unit', label: 'Unit #', type: 'text', width: '80px' },
                        { key: 'unitSize', label: 'Unit Size SF', type: 'number', width: '120px' },
                        { key: 'officeSF', label: 'Office SF', type: 'number', width: '110px' },
                        { key: 'shopSF', label: 'Shop/Mezz. SF', type: 'number', width: '130px' },
                        { key: 'pctShop', label: '% Shop', type: 'calculated', formula: '(shopSF/unitSize)*100', format: 'percent', width: '90px' },
                        { key: 'pctOffice', label: '% Office', type: 'calculated', formula: '(officeSF/unitSize)*100', format: 'percent', width: '90px' },
                        { key: 'restrooms', label: 'Restrooms', type: 'text', width: '180px' },
                        { key: 'ohDoors', label: '# O.H. Doors', type: 'number', width: '110px' }
                    ],
                    showTotals: true,
                    totalRow: {
                        unitSize: 'sum',
                        officeSF: 'sum',
                        shopSF: 'sum',
                        pctShop: 'weighted-avg',
                        pctOffice: 'weighted-avg'
                    },
                    addRowText: '+ Add Unit',
                    minRows: 1
                }
            ],
            help: {
                about: 'Unit mix analysis is essential for understanding how space is allocated within each building. For commercial/industrial properties, this shows the balance between shop space, office space, and support areas. This information is critical for the income approach and for comparing the subject to market comps.',
                uspap: 'Standards Rule 1-4(a) requires identification of property characteristics relevant to the type and definition of value and intended use of the appraisal. Unit mix directly impacts both market value and income potential.',
                definitions: [
                    { term: 'Unit Mix', definition: 'The variety and distribution of different unit types and sizes within a building or property' },
                    { term: 'Shop Space', definition: 'Warehouse, production, or storage area typically with concrete floors, overhead doors, and minimal finish' },
                    { term: 'Office Space', definition: 'Finished interior space with HVAC, lighting, and amenities suitable for office use' },
                    { term: 'Mezzanine', definition: 'An intermediate floor between main floors, often used for additional office or storage space' },
                    { term: 'Overhead (O.H.) Doors', definition: 'Large doors (typically 10\'+ high) that roll up vertically, essential for warehouse/industrial access' }
                ],
                bestPractices: [
                    'Verify unit counts and sizes against architectural drawings',
                    'Calculate space allocations as percentages for comparison purposes',
                    'Note unique features like mezzanines, extra restrooms, or specialized finishes',
                    'Distinguish between gross area and rentable area where applicable',
                    'For multi-tenant buildings, document each unit separately',
                    'Ensure totals match the Gross Building Area stated in Section 9.1'
                ]
            }
        },
        '9.3': {
            title: 'Construction Details',
            section: 'Improvement Analysis',
            helpBanner: {
                title: 'Construction Details',
                content: 'Document comprehensive construction details for each building.'
            },
            customRender: true,
            fields: [
                { type: 'building-tabs-header' },
                { 
                    type: 'accordion-section',
                    sections: [
                        {
                            id: 'general',
                            title: 'General',
                            icon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                            expanded: true,
                            fields: [
                                { type: 'text', label: 'Property Name', placeholder: 'Auto-filled from building ID', readonly: true },
                                { type: 'select', label: 'Property Type', required: true, options: ['Light Industrial', 'Heavy Industrial', 'Office', 'Retail', 'Warehouse', 'Mixed-Use', 'Other'] },
                                { type: 'text', label: 'Property Sub-Type', placeholder: 'e.g., Multiple shop units' },
                                { type: 'select', label: 'Occupancy', options: ['Owner Occupied', 'Tenant Occupied', 'Proposed Tenant Occupied', 'Vacant'] },
                                { type: 'number', label: 'Number of Buildings', placeholder: '1' },
                                { type: 'text', label: 'Stories', placeholder: 'e.g., 1 story w/mezzanine' },
                                { type: 'number', label: 'Year Built', required: true, min: 1800, max: 2050 },
                                { type: 'text', label: 'Year Remodeled', placeholder: 'NA or year' },
                                { type: 'text', label: 'Effective Age', placeholder: 'e.g., New, 5 years' },
                                { type: 'text', label: 'Remaining Economic Life', placeholder: 'e.g., 40 Years' },
                                { type: 'select', label: 'Basement', options: ['Full', 'Partial', 'Crawl Space', 'Slab', 'N/A'] },
                                { type: 'text', label: 'Construction Type', placeholder: 'e.g., Pre-engineered steel' },
                                { type: 'select', label: 'Construction Quality', options: ['Excellent', 'Good', 'Average', 'Fair', 'Poor'] },
                                { type: 'select', label: 'Condition', options: ['New', 'Excellent', 'Good', 'Average', 'Fair', 'Poor'] },
                                { type: 'text', label: 'Sidewall Height', placeholder: 'e.g., 16\' - 21.5\'' }
                            ]
                        },
                        {
                            id: 'exterior',
                            title: 'Exterior',
                            icon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>',
                            expanded: false,
                            fields: [
                                { type: 'textarea', label: 'Foundation/Floor', rows: 2, placeholder: 'e.g., Concrete monolithic slab on grade' },
                                { type: 'text', label: 'Roof', placeholder: 'e.g., Metal' },
                                { type: 'textarea', label: 'Exterior Walls', rows: 2, placeholder: 'e.g., Steel siding' }
                            ]
                        },
                        {
                            id: 'interior',
                            title: 'Interior Finishes',
                            icon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>',
                            expanded: false,
                            fields: [
                                { type: 'textarea', label: 'Ceilings', rows: 3, placeholder: 'e.g., Office and restrooms to have painted drywall. Shop to have metal liner panels.' },
                                { type: 'textarea', label: 'Flooring', rows: 3, placeholder: 'e.g., Mixture of concrete, sealed concrete, and luxury vinyl plank (office area)' },
                                { type: 'textarea', label: 'Walls', rows: 4, placeholder: 'e.g., Shop walls to have 29 gauge white liner paneling. Office walls to have painted drywall.' },
                                { type: 'textarea', label: 'Doors', rows: 3, placeholder: 'e.g., All interior and exterior doors to be hollow metal' },
                                { type: 'textarea', label: 'Windows', rows: 2, placeholder: 'e.g., Various sizes of vinyl framed windows' }
                            ]
                        },
                        {
                            id: 'mechanical',
                            title: 'Mechanical Systems',
                            icon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>',
                            expanded: false,
                            fields: [
                                { type: 'textarea', label: 'Electrical', rows: 3, placeholder: 'e.g., Single Phase 200 Amp Services; (Assumed to be adequate)' },
                                { type: 'textarea', label: 'Heating/Cooling', rows: 3, placeholder: 'e.g., Suspended gas fired unit heaters in shop. HVAC heating and cooling for offices.' },
                                { type: 'textarea', label: 'Plumbing', rows: 4, placeholder: 'e.g., Each unit to feature one restroom with 1 toilet/1 sink. Utility sink in shop area.' },
                                { type: 'select', label: 'Sprinkler System', options: ['Yes', 'No', 'Partial'] },
                                { type: 'textarea', label: 'Sprinkler Details', rows: 2, placeholder: 'Describe sprinkler coverage' },
                                { type: 'select', label: 'Elevators', options: ['Yes', 'No'] },
                                { type: 'text', label: 'Number of Elevators', placeholder: '0' }
                            ]
                        },
                        {
                            id: 'site',
                            title: 'Site Improvements',
                            icon: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path></svg>',
                            expanded: false,
                            fields: [
                                { type: 'textarea', label: 'Asphalt', rows: 4, placeholder: 'Describe paved approach, driving lanes, and parking (e.g., 39 parking spaces along north and east sides, 8 spaces west side, 11 spaces along east perimeter)' },
                                { type: 'textarea', label: 'Concrete', rows: 4, placeholder: 'Describe concrete sidewalks, curbing, and pads (e.g., Concrete sidewalk along east perimeter, curbing, dumpster pad at southwest corner)' },
                                { type: 'textarea', label: 'Landscaping', rows: 4, placeholder: 'Describe landscaping features (e.g., Good quality landscaping with irrigated sod, trees, shrubs, river rock, and crushed limestone. Mailboxes and dumpster enclosures included)' }
                            ]
                        }
                    ]
                }
            ],
            help: {
                about: 'Comprehensive construction details are essential for accurate cost approach calculations, condition assessment, and comparison to market properties. These details form the foundation for depreciation analysis and help support the final value conclusion.',
                uspap: 'Standards Rule 1-4(b) requires analysis of improvements that are relevant to the assignment. Standards Rule 2-2(a)(iii) requires a description of improvements that is adequate for the intended use.',
                definitions: [
                    { term: 'Effective Age', definition: 'The age indicated by the condition and utility of a structure, which may differ from chronological age' },
                    { term: 'Remaining Economic Life', definition: 'The estimated period during which improvements will contribute to property value' },
                    { term: 'Construction Quality', definition: 'The overall quality of materials and workmanship in the structure' },
                    { term: 'Condition', definition: 'The current physical state of the improvements considering maintenance, wear and tear, and repairs' },
                    { term: 'Sidewall Height', definition: 'The vertical distance from floor to eave in warehouse/industrial buildings (clear height to bottom of beams may differ)' }
                ],
                bestPractices: [
                    'Be specific and detailed - vague descriptions undermine credibility',
                    'Cross-reference architectural drawings and specifications when available',
                    'Distinguish between proposed construction and as-built conditions',
                    'Note any non-conforming or unique features',
                    'Document energy efficiency features (insulation, HVAC type, windows)',
                    'Effective age should reflect actual condition, not just years since construction',
                    'Site improvements add value and should be thoroughly documented'
                ]
            }
        },
        '9.4': {
            title: 'Building Summary & Validation',
            section: 'Improvement Analysis',
            helpBanner: {
                title: 'Building Summary & Validation',
                content: 'Review and validate all building data before proceeding.'
            },
            customRender: true,
            fields: [
                { type: 'summary-validation' }
            ],
            help: {
                about: 'This summary screen allows you to review all building data entered in the previous steps. Ensure all required fields are complete, calculations are correct, and data is consistent across all buildings before proceeding to the next section of the appraisal.',
                uspap: 'Standards Rule 2-2(a) requires the appraiser to clearly and accurately set forth the appraisal in a manner that will not be misleading. Reviewing data for completeness and consistency helps ensure a credible report.',
                definitions: [
                    { term: 'Data Validation', definition: 'The process of verifying that data is complete, accurate, and consistent' },
                    { term: 'Combined SF', definition: 'Total square footage of all buildings on the property' },
                    { term: 'Unit Mix Balance', definition: 'The distribution of space types (shop vs office) across all units' }
                ],
                bestPractices: [
                    'Verify that combined SF matches site analysis data',
                    'Check that unit mix totals match building totals',
                    'Ensure all required construction details are complete',
                    'Review building names for consistency',
                    'Confirm year built and condition assessments are reasonable',
                    'Use this screen as a final quality check before moving forward'
                ]
            }
        },
        '10.1': {
            title: 'Property Tax Information',
            section: 'Taxes & Assessments',
            helpBanner: {
                title: 'Property Taxes',
                content: 'Document current property tax information.'
            },
            fields: [
                { type: 'heading', label: 'Current Assessment', highlight: true },
                { type: 'number', label: 'Tax Year', required: true },
                { type: 'currency', label: 'Assessed Land Value', required: true },
                { type: 'currency', label: 'Assessed Improvement Value', required: true },
                { type: 'currency', label: 'Total Assessed Value', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Tax Calculation', highlight: true },
                { type: 'number', label: 'Tax Rate (per $1,000)', step: '0.01', required: true },
                { type: 'currency', label: 'Annual Property Taxes', required: true },
                { type: 'text', label: 'Tax Authority', placeholder: 'County Assessor' },
                { type: 'heading', label: 'Special Assessments', highlight: true },
                { type: 'checkbox', label: 'Special Assessments Apply' },
                { type: 'textarea', label: 'Special Assessment Details', rows: 3, placeholder: 'Describe any special assessments or districts' },
                { type: 'currency', label: 'Annual Special Assessment Amount' },
                { type: 'heading', label: 'Tax History', highlight: true },
                { type: 'textarea', label: 'Prior Year Taxes', rows: 3, placeholder: 'Document prior year tax amounts and trends' }
            ],
            help: {
                about: 'Property taxes are an important operating expense consideration and must be accurately documented for income approach analysis.',
                uspap: 'Property tax information is necessary for expense analysis in income approach.',
                definitions: [
                    { term: 'Assessed Value', definition: 'The value placed on property by the tax assessor for tax purposes' },
                    { term: 'Mill Rate', definition: 'The tax rate expressed in tenths of a cent per dollar of assessed value' },
                    { term: 'Special Assessment', definition: 'A tax levied for a specific improvement benefiting the property' }
                ],
                bestPractices: [
                    'Verify current tax amounts',
                    'Note any appeals or changes',
                    'Consider impact on value'
                ]
            }
        },
        '11.1': {
            title: 'Current Ownership',
            section: 'Property Ownership & History',
            helpBanner: {
                title: 'Ownership',
                content: 'Document current ownership and transaction history.'
            },
            fields: [
                { type: 'heading', label: 'Current Owner', highlight: true },
                { type: 'text', label: 'Owner Name', required: true },
                { type: 'select', label: 'Entity Type', options: ['Individual', 'LLC', 'Corporation', 'Partnership', 'Trust', 'Other'] },
                { type: 'date', label: 'Date of Acquisition', required: true },
                { type: 'currency', label: 'Purchase Price' },
                { type: 'text', label: 'Grantor (Seller)' },
                { type: 'text', label: 'Recording Information', placeholder: 'Book/Page or Reception Number' },
                { type: 'heading', label: 'Transaction History (3 Years)', highlight: true },
                { type: 'textarea', label: 'Prior Sales', rows: 4, placeholder: 'Document any sales or transfers within the past 3 years' },
                { type: 'checkbox', label: 'No sales in past 3 years' },
                { type: 'heading', label: 'Listing History', highlight: true },
                { type: 'checkbox', label: 'Currently Listed for Sale' },
                { type: 'date', label: 'Listing Date' },
                { type: 'currency', label: 'Listing Price' },
                { type: 'text', label: 'Listing Agent/Broker' },
                { type: 'textarea', label: 'Marketing History', rows: 3, placeholder: 'Document any prior listings or marketing efforts' }
            ],
            help: {
                about: 'Ownership information helps understand the property\'s history and may provide evidence of market value.',
                uspap: 'Standards Rule 2-2(a)(vi) requires analysis of any current agreement of sale, option, or listing.',
                definitions: [
                    { term: 'Grantor', definition: 'The party transferring ownership (seller)' },
                    { term: 'Grantee', definition: 'The party receiving ownership (buyer)' },
                    { term: 'Arms-Length Transaction', definition: 'A transaction between unrelated parties, each acting in their own best interest' }
                ],
                bestPractices: [
                    'Verify ownership with title report',
                    'Document all recent sales',
                    'Note any non-arms-length transactions'
                ]
            }
        },
        '12.1': {
            title: 'Highest & Best Use - As Vacant',
            section: 'Highest and Best Use',
            helpBanner: {
                title: 'HBU As Vacant',
                content: 'Analyze highest and best use assuming the land is vacant.'
            },
            fields: [
                { type: 'heading', label: 'Four Tests of Highest and Best Use', highlight: true },
                { type: 'heading', label: '1. Physically Possible' },
                { type: 'textarea', label: 'Physical Possibilities', rows: 3, required: true, placeholder: 'What uses are physically possible given size, shape, topography, and access?' },
                { type: 'heading', label: '2. Legally Permissible' },
                { type: 'textarea', label: 'Legal Possibilities', rows: 3, required: true, placeholder: 'What uses are allowed by zoning and other regulations?' },
                { type: 'heading', label: '3. Financially Feasible' },
                { type: 'textarea', label: 'Financial Feasibility', rows: 3, required: true, placeholder: 'Which legally permissible uses would generate a return?' },
                { type: 'heading', label: '4. Maximally Productive' },
                { type: 'textarea', label: 'Maximum Productivity', rows: 3, required: true, placeholder: 'Which feasible use produces the highest value?' },
                { type: 'heading', label: 'Conclusion', highlight: true },
                { type: 'textarea', label: 'Highest and Best Use As Vacant', rows: 4, required: true, placeholder: 'State the conclusion of highest and best use as if vacant' }
            ],
            help: {
                about: 'HBU analysis determines the most profitable use of the property and is fundamental to the valuation process.',
                uspap: 'Highest and best use analysis is required for most appraisals and must consider what is physically possible, legally permissible, financially feasible, and maximally productive.',
                definitions: [
                    { term: 'Highest and Best Use', definition: 'The reasonably probable use that results in the highest value' },
                    { term: 'As Vacant', definition: 'Analysis assuming the site is vacant and available for development' }
                ],
                bestPractices: [
                    'Apply all four tests',
                    'Support with market data',
                    'Consider market trends'
                ]
            }
        },
        '12.2': {
            title: 'Highest & Best Use - As Improved',
            section: 'Highest and Best Use',
            helpBanner: {
                title: 'HBU As Improved',
                content: 'Analyze highest and best use considering existing improvements.'
            },
            fields: [
                { type: 'heading', label: 'As Improved Analysis', highlight: true },
                { type: 'textarea', label: 'Current Use Description', rows: 3, required: true, placeholder: 'Describe the current use of the property' },
                { type: 'select', label: 'Is Current Use the Highest and Best Use?', required: true, options: ['Yes', 'No', 'Uncertain'] },
                { type: 'textarea', label: 'Analysis', rows: 5, required: true, placeholder: 'Analyze whether the existing improvements represent the highest and best use' },
                { type: 'heading', label: 'Alternative Use Consideration', highlight: true },
                { type: 'textarea', label: 'Alternative Uses Considered', rows: 3, placeholder: 'Discuss any alternative uses considered' },
                { type: 'heading', label: 'Conclusion', highlight: true },
                { type: 'textarea', label: 'Highest and Best Use As Improved', rows: 4, required: true, placeholder: 'State the conclusion of highest and best use as improved' },
                { type: 'checkbox', label: 'Improvements contribute to land value' },
                { type: 'checkbox', label: 'Improvements should be retained' },
                { type: 'checkbox', label: 'Improvements should be modified' },
                { type: 'checkbox', label: 'Improvements should be demolished' }
            ],
            help: {
                about: 'HBU as improved considers the property\'s current state and determines whether the existing improvements should be retained, modified, or removed.',
                uspap: 'As improved analysis determines whether existing improvements contribute to property value.',
                definitions: [
                    { term: 'As Improved', definition: 'Analysis considering the property in its current improved condition' },
                    { term: 'Contributory Value', definition: 'The amount improvements add to property value' }
                ],
                bestPractices: [
                    'Compare to as vacant conclusion',
                    'Consider renovation potential',
                    'Assess contributory value'
                ]
            }
        },
        '13.1': {
            title: 'Land Valuation',
            section: 'Cost Approach',
            visibility: { approaches: ['cost'] },
            helpBanner: {
                title: 'Land Value',
                content: 'Estimate the value of the land using appropriate methods.'
            },
            fields: [
                { type: 'heading', label: 'Land Valuation Method', highlight: true },
                { type: 'select', label: 'Valuation Method', required: true, options: ['Sales Comparison', 'Allocation', 'Extraction', 'Subdivision Development', 'Ground Rent Capitalization'] },
                { type: 'heading', label: 'Comparable Land Sales', highlight: true },
                { type: 'text', label: 'Comparable 1 Address' },
                { type: 'currency', label: 'Sale Price' },
                { type: 'number', label: 'Size (Acres)', step: '0.01' },
                { type: 'currency', label: 'Price per Acre', readonly: true, note: 'Auto-calculated' },
                { type: 'date', label: 'Sale Date' },
                { type: 'text', label: 'Comparable 2 Address' },
                { type: 'currency', label: 'Sale Price' },
                { type: 'number', label: 'Size (Acres)', step: '0.01' },
                { type: 'currency', label: 'Price per Acre', readonly: true, note: 'Auto-calculated' },
                { type: 'date', label: 'Sale Date' },
                { type: 'text', label: 'Comparable 3 Address' },
                { type: 'currency', label: 'Sale Price' },
                { type: 'number', label: 'Size (Acres)', step: '0.01' },
                { type: 'currency', label: 'Price per Acre', readonly: true, note: 'Auto-calculated' },
                { type: 'date', label: 'Sale Date' },
                { type: 'heading', label: 'Land Value Conclusion', highlight: true },
                { type: 'number', label: 'Subject Site Size (Acres)', required: true, step: '0.01' },
                { type: 'currency', label: 'Concluded Price per Acre', required: true },
                { type: 'currency', label: 'Total Land Value', required: true, readonly: true, note: 'Auto-calculated' },
                { type: 'textarea', label: 'Land Value Rationale', rows: 4, required: true, placeholder: 'Explain the land valuation analysis and conclusion' }
            ],
            help: {
                about: 'Land value is the foundation of the cost approach and must be estimated as if vacant and available for development to its highest and best use.',
                uspap: 'Land value must be estimated separately in the cost approach.',
                definitions: [
                    { term: 'Sales Comparison', definition: 'Estimating land value by comparing to similar land sales' },
                    { term: 'Allocation', definition: 'Estimating land value as a percentage of total improved property value' },
                    { term: 'Extraction', definition: 'Estimating land value by subtracting depreciated improvement value from total sale price' }
                ],
                bestPractices: [
                    'Use comparable vacant land sales when possible',
                    'Adjust for differences in size, location, and zoning',
                    'Support conclusion with market data'
                ]
            }
        },
        '13.2': {
            title: 'Improvement Valuation',
            section: 'Cost Approach',
            visibility: { approaches: ['cost'], propertyTypes: ['commercial', 'residential'] },
            helpBanner: {
                title: 'Replacement Cost',
                content: 'Estimate the cost to replace improvements new.'
            },
            fields: [
                { type: 'heading', label: 'Cost Estimation Method', highlight: true },
                { type: 'select', label: 'Cost Approach Type', required: true, options: ['Replacement Cost New', 'Reproduction Cost New'] },
                { type: 'select', label: 'Cost Estimation Method', required: true, options: ['Comparative Unit Method', 'Unit-in-Place Method', 'Quantity Survey Method', 'Cost Service (Marshall & Swift, etc.)'] },
                { type: 'heading', label: 'Building Costs', highlight: true },
                { type: 'number', label: 'Gross Building Area (SF)', required: true },
                { type: 'currency', label: 'Base Cost per SF', required: true },
                { type: 'currency', label: 'Base Building Cost', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Cost Multipliers & Adjustments', highlight: true },
                { type: 'number', label: 'Current Cost Multiplier', step: '0.01', defaultValue: '1.00' },
                { type: 'number', label: 'Local Multiplier', step: '0.01', defaultValue: '1.00' },
                { type: 'currency', label: 'Adjusted Building Cost', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Additional Costs', highlight: true },
                { type: 'currency', label: 'Site Improvements (Paving, Landscaping)', required: true },
                { type: 'currency', label: 'Architect/Engineering Fees' },
                { type: 'currency', label: 'Other Soft Costs' },
                { type: 'heading', label: 'Entrepreneurial Incentive', highlight: true },
                { type: 'number', label: 'Entrepreneurial Incentive (%)', step: '0.1', placeholder: 'Typically 10-20%' },
                { type: 'currency', label: 'Entrepreneurial Incentive Amount', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Total Replacement Cost New', highlight: true },
                { type: 'currency', label: 'Total RCN', required: true, readonly: true, note: 'Auto-calculated' }
            ],
            help: {
                about: 'Replacement cost estimates the cost to build new improvements with equivalent utility using current materials and standards.',
                uspap: 'Cost estimates must be credible and based on recognized cost data sources.',
                definitions: [
                    { term: 'Replacement Cost New', definition: 'Cost to construct improvements with equivalent utility using current materials and standards' },
                    { term: 'Reproduction Cost New', definition: 'Cost to construct an exact replica of the improvements' },
                    { term: 'Entrepreneurial Incentive', definition: 'The amount a developer expects to receive for their contribution to a project' }
                ],
                bestPractices: [
                    'Use current cost data',
                    'Include all direct and indirect costs',
                    'Apply appropriate multipliers'
                ]
            }
        },
        '13.3': {
            title: 'Depreciation',
            section: 'Cost Approach',
            visibility: { approaches: ['cost'], propertyTypes: ['commercial', 'residential'] },
            helpBanner: {
                title: 'Depreciation',
                content: 'Calculate all forms of depreciation: physical, functional, and external.'
            },
            fields: [
                { type: 'heading', label: 'Physical Deterioration', highlight: true },
                { type: 'heading', label: 'Curable Physical Deterioration' },
                { type: 'textarea', label: 'Items Requiring Repair', rows: 3, placeholder: 'List items needing repair (roof, HVAC, etc.)' },
                { type: 'currency', label: 'Cost to Cure', placeholder: 'Total repair costs' },
                { type: 'heading', label: 'Incurable Physical Deterioration - Short-Lived' },
                { type: 'textarea', label: 'Short-Lived Components', rows: 2, placeholder: 'Components with shorter life than structure (roof, HVAC, etc.)' },
                { type: 'number', label: 'Effective Age (years)' },
                { type: 'number', label: 'Total Economic Life (years)' },
                { type: 'currency', label: 'Short-Lived Component Cost' },
                { type: 'currency', label: 'Short-Lived Depreciation', readonly: true, note: 'Auto-calculated: (Effective Age / Total Life) × Cost' },
                { type: 'heading', label: 'Incurable Physical Deterioration - Long-Lived' },
                { type: 'number', label: 'Effective Age of Structure (years)', required: true },
                { type: 'number', label: 'Total Economic Life of Structure (years)', required: true },
                { type: 'currency', label: 'Long-Lived Component Cost', note: 'RCN minus short-lived components' },
                { type: 'currency', label: 'Long-Lived Depreciation', readonly: true, note: 'Auto-calculated: (Effective Age / Total Life) × Cost' },
                { type: 'heading', label: 'Functional Obsolescence', highlight: true },
                { type: 'heading', label: 'Curable Functional Obsolescence' },
                { type: 'textarea', label: 'Deficiencies', rows: 2, placeholder: 'Deficiencies that are economically feasible to cure' },
                { type: 'currency', label: 'Cost to Cure' },
                { type: 'heading', label: 'Incurable Functional Obsolescence' },
                { type: 'textarea', label: 'Deficiencies', rows: 2, placeholder: 'Deficiencies not economically feasible to cure (poor layout, inadequate ceiling height, etc.)' },
                { type: 'currency', label: 'Estimated Loss in Value' },
                { type: 'heading', label: 'External Obsolescence', highlight: true },
                { type: 'textarea', label: 'External Factors', rows: 3, placeholder: 'Factors outside the property causing loss in value (economic conditions, location, etc.)' },
                { type: 'currency', label: 'Estimated Loss in Value' },
                { type: 'heading', label: 'Total Depreciation', highlight: true },
                { type: 'currency', label: 'Total Physical Deterioration', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Total Functional Obsolescence', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Total External Obsolescence', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'TOTAL DEPRECIATION', required: true, readonly: true, note: 'Auto-calculated' }
            ],
            help: {
                about: 'Depreciation accounts for loss in value from all causes: physical deterioration, functional obsolescence, and external obsolescence.',
                uspap: 'All forms of depreciation must be considered and estimated in the cost approach.',
                definitions: [
                    { term: 'Physical Deterioration', definition: 'Loss in value due to wear and tear, deferred maintenance, and age' },
                    { term: 'Functional Obsolescence', definition: 'Loss in value due to design deficiencies or outdated features' },
                    { term: 'External Obsolescence', definition: 'Loss in value due to factors outside the property' },
                    { term: 'Curable', definition: 'Depreciation that is economically feasible to correct' },
                    { term: 'Incurable', definition: 'Depreciation that is not economically feasible to correct' }
                ],
                bestPractices: [
                    'Separate curable from incurable items',
                    'Use market data to support estimates',
                    'Consider all three types of depreciation'
                ]
            }
        },
        '13.4': {
            title: 'Cost Approach Conclusion',
            section: 'Cost Approach',
            visibility: { approaches: ['cost'] },
            helpBanner: {
                title: 'Cost Approach Value',
                content: 'Reconcile land value, replacement cost, and depreciation.'
            },
            fields: [
                { type: 'heading', label: 'Cost Approach Summary', highlight: true },
                { type: 'currency', label: 'Land Value', required: true, readonly: true, note: 'From Step 13.1' },
                { type: 'currency', label: 'Replacement Cost New', required: true, readonly: true, note: 'From Step 13.2' },
                { type: 'currency', label: 'Less: Total Depreciation', required: true, readonly: true, note: 'From Step 13.3' },
                { type: 'currency', label: 'Depreciated Improvement Value', readonly: true, note: 'Auto-calculated: RCN - Depreciation' },
                { type: 'currency', label: 'INDICATED VALUE BY COST APPROACH', required: true, readonly: true, note: 'Auto-calculated: Land + Depreciated Improvements' },
                { type: 'heading', label: 'Reconciliation', highlight: true },
                { type: 'textarea', label: 'Cost Approach Analysis', rows: 5, required: true, placeholder: 'Discuss the reliability and applicability of the cost approach for this property' },
                { type: 'select', label: 'Reliability Rating', options: ['Excellent', 'Good', 'Fair', 'Limited'] }
            ],
            help: {
                about: 'The cost approach indicates value through the cost to recreate the property: Land Value + (Replacement Cost New - Total Depreciation).',
                uspap: 'The cost approach conclusion must be clearly stated and supported.',
                definitions: [
                    { term: 'Cost Approach Formula', definition: 'Land Value + (Replacement Cost New - Total Depreciation) = Indicated Value' },
                    { term: 'Reconciliation', definition: 'The process of analyzing and weighing the value indications' }
                ],
                bestPractices: [
                    'Verify all calculations',
                    'Discuss reliability for property type',
                    'Compare to other approaches'
                ]
            }
        },
        '14.1': {
            title: 'Comparable Sales Search',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Comparable Sales',
                content: 'Search for and identify comparable sales.'
            },
            fields: [
                { type: 'heading', label: 'Search Criteria', highlight: true },
                { type: 'textarea', label: 'Search Parameters', rows: 3, placeholder: 'Describe the search criteria used (location, property type, size, date range, etc.)' },
                { type: 'text', label: 'Data Sources', placeholder: 'MLS, CoStar, public records, etc.' },
                { type: 'number', label: 'Number of Sales Reviewed' },
                { type: 'number', label: 'Number of Sales Selected', required: true, min: '3' },
                { type: 'heading', label: 'Selection Rationale', highlight: true },
                { type: 'textarea', label: 'Why These Comparables', rows: 4, required: true, placeholder: 'Explain why these specific sales were selected as the most comparable' }
            ],
            help: {
                about: 'Comparable sales provide market evidence of value. The selection of appropriate comparables is critical to the sales comparison approach.',
                uspap: 'Comparables must be similar to the subject and represent arms-length transactions.',
                definitions: [
                    { term: 'Comparable Sale', definition: 'A recently sold property similar to the subject property' },
                    { term: 'Arms-Length Transaction', definition: 'A transaction between unrelated parties, each acting in their own best interest' }
                ],
                bestPractices: [
                    'Use recent sales (within 12 months if possible)',
                    'Select similar properties',
                    'Verify sale details'
                ]
            }
        },
        '14.2': {
            title: 'Market Conditions Analysis',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Market Conditions',
                content: 'Analyze current market conditions and trends.'
            },
            fields: [
                { type: 'heading', label: 'Market Trends', highlight: true },
                { type: 'select', label: 'Overall Market Trend', required: true, options: ['Increasing', 'Stable', 'Declining', 'Mixed'] },
                { type: 'textarea', label: 'Market Trend Analysis', rows: 4, required: true, placeholder: 'Describe current market conditions, trends, and factors affecting values' },
                { type: 'heading', label: 'Supply & Demand', highlight: true },
                { type: 'select', label: 'Supply Level', options: ['Shortage', 'Balanced', 'Oversupply'] },
                { type: 'select', label: 'Demand Level', options: ['Strong', 'Moderate', 'Weak'] },
                { type: 'number', label: 'Average Days on Market' },
                { type: 'heading', label: 'Price Trends', highlight: true },
                { type: 'number', label: 'Price Change (% per month)', step: '0.1', placeholder: 'Positive for increasing, negative for declining' },
                { type: 'textarea', label: 'Price Trend Discussion', rows: 3, placeholder: 'Discuss price trends and support with data' }
            ],
            help: {
                about: 'Market conditions analysis helps interpret comparable sales and determine appropriate time adjustments.',
                uspap: 'Market conditions must be analyzed to understand the context of comparable sales.',
                definitions: [
                    { term: 'Market Conditions', definition: 'The state of supply and demand in the market' },
                    { term: 'Time Adjustment', definition: 'Adjustment for changes in market conditions between sale date and effective date' }
                ],
                bestPractices: [
                    'Use paired sales analysis',
                    'Consider economic indicators',
                    'Support with market data'
                ]
            }
        },
        '14.3': {
            title: 'Comparable Sales Data',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Sale Data',
                content: 'Document detailed information for each comparable sale.'
            },
            fields: [
                { type: 'heading', label: 'Comparable Sale 1', highlight: true },
                { type: 'text', label: 'Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'date', label: 'Sale Date', required: true },
                { type: 'text', label: 'Grantor (Seller)' },
                { type: 'text', label: 'Grantee (Buyer)' },
                { type: 'select', label: 'Property Rights', options: ['Fee Simple', 'Leased Fee', 'Leasehold', 'Other'] },
                { type: 'select', label: 'Financing', options: ['Cash', 'Conventional', 'Seller Financing', 'Other'] },
                { type: 'select', label: 'Conditions of Sale', options: ['Arms-Length', 'Non-Arms-Length', 'Foreclosure', 'Estate Sale', 'Other'] },
                { type: 'number', label: 'Building Area (SF)', required: true },
                { type: 'currency', label: 'Price per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'number', label: 'Land Area (Acres)', step: '0.01' },
                { type: 'number', label: 'Year Built' },
                { type: 'select', label: 'Condition', options: ['Excellent', 'Good', 'Average', 'Fair', 'Poor'] },
                { type: 'textarea', label: 'Description', rows: 3, placeholder: 'Describe the comparable property' },
                { type: 'text', label: 'Data Source', placeholder: 'How was this sale verified?' },
                { type: 'heading', label: 'Comparable Sale 2', highlight: true },
                { type: 'text', label: 'Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'date', label: 'Sale Date', required: true },
                { type: 'text', label: 'Grantor (Seller)' },
                { type: 'text', label: 'Grantee (Buyer)' },
                { type: 'select', label: 'Property Rights', options: ['Fee Simple', 'Leased Fee', 'Leasehold', 'Other'] },
                { type: 'select', label: 'Financing', options: ['Cash', 'Conventional', 'Seller Financing', 'Other'] },
                { type: 'select', label: 'Conditions of Sale', options: ['Arms-Length', 'Non-Arms-Length', 'Foreclosure', 'Estate Sale', 'Other'] },
                { type: 'number', label: 'Building Area (SF)', required: true },
                { type: 'currency', label: 'Price per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'number', label: 'Land Area (Acres)', step: '0.01' },
                { type: 'number', label: 'Year Built' },
                { type: 'select', label: 'Condition', options: ['Excellent', 'Good', 'Average', 'Fair', 'Poor'] },
                { type: 'textarea', label: 'Description', rows: 3, placeholder: 'Describe the comparable property' },
                { type: 'text', label: 'Data Source', placeholder: 'How was this sale verified?' },
                { type: 'heading', label: 'Comparable Sale 3', highlight: true },
                { type: 'text', label: 'Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'date', label: 'Sale Date', required: true },
                { type: 'text', label: 'Grantor (Seller)' },
                { type: 'text', label: 'Grantee (Buyer)' },
                { type: 'select', label: 'Property Rights', options: ['Fee Simple', 'Leased Fee', 'Leasehold', 'Other'] },
                { type: 'select', label: 'Financing', options: ['Cash', 'Conventional', 'Seller Financing', 'Other'] },
                { type: 'select', label: 'Conditions of Sale', options: ['Arms-Length', 'Non-Arms-Length', 'Foreclosure', 'Estate Sale', 'Other'] },
                { type: 'number', label: 'Building Area (SF)', required: true },
                { type: 'currency', label: 'Price per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'number', label: 'Land Area (Acres)', step: '0.01' },
                { type: 'number', label: 'Year Built' },
                { type: 'select', label: 'Condition', options: ['Excellent', 'Good', 'Average', 'Fair', 'Poor'] },
                { type: 'textarea', label: 'Description', rows: 3, placeholder: 'Describe the comparable property' },
                { type: 'text', label: 'Data Source', placeholder: 'How was this sale verified?' }
            ],
            help: {
                about: 'Detailed sale data enables accurate comparison and adjustment. All relevant information about each comparable must be documented.',
                uspap: 'Comparables must be verified and all relevant characteristics documented.',
                definitions: [
                    { term: 'Verification', definition: 'Confirming sale details with a party to the transaction or reliable source' },
                    { term: 'Property Rights', definition: 'The type of ownership interest transferred' }
                ],
                bestPractices: [
                    'Verify all sales',
                    'Document all relevant characteristics',
                    'Note any unusual conditions'
                ]
            }
        },
        '14.4': {
            title: 'Sales Comparison Grid',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Comparison Grid',
                content: 'Create a grid comparing subject and comparables.'
            },
            fields: [
                { type: 'heading', label: 'Transactional Adjustments', highlight: true },
                { type: 'currency', label: 'Comp 1: Property Rights Adjustment' },
                { type: 'currency', label: 'Comp 1: Financing Terms Adjustment' },
                { type: 'currency', label: 'Comp 1: Conditions of Sale Adjustment' },
                { type: 'currency', label: 'Comp 1: Time/Market Conditions Adjustment' },
                { type: 'currency', label: 'Comp 2: Property Rights Adjustment' },
                { type: 'currency', label: 'Comp 2: Financing Terms Adjustment' },
                { type: 'currency', label: 'Comp 2: Conditions of Sale Adjustment' },
                { type: 'currency', label: 'Comp 2: Time/Market Conditions Adjustment' },
                { type: 'currency', label: 'Comp 3: Property Rights Adjustment' },
                { type: 'currency', label: 'Comp 3: Financing Terms Adjustment' },
                { type: 'currency', label: 'Comp 3: Conditions of Sale Adjustment' },
                { type: 'currency', label: 'Comp 3: Time/Market Conditions Adjustment' },
                { type: 'heading', label: 'Physical Adjustments', highlight: true },
                { type: 'currency', label: 'Comp 1: Location Adjustment' },
                { type: 'currency', label: 'Comp 1: Size Adjustment' },
                { type: 'currency', label: 'Comp 1: Age/Condition Adjustment' },
                { type: 'currency', label: 'Comp 1: Quality Adjustment' },
                { type: 'currency', label: 'Comp 1: Other Adjustments' },
                { type: 'currency', label: 'Comp 2: Location Adjustment' },
                { type: 'currency', label: 'Comp 2: Size Adjustment' },
                { type: 'currency', label: 'Comp 2: Age/Condition Adjustment' },
                { type: 'currency', label: 'Comp 2: Quality Adjustment' },
                { type: 'currency', label: 'Comp 2: Other Adjustments' },
                { type: 'currency', label: 'Comp 3: Location Adjustment' },
                { type: 'currency', label: 'Comp 3: Size Adjustment' },
                { type: 'currency', label: 'Comp 3: Age/Condition Adjustment' },
                { type: 'currency', label: 'Comp 3: Quality Adjustment' },
                { type: 'currency', label: 'Comp 3: Other Adjustments' },
                { type: 'heading', label: 'Adjusted Values', highlight: true },
                { type: 'currency', label: 'Comp 1: Total Net Adjustment', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 1: Adjusted Sale Price', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 1: Adjusted Price per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 2: Total Net Adjustment', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 2: Adjusted Sale Price', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 2: Adjusted Price per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 3: Total Net Adjustment', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 3: Adjusted Sale Price', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Comp 3: Adjusted Price per SF', readonly: true, note: 'Auto-calculated' }
            ],
            help: {
                about: 'The comparison grid organizes adjustments systematically, showing how each comparable is adjusted to match the subject property.',
                uspap: 'All adjustments must be reasonable and supported.',
                definitions: [
                    { term: 'Transactional Adjustments', definition: 'Adjustments for differences in property rights, financing, conditions of sale, and time' },
                    { term: 'Physical Adjustments', definition: 'Adjustments for physical differences between properties' },
                    { term: 'Net Adjustment', definition: 'The sum of all adjustments applied to a comparable' }
                ],
                bestPractices: [
                    'Apply transactional adjustments first',
                    'Support all adjustments with market data',
                    'Keep net adjustments reasonable (typically under 25%)'
                ]
            }
        },
        '14.5': {
            title: 'Adjustment Analysis',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Adjustments',
                content: 'Calculate and justify all adjustments.'
            },
            fields: [
                { type: 'heading', label: 'Adjustment Methodology', highlight: true },
                { type: 'textarea', label: 'Property Rights Adjustments', rows: 3, placeholder: 'Explain adjustments for property rights differences' },
                { type: 'textarea', label: 'Financing Terms Adjustments', rows: 3, placeholder: 'Explain adjustments for non-typical financing' },
                { type: 'textarea', label: 'Conditions of Sale Adjustments', rows: 3, placeholder: 'Explain adjustments for non-arms-length conditions' },
                { type: 'textarea', label: 'Time/Market Conditions Adjustments', rows: 3, placeholder: 'Explain time adjustments based on market trends' },
                { type: 'textarea', label: 'Location Adjustments', rows: 3, placeholder: 'Explain location adjustments' },
                { type: 'textarea', label: 'Size Adjustments', rows: 3, placeholder: 'Explain size adjustments' },
                { type: 'textarea', label: 'Age/Condition Adjustments', rows: 3, placeholder: 'Explain age and condition adjustments' },
                { type: 'textarea', label: 'Quality Adjustments', rows: 3, placeholder: 'Explain construction quality adjustments' },
                { type: 'textarea', label: 'Other Adjustments', rows: 3, placeholder: 'Explain any other adjustments' }
            ],
            help: {
                about: 'Adjustments account for differences between subject and comparables. All adjustments must be explained and supported.',
                uspap: 'Adjustments must be reasonable and based on market evidence.',
                definitions: [
                    { term: 'Paired Sales Analysis', definition: 'Comparing two sales that differ in only one characteristic to derive an adjustment' },
                    { term: 'Regression Analysis', definition: 'Statistical method for deriving adjustments' }
                ],
                bestPractices: [
                    'Use market-derived adjustments',
                    'Explain methodology clearly',
                    'Support with data'
                ]
            }
        },
        '14.6': {
            title: 'Sales Comparison Conclusion',
            section: 'Sales Comparison Approach',
            visibility: { approaches: ['sales'] },
            helpBanner: {
                title: 'Indicated Value',
                content: 'Reconcile adjusted sale prices to reach indicated value.'
            },
            fields: [
                { type: 'heading', label: 'Reconciliation of Comparables', highlight: true },
                { type: 'textarea', label: 'Reconciliation Analysis', rows: 5, required: true, placeholder: 'Discuss which comparables are most similar and reliable, and explain how you arrived at the indicated value' },
                { type: 'currency', label: 'Concluded Price per SF', required: true },
                { type: 'number', label: 'Subject Building Area (SF)', required: true },
                { type: 'currency', label: 'INDICATED VALUE BY SALES COMPARISON APPROACH', required: true, readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Reliability Assessment', highlight: true },
                { type: 'select', label: 'Reliability Rating', options: ['Excellent', 'Good', 'Fair', 'Limited'] },
                { type: 'textarea', label: 'Reliability Discussion', rows: 3, placeholder: 'Discuss the reliability and applicability of the sales comparison approach for this property' }
            ],
            help: {
                about: 'The sales comparison approach indicates value through market transactions. Reconciliation involves weighing the adjusted sale prices to arrive at a single value indication.',
                uspap: 'The sales comparison conclusion must be clearly stated and supported.',
                definitions: [
                    { term: 'Reconciliation', definition: 'The process of analyzing and weighing value indications to arrive at a final opinion' },
                    { term: 'Indicated Value', definition: 'The value conclusion from a particular approach' }
                ],
                bestPractices: [
                    'Give most weight to most similar comparables',
                    'Consider quality and quantity of data',
                    'Explain reasoning clearly'
                ]
            }
        },
        '15.1': {
            title: 'Income Approach Method Selection',
            section: 'Income Approach',
            visibility: { approaches: ['income'] },
            helpBanner: {
                title: 'Method Selection',
                content: 'Select the appropriate income capitalization method.'
            },
            fields: [
                { type: 'heading', label: 'Income Approach Method Selection', highlight: true },
                { type: 'select', label: 'Primary Method', required: true, options: ['Direct Capitalization', 'Discounted Cash Flow (DCF)', 'Gross Rent Multiplier (GRM)', 'Not Applicable'] },
                { type: 'textarea', label: 'Method Justification', rows: 4, required: true, placeholder: 'Explain why this method is most appropriate for this property' },
                { type: 'heading', label: 'Income Approach Applicability', highlight: true },
                { type: 'textarea', label: 'Applicability Discussion', rows: 4, placeholder: 'Discuss the applicability and reliability of the income approach for this property type and market' }
            ],
            help: {
                about: 'Method selection depends on property type and available data. Direct capitalization is most common for stabilized properties.',
                uspap: 'The income approach must be developed when applicable to the property type and assignment.',
                definitions: [
                    { term: 'Direct Capitalization', definition: 'Converting a single year\'s income into value using a cap rate' },
                    { term: 'DCF', definition: 'Discounted Cash Flow - projecting future cash flows and discounting to present value' },
                    { term: 'GRM', definition: 'Gross Rent Multiplier - a ratio of price to gross rent' }
                ],
                bestPractices: [
                    'Select method based on property type',
                    'Consider data availability',
                    'Explain method selection'
                ]
            }
        },
        '15.2': {
            title: 'Rental Income Analysis',
            section: 'Income Approach',
            visibility: { approaches: ['income'] },
            helpBanner: {
                title: 'Rental Income',
                content: 'Analyze rental income including lease comps and effective rent.'
            },
            fields: [
                { type: 'heading', label: 'Market Rent Survey (Lease Comps)', highlight: true },
                { type: 'heading', label: 'Lease Comparable 1' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Contract Rent (per SF/year)', required: true },
                { type: 'select', label: 'Lease Type', required: true, options: ['Triple Net (NNN)', 'Modified Gross', 'Full Service Gross', 'Other'] },
                { type: 'number', label: 'Lease Term (years)', step: '0.5' },
                { type: 'currency', label: 'Tenant Improvements (TI) Allowance (per SF)' },
                { type: 'number', label: 'Free Rent Period (months)' },
                { type: 'text', label: 'Escalations', placeholder: 'e.g., 3% annual' },
                { type: 'currency', label: 'Effective Rent (per SF/year)', readonly: true, note: 'Auto-calculated considering TI, free rent, etc.' },
                { type: 'heading', label: 'Lease Comparable 2' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Contract Rent (per SF/year)', required: true },
                { type: 'select', label: 'Lease Type', required: true, options: ['Triple Net (NNN)', 'Modified Gross', 'Full Service Gross', 'Other'] },
                { type: 'number', label: 'Lease Term (years)', step: '0.5' },
                { type: 'currency', label: 'Tenant Improvements (TI) Allowance (per SF)' },
                { type: 'number', label: 'Free Rent Period (months)' },
                { type: 'text', label: 'Escalations', placeholder: 'e.g., 3% annual' },
                { type: 'currency', label: 'Effective Rent (per SF/year)', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Lease Comparable 3' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Contract Rent (per SF/year)', required: true },
                { type: 'select', label: 'Lease Type', required: true, options: ['Triple Net (NNN)', 'Modified Gross', 'Full Service Gross', 'Other'] },
                { type: 'number', label: 'Lease Term (years)', step: '0.5' },
                { type: 'currency', label: 'Tenant Improvements (TI) Allowance (per SF)' },
                { type: 'number', label: 'Free Rent Period (months)' },
                { type: 'text', label: 'Escalations', placeholder: 'e.g., 3% annual' },
                { type: 'currency', label: 'Effective Rent (per SF/year)', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Market Rent Conclusion', highlight: true },
                { type: 'currency', label: 'Concluded Market Rent (per SF/year)', required: true },
                { type: 'textarea', label: 'Market Rent Analysis', rows: 4, required: true, placeholder: 'Explain how you arrived at the market rent conclusion' },
                { type: 'heading', label: 'Subject Property Potential Income', highlight: true },
                { type: 'number', label: 'Rentable Area (SF)', required: true },
                { type: 'currency', label: 'Market Rent per SF', required: true },
                { type: 'currency', label: 'Potential Gross Income (PGI)', readonly: true, note: 'Auto-calculated' },
                { type: 'number', label: 'Vacancy & Collection Loss (%)', step: '0.1', required: true },
                { type: 'currency', label: 'Vacancy & Collection Loss ($)', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Effective Gross Income (EGI)', readonly: true, note: 'Auto-calculated: PGI - Vacancy' }
            ],
            help: {
                about: 'Rental income analysis determines potential gross income based on comparable leases.',
                uspap: 'Market rent must be supported by comparable lease data.',
                definitions: [
                    { term: 'Contract Rent', definition: 'The actual rent specified in a lease' },
                    { term: 'Effective Rent', definition: 'Contract rent adjusted for concessions like TI and free rent' },
                    { term: 'Triple Net (NNN)', definition: 'Tenant pays rent plus taxes, insurance, and maintenance' },
                    { term: 'PGI', definition: 'Potential Gross Income - income if 100% occupied at market rent' },
                    { term: 'EGI', definition: 'Effective Gross Income - PGI less vacancy and collection loss' }
                ],
                bestPractices: [
                    'Use recent comparable leases',
                    'Adjust for lease concessions',
                    'Support vacancy estimate with market data'
                ]
            }
        },
        '15.3': {
            title: 'Operating Expenses',
            section: 'Income Approach',
            visibility: { approaches: ['income'] },
            helpBanner: {
                title: 'Operating Expenses',
                content: 'Estimate operating expenses and calculate net operating income.'
            },
            fields: [
                { type: 'heading', label: 'Operating Expense Categories', highlight: true },
                { type: 'currency', label: 'Management Fee', required: true, note: 'Typically 3-5% of EGI' },
                { type: 'number', label: 'Management Fee (%)', step: '0.1', placeholder: 'As % of EGI' },
                { type: 'currency', label: 'Maintenance & Repairs', required: true },
                { type: 'currency', label: 'Insurance', required: true },
                { type: 'currency', label: 'Property Taxes', required: true },
                { type: 'currency', label: 'Utilities', placeholder: 'If landlord-paid' },
                { type: 'currency', label: 'Reserves for Replacement', required: true, note: 'Typically $0.10-0.30 per SF' },
                { type: 'currency', label: 'Other Operating Expenses' },
                { type: 'textarea', label: 'Other Expenses Description', rows: 2, placeholder: 'Describe other expenses' },
                { type: 'heading', label: 'Total Operating Expenses', highlight: true },
                { type: 'currency', label: 'Total Operating Expenses', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Operating Expenses per SF', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Net Operating Income', highlight: true },
                { type: 'currency', label: 'Effective Gross Income (EGI)', readonly: true, note: 'From Step 15.2' },
                { type: 'currency', label: 'Less: Total Operating Expenses', readonly: true, note: 'Auto-calculated above' },
                { type: 'currency', label: 'NET OPERATING INCOME (NOI)', required: true, readonly: true, note: 'Auto-calculated: EGI - Expenses' },
                { type: 'heading', label: 'Expense Analysis', highlight: true },
                { type: 'textarea', label: 'Expense Rationale', rows: 4, required: true, placeholder: 'Explain and support the operating expense estimates' }
            ],
            help: {
                about: 'Operating expenses reduce gross income to net operating income. Only include expenses typical for the property type.',
                uspap: 'Operating expenses must be reasonable and supported by market data.',
                definitions: [
                    { term: 'Operating Expenses', definition: 'Expenses necessary to maintain the property and continue production of income' },
                    { term: 'NOI', definition: 'Net Operating Income - income remaining after operating expenses but before debt service' },
                    { term: 'Reserves', definition: 'Annual allowance for replacement of short-lived items' }
                ],
                bestPractices: [
                    'Use market-derived expense ratios',
                    'Include all typical expenses',
                    'Exclude debt service and depreciation'
                ]
            }
        },
        '15.4': {
            title: 'Capitalization Rate',
            section: 'Income Approach',
            visibility: { approaches: ['income'] },
            helpBanner: {
                title: 'Cap Rate',
                content: 'Derive and apply the capitalization rate.'
            },
            fields: [
                { type: 'heading', label: 'Cap Rate Analysis (Cap Rate Comps)', highlight: true },
                { type: 'textarea', label: 'Market Cap Rate Survey', rows: 3, placeholder: 'Describe the market survey and data sources for cap rates' },
                { type: 'heading', label: 'Comparable Sale 1 Cap Rate Analysis' },
                { type: 'text', label: 'Property Address' },
                { type: 'number', label: 'As-Sold Cap Rate (%)', step: '0.01', required: true },
                { type: 'select', label: 'Location Quality', options: ['A (Prime)', 'B (Good)', 'C (Average)', 'D (Below Average)'] },
                { type: 'select', label: 'Tenant Credit Quality', options: ['Investment Grade', 'National/Regional', 'Local', 'Weak'] },
                { type: 'number', label: 'Weighted Avg. Lease Term (years)', step: '0.1' },
                { type: 'number', label: 'Occupancy Rate (%)', step: '0.1' },
                { type: 'number', label: 'Adjusted Cap Rate (%)', step: '0.01', readonly: true, note: 'Auto-calculated after risk adjustments' },
                { type: 'heading', label: 'Comparable Sale 2 Cap Rate Analysis' },
                { type: 'text', label: 'Property Address' },
                { type: 'number', label: 'As-Sold Cap Rate (%)', step: '0.01', required: true },
                { type: 'select', label: 'Location Quality', options: ['A (Prime)', 'B (Good)', 'C (Average)', 'D (Below Average)'] },
                { type: 'select', label: 'Tenant Credit Quality', options: ['Investment Grade', 'National/Regional', 'Local', 'Weak'] },
                { type: 'number', label: 'Weighted Avg. Lease Term (years)', step: '0.1' },
                { type: 'number', label: 'Occupancy Rate (%)', step: '0.1' },
                { type: 'number', label: 'Adjusted Cap Rate (%)', step: '0.01', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Comparable Sale 3 Cap Rate Analysis' },
                { type: 'text', label: 'Property Address' },
                { type: 'number', label: 'As-Sold Cap Rate (%)', step: '0.01', required: true },
                { type: 'select', label: 'Location Quality', options: ['A (Prime)', 'B (Good)', 'C (Average)', 'D (Below Average)'] },
                { type: 'select', label: 'Tenant Credit Quality', options: ['Investment Grade', 'National/Regional', 'Local', 'Weak'] },
                { type: 'number', label: 'Weighted Avg. Lease Term (years)', step: '0.1' },
                { type: 'number', label: 'Occupancy Rate (%)', step: '0.1' },
                { type: 'number', label: 'Adjusted Cap Rate (%)', step: '0.01', readonly: true, note: 'Auto-calculated' },
                { type: 'heading', label: 'Subject Property Risk Assessment', highlight: true },
                { type: 'textarea', label: 'Risk Analysis', rows: 4, required: true, placeholder: 'Analyze risk factors affecting the subject property' },
                { type: 'checkbox-group', label: 'Risk Factors', options: [
                    { label: 'Project Size', description: '' },
                    { label: 'Location', description: '' },
                    { label: 'Tenant Quality', description: '' },
                    { label: 'Market Conditions', description: '' },
                    { label: 'Lease Terms', description: '' },
                    { label: 'Other', description: '' }
                ]},
                { type: 'heading', label: 'Cap Rate Conclusion', highlight: true },
                { type: 'number', label: 'Selected Capitalization Rate (%)', step: '0.01', required: true },
                { type: 'textarea', label: 'Cap Rate Justification', rows: 4, required: true, placeholder: 'Explain how you arrived at the selected cap rate' }
            ],
            help: {
                about: 'The cap rate converts net operating income into value. It must be derived from comparable sales and adjusted for risk differences.',
                uspap: 'Cap rate must be supported by market data and analysis.',
                definitions: [
                    { term: 'Capitalization Rate', definition: 'The ratio of NOI to value, used to convert income to value' },
                    { term: 'As-Sold Cap Rate', definition: 'The cap rate indicated by a comparable sale (NOI ÷ Sale Price)' },
                    { term: 'Risk Adjustment', definition: 'Adjustment to cap rate for differences in risk between subject and comparable' }
                ],
                bestPractices: [
                    'Use comparable sales with known NOI',
                    'Adjust for risk differences',
                    'Support with investor surveys'
                ]
            }
        },
        '15.5': {
            title: 'Income Approach Conclusion',
            section: 'Income Approach',
            visibility: { approaches: ['income'] },
            helpBanner: {
                title: 'Income Value',
                content: 'Calculate indicated value using the income approach.'
            },
            fields: [
                { type: 'heading', label: 'Direct Capitalization Calculation', highlight: true },
                { type: 'currency', label: 'Net Operating Income (NOI)', required: true, readonly: true, note: 'From Step 15.3' },
                { type: 'number', label: 'Capitalization Rate (%)', step: '0.01', required: true, readonly: true, note: 'From Step 15.4' },
                { type: 'heading', label: 'Value Calculation Formula', highlight: true },
                { type: 'textarea', label: 'Formula', rows: 2, readonly: true, defaultValue: 'Value = NOI ÷ Cap Rate' },
                { type: 'currency', label: 'Calculated Value', readonly: true, note: 'Auto-calculated: NOI ÷ Cap Rate' },
                { type: 'heading', label: 'Rounding & Conclusion', highlight: true },
                { type: 'currency', label: 'Rounded Value', required: true },
                { type: 'textarea', label: 'Rounding Explanation', rows: 2, placeholder: 'Explain rounding rationale' },
                { type: 'currency', label: 'INDICATED VALUE BY INCOME APPROACH', required: true },
                { type: 'heading', label: 'Reliability Assessment', highlight: true },
                { type: 'select', label: 'Reliability Rating', options: ['Excellent', 'Good', 'Fair', 'Limited'] },
                { type: 'textarea', label: 'Reliability Discussion', rows: 3, placeholder: 'Discuss the reliability and applicability of the income approach for this property' }
            ],
            help: {
                about: 'The income approach indicates value through income capitalization: Value = NOI ÷ Cap Rate.',
                uspap: 'The income approach conclusion must be clearly stated and supported.',
                definitions: [
                    { term: 'Direct Capitalization Formula', definition: 'Value = NOI ÷ Cap Rate' },
                    { term: 'Indicated Value', definition: 'The value conclusion from a particular approach' }
                ],
                bestPractices: [
                    'Verify all calculations',
                    'Discuss reliability for property type',
                    'Compare to other approaches'
                ]
            }
        },
        '15.5.1': {
            title: 'GRM Analysis',
            section: 'Income Approach',
            visibility: { approaches: ['income'], subTypes: ['Multi-Family (2-4)', 'Multi-Family (5+)'] },
            helpBanner: {
                title: 'Gross Rent Multiplier',
                content: 'Calculate and apply gross rent multipliers for multi-family properties.'
            },
            fields: [
                { type: 'heading', label: 'GRM Calculation from Comparables', highlight: true },
                { type: 'heading', label: 'Comparable Sale 1' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'currency', label: 'Annual Gross Rent', required: true },
                { type: 'number', label: 'Gross Rent Multiplier (GRM)', readonly: true, step: '0.01', note: 'Auto-calculated: Sale Price ÷ Annual Gross Rent' },
                { type: 'heading', label: 'Comparable Sale 2' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'currency', label: 'Annual Gross Rent', required: true },
                { type: 'number', label: 'Gross Rent Multiplier (GRM)', readonly: true, step: '0.01', note: 'Auto-calculated' },
                { type: 'heading', label: 'Comparable Sale 3' },
                { type: 'text', label: 'Property Address', required: true },
                { type: 'currency', label: 'Sale Price', required: true },
                { type: 'currency', label: 'Annual Gross Rent', required: true },
                { type: 'number', label: 'Gross Rent Multiplier (GRM)', readonly: true, step: '0.01', note: 'Auto-calculated' },
                { type: 'heading', label: 'Market GRM Conclusion', highlight: true },
                { type: 'number', label: 'Concluded Market GRM', required: true, step: '0.01' },
                { type: 'textarea', label: 'GRM Analysis', rows: 3, required: true, placeholder: 'Explain how you arrived at the market GRM' },
                { type: 'heading', label: 'Value Indication by GRM', highlight: true },
                { type: 'currency', label: 'Subject Annual Gross Rent', required: true },
                { type: 'number', label: 'Market GRM', readonly: true, note: 'From above' },
                { type: 'currency', label: 'INDICATED VALUE BY GRM', readonly: true, note: 'Auto-calculated: Annual Gross Rent × GRM' }
            ],
            help: {
                about: 'GRM is a simplified income approach method for multi-family properties that relates sale price to gross rent.',
                uspap: 'GRM must be supported by comparable sales data.',
                definitions: [
                    { term: 'GRM', definition: 'Gross Rent Multiplier - the ratio of sale price to annual gross rent' },
                    { term: 'Annual Gross Rent', definition: 'Total annual rent collected or collectible from all units' }
                ],
                bestPractices: [
                    'Use comparable multi-family sales',
                    'Verify rent data',
                    'Consider as supplemental to income approach'
                ]
            }
        },
        '15.5.2': {
            title: 'Amenity Analysis',
            section: 'Income Approach',
            visibility: { approaches: ['income'], subTypes: ['Multi-Family (2-4)', 'Multi-Family (5+)'] },
            helpBanner: {
                title: 'Amenities',
                content: 'Document amenities and their impact on value.'
            },
            fields: [
                { type: 'heading', label: 'Subject Property Amenities', highlight: true },
                { type: 'checkbox-group', label: 'Amenities Present', options: [
                    { label: 'Swimming Pool', description: '' },
                    { label: 'Fitness Center', description: '' },
                    { label: 'Clubhouse', description: '' },
                    { label: 'Playground', description: '' },
                    { label: 'Laundry Facilities', description: '' },
                    { label: 'Covered Parking', description: '' },
                    { label: 'Security System', description: '' },
                    { label: 'On-Site Management', description: '' }
                ]},
                { type: 'heading', label: 'Amenity Comparison', highlight: true },
                { type: 'textarea', label: 'Comparison to Comparables', rows: 4, placeholder: 'Compare subject amenities to comparable properties' },
                { type: 'heading', label: 'Amenity Adjustments', highlight: true },
                { type: 'currency', label: 'Pool Adjustment (per unit)' },
                { type: 'currency', label: 'Fitness Center Adjustment (per unit)' },
                { type: 'currency', label: 'Other Amenity Adjustments (per unit)' },
                { type: 'textarea', label: 'Adjustment Rationale', rows: 3, placeholder: 'Explain amenity adjustments' }
            ],
            help: {
                about: 'Amenities can significantly impact rental rates and value in multi-family properties.',
                uspap: 'Amenity differences must be considered in comparable analysis.',
                definitions: [
                    { term: 'Amenity', definition: 'A feature that enhances the desirability and value of a property' },
                    { term: 'Amenity Adjustment', definition: 'The value difference attributable to amenity differences' }
                ],
                bestPractices: [
                    'Document all amenities',
                    'Support adjustments with market data',
                    'Consider maintenance costs'
                ]
            }
        },
        '17.1': {
            title: 'Reconciliation of Approaches',
            section: 'Correlation & Final Value',
            helpBanner: {
                title: 'Reconciliation',
                content: 'Reconcile values from all applicable approaches.'
            },
            fields: [
                { type: 'heading', label: 'Approach Summary', highlight: true },
                { type: 'heading', label: 'Cost Approach' },
                { type: 'currency', label: 'Indicated Value', readonly: true, note: 'From Section 13' },
                { type: 'number', label: 'Weight (%)', step: '1', min: '0', max: '100' },
                { type: 'textarea', label: 'Reasoning', rows: 3, placeholder: 'Explain the weight given to the cost approach' },
                { type: 'heading', label: 'Sales Comparison Approach' },
                { type: 'currency', label: 'Indicated Value', readonly: true, note: 'From Section 14' },
                { type: 'number', label: 'Weight (%)', step: '1', min: '0', max: '100' },
                { type: 'textarea', label: 'Reasoning', rows: 3, placeholder: 'Explain the weight given to the sales comparison approach' },
                { type: 'heading', label: 'Income Approach' },
                { type: 'currency', label: 'Indicated Value', readonly: true, note: 'From Section 15' },
                { type: 'number', label: 'Weight (%)', step: '1', min: '0', max: '100' },
                { type: 'textarea', label: 'Reasoning', rows: 3, placeholder: 'Explain the weight given to the income approach' },
                { type: 'heading', label: 'Value Conclusions', highlight: true },
                { type: 'heading', label: '"As Completed" Value' },
                { type: 'currency', label: 'Weighted Value', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Final "As Completed" Value', required: true },
                { type: 'textarea', label: 'Rounding Explanation', rows: 2 },
                { type: 'heading', label: '"As Stabilized" Value' },
                { type: 'currency', label: 'Weighted Value', readonly: true, note: 'Auto-calculated' },
                { type: 'currency', label: 'Final "As Stabilized" Value', required: true },
                { type: 'textarea', label: 'Rounding Explanation', rows: 2 },
                { type: 'heading', label: '"As Is" Value' },
                { type: 'currency', label: 'Land Value' },
                { type: 'currency', label: 'Remainder Parcel Value' },
                { type: 'currency', label: 'Final "As Is" Value', required: true }
            ],
            help: {
                about: 'Reconciliation weighs and combines results from different approaches to arrive at a final opinion of value.',
                uspap: 'Reconciliation must consider the quality and quantity of data, the applicability of each approach, and the strengths and weaknesses of each.',
                definitions: [
                    { term: 'Reconciliation', definition: 'The process of analyzing and weighing value indications to arrive at a final opinion' },
                    { term: 'Weight', definition: 'The relative importance given to each approach based on its reliability' }
                ],
                bestPractices: [
                    'Explain weight rationale clearly',
                    'Consider approach applicability',
                    'Support final value conclusion'
                ]
            }
        },
        '17.2': {
            title: 'Final Value Conclusion',
            section: 'Correlation & Final Value',
            helpBanner: {
                title: 'Final Value',
                content: 'State the final value conclusion.'
            },
            fields: [
                { type: 'heading', label: 'Final Value Opinions', highlight: true },
                { type: 'currency', label: '"AS COMPLETED" MARKET VALUE', required: true },
                { type: 'date', label: 'Effective Date of "As Completed" Value', required: true },
                { type: 'currency', label: '"AS STABILIZED" MARKET VALUE', required: true },
                { type: 'date', label: 'Effective Date of "As Stabilized" Value', required: true },
                { type: 'currency', label: '"AS IS" MARKET VALUE', required: true },
                { type: 'date', label: 'Effective Date of "As Is" Value', required: true },
                { type: 'heading', label: 'Exposure & Marketing Time', highlight: true },
                { type: 'number', label: 'Estimated Exposure Period', unit: 'select', unitOptions: ['Days', 'Months', 'Years'] },
                { type: 'textarea', label: 'Exposure Period Discussion', rows: 3, placeholder: 'Explain the estimated exposure period' },
                { type: 'heading', label: 'Final Statement', highlight: true },
                { type: 'textarea', label: 'Final Value Statement', rows: 4, required: true, placeholder: 'Provide a final statement summarizing the value conclusions' }
            ],
            help: {
                about: 'The final value conclusion represents the appraiser\'s opinion of value after considering all approaches and market data.',
                uspap: 'Standards Rule 2-2(a)(viii) requires a clear statement of the value conclusion(s) and effective date(s).',
                definitions: [
                    { term: 'Market Value', definition: 'The most probable price which a property should bring in a competitive and open market' },
                    { term: 'Effective Date', definition: 'The date as of which the opinion of value applies' },
                    { term: 'Exposure Period', definition: 'The estimated length of time the property would be on the market' }
                ],
                bestPractices: [
                    'State value clearly and unambiguously',
                    'Include all required effective dates',
                    'Provide exposure period estimate'
                ]
            }
        },
        '18.1': {
            title: 'Certification Statement',
            section: 'Certification',
            helpBanner: {
                title: 'Certification',
                content: 'Provide the required certification statement.'
            },
            fields: [
                { type: 'heading', label: 'Appraiser Certification', highlight: true },
                { type: 'textarea', label: 'Standard Certification', rows: 15, readonly: true, defaultValue: 'I certify that, to the best of my knowledge and belief:\n\n• The statements of fact contained in this report are true and correct.\n• The reported analyses, opinions, and conclusions are limited only by the reported assumptions and limiting conditions and are my personal, impartial, and unbiased professional analyses, opinions, and conclusions.\n• I have no present or prospective interest in the property that is the subject of this report and no personal interest with respect to the parties involved.\n• I have performed no services, as an appraiser or in any other capacity, regarding the property that is the subject of this report within the three-year period immediately preceding acceptance of this assignment.\n• I have no bias with respect to the property that is the subject of this report or to the parties involved with this assignment.\n• My engagement in this assignment was not contingent upon developing or reporting predetermined results.\n• My compensation for completing this assignment is not contingent upon the development or reporting of a predetermined value or direction in value that favors the cause of the client, the amount of the value opinion, the attainment of a stipulated result, or the occurrence of a subsequent event directly related to the intended use of this appraisal.\n• My analyses, opinions, and conclusions were developed, and this report has been prepared, in conformity with the Uniform Standards of Professional Appraisal Practice.\n• I have made a personal inspection of the property that is the subject of this report.\n• No one provided significant real property appraisal assistance to the person signing this certification.' },
                { type: 'heading', label: 'Additional Certifications', highlight: true },
                { type: 'textarea', label: 'Additional Certifications (if any)', rows: 4, placeholder: 'Add any additional certifications required for this assignment' },
                { type: 'heading', label: 'Signature', highlight: true },
                { type: 'text', label: 'Appraiser Name', required: true, readonly: true, autoFill: true, defaultValue: 'loggedInUser.appraiserName' },
                { type: 'text', label: 'License/Certification Number', required: true },
                { type: 'text', label: 'State', required: true },
                { type: 'date', label: 'Date of Signature', required: true },
                { type: 'file', label: 'Digital Signature Upload', accept: 'image/*' }
            ],
            help: {
                about: 'Certification statements affirm compliance with USPAP standards and attest to the appraiser\'s independence and objectivity.',
                uspap: 'Standards Rule 2-3 requires specific certifications in every appraisal report.',
                definitions: [
                    { term: 'Certification', definition: 'A signed statement attesting to the accuracy and compliance of the appraisal' },
                    { term: 'USPAP', definition: 'Uniform Standards of Professional Appraisal Practice' }
                ],
                bestPractices: [
                    'Review all certifications carefully',
                    'Ensure all required items are included',
                    'Sign and date the certification'
                ]
            }
        },
        '19.1': {
            title: 'Appraiser Qualifications',
            section: 'Qualifications',
            helpBanner: {
                title: 'Qualifications',
                content: 'Document appraiser qualifications and experience.'
            },
            fields: [
                { type: 'heading', label: 'Appraiser Information', highlight: true },
                { type: 'text', label: 'Name', required: true, readonly: true, autoFill: true, defaultValue: 'loggedInUser.appraiserName' },
                { type: 'text', label: 'Company', required: true, readonly: true, autoFill: true, defaultValue: 'loggedInUser.companyName' },
                { type: 'text', label: 'Address', required: true, readonly: true, autoFill: true, defaultValue: 'loggedInUser.address' },
                { type: 'text', label: 'Phone', required: true, readonly: true, autoFill: true, defaultValue: 'loggedInUser.phone' },
                { type: 'email', label: 'Email', required: true },
                { type: 'heading', label: 'Licenses & Certifications', highlight: true },
                { type: 'text', label: 'State License/Certification Number', required: true },
                { type: 'text', label: 'State', required: true },
                { type: 'date', label: 'Expiration Date', required: true },
                { type: 'textarea', label: 'Additional Licenses/Certifications', rows: 3, placeholder: 'List any additional licenses or certifications' },
                { type: 'heading', label: 'Professional Designations', highlight: true },
                { type: 'checkbox-group', label: 'Designations', options: [
                    { label: 'MAI (Appraisal Institute)', description: '' },
                    { label: 'SRA (Appraisal Institute)', description: '' },
                    { label: 'CCIM (CCIM Institute)', description: '' },
                    { label: 'ASA (American Society of Appraisers)', description: '' },
                    { label: 'Other', description: '' }
                ]},
                { type: 'textarea', label: 'Other Designations', rows: 2 },
                { type: 'heading', label: 'Experience', highlight: true },
                { type: 'number', label: 'Years of Appraisal Experience', required: true },
                { type: 'textarea', label: 'Relevant Experience', rows: 4, required: true, placeholder: 'Describe relevant experience with this property type' },
                { type: 'heading', label: 'Education', highlight: true },
                { type: 'textarea', label: 'Education & Training', rows: 4, placeholder: 'List relevant education and training' }
            ],
            help: {
                about: 'Appraiser qualifications establish credibility and expertise and demonstrate competency for the assignment.',
                uspap: 'The Competency Rule requires appraisers to have the knowledge and experience necessary to complete the assignment competently.',
                definitions: [
                    { term: 'MAI', definition: 'Member of the Appraisal Institute - a professional designation for commercial appraisers' },
                    { term: 'SRA', definition: 'Senior Residential Appraiser - a professional designation for residential appraisers' },
                    { term: 'Competency', definition: 'Having the knowledge and experience necessary to complete an assignment' }
                ],
                bestPractices: [
                    'Include all relevant licenses',
                    'Highlight relevant experience',
                    'Document continuing education'
                ]
            }
        },
        '20.1': {
            title: 'Standard Assumptions',
            section: 'Assumptions & Limiting Conditions',
            helpBanner: {
                title: 'Assumptions',
                content: 'State standard assumptions and limiting conditions.'
            },
            fields: [
                { type: 'heading', label: 'Standard Assumptions', highlight: true },
                { type: 'textarea', label: 'General Assumptions', rows: 10, readonly: true, defaultValue: '• No responsibility is assumed for legal matters or questions of survey or title.\n• All information furnished by others is assumed to be true and correct.\n• The property is assumed to be in full compliance with all applicable federal, state, and local environmental regulations and laws unless otherwise stated.\n• The property is assumed to be in full compliance with all applicable zoning and land use regulations unless otherwise stated.\n• All engineering is assumed to be correct.\n• It is assumed that all required licenses, certificates of occupancy, consents, or other legislative or administrative authority from any local, state, or national government or private entity or organization have been or can be obtained or renewed for any use on which the value estimate contained in this report is based.\n• It is assumed that the use of the land and improvements is confined within the boundaries or property lines of the property described and that there is no encroachment or trespass unless otherwise stated.\n• Unless otherwise stated in this report, the existence of hazardous materials was not observed by the appraiser. The appraiser has no knowledge of the existence of such materials on or in the property.' },
                { type: 'heading', label: 'Limiting Conditions', highlight: true },
                { type: 'textarea', label: 'Standard Limiting Conditions', rows: 10, readonly: true, defaultValue: '• This appraisal report is to be used only for the purpose stated herein.\n• Possession of this report does not carry with it the right of publication.\n• The appraiser may not be required to give testimony or appear in court because of having made the appraisal with reference to the property in question, unless arrangements have been previously made.\n• Neither all nor any part of the contents of this report shall be conveyed to the public through advertising, public relations, news, sales, or other media without the written consent and approval of the appraiser.\n• The appraiser assumes no responsibility for matters of a legal nature affecting the property appraised or the title thereto.\n• Sketches, maps, and photographs in this report are intended as visual aids and are not necessarily to scale.\n• The appraiser has not made a specific compliance survey or analysis of the property to determine if it is or is not in conformance with various detailed requirements of the Americans with Disabilities Act.' },
                { type: 'heading', label: 'Additional Assumptions & Conditions', highlight: true },
                { type: 'textarea', label: 'Additional Assumptions', rows: 4, placeholder: 'Add any assignment-specific assumptions' },
                { type: 'textarea', label: 'Additional Limiting Conditions', rows: 4, placeholder: 'Add any assignment-specific limiting conditions' }
            ],
            help: {
                about: 'Assumptions and limiting conditions protect all parties and clarify scope. They define the boundaries of the appraisal assignment.',
                uspap: 'All assumptions and limiting conditions must be clearly stated in the report.',
                definitions: [
                    { term: 'Assumption', definition: 'A supposition taken to be true' },
                    { term: 'Limiting Condition', definition: 'A condition that limits the scope or use of the appraisal' }
                ],
                bestPractices: [
                    'Include all standard assumptions',
                    'Add assignment-specific conditions',
                    'Ensure clarity and completeness'
                ]
            }
        },
        '21.1': {
            title: 'Supporting Documentation',
            section: 'Addenda',
            helpBanner: {
                title: 'Addenda',
                content: 'Attach supporting documentation and exhibits.'
            },
            fields: [
                { type: 'heading', label: 'Required Exhibits', highlight: true },
                { type: 'checkbox-group', label: 'Standard Exhibits', options: [
                    { label: 'Location Map', description: '' },
                    { label: 'Site Map/Survey', description: '' },
                    { label: 'Zoning Map', description: '' },
                    { label: 'Flood Map', description: '' },
                    { label: 'Building Plans', description: '' },
                    { label: 'Property Photos', description: '' },
                    { label: 'Comparable Sales Photos', description: '' },
                    { label: 'Comparable Lease Data', description: '' }
                ]},
                { type: 'heading', label: 'Photo Documentation', highlight: true },
                { type: 'file', label: 'Subject Property Photos', accept: 'image/*', multiple: true },
                { type: 'textarea', label: 'Photo Descriptions', rows: 4, placeholder: 'Describe each photo' },
                { type: 'file', label: 'Comparable Property Photos', accept: 'image/*', multiple: true },
                { type: 'heading', label: 'Maps & Plans', highlight: true },
                { type: 'file', label: 'Location Map', accept: 'image/*,application/pdf' },
                { type: 'file', label: 'Site Map/Survey', accept: 'image/*,application/pdf' },
                { type: 'file', label: 'Zoning Map', accept: 'image/*,application/pdf' },
                { type: 'file', label: 'Flood Map', accept: 'image/*,application/pdf' },
                { type: 'file', label: 'Building Plans', accept: 'image/*,application/pdf', multiple: true },
                { type: 'heading', label: 'Supporting Documents', highlight: true },
                { type: 'file', label: 'Title Report', accept: 'application/pdf' },
                { type: 'file', label: 'Rent Roll', accept: 'application/pdf,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' },
                { type: 'file', label: 'Operating Statements', accept: 'application/pdf,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' },
                { type: 'file', label: 'Environmental Reports', accept: 'application/pdf' },
                { type: 'file', label: 'Other Supporting Documents', accept: '*/*', multiple: true },
                { type: 'textarea', label: 'Document Descriptions', rows: 4, placeholder: 'Describe other supporting documents' }
            ],
            help: {
                about: 'Addenda provide supporting documentation for the appraisal report. All exhibits referenced in the report should be included.',
                uspap: 'All data and information relied upon must be identified in the report.',
                definitions: [
                    { term: 'Addenda', definition: 'Supporting documentation attached to the appraisal report' },
                    { term: 'Exhibit', definition: 'A document or item attached to support the report' }
                ],
                bestPractices: [
                    'Include all referenced exhibits',
                    'Label all photos and maps clearly',
                    'Organize documents logically'
                ]
            }
        },
        'review': {
            title: 'Review Report',
            section: 'Review & Finalize',
            helpBanner: {
                title: 'Review & Finalize',
                content: 'Review all sections of your appraisal report before generating the final PDF. Make any necessary edits and ensure all required information is complete.'
            },
            fields: [],
            help: {
                about: 'The review stage allows you to verify all information, make final edits, and generate the appraisal report PDF.',
                bestPractices: [
                    'Review each section for completeness and accuracy',
                    'Verify all value conclusions are consistent',
                    'Check that all required USPAP disclosures are present',
                    'Ensure effective dates are correct',
                    'Review certifications and limiting conditions'
                ]
            },
            isReview: true
        }
    };

    // Current step tracking
    let currentStep = 'template-selection';
    let completedSteps = [];
    let preWizardStep = 1; // 1 = template, 2 = setup, 3 = overview

    // Accordion section renderer
    function renderAccordionSection(field, fieldIndex) {
        let html = '<div class="space-y-3">';
        
        field.sections.forEach((section, sectionIndex) => {
            const accordionId = `accordion-${fieldIndex}-${sectionIndex}`;
            const isExpanded = section.expanded !== false;
            
            html += `<div class="border border-gray-300 rounded-lg overflow-hidden">`;
            
            // Accordion header
            html += `<button type="button" class="w-full px-6 py-4 flex items-center justify-between bg-gray-800 text-white hover:bg-gray-700 transition-colors" onclick="toggleAccordion('${accordionId}')">`;
            html += `<div class="flex items-center gap-3">`;
            if (section.icon) {
                html += section.icon;
            }
            html += `<span class="text-base font-semibold">${section.title}</span>`;
            html += `</div>`;
            html += `<svg id="${accordionId}-icon" class="w-5 h-5 transition-transform duration-200 ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>`;
            html += `</svg>`;
            html += `</button>`;
            
            // Accordion content
            html += `<div id="${accordionId}-content" class="bg-white p-6 space-y-4 ${isExpanded ? '' : 'hidden'}">`;
            if (section.fields && Array.isArray(section.fields)) {
                section.fields.forEach((subField, subIndex) => {
                    html += renderField(subField, `${fieldIndex}-${sectionIndex}-${subIndex}`);
                });
            }
            html += `</div>`;
            
            html += `</div>`;
        });
        
        html += '</div>';
        return html;
    }

    // Toggle accordion section
    function toggleAccordion(accordionId) {
        const content = document.getElementById(`${accordionId}-content`);
        const icon = document.getElementById(`${accordionId}-icon`);
        
        if (content && icon) {
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    }

    // Render building summary and validation
    function renderBuildingSummary() {
        const container = document.getElementById('building-summary');
        if (!container || buildingsData.length === 0) return;
        
        let html = '<div class="space-y-6">';
        
        // Progress indicator
        let completedCount = 0;
        buildingsData.forEach(building => {
            if (building.name && building.units && building.units.length > 0) {
                completedCount++;
            }
        });
        
        html += '<div class="bg-white border border-gray-200 rounded-lg p-6">';
        html += '<h3 class="text-lg font-semibold text-harken-dark mb-4">Completion Status</h3>';
        html += '<div class="flex items-center gap-4">';
        html += `<div class="flex-1 bg-gray-200 rounded-full h-3">`;
        const percent = (completedCount / buildingsData.length) * 100;
        html += `<div class="bg-harken-accent rounded-full h-3 transition-all" style="width: ${percent}%"></div>`;
        html += `</div>`;
        html += `<span class="text-sm font-medium text-harken-dark whitespace-nowrap">${completedCount} of ${buildingsData.length} buildings complete</span>`;
        html += '</div>';
        html += '</div>';
        
        // Building cards
        buildingsData.forEach((building, index) => {
            html += '<div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-harken-accent transition-colors">';
            
            // Building header
            html += '<div class="flex items-start justify-between mb-4">';
            html += '<div>';
            html += `<h3 class="text-xl font-bold text-harken-dark mb-1">${building.name || `Building ${index + 1}`}</h3>`;
            html += `<p class="text-sm text-gray-600">${building.locationOnSite || 'Location not specified'}</p>`;
            html += '</div>';
            html += `<button type="button" class="px-4 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-dark flex items-center text-sm" onclick="switchBuilding(${index}); loadStep('9.2')">`;
            html += '<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
            html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>';
            html += '</svg>';
            html += 'Edit';
            html += '</button>';
            html += '</div>';
            
            // Building stats
            html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">';
            
            const totalUnits = building.units ? building.units.length : 0;
            html += '<div class="bg-gray-50 rounded-lg p-3">';
            html += '<p class="text-xs text-gray-600 mb-1">Total Units</p>';
            html += `<p class="text-2xl font-bold text-harken-dark">${totalUnits}</p>`;
            html += '</div>';
            
            let totalSF = 0;
            if (building.units) {
                building.units.forEach(unit => {
                    totalSF += parseFloat(unit.unitSize) || 0;
                });
            }
            html += '<div class="bg-gray-50 rounded-lg p-3">';
            html += '<p class="text-xs text-gray-600 mb-1">Total SF</p>';
            html += `<p class="text-2xl font-bold text-harken-dark">${totalSF.toLocaleString()}</p>`;
            html += '</div>';
            
            html += '<div class="bg-gray-50 rounded-lg p-3">';
            html += '<p class="text-xs text-gray-600 mb-1">Construction Type</p>';
            html += `<p class="text-sm font-medium text-harken-dark">${building.constructionDetails?.constructionType || 'Not specified'}</p>`;
            html += '</div>';
            
            html += '<div class="bg-gray-50 rounded-lg p-3">';
            html += '<p class="text-xs text-gray-600 mb-1">Condition</p>';
            html += `<p class="text-sm font-medium text-harken-dark">${building.constructionDetails?.condition || 'Not specified'}</p>`;
            html += '</div>';
            
            html += '</div>';
            
            // Validation checklist
            html += '<div class="border-t border-gray-200 pt-4">';
            html += '<h4 class="text-sm font-semibold text-gray-700 mb-3">Data Validation</h4>';
            html += '<div class="space-y-2">';
            
            const checks = [
                { condition: building.name, label: 'Building name specified' },
                { condition: building.units && building.units.length > 0, label: 'Unit mix data entered' },
                { condition: totalSF > 0, label: 'Square footage calculated' },
                { condition: building.constructionDetails?.yearBuilt, label: 'Construction details complete' }
            ];
            
            checks.forEach(check => {
                html += '<div class="flex items-center gap-2">';
                if (check.condition) {
                    html += '<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                    html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                    html += '</svg>';
                    html += `<span class="text-sm text-gray-700">${check.label}</span>`;
                } else {
                    html += '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">';
                    html += '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';
                    html += '</svg>';
                    html += `<span class="text-sm text-red-600">${check.label}</span>`;
                }
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
            
            html += '</div>';
        });
        
        // Combined totals
        let combinedSF = 0;
        let combinedUnits = 0;
        buildingsData.forEach(building => {
            if (building.units) {
                building.units.forEach(unit => {
                    combinedSF += parseFloat(unit.unitSize) || 0;
                    combinedUnits++;
                });
            }
        });
        
        html += '<div class="bg-harken-accent/10 border-2 border-harken-accent rounded-lg p-6">';
        html += '<h3 class="text-lg font-semibold text-harken-dark mb-4">Combined Property Totals</h3>';
        html += '<div class="grid grid-cols-3 gap-6">';
        html += '<div>';
        html += '<p class="text-sm text-gray-600 mb-1">Total Buildings</p>';
        html += `<p class="text-3xl font-bold text-harken-accent">${buildingsData.length}</p>`;
        html += '</div>';
        html += '<div>';
        html += '<p class="text-sm text-gray-600 mb-1">Combined Units</p>';
        html += `<p class="text-3xl font-bold text-harken-accent">${combinedUnits}</p>`;
        html += '</div>';
        html += '<div>';
        html += '<p class="text-sm text-gray-600 mb-1">Combined Square Footage</p>';
        html += `<p class="text-3xl font-bold text-harken-accent">${combinedSF.toLocaleString()} SF</p>`;
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '</div>';
        
        container.innerHTML = html;
    }

    // Editable table renderer with auto-calculation
    function renderEditableTable(field, fieldIndex) {
        let html = '<div class="mb-6">';
        html += `<label class="block text-sm font-medium text-gray-700 mb-3">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
        
        html += `<div class="overflow-x-auto border border-gray-300 rounded-lg">`;
        html += `<table class="w-full editable-table" id="table-${fieldIndex}">`;
        
        // Table header
        html += `<thead class="bg-gray-100 border-b-2 border-gray-300">`;
        html += `<tr>`;
        field.columns.forEach(col => {
            html += `<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider" style="width: ${col.width || 'auto'}">${col.label}</th>`;
        });
        html += `<th class="px-4 py-3 w-12"></th>`; // Delete column
        html += `</tr>`;
        html += `</thead>`;
        
        // Table body
        html += `<tbody class="bg-white divide-y divide-gray-200" id="tbody-${fieldIndex}">`;
        // Render one default row
        html += renderTableRow(field.columns, fieldIndex, 0);
        html += `</tbody>`;
        
        // Total row
        if (field.showTotals) {
            html += `<tfoot class="bg-harken-accent/10 border-t-2 border-harken-accent">`;
            html += `<tr>`;
            field.columns.forEach((col, colIndex) => {
                if (colIndex === 0) {
                    html += `<td class="px-4 py-3 text-sm font-bold text-harken-dark">Total</td>`;
                } else if (field.totalRow && field.totalRow[col.key]) {
                    html += `<td class="px-4 py-3 text-sm font-bold text-harken-dark" id="total-${fieldIndex}-${col.key}">0</td>`;
                } else {
                    html += `<td class="px-4 py-3"></td>`;
                }
            });
            html += `<td class="px-4 py-3"></td>`;
            html += `</tr>`;
            html += `</tfoot>`;
        }
        
        html += `</table>`;
        html += `</div>`;
        
        // Add row button
        html += `<button type="button" class="mt-3 px-4 py-2 text-sm bg-white border-2 border-dashed border-harken-accent text-harken-accent rounded-lg hover:bg-harken-accent/5 flex items-center" onclick="addTableRow(${fieldIndex}, ${JSON.stringify(field.columns).replace(/"/g, '&quot;')}, ${field.showTotals || false}, ${JSON.stringify(field.totalRow || {}).replace(/"/g, '&quot;')})">`;
        html += `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>`;
        html += `</svg>`;
        html += `${field.addRowText || '+ Add Row'}`;
        html += `</button>`;
        
        html += '</div>';
        return html;
    }

    // Render a single table row
    function renderTableRow(columns, tableIndex, rowIndex) {
        let html = `<tr class="hover:bg-blue-50 ${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}" data-row="${rowIndex}">`;
        
        columns.forEach((col, colIndex) => {
            html += `<td class="px-4 py-2">`;
            if (col.type === 'calculated') {
                html += `<input type="text" readonly class="w-full px-2 py-1 text-sm border border-gray-200 rounded bg-gray-50 cursor-not-allowed text-gray-600" data-col="${col.key}" data-formula="${col.formula || ''}" data-format="${col.format || ''}" value="">`;
            } else if (col.type === 'number') {
                html += `<input type="number" step="0.01" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-harken-accent focus:border-transparent" data-col="${col.key}" onblur="calculateRow(${tableIndex}, ${rowIndex})">`;
            } else {
                html += `<input type="text" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-harken-accent focus:border-transparent" data-col="${col.key}">`;
            }
            html += `</td>`;
        });
        
        // Delete button
        html += `<td class="px-4 py-2 text-center">`;
        html += `<button type="button" class="text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteTableRow(${tableIndex}, ${rowIndex})">`;
        html += `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>`;
        html += `</svg>`;
        html += `</button>`;
        html += `</td>`;
        
        html += `</tr>`;
        return html;
    }

    // Add a new row to the table
    function addTableRow(tableIndex, columns, showTotals, totalRow) {
        const tbody = document.getElementById(`tbody-${tableIndex}`);
        if (!tbody) return;
        
        const rowIndex = tbody.querySelectorAll('tr').length;
        const newRow = document.createElement('tr');
        newRow.className = `hover:bg-blue-50 ${rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
        newRow.setAttribute('data-row', rowIndex);
        newRow.innerHTML = renderTableRow(columns, tableIndex, rowIndex).replace(/<\/?tr[^>]*>/g, '');
        
        tbody.appendChild(newRow);
        
        // Recalculate totals
        if (showTotals) {
            calculateTableTotals(tableIndex, columns, totalRow);
        }
    }

    // Delete a row from the table
    function deleteTableRow(tableIndex, rowIndex) {
        const tbody = document.getElementById(`tbody-${tableIndex}`);
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        if (rows.length <= 1) {
            alert('Cannot delete the last row. At least one row is required.');
            return;
        }
        
        rows[rowIndex].remove();
        
        // Reindex rows and alternate colors
        tbody.querySelectorAll('tr').forEach((row, idx) => {
            row.setAttribute('data-row', idx);
            row.className = `hover:bg-blue-50 ${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`;
            
            // Update onclick for delete buttons
            const deleteBtn = row.querySelector('button[onclick*="deleteTableRow"]');
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', `deleteTableRow(${tableIndex}, ${idx})`);
            }
            
            // Update onblur for number inputs
            row.querySelectorAll('input[type="number"]').forEach(input => {
                input.setAttribute('onblur', `calculateRow(${tableIndex}, ${idx})`);
            });
        });
        
        // Recalculate totals
        const table = document.getElementById(`table-${tableIndex}`);
        if (table && table.querySelector('tfoot')) {
            const columnsData = JSON.parse(table.getAttribute('data-columns') || '[]');
            const totalRowData = JSON.parse(table.getAttribute('data-total-row') || '{}');
            calculateTableTotals(tableIndex, columnsData, totalRowData);
        }
    }

    // Calculate values for a single row
    function calculateRow(tableIndex, rowIndex) {
        const tbody = document.getElementById(`tbody-${tableIndex}`);
        if (!tbody) return;
        
        const row = tbody.querySelector(`tr[data-row="${rowIndex}"]`);
        if (!row) return;
        
        // Get all inputs in the row
        const inputs = {};
        row.querySelectorAll('input[data-col]').forEach(input => {
            const col = input.getAttribute('data-col');
            inputs[col] = parseFloat(input.value) || 0;
        });
        
        // Calculate formula fields
        row.querySelectorAll('input[data-formula]').forEach(input => {
            const formula = input.getAttribute('data-formula');
            const format = input.getAttribute('data-format');
            
            if (formula) {
                try {
                    // Replace variable names with values
                    let evalFormula = formula;
                    Object.keys(inputs).forEach(key => {
                        evalFormula = evalFormula.replace(new RegExp(key, 'g'), inputs[key]);
                    });
                    
                    const result = eval(evalFormula);
                    
                    if (format === 'percent') {
                        input.value = isNaN(result) ? '0%' : result.toFixed(0) + '%';
                    } else {
                        input.value = isNaN(result) ? '0' : result.toFixed(2);
                    }
                } catch (e) {
                    input.value = '0';
                }
            }
        });
        
        // Recalculate totals
        const table = document.getElementById(`table-${tableIndex}`);
        if (table && table.querySelector('tfoot')) {
            const columnsData = JSON.parse(table.getAttribute('data-columns') || '[]');
            const totalRowData = JSON.parse(table.getAttribute('data-total-row') || '{}');
            calculateTableTotals(tableIndex, columnsData, totalRowData);
        }
    }

    // Calculate table totals
    function calculateTableTotals(tableIndex, columns, totalRow) {
        const tbody = document.getElementById(`tbody-${tableIndex}`);
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        
        columns.forEach(col => {
            if (totalRow[col.key]) {
                let total = 0;
                let weightedNumerator = 0;
                let weightedDenominator = 0;
                
                rows.forEach(row => {
                    const input = row.querySelector(`input[data-col="${col.key}"]`);
                    if (input) {
                        let value = input.value;
                        
                        // Strip % for percentage values
                        if (value.includes('%')) {
                            value = value.replace('%', '');
                        }
                        
                        const numValue = parseFloat(value) || 0;
                        
                        if (totalRow[col.key] === 'sum') {
                            total += numValue;
                        } else if (totalRow[col.key] === 'weighted-avg') {
                            // For weighted average of percentages, use unit size as weight
                            const unitSizeInput = row.querySelector('input[data-col="unitSize"]');
                            const unitSize = parseFloat(unitSizeInput?.value) || 0;
                            
                            if (col.key === 'pctShop') {
                                const shopSF = row.querySelector('input[data-col="shopSF"]');
                                weightedNumerator += parseFloat(shopSF?.value) || 0;
                            } else if (col.key === 'pctOffice') {
                                const officeSF = row.querySelector('input[data-col="officeSF"]');
                                weightedNumerator += parseFloat(officeSF?.value) || 0;
                            }
                            weightedDenominator += unitSize;
                        }
                    }
                });
                
                const totalCell = document.getElementById(`total-${tableIndex}-${col.key}`);
                if (totalCell) {
                    if (totalRow[col.key] === 'weighted-avg') {
                        const avgValue = weightedDenominator > 0 ? (weightedNumerator / weightedDenominator) * 100 : 0;
                        totalCell.textContent = avgValue.toFixed(0) + '%';
                    } else {
                        totalCell.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                    }
                }
            }
        });
    }

    // Form field renderer
    function renderField(field, index) {
        let html = '<div class="mb-4">';
        
        if (field.type === 'building-tabs-header') {
            html = '<div id="building-tabs"></div>';
            return html;
        }
        
        if (field.type === 'summary-validation') {
            html = '<div id="building-summary"></div>';
            return html;
        }
        
        if (field.type === 'heading') {
            html += `<h3 class="text-lg font-semibold text-harken-dark mt-6 mb-3 pb-2 border-b-2 ${field.highlight ? 'border-red-400 bg-red-50 -mx-4 px-4 py-2' : 'border-gray-200'}">${field.label}</h3>`;
            html += '</div>';
            return html;
        }
        
        if (field.type === 'text' || field.type === 'tel' || field.type === 'number') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}${field.autoFill ? ' <span class="text-xs text-harken-text font-normal">(Auto-filled from your profile)</span>' : ''}</label>`;
            if (field.type === 'number' && field.unit) {
                html += `<div class="flex space-x-4">`;
                let defaultValue = '';
                if (field.defaultValue && field.defaultValue.startsWith('loggedInUser.')) {
                    const key = field.defaultValue.replace('loggedInUser.', '');
                    defaultValue = loggedInUser[key] || '';
                } else if (field.defaultValue) {
                    defaultValue = field.defaultValue;
                }
                html += `<input type="number" ${field.step ? `step="${field.step}"` : ''} ${field.min ? `min="${field.min}"` : ''} ${field.readonly ? 'readonly' : ''} value="${defaultValue}" placeholder="${field.placeholder || ''}" class="w-32 px-4 py-2 border border-gray-300 rounded-lg ${field.readonly ? 'bg-gray-50 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
                html += `<select class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
                field.unitOptions.forEach(opt => {
                    html += `<option>${opt}</option>`;
                });
                html += `</select></div>`;
            } else {
                let defaultValue = '';
                if (field.defaultValue && field.defaultValue.startsWith('loggedInUser.')) {
                    const key = field.defaultValue.replace('loggedInUser.', '');
                    defaultValue = loggedInUser[key] || '';
                } else if (field.defaultValue) {
                    defaultValue = field.defaultValue;
                }
                html += `<input type="${field.type}" ${field.readonly ? 'readonly' : ''} value="${defaultValue}" placeholder="${field.placeholder || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg ${field.readonly ? 'bg-gray-50 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            }
            if (field.note) {
                html += `<p class="text-xs text-gray-600 mt-1"><strong>${field.note}.</strong></p>`;
            } else if (!field.readonly) {
                html += `<p class="text-xs text-gray-500 mt-1">${field.description || ''}</p>`;
            } else if (field.autoFill) {
                html += `<p class="text-xs text-harken-text mt-1">This information is automatically filled from your logged-in profile.</p>`;
            }
        } else if (field.type === 'textarea') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<textarea rows="${field.rows || 3}" placeholder="${field.placeholder || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent"></textarea>`;
            if (field.note) {
                html += `<p class="text-xs text-gray-600 mt-1"><strong>${field.note}.</strong></p>`;
            }
        } else if (field.type === 'date') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<input type="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            if (field.note) {
                html += `<p class="text-xs text-gray-600 mt-1"><strong>${field.note}.</strong></p>`;
            }
        } else if (field.type === 'select') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            html += `<option value="">Select...</option>`;
            field.options.forEach(opt => {
                html += `<option>${opt}</option>`;
            });
            html += `</select>`;
        } else if (field.type === 'select-or-custom') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" id="select-custom-${index}" onchange="toggleCustomInput(${index})">`;
            html += `<option value="">Select...</option>`;
            field.options.forEach(opt => {
                html += `<option value="${opt}">${opt}</option>`;
            });
            html += `</select>`;
            html += `<input type="text" id="custom-input-${index}" placeholder="Enter custom value" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent mt-2" style="display: none;">`;
        } else if (field.type === 'select-with-add') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<div class="flex gap-2">`;
            html += `<select class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" id="select-${index}">`;
            html += `<option value="">Select ${field.label.toLowerCase()}...</option>`;
            if (field.options && field.options.length > 0) {
                field.options.forEach(opt => {
                    html += `<option value="${opt}">${opt}</option>`;
                });
            }
            html += `</select>`;
            html += `<button type="button" onclick="openAddClientModal()" class="px-4 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light whitespace-nowrap flex items-center">`;
            html += `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>`;
            html += `</svg>`;
            html += `${field.addNewLabel || 'Add New'}`;
            html += `</button>`;
            html += `</div>`;
        } else if (field.type === 'checkbox') {
            html += `<label class="flex items-center">`;
            html += `<input type="checkbox" class="mr-2 h-4 w-4 text-harken-accent">`;
            html += `<span class="text-sm text-gray-700">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</span>`;
            html += `</label>`;
        } else if (field.type === 'checkbox-group') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-3">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<div class="space-y-3">`;
            field.options.forEach(opt => {
                html += `<label class="flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50">`;
                html += `<input type="checkbox" class="mt-1 mr-3 h-4 w-4 text-harken-accent">`;
                html += `<div class="flex-1">`;
                html += `<div class="font-medium text-gray-900">${opt.label}</div>`;
                if (opt.description) {
                    html += `<p class="text-sm text-gray-600 mt-1">${opt.description}</p>`;
                }
                html += `</div></label>`;
            });
            html += `</div>`;
        } else if (field.type === 'currency') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<div class="relative">`;
            html += `<span class="absolute left-3 top-2 text-gray-500">$</span>`;
            html += `<input type="text" placeholder="0.00" class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            html += `</div>`;
        } else if (field.type === 'repeater') {
            html += `<div class="border border-gray-200 rounded-lg p-4 mb-4">`;
            html += `<div class="flex items-center justify-between mb-4">`;
            html += `<h4 class="text-sm font-semibold text-gray-700">${field.label}</h4>`;
            html += `<button type="button" class="text-sm text-harken-accent hover:text-harken-accent-light">+ Add</button>`;
            html += `</div>`;
            html += `<div class="space-y-4" id="repeater-${index}">`;
            field.fields.forEach(subField => {
                html += renderField(subField, `${index}-${field.fields.indexOf(subField)}`);
            });
            html += `</div></div>`;
        } else if (field.type === 'editable-select') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent mb-2" id="editable-select-${index}" onchange="populateEditableText(${index})">`;
            html += `<option value="">Select template...</option>`;
            field.options.forEach(opt => {
                html += `<option value="${opt}">${opt}</option>`;
            });
            html += `</select>`;
            html += `<textarea id="editable-text-${index}" rows="3" placeholder="${field.placeholder || 'Select a template above to edit'}" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent"></textarea>`;
            if (field.note) {
                html += `<p class="text-xs text-gray-600 mt-1">${field.note}</p>`;
            }
        } else if (field.type === 'collapsible-boilerplate') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<div class="border border-gray-300 rounded-lg bg-gray-50">`;
            html += `<button type="button" class="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-100 rounded-lg" onclick="toggleBoilerplate(${index})">`;
            html += `<span class="text-sm font-medium text-gray-700">Standard Environmental Disclaimer</span>`;
            html += `<svg id="boilerplate-icon-${index}" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>`;
            html += `</svg>`;
            html += `</button>`;
            html += `<div id="boilerplate-content-${index}" class="px-4 pb-4 text-sm text-gray-700 leading-relaxed hidden">`;
            html += field.content.split('\n\n').map(para => `<p class="mb-3">${para}</p>`).join('');
            html += `</div>`;
            html += `</div>`;
            html += `<p class="text-xs text-gray-500 mt-1">This is standard boilerplate text. Click to expand/collapse.</p>`;
        } else if (field.type === 'accordion-section') {
            html += renderAccordionSection(field, index);
        } else if (field.type === 'editable-table') {
            html += renderEditableTable(field, index);
        } else if (field.type === 'repeatable-group') {
            html += `<label class="block text-sm font-medium text-gray-700 mb-3">${field.label}${field.required ? ' <span class="text-red-500 ml-1">*</span>' : ''}</label>`;
            html += `<div class="border border-gray-300 rounded-lg overflow-hidden">`;
            html += `<div class="space-y-3 p-4 bg-white" id="repeatable-container-${index}">`;
            // Render first group by default
            html += `<div class="repeatable-item border border-gray-200 rounded-lg p-4 bg-gray-50">`;
            html += `<div class="flex items-center justify-between mb-3">`;
            html += `<span class="text-sm font-semibold text-harken-dark">Parcel 1</span>`;
            html += `<button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeRepeatableItem(this)">`;
            html += `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>`;
            html += `</svg>`;
            html += `</button>`;
            html += `</div>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-3">`;
            field.fields.forEach((subField, subIndex) => {
                html += `<div>`;
                html += `<label class="block text-xs font-medium text-gray-700 mb-1">${subField.label}${subField.required ? ' <span class="text-red-500">*</span>' : ''}</label>`;
                if (subField.type === 'number') {
                    html += `<input type="number" ${subField.step ? `step="${subField.step}"` : ''} ${subField.readonly ? 'readonly' : ''} placeholder="${subField.placeholder || ''}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded ${subField.readonly ? 'bg-gray-100 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
                } else {
                    html += `<input type="text" ${subField.readonly ? 'readonly' : ''} placeholder="${subField.placeholder || ''}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded ${subField.readonly ? 'bg-gray-100 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
                }
                if (subField.note) {
                    html += `<p class="text-xs text-gray-500 mt-1">${subField.note}</p>`;
                }
                html += `</div>`;
            });
            html += `</div></div>`;
            html += `</div>`;
            html += `<div class="px-4 pb-4 bg-white">`;
            html += `<button type="button" class="w-full px-4 py-2 text-sm bg-white border-2 border-dashed border-harken-accent text-harken-accent rounded-lg hover:bg-harken-accent/5 flex items-center justify-center" onclick="addRepeatableItem(${index}, ${JSON.stringify(field.fields).replace(/"/g, '&quot;')})">`;
            html += `<svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>`;
            html += `</svg>`;
            html += `${field.addButtonText || '+ Add Item'}`;
            html += `</button>`;
            html += `</div>`;
            
            // Add totals section if showTotals is true
            if (field.showTotals) {
                html += `<div class="border-t-2 border-gray-300 bg-blue-50 px-4 py-4">`;
                html += `<div class="flex items-center justify-between">`;
                html += `<div class="flex items-baseline gap-2">`;
                html += `<span class="text-sm font-bold text-harken-dark">Total:</span>`;
                html += `<span class="text-sm font-semibold text-gray-700">5.727 acres</span>`;
                html += `</div>`;
                html += `<div class="flex items-center gap-2">`;
                html += `<span class="text-lg font-bold text-harken-dark">=</span>`;
                html += `<span class="text-sm font-semibold text-gray-700">249,487 sf</span>`;
                html += `</div>`;
                html += `</div>`;
                html += `<p class="text-xs text-gray-600 mt-2">Auto-calculated from all parcels above</p>`;
                html += `</div>`;
            }
            html += `</div>`;
        }
        
        html += '</div>';
        return html;
    }

    // Render form content
    // Template selection state
    let selectedTemplate = null;

    // Update progress bar
    function updateProgressBar(stepKey) {
        const steps = [
            { key: 'template-selection', num: 1 },
            { key: 'appraisal-setup', num: 2 },
            { key: 'overview', num: 3 },
            { key: 'sales-approach', num: 4 }, // This will be set when entering main wizard
            { key: 'exhibits', num: 5 },
            { key: 'review', num: 6 }
        ];
        
        let currentStepNum = 1;
        if (stepKey === 'template-selection') {
            currentStepNum = 1;
        } else if (stepKey === 'appraisal-setup') {
            currentStepNum = 2;
        } else if (stepKey === 'overview') {
            currentStepNum = 3;
        } else if (stepKey && stepKey.startsWith('1.') || stepKey && stepKey.startsWith('2.') || stepKey && stepKey.startsWith('3.')) {
            // Main wizard steps - show step 4 (Sales Approach)
            currentStepNum = 4;
        } else if (stepKey === 'review') {
            currentStepNum = 6;
        }
        
        // Update all progress steps
        for (let i = 1; i <= 6; i++) {
            const stepEl = document.getElementById(`progress-step-${i}`);
            const labelEl = document.getElementById(`progress-label-${i}`);
            const connectorEl = stepEl?.nextElementSibling?.nextElementSibling;
            
            if (stepEl && labelEl) {
                if (i < currentStepNum) {
                    // Completed steps
                    stepEl.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-green-500 border-green-500 text-white';
                    stepEl.innerHTML = '<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                    labelEl.className = 'ml-3 text-sm font-medium text-green-600';
                    if (connectorEl) {
                        connectorEl.className = 'w-16 h-0.5 bg-green-500';
                    }
                } else if (i === currentStepNum) {
                    // Current step
                    stepEl.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-harken-accent border-harken-accent text-white';
                    stepEl.textContent = i;
                    labelEl.className = 'ml-3 text-sm font-medium text-harken-accent';
                    if (connectorEl) {
                        connectorEl.className = 'w-16 h-0.5 bg-gray-300';
                    }
                } else {
                    // Future steps
                    stepEl.className = 'w-10 h-10 rounded-full flex items-center justify-center text-sm font-semibold border-2 transition-all bg-white border-gray-300 text-gray-400';
                    stepEl.textContent = i;
                    labelEl.className = 'ml-3 text-sm font-medium text-gray-400';
                    if (connectorEl) {
                        connectorEl.className = 'w-16 h-0.5 bg-gray-300';
                    }
                }
            }
        }
    }

    // Render Template Selection Screen
    function renderTemplateSelection() {
        // Templates for each property type
        const allTemplates = {
            commercial: [
                {
                    id: 'commercial-standard',
                    name: 'Commercial Appraisal - Standard',
                    tags: ['COMMERCIAL', 'APPRAISAL'],
                    systemTag: true,
                    description: 'Comprehensive commercial appraisal report with all standard sections and USPAP compliance',
                    sections: 21,
                    approaches: 'Sales, Cost, Income',
                    accounts: 73
                },
                {
                    id: 'commercial-evaluation',
                    name: 'Commercial Evaluation - Standard',
                    tags: ['COMMERCIAL', 'EVALUATION'],
                    systemTag: false,
                    description: 'Standard commercial property evaluation with income, sales, and cap rate approaches',
                    sections: 18,
                    approaches: 'Income, Sales, Cap',
                    accounts: 73
                }
            ],
            residential: [
                {
                    id: 'residential-short',
                    name: 'Residential - Short Form',
                    tags: ['RESIDENTIAL', 'APPRAISAL'],
                    systemTag: true,
                    description: 'Streamlined residential appraisal report for quick valuations',
                    sections: 15,
                    approaches: 'Sales, Cost',
                    accounts: 28
                }
            ],
            land: [
                {
                    id: 'land-uspap',
                    name: 'Land Appraisal - USPAP Compliant',
                    tags: ['LAND', 'APPRAISAL'],
                    systemTag: true,
                    description: 'Land valuation report with highest and best use analysis and USPAP compliance',
                    sections: 18,
                    approaches: 'Sales, Cost',
                    accounts: 32
                }
            ]
        };

        // Get current property type or default to commercial
        const currentPropertyType = assignmentContext.propertyType || 'commercial';
        const templates = allTemplates[currentPropertyType] || allTemplates.commercial;

        let html = '';
        
        // White Card Container
        html += `<div style="background: white; border-radius: 8px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px;">`;
        
        // Property Type Tabs
        html += `<div style="display: flex; gap: 8px; margin-bottom: 32px; border-bottom: 2px solid #e0e0e0;">`;
        const propertyTypes = [
            { id: 'commercial', label: 'Commercial', icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>' },
            { id: 'residential', label: 'Residential', icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>' },
            { id: 'land', label: 'Land', icon: '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;"><path d="M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z"/></svg>' }
        ];
        
        propertyTypes.forEach(pt => {
            const isActive = currentPropertyType === pt.id;
            html += `<button style="padding: 12px 24px; border: none; background: ${isActive ? '#f0fbfd' : 'transparent'}; color: ${isActive ? '#0da1c7' : '#687F8B'}; font-size: 14px; font-weight: 600; cursor: pointer; border-bottom: 3px solid ${isActive ? '#0da1c7' : 'transparent'}; margin-bottom: -2px; display: flex; align-items: center;" onclick="switchTemplatePropertyType('${pt.id}')">
                ${pt.icon}${pt.label}
            </button>`;
        });
        html += `</div>`;
        
        // Title
        html += `<div style="font-size: 20px; font-weight: 700; color: #1c3643; margin-bottom: 12px;">Select Report Template</div>`;
        html += `<div style="font-size: 14px; color: #687F8B; margin-bottom: 32px;">Choose a template that determines which sections and fields will appear in your final report. You can customize this later if needed.</div>`;
        
        // Info Box
        html += `<div style="background: #e3f2fd; border-left: 4px solid #2196F3; padding: 16px; border-radius: 4px; margin-bottom: 24px;">`;
        html += `<div style="font-size: 14px; font-weight: 700; color: #1565c0; margin-bottom: 8px;"><svg style="width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 8px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>What are report templates?</div>`;
        html += `<div style="font-size: 13px; color: #1976d2; line-height: 1.6;">Report templates allow you to control what appears in your final PDF. Your administrator has created pre-configured templates for different scenarios (bank submissions, quick valuations, etc.). Select the one that best fits your needs.</div>`;
        html += `</div>`;
        
        // Template Grid
        html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px;">`;
        templates.forEach(template => {
            const isSelected = selectedTemplate === template.id;
            html += `<div style="border: 2px solid ${isSelected ? '#0da1c7' : '#e0e0e0'}; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; background: ${isSelected ? 'linear-gradient(to bottom, #e8f5f7 0%, white 100%)' : 'white'};" onclick="selectTemplate('${template.id}')">`;
            
            // Header
            html += `<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">`;
            html += `<div style="font-size: 16px; font-weight: 700; color: #1c3643;">${template.name}</div>`;
            if (template.systemTag) {
                html += `<div style="background: #0da1c7; color: white; font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 4px;">SYSTEM</div>`;
            }
            html += `</div>`;
            
            // Description
            html += `<div style="font-size: 13px; color: #687F8B; line-height: 1.6; margin-bottom: 12px;">${template.description}</div>`;
            
            // Meta Info with SVG icons
            html += `<div style="display: flex; justify-content: space-between; font-size: 12px; color: #687F8B; margin-bottom: 12px;">`;
            html += `<span><svg style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>${template.sections} sections</span>`;
            html += `<span><svg style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>${template.accounts} accounts</span>`;
            html += `</div>`;
            html += `<div style="font-size: 12px; color: #687F8B; margin-bottom: 12px;"><svg style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin-right: 4px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>${template.approaches}</div>`;
            
            // Tags
            html += `<div style="display: flex; gap: 8px; flex-wrap: wrap;">`;
            template.tags.forEach(tag => {
                const bgColor = tag === 'COMMERCIAL' || tag === 'RESIDENTIAL' || tag === 'LAND' ? '#4caf50' : (tag === 'APPRAISAL' ? '#2196F3' : '#ff9800');
                html += `<span style="background: ${bgColor}; color: white; font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 4px;">${tag}</span>`;
            });
            html += `</div>`;
            
            html += `</div>`;
        });
        html += `</div>`;
        
        html += `</div>`;
        return html;
    }

    // Switch property type in template selection
    function switchTemplatePropertyType(propertyType) {
        assignmentContext.propertyType = propertyType;
        selectedTemplate = null; // Reset selection when switching types
        loadPreWizardStep(1);
    }

    // Show/Hide Pre-Wizard Container
    function showPreWizard() {
        document.getElementById('pre-wizard-container').classList.remove('hidden');
        document.getElementById('wizard-sidebar').style.display = 'none';
        document.getElementById('wizard-main').style.display = 'none';
    }

    function hidePreWizard() {
        document.getElementById('pre-wizard-container').classList.add('hidden');
        document.getElementById('wizard-sidebar').style.display = 'block';
        document.getElementById('wizard-main').style.display = 'flex';
        document.getElementById('help-sidebar').style.display = 'block';
    }

    // Load Pre-Wizard Step
    function loadPreWizardStep(step) {
        preWizardStep = step;
        const contentArea = document.getElementById('pre-wizard-content');
        const backBtn = document.getElementById('pre-back-btn');
        const continueBtn = document.getElementById('pre-continue-btn');
        
        // Update progress bar
        for (let i = 1; i <= 3; i++) {
            const stepEl = document.getElementById(`pre-progress-step-${i}`);
            const labelEl = document.getElementById(`pre-progress-label-${i}`);
            
            if (i < step) {
                // Completed
                stepEl.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: #2e7d32; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;';
                stepEl.textContent = '✓';
                labelEl.style.cssText = 'font-size: 14px; font-weight: 600; color: #1c3643;';
            } else if (i === step) {
                // Current
                stepEl.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: #0da1c7; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;';
                stepEl.textContent = i;
                labelEl.style.cssText = 'font-size: 14px; font-weight: 600; color: #1c3643;';
            } else {
                // Future
                stepEl.style.cssText = 'width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; color: #687F8B; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;';
                stepEl.textContent = i;
                labelEl.style.cssText = 'font-size: 14px; font-weight: 600; color: #687F8B;';
            }
        }
        
        // Show/hide back button
        backBtn.style.display = step === 1 ? 'none' : 'flex';
        
        // Render content
        if (step === 1) {
            contentArea.innerHTML = renderTemplateSelection();
            continueBtn.disabled = !selectedTemplate;
        } else if (step === 2) {
            contentArea.innerHTML = renderAppraisalSetup();
            continueBtn.disabled = false;
        } else if (step === 3) {
            contentArea.innerHTML = renderOverview();
            continueBtn.disabled = !assignmentContext.subType;
        }
    }

    // Handle Pre-Wizard Navigation
    function handlePreWizardContinue() {
        if (preWizardStep === 1) {
            if (!selectedTemplate) {
                alert('Please select a template before continuing.');
                return;
            }
            loadPreWizardStep(2);
        } else if (preWizardStep === 2) {
            if (!assignmentContext.propertyType) {
                alert('Please select a property type before continuing.');
                return;
            }
            const clientSelect = document.getElementById('setup-client-select');
            if (!clientSelect || !clientSelect.value) {
                alert('Please select a client before continuing.');
                return;
            }
            loadPreWizardStep(3);
        } else if (preWizardStep === 3) {
            if (!assignmentContext.subType) {
                alert('Please select a property sub-type before continuing.');
                return;
            }
            // Transition to main wizard
            hidePreWizard();
            loadStep('1.1');
        }
    }

    function handlePreWizardBack() {
        if (preWizardStep > 1) {
            loadPreWizardStep(preWizardStep - 1);
        }
    }

    // Select template function
    function selectTemplate(templateId) {
        selectedTemplate = templateId;
        // Update visual selection
        document.querySelectorAll('.template-card').forEach(card => {
            card.classList.remove('border-harken-accent', 'bg-harken-accent/5');
            card.classList.add('border-gray-200');
        });
        const selectedCard = document.querySelector(`[data-template-id="${templateId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('border-harken-accent', 'bg-harken-accent/5');
            selectedCard.classList.remove('border-gray-200');
        }
        // Enable continue button
        const continueBtn = document.getElementById('continue-btn');
        if (continueBtn) {
            continueBtn.disabled = false;
            continueBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    // Render Appraisal Setup Screen
    function renderAppraisalSetup() {
        let html = '';
        html += `<div class="max-w-6xl mx-auto">`;
        
        // Title
        html += `<h1 class="text-3xl font-bold text-gray-900 mb-8">Appraisal Setup</h1>`;
        
        // Section 1: Basic Information
        html += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">`;
        html += `<div class="flex items-center mb-4">`;
        html += `<svg class="w-6 h-6 text-harken-accent mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>`;
        html += `<h2 class="text-xl font-semibold text-gray-900">Basic Information</h2>`;
        html += `</div>`;
        
        // Property Type Cards
        html += `<div class="mb-6">`;
        html += `<label class="block text-sm font-medium text-gray-700 mb-3">Property Type *</label>`;
        html += `<div class="grid grid-cols-3 gap-4">`;
        
        const propertyTypes = [
            { type: 'commercial', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4', label: 'Commercial', description: 'Industrial, Office, Retail, Medical, Mixed-Use, Specialized' },
            { type: 'residential', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6', label: 'Residential', description: 'Single-Family, Multi-Family, Condo, Manufactured Housing' },
            { type: 'land', icon: 'M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7', label: 'Land', description: 'Finished Lot, Entitled Land, Agricultural, Transitional, Special Use' }
        ];
        
        propertyTypes.forEach(pt => {
            const isSelected = assignmentContext.propertyType === pt.type;
            html += `<button type="button" class="property-type-setup-btn p-6 border-2 rounded-lg transition-all text-left ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent hover:bg-harken-accent/5'}" data-type="${pt.type}" onclick="selectPropertyTypeSetup('${pt.type}')">`;
            html += `<svg class="w-12 h-12 text-harken-accent mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${pt.icon}" />`;
            html += `</svg>`;
            html += `<h3 class="text-lg font-semibold text-harken-dark mb-2">${pt.label}</h3>`;
            html += `<p class="text-sm text-harken-text">${pt.description}</p>`;
            html += `</button>`;
        });
        
        html += `</div>`;
        html += `</div>`;
        
        // Client Selection
        html += `<div class="mb-4">`;
        html += `<label class="block text-sm font-medium text-gray-700 mb-2">Client *</label>`;
        html += `<div class="flex gap-2">`;
        html += `<select class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-harken-accent focus:border-transparent" id="setup-client-select">`;
        html += `<option value="">Search for client...</option>`;
        html += `<option value="acme">Acme Corporation</option>`;
        html += `<option value="smith">Smith Realty Group</option>`;
        html += `<option value="johnson">Johnson Development LLC</option>`;
        html += `<option value="metro">Metro Properties Inc</option>`;
        html += `</select>`;
        html += `<button type="button" onclick="openAddClientModal()" class="px-4 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light whitespace-nowrap flex items-center">`;
        html += `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>`;
        html += `</svg>`;
        html += `Add New`;
        html += `</button>`;
        html += `</div>`;
        html += `</div>`;
        
        html += `</div>`;
        
        // Section 2: Property Status & Scenario Triggers (NEW)
        html += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">`;
        html += `<div class="flex items-center mb-4">`;
        html += `<svg class="w-6 h-6 text-harken-accent mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`;
        html += `<h2 class="text-xl font-semibold text-gray-900">Property Status</h2>`;
        html += `</div>`;
        html += `<p class="text-gray-600 mb-4">These questions determine which valuation scenarios are required for your appraisal.</p>`;
        
        // Property Status Cards
        html += `<div class="mb-6">`;
        html += `<label class="block text-sm font-medium text-gray-700 mb-3">What is the current status of the property? *</label>`;
        html += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">`;
        
        propertyStatusOptions.forEach(opt => {
            const isSelected = assignmentContext.propertyStatus === opt.value;
            html += `<button type="button" class="property-status-btn p-4 border-2 rounded-lg transition-all text-left ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent/50'}" onclick="updateScenarioTrigger('propertyStatus', '${opt.value}')">`;
            html += `<svg class="w-8 h-8 text-harken-accent mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${opt.icon}" />`;
            html += `</svg>`;
            html += `<h4 class="font-semibold text-sm text-harken-dark">${opt.label}</h4>`;
            html += `<p class="text-xs text-harken-text mt-1">${opt.description}</p>`;
            html += `</button>`;
        });
        
        html += `</div>`;
        html += `</div>`;
        
        // Planned Changes (only show for existing properties)
        if (assignmentContext.propertyStatus === 'existing' || assignmentContext.propertyStatus === 'recently_completed') {
            html += `<div class="mb-6">`;
            html += `<label class="block text-sm font-medium text-gray-700 mb-3">Are there any planned improvements or renovations?</label>`;
            html += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">`;
            
            plannedChangesOptions.forEach(opt => {
                const isSelected = assignmentContext.plannedChanges === opt.value;
                html += `<button type="button" class="p-3 border-2 rounded-lg transition-all text-left ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent/50'}" onclick="updateScenarioTrigger('plannedChanges', '${opt.value}')">`;
                html += `<h4 class="font-semibold text-sm text-harken-dark">${opt.label}</h4>`;
                html += `<p class="text-xs text-harken-text mt-1">${opt.description}</p>`;
                html += `</button>`;
            });
            
            html += `</div>`;
            html += `</div>`;
        }
        
        // Occupancy Status (only for commercial or multi-family)
        if (assignmentContext.propertyType === 'commercial' || shouldShowOccupancyQuestion()) {
            html += `<div class="mb-6">`;
            html += `<label class="block text-sm font-medium text-gray-700 mb-3">What is the current occupancy status?</label>`;
            html += `<div class="grid grid-cols-2 lg:grid-cols-4 gap-3">`;
            
            occupancyStatusOptions.forEach(opt => {
                const isSelected = assignmentContext.occupancyStatus === opt.value;
                html += `<button type="button" class="p-3 border-2 rounded-lg transition-all text-left ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent/50'}" onclick="updateScenarioTrigger('occupancyStatus', '${opt.value}')">`;
                html += `<h4 class="font-semibold text-sm text-harken-dark">${opt.label}</h4>`;
                html += `<p class="text-xs text-harken-text mt-1">${opt.description}</p>`;
                html += `</button>`;
            });
            
            html += `</div>`;
            html += `</div>`;
        }
        
        // Loan Purpose
        html += `<div class="mb-4">`;
        html += `<label class="block text-sm font-medium text-gray-700 mb-3">What is the intended use of this appraisal?</label>`;
        html += `<div class="grid grid-cols-2 lg:grid-cols-5 gap-3">`;
        
        loanPurposeOptions.forEach(opt => {
            const isSelected = assignmentContext.loanPurpose === opt.value;
            html += `<button type="button" class="p-3 border-2 rounded-lg transition-all text-left ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent/50'}" onclick="updateScenarioTrigger('loanPurpose', '${opt.value}')">`;
            html += `<h4 class="font-semibold text-sm text-harken-dark">${opt.label}</h4>`;
            html += `<p class="text-xs text-harken-text mt-1">${opt.description}</p>`;
            html += `</button>`;
        });
        
        html += `</div>`;
        html += `</div>`;
        
        html += `</div>`;
        
        // Section 3: Valuation Scenarios (Auto-configured)
        html += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">`;
        html += `<div class="flex items-center justify-between mb-4">`;
        html += `<div class="flex items-center">`;
        html += `<svg class="w-6 h-6 text-harken-accent mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>`;
        html += `<h2 class="text-xl font-semibold text-gray-900">Valuation Scenarios</h2>`;
        html += `</div>`;
        
        // Auto-configured badge
        if (assignmentContext.propertyStatus) {
            html += `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">`;
            html += `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
            html += `Auto-configured`;
            html += `</span>`;
        }
        
        html += `</div>`;
        html += `</div>`;
        html += `<p class="text-gray-600 mb-6">Based on your selections above, these scenarios are recommended. You can customize approaches for each or add additional scenarios.</p>`;
        
        // Render Scenarios
        if (!assignmentContext.scenarios || assignmentContext.scenarios.length === 0) {
            assignmentContext.scenarios = [{ id: 1, name: 'As Is', nameSelect: 'As Is', customName: '', approaches: [] }];
        }
        
        assignmentContext.scenarios.forEach((scenario, index) => {
            const blockClass = scenario.isRequired ? 'required' : (scenario.isRequired === false ? 'recommended' : '');
            html += `<div class="scenario-block ${blockClass}">`;
            
            // Scenario Header with Required/Recommended Badge
            html += `<div class="flex items-center justify-between mb-3">`;
            html += `<div class="flex items-center gap-3">`;
            html += `<span class="text-lg font-semibold text-gray-900">${scenario.name || 'New Scenario'}</span>`;
            
            // Required/Recommended badge
            if (scenario.isRequired !== undefined) {
                if (scenario.isRequired) {
                    html += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800" title="${scenario.requirementSource || 'Required'}">`;
                    html += `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                    html += `Required`;
                    html += `</span>`;
                } else {
                    html += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800" title="${scenario.requirementSource || 'Recommended'}">`;
                    html += `<svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
                    html += `Recommended`;
                    html += `</span>`;
                }
            }
            html += `</div>`;
            
            // Delete button (only if more than one scenario AND not required)
            if (assignmentContext.scenarios.length > 1) {
                const canDelete = !scenario.isRequired;
                if (canDelete) {
                    html += `<button onclick="removeScenario(${scenario.id})" class="text-red-500 hover:text-red-700 p-2 transition-colors rounded-full hover:bg-red-50" title="Remove Scenario">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>`;
                } else {
                    html += `<span class="text-xs text-gray-400 italic">Cannot remove required scenario</span>`;
                }
            }
            html += `</div>`;
            
            // Requirement Source tooltip
            if (scenario.requirementSource) {
                html += `<div class="mb-4 px-3 py-2 bg-gray-50 border-l-4 ${scenario.isRequired ? 'border-red-400' : 'border-blue-400'} rounded-r text-xs text-gray-600">`;
                html += `<span class="font-medium">${scenario.isRequired ? 'Why required:' : 'Why recommended:'}</span> ${scenario.requirementSource}`;
                html += `</div>`;
            }
            
            // Scenario Name with Pill Buttons (for changing/customizing)
            html += `<div class="flex justify-between items-start mb-4 gap-4">`;
            html += `<div class="flex-1">`;
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">Change Scenario Type</label>`;
            html += `<div class="scenario-name-pills">`;
            scenarioOptions.forEach(opt => {
                const isSelected = scenario.nameSelect === opt.value;
                const pillClass = opt.value === 'Type my own' ? 'scenario-pill custom' : 'scenario-pill';
                html += `<button type="button" class="${pillClass} ${isSelected ? 'selected' : ''}" onclick="updateScenarioName(${scenario.id}, 'pill', '${opt.value}')">
                    ${opt.label}
                </button>`;
            });
            html += `</div>`;
            
            // Custom input if "Type my own" is selected
            if (scenario.nameSelect === 'Type my own' || (scenario.name && !scenarioOptions.some(opt => opt.value === scenario.name))) {
                const customVal = scenario.customName || (scenario.nameSelect === 'Type my own' ? '' : scenario.name);
                html += `<div class="scenario-custom-input">
                    <input type="text" class="w-full rounded-md border-gray-300 shadow-sm focus:border-harken-accent focus:ring focus:ring-harken-accent focus:ring-opacity-50 px-3 py-2" placeholder="Enter custom scenario name..." value="${customVal}" onchange="updateScenarioName(${scenario.id}, 'custom', this.value)">
                </div>`;
            }
            html += `</div>`;
            html += `</div>`;

            // Approaches Grid with Cards
            html += `<label class="block text-sm font-medium text-gray-700 mb-2">Select Approaches for this Scenario</label>`;
            html += `<div class="approach-grid">`;
            
            const approaches = [
                { key: 'Sales Comparison', label: 'Sales Comparison', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' },
                { key: 'Cost Approach', label: 'Cost Approach', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
                { key: 'Income Approach', label: 'Income Approach', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' }
            ];

            approaches.forEach(app => {
                const isSelected = scenario.approaches.includes(app.key);
                html += `
                <div class="approach-card ${isSelected ? 'selected' : ''}" onclick="toggleScenarioApproach(${scenario.id}, '${app.key}')">
                    <div class="check-badge">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path></svg>
                    </div>
                    <div class="approach-icon">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="${app.icon}"></path></svg>
                    </div>
                    <span class="approach-label">${app.label}</span>
                </div>`;
            });
            
            html += `</div>`; // End approach grid
            html += `</div>`; // End scenario block
        });

        // Add Scenario Button
        html += `<button onclick="addScenario()" class="btn-add-scenario">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
            Add Another Scenario
        </button>`;
        
        html += `</div>`;
        
        html += `</div>`;
        return html;
    }

    // Select property type in setup
    function selectPropertyTypeSetup(propertyType) {
        assignmentContext.propertyType = propertyType;
        // Update visual selection
        document.querySelectorAll('.property-type-setup-btn').forEach(btn => {
            btn.classList.remove('border-harken-accent', 'bg-harken-accent/5');
            btn.classList.add('border-gray-200');
        });
        const selectedBtn = document.querySelector(`[data-type="${propertyType}"]`);
        if (selectedBtn) {
            selectedBtn.classList.add('border-harken-accent', 'bg-harken-accent/5');
            selectedBtn.classList.remove('border-gray-200');
        }
    }

    // Toggle approach selection
    function toggleApproach(approachKey) {
        assignmentContext.approaches[approachKey].enabled = !assignmentContext.approaches[approachKey].enabled;
        const checkbox = document.querySelector(`[data-approach="${approachKey}"] input[type="checkbox"]`);
        if (checkbox) {
            checkbox.checked = assignmentContext.approaches[approachKey].enabled;
        }
        const card = document.querySelector(`[data-approach="${approachKey}"]`);
        if (card) {
            if (assignmentContext.approaches[approachKey].enabled) {
                card.classList.add('border-harken-accent', 'bg-harken-accent/5');
            } else {
                card.classList.remove('border-harken-accent', 'bg-harken-accent/5');
            }
        }
    }

    // Render Overview Screen (Property Sub-Type Selection)
    function renderOverview() {
        if (!assignmentContext.propertyType) {
            return '<div class="p-8 text-center"><p class="text-gray-600">Please select a property type in the Setup step first.</p></div>';
        }

        let html = '';
        html += `<div class="max-w-6xl mx-auto">`;
        
        // Title
        html += `<h1 class="text-3xl font-bold text-gray-900 mb-2">Appraisal Overview</h1>`;
        html += `<p class="text-gray-600 mb-8">Select the property sub-type that best describes the subject property.</p>`;
        
        // Sub-types based on property type
        let subtypes = [];
        if (assignmentContext.propertyType === 'commercial') {
            subtypes = [
                { id: 'industrial', label: 'Industrial', description: 'Manufacturing, production, and warehouse facilities' },
                { id: 'office', label: 'Office', description: 'Office buildings and business centers' },
                { id: 'retail', label: 'Retail', description: 'Shopping centers, stores, and retail spaces' },
                { id: 'medical', label: 'Medical', description: 'Medical offices, clinics, and healthcare facilities' },
                { id: 'hospitality', label: 'Hospitality', description: 'Hotels, motels, and lodging facilities' },
                { id: 'mixed-use', label: 'Mixed-Use', description: 'Properties combining multiple uses' },
                { id: 'warehouse', label: 'Warehouse/Storage', description: 'Storage and distribution facilities' },
                { id: 'special-purpose', label: 'Special Purpose', description: 'Unique properties with specialized uses' },
                { id: 'custom', label: 'Custom', description: 'Define your own sub-type', isCustom: true }
            ];
        } else if (assignmentContext.propertyType === 'residential') {
            subtypes = [
                { id: 'single-family', label: 'Single-Family Residence', description: 'Standalone homes designed for one family' },
                { id: 'condo', label: 'Condominium', description: 'Individual units within a multi-unit building' },
                { id: 'townhouse', label: 'Townhouse', description: 'Multi-floor homes sharing walls with adjacent properties' },
                { id: 'multi-2-4', label: 'Multi-Family (2-4 units)', description: 'Duplexes, triplexes, and quadruplexes' },
                { id: 'multi-5-plus', label: 'Multi-Family (5+ units)', description: 'Apartment buildings and complexes' },
                { id: 'manufactured', label: 'Manufactured Home', description: 'Factory-built homes' }
            ];
        } else if (assignmentContext.propertyType === 'land') {
            subtypes = [
                { id: 'ag-cropland', label: 'Agricultural (Cropland)', description: 'Land used for crop production' },
                { id: 'ag-livestock', label: 'Agricultural (Livestock/Ranch)', description: 'Land used for livestock and ranching' },
                { id: 'ag-orchard', label: 'Agricultural (Orchard)', description: 'Land used for orchards and tree crops' },
                { id: 'vacant', label: 'Vacant/Unimproved Land', description: 'Undeveloped land without structures' },
                { id: 'dev-residential', label: 'Development Land (Residential)', description: 'Land intended for residential development' },
                { id: 'dev-commercial', label: 'Development Land (Commercial)', description: 'Land intended for commercial development' },
                { id: 'transitional', label: 'Transitional Land', description: 'Land in transition between uses' },
                { id: 'special-use', label: 'Special Use Land', description: 'Land with specialized or unique uses' }
            ];
        }
        
        html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">`;
        subtypes.forEach(subtype => {
            const isSelected = assignmentContext.subType === subtype.id;
            html += `<div class="subtype-card border-2 rounded-lg p-6 cursor-pointer transition-all ${isSelected ? 'border-harken-accent bg-harken-accent/5' : 'border-gray-200 hover:border-harken-accent hover:shadow-lg'}" data-subtype-id="${subtype.id}" onclick="selectSubType('${subtype.id}')">`;
            html += `<h3 class="text-lg font-semibold text-gray-900 mb-2">${subtype.label}</h3>`;
            html += `<p class="text-gray-600 text-sm">${subtype.description}</p>`;
            if (subtype.isCustom) {
                html += `<div id="custom-subtype-input-${subtype.id}" class="mt-4 hidden">`;
                html += `<input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Enter custom sub-type name" id="custom-subtype-name-${subtype.id}">`;
                html += `<button type="button" class="mt-2 px-4 py-2 bg-harken-accent text-white rounded-lg text-sm" onclick="saveCustomSubType('${subtype.id}')">Save for Future Use</button>`;
                html += `</div>`;
            }
            html += `</div>`;
        });
        html += `</div>`;
        
        html += `</div>`;
        return html;
    }

    // Select sub-type function
    function selectSubType(subtypeId) {
        assignmentContext.subType = subtypeId;
        // Update visual selection
        document.querySelectorAll('.subtype-card').forEach(card => {
            card.classList.remove('border-harken-accent', 'bg-harken-accent/5');
            card.classList.add('border-gray-200');
        });
        const selectedCard = document.querySelector(`[data-subtype-id="${subtypeId}"]`);
        if (selectedCard) {
            selectedCard.classList.add('border-harken-accent', 'bg-harken-accent/5');
            selectedCard.classList.remove('border-gray-200');
            
            // Show custom input if it's a custom sub-type
            if (subtypeId === 'custom') {
                const customInput = document.getElementById(`custom-subtype-input-${subtypeId}`);
                if (customInput) {
                    customInput.classList.remove('hidden');
                }
            }
        }
    }

    // Save custom sub-type
    function saveCustomSubType(subtypeId) {
        const input = document.getElementById(`custom-subtype-name-${subtypeId}`);
        if (input && input.value.trim()) {
            // In production, this would save to the database
            console.log('Saving custom sub-type:', input.value);
            alert(`Custom sub-type "${input.value}" saved for future use!`);
            assignmentContext.subType = input.value.trim();
        }
    }

    // Handle Continue button click
    function handleContinue() {
        if (currentStep === 'template-selection') {
            if (!selectedTemplate) {
                alert('Please select a template before continuing.');
                return;
            }
            loadStep('appraisal-setup');
        } else if (currentStep === 'appraisal-setup') {
            if (!assignmentContext.propertyType) {
                alert('Please select a property type before continuing.');
                return;
            }
            const clientSelect = document.getElementById('setup-client-select');
            if (!clientSelect || !clientSelect.value) {
                alert('Please select a client before continuing.');
                return;
            }
            loadStep('overview');
        } else if (currentStep === 'overview') {
            if (!assignmentContext.subType) {
                alert('Please select a property sub-type before continuing.');
                return;
            }
            // Proceed to main wizard
            loadStep('1.1');
        }
    }

    // Handle Back button click
    function handleBack() {
        if (currentStep === 'appraisal-setup') {
            loadStep('template-selection');
        } else if (currentStep === 'overview') {
            loadStep('appraisal-setup');
        } else if (currentStep && currentStep.startsWith('1.')) {
            loadStep('overview');
        }
    }

    function renderStepContent(stepKey) {
        const step = wizardSteps[stepKey];
        if (!step) return '<p>Step not found</p>';

        // Special handling for pre-wizard steps
        if (step.isPreWizard) {
            if (stepKey === 'template-selection') {
                return renderTemplateSelection();
            } else if (stepKey === 'appraisal-setup') {
                return renderAppraisalSetup();
            } else if (stepKey === 'overview') {
                return renderOverview();
            }
        }

        // Special handling for review step
        if (step.isReview) {
            return renderReviewScreen();
        }
        
        // Special handling for building summary step
        if (stepKey === '9.4') {
            let html = '';
            if (step.helpBanner) {
                html += `<div class="bg-harken-accent/10 border border-harken-accent/20 rounded-lg p-4 mb-6">`;
                html += `<div class="flex">`;
                html += `<svg class="w-5 h-5 text-harken-accent mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">`;
                html += `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>`;
                html += `</svg>`;
                html += `<div>`;
                html += `<h3 class="text-sm font-medium text-harken-dark">${step.helpBanner.title}</h3>`;
                html += `<p class="text-sm text-harken-text mt-1">${step.helpBanner.content}</p>`;
                html += `</div></div></div>`;
            }
            html += `<div id="building-summary"></div>`;
            setTimeout(() => renderBuildingSummary(), 100);
            return html;
        }

        let html = '';
        
        // Help Banner
        if (step.helpBanner) {
            html += `<div class="bg-harken-accent/10 border border-harken-accent/20 rounded-lg p-4 mb-6">`;
            html += `<div class="flex">`;
            html += `<svg class="w-5 h-5 text-harken-accent mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">`;
            html += `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>`;
            html += `</svg>`;
            html += `<div>`;
            html += `<h3 class="text-sm font-medium text-harken-dark">${step.helpBanner.title}</h3>`;
            html += `<p class="text-sm text-harken-text mt-1">${step.helpBanner.content}</p>`;
            html += `</div></div></div>`;
        }

        // Form Content
        html += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">`;
        
        if (step.fields && step.fields.length > 0) {
            step.fields.forEach((field, index) => {
                html += renderField(field, index);
            });
        }
        
        html += `</div>`;
        
        // Initialize buildings if this is a building-related step and buildings haven't been initialized
        if ((stepKey === '9.2' || stepKey === '9.3') && buildingsData.length === 0) {
            initializeBuildings(3); // Default to 3 buildings
        }
        
        // Render building tabs after content is loaded
        if (stepKey === '9.2' || stepKey === '9.3') {
            setTimeout(() => {
                renderBuildingTabs();
                loadBuildingData(activeBuildingIndex);
            }, 100);
        }
        
        return html;
    }

    // Render Review Screen
    function renderReviewScreen() {
        const enabledApproaches = [];
        if (assignmentContext.approaches.cost.enabled) enabledApproaches.push('Cost');
        if (assignmentContext.approaches.sales.enabled) enabledApproaches.push('Sales Comparison');
        if (assignmentContext.approaches.income.enabled) enabledApproaches.push('Income');

        let html = `
            <div class="bg-harken-accent/10 border border-harken-accent/20 rounded-lg p-4 mb-6">
                <div class="flex">
                    <svg class="w-5 h-5 text-harken-accent mr-3 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-harken-dark">Review & Finalize</h3>
                        <p class="text-sm text-harken-text mt-1">Review all sections of your appraisal report before generating the final PDF. Make any necessary edits and ensure all required information is complete.</p>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <!-- Property Summary Card -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-harken-dark mb-4">Property Summary</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Property Type</p>
                            <p class="text-base font-medium text-harken-dark">${assignmentContext.propertyType ? assignmentContext.propertyType.charAt(0).toUpperCase() + assignmentContext.propertyType.slice(1) : 'Not Selected'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Sub-Type</p>
                            <p class="text-base font-medium text-harken-dark">${assignmentContext.subType || 'Not Selected'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Valuation Approaches</p>
                            <p class="text-base font-medium text-harken-dark">${enabledApproaches.join(', ') || 'None Selected'}</p>
                        </div>
                    </div>
                </div>

                <!-- Approach Status Cards -->
                <div class="grid grid-cols-3 gap-4">
                    ${assignmentContext.approaches.cost.enabled ? `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-harken-dark">Cost Approach</h4>
                            <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">In Progress</span>
                        </div>
                        <p class="text-sm text-gray-600">Review cost approach sections</p>
                        <button class="mt-3 text-sm text-harken-accent hover:text-harken-accent-light" onclick="loadStep('13.1')">Edit →</button>
                    </div>
                    ` : ''}
                    ${assignmentContext.approaches.sales.enabled ? `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-harken-dark">Sales Comparison</h4>
                            <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">In Progress</span>
                        </div>
                        <p class="text-sm text-gray-600">Review sales comparison sections</p>
                        <button class="mt-3 text-sm text-harken-accent hover:text-harken-accent-light" onclick="loadStep('14.1')">Edit →</button>
                    </div>
                    ` : ''}
                    ${assignmentContext.approaches.income.enabled ? `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-harken-dark">Income Approach</h4>
                            <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">In Progress</span>
                        </div>
                        <p class="text-sm text-gray-600">Review income approach sections</p>
                        <button class="mt-3 text-sm text-harken-accent hover:text-harken-accent-light" onclick="loadStep('15.1')">Edit →</button>
                    </div>
                    ` : ''}
                </div>

                <!-- USPAP Checklist -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-harken-dark mb-4">USPAP Compliance Checklist</h3>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-harken-accent">
                            <span class="text-sm text-gray-700">Effective date(s) clearly stated</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-harken-accent">
                            <span class="text-sm text-gray-700">All intended users identified</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-harken-accent">
                            <span class="text-sm text-gray-700">Assumptions and limiting conditions disclosed</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-harken-accent">
                            <span class="text-sm text-gray-700">Certification statement included</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 h-4 w-4 text-harken-accent">
                            <span class="text-sm text-gray-700">Appraiser qualifications documented</span>
                        </label>
                    </div>
                </div>

                <!-- PDF Generation -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-harken-dark mb-4">Generate Report</h3>
                    <p class="text-sm text-gray-600 mb-4">Once you've reviewed all sections, generate the final PDF report.</p>
                    <div class="flex gap-3">
                        <button class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200" onclick="generateDraftPDF()">
                            Generate Draft PDF
                        </button>
                        <button class="px-6 py-2 bg-harken-accent text-white rounded-lg hover:bg-harken-accent-light" onclick="generateFinalPDF()">
                            Generate Final PDF
                        </button>
                    </div>
                </div>
            </div>
        `;
        return html;
    }

    function generateDraftPDF() {
        alert('Draft PDF generation would be implemented here. This would create a draft version of the appraisal report for review.');
    }

    function generateFinalPDF() {
        alert('Final PDF generation would be implemented here. This would create the final appraisal report PDF.');
    }

    // Add Client Modal Functions
    function openAddClientModal() {
        document.getElementById('add-client-modal').style.display = 'flex';
    }

    function closeAddClientModal() {
        document.getElementById('add-client-modal').style.display = 'none';
        document.getElementById('add-client-form').reset();
    }

    // Handle Add Client Form Submission
    document.addEventListener('DOMContentLoaded', function() {
        // This will be attached when the form is rendered
    });

    // Function to add client to dropdown after creation
    function addClientToDropdown(clientName, selectElementId) {
        const select = document.getElementById(selectElementId);
        if (select) {
            const option = document.createElement('option');
            option.value = clientName;
            option.textContent = clientName;
            option.selected = true;
            select.appendChild(option);
        }
    }

    // Handle Add Client Form Submission
    function setupAddClientForm() {
        const addClientForm = document.getElementById('add-client-form');
        if (addClientForm && !addClientForm.dataset.listenerAttached) {
            addClientForm.dataset.listenerAttached = 'true';
            addClientForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const clientName = document.getElementById('new-client-name').value;
                const attention = document.getElementById('new-client-attention').value;
                const address = document.getElementById('new-client-address').value;
                const cityStateZip = document.getElementById('new-client-city-state-zip').value;
                
                // Find the client select dropdown (it will have an id starting with "select-")
                const selects = document.querySelectorAll('select[id^="select-"]');
                if (selects.length > 0) {
                    const clientSelect = selects[0];
                    const option = document.createElement('option');
                    option.value = clientName;
                    option.textContent = clientName;
                    option.selected = true;
                    clientSelect.appendChild(option);
                    
                    // Also update the client address fields if they exist
                    const addressField = document.querySelector('textarea[placeholder*="address" i]');
                    if (addressField) addressField.value = address;
                    
                    const cityStateField = document.querySelector('input[placeholder*="City, State ZIP" i]');
                    if (cityStateField) cityStateField.value = cityStateZip;
                }
                
                // In a real implementation, this would save to the database
                console.log('New client added:', { clientName, attention, address, cityStateZip });
                
                closeAddClientModal();
            });
        }
    }

    // Attach form handler when modal opens
    const originalOpenAddClientModal = openAddClientModal;
    openAddClientModal = function() {
        originalOpenAddClientModal();
        setTimeout(setupAddClientForm, 100);
    };

    // Render help sidebar
    function renderHelpContent(stepKey) {
        const step = wizardSteps[stepKey];
        if (!step) return '';
        // Pre-wizard steps don't have help content
        if (step.isPreWizard) return '';
        if (!step.help) return '<p>Help content not available</p>';

        let html = `<h3 class="text-lg font-semibold text-harken-dark mb-4">Help & Resources</h3>`;
        
        // About This Section
        if (step.help.about) {
            html += `<div class="mb-6">`;
            html += `<h4 class="text-sm font-medium text-gray-700 mb-2">About This Section</h4>`;
            html += `<p class="text-sm text-gray-600 leading-relaxed">${step.help.about}</p>`;
            html += `</div>`;
        }

        // USPAP Reference
        if (step.help.uspap) {
            html += `<div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">`;
            html += `<h4 class="text-sm font-semibold text-amber-900 flex items-center mb-2">`;
            html += `<svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">`;
            html += `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>`;
            html += `</svg>`;
            html += `USPAP Standards`;
            html += `</h4>`;
            html += `<p class="text-xs text-amber-800">${step.help.uspap}</p>`;
            html += `</div>`;
        }

        // Definitions
        if (step.help.definitions && step.help.definitions.length > 0) {
            html += `<div class="mb-6">`;
            html += `<h4 class="text-sm font-medium text-gray-700 mb-3">Key Definitions</h4>`;
            html += `<div class="space-y-3">`;
            const colors = ['harken-accent', 'harken-success', 'yellow-400', 'purple-400'];
            step.help.definitions.forEach((def, idx) => {
                const color = colors[idx % colors.length];
                html += `<div class="border-l-4 border-${color} pl-3">`;
                html += `<h5 class="text-xs font-semibold text-gray-900">${def.term}</h5>`;
                html += `<p class="text-xs text-gray-600 mt-1">${def.definition}</p>`;
                html += `</div>`;
            });
            html += `</div></div>`;
        }

        // Best Practices
        if (step.help.bestPractices && step.help.bestPractices.length > 0) {
            html += `<div class="bg-gray-50 rounded-lg p-4">`;
            html += `<h4 class="text-sm font-medium text-gray-700 mb-2 flex items-center">`;
            html += `<svg class="icon mr-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">`;
            html += `<path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.624l-.219.823.219-.823a5.25 5.25 0 005.156-5.157l-.823.219.823-.219a5.25 5.25 0 00-5.157-5.156l.219.823-.219-.823a5.25 5.25 0 00-5.156 5.157l.823-.219-.823.219a5.25 5.25 0 005.157 5.156z" /></svg>`;
            html += `Best Practices`;
            html += `</h4>`;
            html += `<ul class="text-xs text-gray-600 space-y-2 mt-2">`;
            step.help.bestPractices.forEach(practice => {
                html += `<li class="flex items-start">`;
                html += `<span class="mr-2">•</span>`;
                html += `<span>${practice}</span>`;
                html += `</li>`;
            });
            html += `</ul></div>`;
        }

        return html;
    }

    // Update top bar
    function updateTopBar(stepKey) {
        if (!stepKey || !wizardSteps) {
            console.error('updateTopBar called with invalid stepKey or wizardSteps not defined:', stepKey);
            return;
        }
        const step = wizardSteps[stepKey];
        if (!step) {
            console.error('Step not found in wizardSteps:', stepKey);
            return;
        }
        
        const topBarTitle = document.querySelector('.text-xl.font-semibold');
        const topBarSubtitle = document.querySelector('.text-sm.text-harken-text');
        const backBtn = document.getElementById('back-btn');
        const continueBtn = document.getElementById('continue-btn');
        const saveContinueBtn = document.getElementById('save-continue-btn');
        const prevBtn = document.getElementById('prev-btn');
        
        // Handle pre-wizard steps
        if (step.isPreWizard) {
            if (topBarTitle) {
                topBarTitle.textContent = step.title;
            }
            if (topBarSubtitle) {
                if (stepKey === 'template-selection') {
                    topBarSubtitle.textContent = 'Step 1 of 6 • Template Selection';
                } else if (stepKey === 'appraisal-setup') {
                    topBarSubtitle.textContent = 'Step 2 of 6 • Setup';
                } else if (stepKey === 'overview') {
                    topBarSubtitle.textContent = 'Step 3 of 6 • Overview';
                }
            }
            // Show/hide buttons for pre-wizard steps
            if (backBtn) {
                backBtn.style.display = stepKey === 'template-selection' ? 'none' : 'flex';
            }
            if (continueBtn) {
                continueBtn.style.display = 'flex';
            }
            if (saveContinueBtn) {
                saveContinueBtn.style.display = 'none';
            }
            if (prevBtn) {
                prevBtn.style.display = 'none';
            }
            return;
        }
        
        // Handle regular wizard steps
        if (topBarTitle) {
            if (stepKey === 'review') {
                topBarTitle.textContent = 'Review & Finalize';
            } else {
                topBarTitle.textContent = `${stepKey} ${step.title}`;
            }
        }
        if (topBarSubtitle) {
            if (stepKey === 'review') {
                topBarSubtitle.textContent = 'Review all sections before generating PDF';
            } else {
                const stepNumber = Object.keys(wizardSteps).filter(k => k !== 'review' && !wizardSteps[k].isPreWizard).indexOf(stepKey) + 4; // +4 because we have 3 pre-wizard steps
                const totalSteps = Object.keys(wizardSteps).filter(k => k !== 'review' && !wizardSteps[k].isPreWizard).length + 3;
                topBarSubtitle.textContent = `Step ${stepNumber} of ${totalSteps} • Section ${stepKey.split('.')[0]}: ${step.section}`;
            }
        }
        
        // Show/hide buttons for regular wizard steps
        if (backBtn) {
            backBtn.style.display = 'none';
        }
        if (continueBtn) {
            continueBtn.style.display = 'none';
        }
        if (saveContinueBtn) {
            saveContinueBtn.style.display = 'flex';
        }
        if (prevBtn) {
            prevBtn.style.display = 'flex';
        }
    }

    // Load step content
    function loadStep(stepKey) {
        try {
            currentStep = stepKey;
            const contentArea = document.getElementById('content-area');
            const helpSidebar = document.getElementById('help-sidebar');
            
            if (!wizardSteps) {
                throw new Error('wizardSteps is not defined');
            }
            
            const step = wizardSteps[stepKey];
            if (!step) {
                throw new Error(`Step "${stepKey}" not found in wizardSteps`);
            }
            
            // Update progress bar
            updateProgressBar(stepKey);
            
            if (contentArea) {
                contentArea.innerHTML = renderStepContent(stepKey);
            }
            
            if (helpSidebar) {
                const helpContent = renderHelpContent(stepKey);
                helpSidebar.innerHTML = helpContent;
                // Hide help sidebar for pre-wizard steps
                const helpSidebarContainer = helpSidebar.closest('.w-80');
                if (helpSidebarContainer && step && step.isPreWizard) {
                    helpSidebarContainer.style.display = 'none';
                } else if (helpSidebarContainer) {
                    helpSidebarContainer.style.display = 'block';
                }
            }
            
            updateTopBar(stepKey);
        } catch (error) {
            console.error('Error in loadStep:', error);
            const contentArea = document.getElementById('content-area');
            if (contentArea) {
                contentArea.innerHTML = '<div class="p-8 bg-red-50 border border-red-200 rounded-lg"><h3 class="text-red-800 font-semibold mb-2">Error Loading Step</h3><p class="text-red-600">' + (error.message || error.toString()) + '</p></div>';
            }
        }
        
        // Re-attach auto-save listeners
        attachAutoSaveListeners();
    }

    // Select or custom input toggle
    function toggleCustomInput(index) {
        const select = document.getElementById(`select-custom-${index}`);
        const customInput = document.getElementById(`custom-input-${index}`);
        
        if (select && customInput) {
            if (select.value === 'Type My Own') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }
    }

    // Editable select - populate text area with selected template
    function populateEditableText(index) {
        const select = document.getElementById(`editable-select-${index}`);
        const textarea = document.getElementById(`editable-text-${index}`);
        
        if (select && textarea && select.value) {
            textarea.value = select.value;
            textarea.focus();
            // Move cursor to end of text
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
    }

    // Toggle boilerplate content
    function toggleBoilerplate(index) {
        const content = document.getElementById(`boilerplate-content-${index}`);
        const icon = document.getElementById(`boilerplate-icon-${index}`);
        
        if (content && icon) {
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                content.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
    }

    // Repeatable group functions
    function addRepeatableItem(containerIndex, fields) {
        const container = document.getElementById(`repeatable-container-${containerIndex}`);
        if (!container) return;
        
        const existingItems = container.querySelectorAll('.repeatable-item');
        const newIndex = existingItems.length + 1;
        
        let html = `<div class="repeatable-item border border-gray-200 rounded-lg p-4 bg-gray-50">`;
        html += `<div class="flex items-center justify-between mb-3">`;
        html += `<span class="text-sm font-semibold text-harken-dark">Parcel ${newIndex}</span>`;
        html += `<button type="button" class="text-red-500 hover:text-red-700 text-sm" onclick="removeRepeatableItem(this)">`;
        html += `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">`;
        html += `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>`;
        html += `</svg>`;
        html += `</button>`;
        html += `</div>`;
        html += `<div class="grid grid-cols-1 md:grid-cols-3 gap-3">`;
        fields.forEach((subField) => {
            html += `<div>`;
            html += `<label class="block text-xs font-medium text-gray-700 mb-1">${subField.label}${subField.required ? ' <span class="text-red-500">*</span>' : ''}</label>`;
            if (subField.type === 'number') {
                html += `<input type="number" ${subField.step ? `step="${subField.step}"` : ''} ${subField.readonly ? 'readonly' : ''} placeholder="${subField.placeholder || ''}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded ${subField.readonly ? 'bg-gray-100 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            } else {
                html += `<input type="text" ${subField.readonly ? 'readonly' : ''} placeholder="${subField.placeholder || ''}" class="w-full px-3 py-2 text-sm border border-gray-300 rounded ${subField.readonly ? 'bg-gray-100 cursor-not-allowed' : ''} focus:ring-2 focus:ring-harken-accent focus:border-transparent">`;
            }
            if (subField.note) {
                html += `<p class="text-xs text-gray-500 mt-1">${subField.note}</p>`;
            }
            html += `</div>`;
        });
        html += `</div></div>`;
        
        container.insertAdjacentHTML('beforeend', html);
        updateParcelNumbers(container);
    }
    
    function removeRepeatableItem(button) {
        const item = button.closest('.repeatable-item');
        const container = item.parentElement;
        
        // Don't allow removing if only one item remains
        if (container.querySelectorAll('.repeatable-item').length <= 1) {
            alert('At least one parcel is required.');
            return;
        }
        
        item.remove();
        updateParcelNumbers(container);
    }
    
    function updateParcelNumbers(container) {
        const items = container.querySelectorAll('.repeatable-item');
        items.forEach((item, index) => {
            const label = item.querySelector('.text-harken-dark');
            if (label) {
                label.textContent = `Parcel ${index + 1}`;
            }
        });
    }

    // Attach auto-save listeners
    function attachAutoSaveListeners() {
        let saveTimer;
        document.querySelectorAll('input, select, textarea').forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    console.log('Auto-saved');
                }, 2000);
            });
        });
    }

    // Toggle section expand/collapse
    function attachSectionHandlers() {
        document.querySelectorAll('.section-item > button').forEach(button => {
            // Remove existing listeners by cloning (prevents duplicates)
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            newButton.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const section = this.closest('.section-item');
                if (!section) return;
                
                section.classList.toggle('section-expanded');
                
                // Find and rotate the arrow (last SVG child)
                const svgs = this.querySelectorAll('svg');
                const arrow = svgs[svgs.length - 1];
                if (arrow) {
                    const isExpanded = section.classList.contains('section-expanded');
                    arrow.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                    arrow.style.transition = 'transform 0.3s ease';
                }
            });
        });
    }

    // Step navigation
    function attachStepHandlers() {
        document.querySelectorAll('.step-item').forEach(step => {
            // Remove existing listeners by cloning (prevents duplicates)
            const newStep = step.cloneNode(true);
            step.parentNode.replaceChild(newStep, step);
            
            newStep.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Get step text - try span first, then fallback to textContent/innerText
                let stepText = this.querySelector('span')?.textContent?.trim();
                if (!stepText) {
                    // If no span, get text content directly (removing SVG and other child elements)
                    const clone = this.cloneNode(true);
                    clone.querySelectorAll('svg').forEach(svg => svg.remove());
                    stepText = clone.textContent?.trim() || clone.innerText?.trim();
                }
                
                if (!stepText) return;
                
                if (stepText === 'Review Report' || stepText.includes('Review & Finalize')) {
                    document.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    loadStep('review');
                    const reviewBtn = document.getElementById('review-btn');
                    if (reviewBtn) reviewBtn.style.display = 'none';
                    return;
                }
                
                const stepMatch = stepText.match(/^(\d+\.\d+(?:\.\d+)?)/);
                if (stepMatch) {
                    const stepKey = stepMatch[1];
                    document.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    loadStep(stepKey);
                    // Show review button when not on review step
                    if (assignmentContext.propertyType) {
                        const reviewBtn = document.getElementById('review-btn');
                        if (reviewBtn) reviewBtn.style.display = 'flex';
                    }
                }
            });
        });
    }

    // Attach handlers on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            attachSectionHandlers();
            attachStepHandlers();
        });
    } else {
        attachSectionHandlers();
        attachStepHandlers();
    }

    // Property Type Selection Handlers
    function handlePropertyTypeClick(propertyType, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        console.log('Property type clicked (inline):', propertyType);
        if (propertyType) {
            assignmentContext.propertyType = propertyType;
            showSubTypeModal(propertyType);
        }
    }
    
    function showPropertyTypeModal() {
        const modal = document.getElementById('property-type-modal');
        if (modal) {
            modal.style.display = 'flex';
            console.log('Property type modal shown');
        } else {
            console.error('Property type modal not found!');
        }
    }

    function showSubTypeModal(propertyType) {
        const propertyModal = document.getElementById('property-type-modal');
        const subtypeModal = document.getElementById('subtype-modal');
        if (!propertyModal || !subtypeModal) return;
        
        propertyModal.style.display = 'none';
        const config = propertyTypeConfig[propertyType];
        if (!config) return;
        
        const descriptionEl = document.getElementById('subtype-description');
        if (descriptionEl) {
            descriptionEl.textContent = config.description;
        }
        
        const optionsContainer = document.getElementById('subtype-options');
        if (!optionsContainer) return;
        optionsContainer.innerHTML = '';
        
        config.subtypes.forEach(subtype => {
            const button = document.createElement('button');
            button.className = 'subtype-btn p-4 border-2 border-gray-200 rounded-lg hover:border-harken-accent hover:bg-harken-accent/5 transition-all text-left';
            button.textContent = subtype;
            button.dataset.subtype = subtype;
            button.addEventListener('click', () => selectSubType(propertyType, subtype));
            optionsContainer.appendChild(button);
        });
        
        subtypeModal.style.display = 'flex';
    }

    function selectSubType(propertyType, subType) {
        try {
            assignmentContext.propertyType = propertyType;
            assignmentContext.subType = subType;
            
            // Set default approaches based on property type
            const defaults = propertyTypeConfig[propertyType].defaultApproaches;
            assignmentContext.approaches.cost.enabled = defaults.cost;
            assignmentContext.approaches.sales.enabled = defaults.sales;
            assignmentContext.approaches.income.enabled = defaults.income;
            
            // Special handling for Multi-Family residential
            if (subType.includes('Multi-Family')) {
                assignmentContext.approaches.income.enabled = true;
            }
            
            // Update UI
            const subtypeModal = document.getElementById('subtype-modal');
            if (!subtypeModal) throw new Error('subtype-modal not found');
            subtypeModal.style.display = 'none';
            
            const propertyTypeDisplay = document.getElementById('property-type-display');
            if (!propertyTypeDisplay) throw new Error('property-type-display not found');
            propertyTypeDisplay.textContent = propertyType.charAt(0).toUpperCase() + propertyType.slice(1) + ' Property';
            
            const subtypeDisplay = document.getElementById('subtype-display');
            if (!subtypeDisplay) throw new Error('subtype-display not found');
            subtypeDisplay.textContent = subType;
            
            const approachConfigPanel = document.getElementById('approach-config-panel');
            if (!approachConfigPanel) throw new Error('approach-config-panel not found');
            approachConfigPanel.style.display = 'block';
            
            // Update approach checkboxes
            const approachCost = document.getElementById('approach-cost');
            if (!approachCost) throw new Error('approach-cost not found');
            approachCost.checked = assignmentContext.approaches.cost.enabled;
            
            const approachSales = document.getElementById('approach-sales');
            if (!approachSales) throw new Error('approach-sales not found');
            approachSales.checked = assignmentContext.approaches.sales.enabled;
            
            const approachIncome = document.getElementById('approach-income');
            if (!approachIncome) throw new Error('approach-income not found');
            approachIncome.checked = assignmentContext.approaches.income.enabled;
            
            // Update navigation
            updateNavigationVisibility();
        } catch (error) {
            console.error('Error in selectSubType:', error);
            throw error;
        }
    }

    // Approach Configuration Handlers (will be attached in DOMContentLoaded)

    // Navigation Visibility Filtering
    function isStepVisible(stepKey) {
        const step = wizardSteps[stepKey];
        if (!step || !step.visibility) return true; // Show by default if no visibility rules
        
        const visibility = step.visibility;
        
        // Check approach visibility
        if (visibility.approaches) {
            const hasApproach = visibility.approaches.some(approach => {
                if (approach === 'cost') return assignmentContext.approaches.cost.enabled;
                if (approach === 'sales') return assignmentContext.approaches.sales.enabled;
                if (approach === 'income') return assignmentContext.approaches.income.enabled;
                return false;
            });
            if (!hasApproach) return false;
        }
        
        // Check property type visibility
        if (visibility.propertyTypes && assignmentContext.propertyType) {
            if (!visibility.propertyTypes.includes(assignmentContext.propertyType)) return false;
        }
        
        // Check sub-type visibility
        if (visibility.subTypes && assignmentContext.subType) {
            if (!visibility.subTypes.includes(assignmentContext.subType)) return false;
        }
        
        return true;
    }

    function updateNavigationVisibility() {
        document.querySelectorAll('.step-item').forEach(stepItem => {
            // Get step text - handle both span and no-span cases
            let stepText = stepItem.querySelector('span')?.textContent?.trim();
            if (!stepText) {
                const clone = stepItem.cloneNode(true);
                clone.querySelectorAll('svg').forEach(svg => svg.remove());
                stepText = clone.textContent?.trim() || clone.innerText?.trim();
            }
            if (stepText) {
                const stepMatch = stepText.match(/^(\d+\.\d+(?:\.\d+)?)/);
                if (stepMatch) {
                    const stepKey = stepMatch[1];
                    const isVisible = isStepVisible(stepKey);
                    
                    if (!isVisible) {
                        stepItem.style.display = 'none';
                        stepItem.classList.add('opacity-50');
                    } else {
                        stepItem.style.display = 'flex';
                        stepItem.classList.remove('opacity-50');
                    }
                }
            }
        });
        
        // Update section headers to show/hide based on visible steps
        document.querySelectorAll('.section-item').forEach(sectionItem => {
            const sectionContent = sectionItem.querySelector('.section-content');
            const visibleSteps = sectionContent.querySelectorAll('.step-item:not([style*="display: none"])');
            if (visibleSteps.length === 0 && assignmentContext.propertyType) {
                sectionItem.style.opacity = '0.5';
            } else {
                sectionItem.style.opacity = '1';
            }
        });
        
        // Re-attach handlers after visibility update to ensure they work
        attachStepHandlers();
        attachSectionHandlers();
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing...');
        
        // Property Type Button Handlers
        const propertyTypeButtons = document.querySelectorAll('.property-type-btn');
        console.log('Found property type buttons:', propertyTypeButtons.length);
        propertyTypeButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const propertyType = this.dataset.type;
                console.log('Property type clicked:', propertyType);
                if (propertyType) {
                    assignmentContext.propertyType = propertyType;
                    showSubTypeModal(propertyType);
                } else {
                    console.error('No property type found in dataset');
                }
            });
        });

        // Back to Property Type Handler
        const backButton = document.getElementById('back-to-property-type');
        if (backButton) {
            backButton.addEventListener('click', function() {
                document.getElementById('subtype-modal').style.display = 'none';
                document.getElementById('property-type-modal').style.display = 'flex';
            });
        }

        // Review button handler
        const reviewBtn = document.getElementById('review-btn');
        if (reviewBtn) {
            reviewBtn.addEventListener('click', function() {
                document.querySelectorAll('.step-item').forEach(s => s.classList.remove('active'));
                const reviewStep = document.getElementById('review-step');
                if (reviewStep) {
                    reviewStep.classList.add('active');
                    loadStep('review');
                    this.style.display = 'none';
                }
            });
        }

        // Approach Configuration Handlers
        const approachCost = document.getElementById('approach-cost');
        if (approachCost) {
            approachCost.addEventListener('change', function() {
                assignmentContext.approaches.cost.enabled = this.checked;
                updateNavigationVisibility();
            });
        }

        const approachSales = document.getElementById('approach-sales');
        if (approachSales) {
            approachSales.addEventListener('change', function() {
                assignmentContext.approaches.sales.enabled = this.checked;
                updateNavigationVisibility();
            });
        }

        const approachIncome = document.getElementById('approach-income');
        if (approachIncome) {
            approachIncome.addEventListener('change', function() {
                assignmentContext.approaches.income.enabled = this.checked;
                updateNavigationVisibility();
            });
        }

        // Initialize with pre-wizard (template selection)
        try {
            showPreWizard();
            loadPreWizardStep(1);
        } catch (error) {
            console.error('Error loading initial step:', error);
            alert('Error initializing wizard: ' + (error.message || error.toString()));
        }
    });
</script>

</body>
</html>

