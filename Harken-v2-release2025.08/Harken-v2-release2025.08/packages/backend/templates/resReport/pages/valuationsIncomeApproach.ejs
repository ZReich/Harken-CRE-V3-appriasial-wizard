<%
if (evaluation && Array.isArray(evaluation.res_evaluation_scenarios)) {
for(let index = 0; index < evaluation.res_evaluation_scenarios.length; index++){
    const scenario = evaluation.res_evaluation_scenarios[index];
    let low_psf, market_psf, high_psf = 0;
    if(scenario.has_income_approach){
        let label = '';
        if (evaluation && evaluation.res_evaluation_scenarios && evaluation.res_evaluation_scenarios.length > 1 && label === '') {
            label = scenario.name;
        }
        if(scenario?.res_evaluation_income_approach){
            const evaluation_income_approach = scenario.res_evaluation_income_approach;
            const incomes = evaluation_income_approach?.incomeSources;
            const countIS = incomes ? incomes.length : 0;
            const otherIncomes = evaluation_income_approach?.otherIncomeSources;
            const countOIS = otherIncomes ? otherIncomes.length : 0;
            const lengthIN = evaluation_income_approach?.income_notes?.length || 0;
            const lengthEN = evaluation_income_approach?.expense_notes?.length || 0;
            const lengthCN = evaluation_income_approach?.cap_rate_notes?.length || 0;
            const totalLength = lengthIN + lengthEN + lengthCN;
            const totalINENLength = lengthIN + lengthEN;
            const totalENCN = lengthEN + lengthCN;

            const oes = evaluation_income_approach.operatingExpenses;
            const countOe = oes ? oes.length : 0;
            const total = countIS + countOe + countOIS + 2;

            let maxlengthForENCN = 1500;
            if (countOe < 7) {
                const countChars = 7 - countOe;
                maxlengthForENCN += countChars * 120;
            }

            let maxlengthForINEN = 1500;
            if (total < 16) {
                const countChars = 16 - total;
                maxlengthForINEN += countChars * 120;
            }
            let showOe = true;
            let showCAP = true;
            let showExpenseNotes = true;
        %>
            <div class="new-page valuations_page_3" data-type="income-approach">
                <div class="page-header">
                <%- chapter %>
                </div>
                <div class="description">
                <p class="title">Income <span class="subtitle">Approach</span></p>
                <p class="label"><%= label %></p>
                <table class="space-table">
                    <thead>
                    <tr>
                        <th class="type-col">Type</th>
                        <th class="amount-col">Monthly Income</th>
                        <th class="amount-col">Annual Income</th>
                        <th class="amount-sf-col">$/SF/YR</th>
                        <th class="amount-col">Square Footage</th>
                        <th>Comments</th>
                    </tr>
                    </thead>
                    <tbody>
                    <% 
                    let trClass = '';
                    if (scenario.res_evaluation_income_approach.incomeSources) {
                        let zone = 0;
                        for (let i = 0; i < scenario.res_evaluation_income_approach.incomeSources.length; i++) {
                        const incomeSource = scenario.res_evaluation_income_approach.incomeSources[i];
                        trClass = i % 2 === 0 ? 'odd' : '';
                    %>
                        <tr class="<%= trClass %>">
                        <td>
                            <%
                                let zone_string = '';
                                let zoneValue = '';
                                let subZoneValue = getArrayValue('space', incomeSource) || 'Single Family Residence';
                                if (evaluation && evaluation.res_zonings && evaluation.res_zonings[zone]) {
                                    zone_string = evaluation.res_zonings[zone].zone;
                                    const zoneObj = zoneOptions.find((obj) => obj?.code === zone_string);
                                    zoneValue = zoneObj ? zoneObj.name : zone_string;
                                    const sub_options = zoneObj?.sub_options || [];
                                    const subZone = sub_options.find((obj) => obj?.code === subZoneValue);
                                    subZoneValue = subZone ? subZone.name : subZoneValue;
                                }
                            %>
                            <%= (zone < evaluation.res_zonings.length) ? zoneValue + ' - ' : '' %>
                            <%= subZoneValue %>
                        </td>
                        <td class="<%= (i + 1 === countIS) ? 'total-sum' : '' %>"><span><%= getArrayValue('monthly_income', incomeSource, 0, true) %></span></td>
                        <td class="<%= (i + 1 === countIS) ? 'total-sum' : '' %>"><span><%= getArrayValue('annual_income', incomeSource, 0, true) %></span></td>
                        <td class="<%= (i + 1) === countIS ? 'total-sum' : '' %>"><span class=""><%= getArrayValue('rent_sq_ft', incomeSource, 0, true) %></span></td>
                        <td class="<%= (i + 1) === countIS ? 'total-sum' : '' %>"><%= to_area(getArrayValue('square_feet', incomeSource, 'None')) %></td>
                        <td><%= getArrayValue('comments', incomeSource, 'None') %></td>
                        </tr>
                    <% zone++; } 
                        } %>
                    <tr class="bold <%= (trClass === '') ? 'odd' : '' %>">
                        <td>Total and Average</td>
                        <td><span><%= toCurrency(evaluation_income_approach.total_monthly_income) %></span></td>
                        <td><span><%= toCurrency(evaluation_income_approach.total_annual_income) %></span></td>
                        <td><span><%= toCurrency(evaluation_income_approach.total_rent_sq_ft) %></span></td>
                        <td><span><%= to_area(evaluation_income_approach.total_sq_ft) %></span></td>
                        <td></td>
                    </tr>
                    <%
                        const notes = evaluation_income_approach?.income_notes || '';
                        const length = notes?.length || 0;
                        let endLength = 3200;
                    
                        if (countIS < 7) {
                            const countChars = 7 - countIS;
                            const remove = countChars * 120;
                            endLength += remove;
                        }
                    
                        if (length <= endLength) {
                    %>
                    <tr>
                        <td colspan="6">
                            <p class="regular-description">
                                <span class="type income_type">
                                    Income Notes:
                                </span>
                                <span class="text income_text">
                                    <%- notes.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                </span>
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <p>
                                <span class="regular-description"><span>Vacancy :</span></span>
                                <span class="bold"><%= toPercentage(evaluation_income_approach.vacancy) %> of Gross Income</span>
                            </p>
                        </td>
                        <td class="noBorder" style="text-align:left;">
                            <p class="bold">
                                $(<%= numberFormat(Math.abs(evaluation_income_approach.vacant_amount) || 0, 2) %>)
                            </p>
                        </td>
                        </tr>
                    </tbody>
                </table>
                <% if ((countOe || countOIS) && countIS <= 7 && endLength/120 > 10) { %>
                    <table class="space-table">
                        <thead>
                        <% if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                            <tr>
                                <th class="type-col">Other Income</th>
                                <th class="amount-col">Monthly Income</th>
                                <th class="amount-col">Annual Income</th>
                                <th>Total SF</th>
                                <th>Comments</th>
                            </tr>
                        <% } %>
                        </thead>
                        <tbody>
                            <% 
                            let trOtherClass = '';
                            if (scenario.res_evaluation_income_approach.otherIncomeSources) {
                                for (let i = 0; i < scenario.res_evaluation_income_approach.otherIncomeSources.length; i++) {
                                const otherIncomeSources = scenario.res_evaluation_income_approach.otherIncomeSources[i];
                                trOtherClass = i % 2 === 0 ? 'odd' : '';
                            %>
                            <tr class="<%= trOtherClass %>">
                                <td> 
                                    <%= otherIncomeSources.type %>
                                </td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.monthly_income || 0) %></span></td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.annual_income || 0) %></span></td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><%= getArrayValue('square_feet', otherIncomeSources) ? to_area(getArrayValue('square_feet', otherIncomeSources)) : getArrayValue('square_feet', otherIncomeSources) %></td>
                                <td><%= getArrayValue('comments', otherIncomeSources, 'None') %></td>
                            </tr>
                            <% } } 
                            if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                            <tr class="bold <%= (trOtherClass === '') ? 'odd' : '' %>">
                                <td>Total and Average</td>
                                <td><span><%= toCurrency(evaluation_income_approach.other_total_monthly_income || 0) %></span></td>
                                <td><span><%= toCurrency(evaluation_income_approach.other_total_annual_income || 0) %></span></td>
                                <td><%= to_area(evaluation_income_approach.other_total_sq_ft || 0) %></td>
                                <td></td>
                            </tr>
                            <% } %>
                        </tbody>
                        <tbody>
                            <tr>
                                <td colspan="2">
                                    <p class="regular-description">
                                        <span>Adjusted Gross : </span>
                                    </p>
                                </td>
                                <td colspan="4" class="noBorder">
                                    <p class="bold">
                                        <%= toCurrency(evaluation_income_approach.adjusted_gross_amount) %>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                            <% 
                                const totalRows = countIS + countOIS + 3;
                                const rowsOnPage = 32;
                                const remainingRows = rowsOnPage - totalRows;
                                const remainingPageLength = ((endLength - notes.length)/120) - totalRows;
                                if(parseInt(remainingPageLength) >= countOe){
                                    showOe = false;
                                if(oes.length){ %>
                        <thead>
                            <tr>
                                <th>Operation Expenses</th>
                                <th class="amount-col">Amounts</th>
                                <th class="amount-gross-col">% of Adjusted Gross</th>
                                <th class="amount-sf-col">$/SF</th>
                                <th>Comments</th>
                                <th></th>
                            </tr>
                        </thead>
                        <% } %>
                        <tbody>
                            <% let total_sf_price = 0; %>
                            <% if (oes && oes.length) { %>
                                <% oes.forEach((oe, i) => { 
                                    trClass = i % 2 === 0 ? 'odd' : ''; 
                                    const isLast = (i + 1) === countOe;
                                    const annual_amount = oe.annual_amount || 0;
                                    const building_size = evaluation.building_size;
                                    let price_per_sf = 0;
                                    if (annual_amount && building_size > 0) {
                                        price_per_sf = annual_amount / building_size;
                                    }
                                    total_sf_price += Number(price_per_sf.toFixed(2));
                                %>
                                <tr class="<%= trClass %>">
                                    <td><%= getArrayValue('name', oe, '-') %></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('annual_amount', oe, 0, true) %></span></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= toPercentage(getArrayValue('percentage_of_gross', oe)) %></span></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('total_per_sq_ft', oe, 0, true) %></span></td>
                                    <td colspan="2"><%= getArrayValue('comments', oe, 'None') %></td>
                                </tr>
                                <% }) %>
                            <% }
                            if(oes.length){ %>
                            <tr class="bold <%= !trClass ? 'odd' : '' %>">
                                <td>Total Expenses</td>
                                <td><span><%= toCurrency(evaluation_income_approach.total_oe_annual_amount) %></span></td>
                                <td><%= toPercentage(evaluation_income_approach.total_oe_gross) %></td>
                                <td><span><%= toCurrency(evaluation_income_approach.total_oe_per_square_feet) %></span></td>
                                <td colspan="2"></td>
                            </tr>
                            <% } %>
                        </tbody>
                        <%
                        showExpenseNotes = false;
                        let limit = (parseInt(remainingPageLength) - 5) * 120;
                        let exendLength = limit;
                        const expenseNotes = evaluation_income_approach?.expense_notes?.trim() || '';
                        let count = expenseNotes.length > limit ? remainingPageLength-countOe : 1;
                        let startLen = 0;
                        for (let i = 0; i <= remainingPageLength; i++) {
                            const segment = expenseNotes.substring(startLen, startLen + limit);
                            let extendLength = startLen + limit;
                            if (segment.length > 0) {
                                const lastDot = segment.lastIndexOf(' ');
                                const endPart = segment.substring(lastDot);
                                const chars = endPart.length;
                                if (chars < 10) {
                                    limit -= chars;
                                    exendLength -= chars;
                                }
                                const data = expenseNotes.substring(startLen, startLen + limit);
                                if (i !== 0) {
                                %>
                                <div class="new-page valuations_page_3">
                                    <div class="page-header">
                                        <%- chapter %>
                                    </div>
                                    <div class="description">
                                        <p class="title">Income <span class="subtitle">Approach</span></p>
                                        <p class="label"><%= label %></p>
                                        <p class="regular-description">
                                            <span class="type income_type">
                                                Expense Notes:
                                            </span>
                                            <span class="text income_text">
                                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>  
                                            </span>
                                        </p>
                                        <% const remainingPageLengthForCAPRate = remainingPageLength - (data.length / 120);
                                        if(remainingPageLengthForCAPRate > 10){
                                            showCAP = false; %>
                                        <div>
                                            <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                                            <p class="main-description">
                                                Recent sales indicate acceptable capitalization rates ranging from
                                                <%= evaluation_income_approach.monthly_capitalization_rate %>%
                                                - <%= (evaluation_income_approach?.sq_ft_capitalization_rate || evaluation_income_approach.high_capitalization_rate) %>%, thus utilizing the
                                                direct capitalization method of evaluation the author has assumed a capitalization rate
                                                of <%= evaluation_income_approach.annual_capitalization_rate %>% based on the property's location,
                                                condition, and tenant mix.
                                            </p>
                                            <table class="cap-rate-table">
                                                <tbody>
                                                <tr>
                                                    <td>Net Operating Value</td>
                                                    <td></td>
                                                    <td><b><%= toCurrency(evaluation_income_approach.total_net_income) %></b></td>
                                                    <td></td>
                                                </tr>
                                                <tr class="odd">
                                                    <td>Cap Rate Range </td>
                                                    <td class="percentage-cell"><%= toPercentage(evaluation_income_approach.monthly_capitalization_rate || 0) %></td>
                                                    <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.annual_capitalization_rate || 0) %></span></td>
                                                    <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach?.sq_ft_capitalization_rate || evaluation_income_approach.high_capitalization_rate) %></span></td>
                                                </tr>
                                                <tr>
                                                    <td>Indicated Value</td>
                                                    <td class="percentage-cell"><%= evaluation_income_approach.indicated_range_monthly ? toCurrency(evaluation_income_approach.indicated_range_monthly) : getNotAvailableLabel() %></td>
                                                    <td class="percentage-cell"><span class="contents"><%= evaluation_income_approach.indicated_range_annual ? toCurrency(evaluation_income_approach.indicated_range_annual) : getNotAvailableLabel() %></span></td>
                                                    <td class="percentage-cell">
                                                        <span class="contents">
                                                            <%= evaluation_income_approach['indicated_range_sq_feet'] ? toCurrency(evaluation_income_approach['indicated_range_sq_feet']) : getNotAvailableLabel() %>
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr class="odd">
                                                    <td>Indicated Value PSF</td>
                                                    <td><%= toCurrency(evaluation_income_approach?.indicated_psf_monthly) %></td>
                                                    <td><%= toCurrency(evaluation_income_approach?.indicated_psf_annual) %></td>
                                                    <td><%= toCurrency(evaluation_income_approach?.indicated_psf_sq_feet) %></td>
                                                    <td></td>
                                                    <td></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                            <% const capNotes = evaluation_income_approach?.cap_rate_notes || '';
                                                let displayOnThisPage = false;
                                                const capNotesLength = capNotes?.length || 0;
                                                let startLen = 0;
                                                const decreaseRows = 5;
                                                let capNotesLimit = ((remainingPageLengthForCAPRate - decreaseRows) - (capNotesLength ? (capNotesLength/120) : 0)) * 120;
                                                const remainingLinesForThisPage = remainingPageLengthForCAPRate - decreaseRows;
                                                if (capNotesLength <= capNotesLimit) { %>
                                                    <p class="regular-description">
                                                        <span class="type income_type">
                                                            CAP Rate Notes:
                                                        </span>
                                                        <span class="text income_text">
                                                            <%- capNotes.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                        </span>
                                                    </p>
                                                </div>
                                            </div>
                                            <%- watermark %>
                                    </div>
                                        <% } else {
                                            let limit = label.length ? 4600 : 4800;
                                            let count = Math.ceil(capNotesLength / limit);
                                            for (let i = 0; i < count; i++) {
                                                if(remainingLinesForThisPage > 2 && !displayOnThisPage){
                                                    displayOnThisPage = true;
                                                    const capNotesData = capNotes.substring(0, remainingLinesForThisPage*120);
                                                    startLen += remainingLinesForThisPage*120; %>
                                                                <p class="regular-description">
                                                                    <span class="type income_type">
                                                                        CAP Rate Notes:
                                                                    </span>
                                                                    <span class="text income_text">
                                                                        <%- capNotesData.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                                    </span>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <%- watermark %>
                                                    </div>
                                                <% }
                                                let chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                                let lastSpace = chunk.lastIndexOf(' ');
                                                if (lastSpace !== -1 && chunk.length - lastSpace < 10) {
                                                    limit -= (chunk.length - lastSpace);
                                                    chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                                }
                                                const data = chunk; %>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="new-page valuations_page_3">
                                                    <div class="page-header">
                                                        <%- chapter %>
                                                    </div>
                                                    <div class="description">
                                                        <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                                                        <p class="label"><%= label %></p>
                                                        <p class="regular-description">
                                                            <span class="type income_type">
                                                                CAP Rate Notes:
                                                            </span>
                                                            <span class="text income_text">
                                                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                            </span>
                                                        </p>
                                                    </div>
                                                    <%- watermark %>
                                                </div>
                                                <% 
                                                startLen += limit;
                                                limit = 4700;
                                                endLength = startLen + limit;
                                            } 
                                        } %>
                                        </div>
                                        <%
                                        }
                                    %>
                                    </div>
                                    <%- watermark %>
                                </div>
                                <% } else { %>
                                    </table>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            Expense Notes:
                                        </span>
                                        <span class="text income_text">
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                    <% const remainingPageLengthForCAPRate = remainingPageLength - (data.length / 120);
                                    if(remainingPageLengthForCAPRate > 20){
                                        showCAP = false; %>
                                            <div>
                                                <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                                                <p class="main-description">
                                                    Recent sales indicate acceptable capitalization rates ranging from
                                                    <%= evaluation_income_approach.monthly_capitalization_rate %>%
                                                    - <%= (evaluation_income_approach?.sq_ft_capitalization_rate || evaluation_income_approach.high_capitalization_rate) %>%, thus utilizing the
                                                    direct capitalization method of evaluation the author has assumed a capitalization rate
                                                    of <%= evaluation_income_approach.annual_capitalization_rate %>% based on the property's location,
                                                    condition, and tenant mix.
                                                </p>
                                                <table class="cap-rate-table">
                                                    <tbody>
                                                    <tr>
                                                        <td>Net Operating Value</td>
                                                        <td></td>
                                                        <td><b><%= toCurrency(evaluation_income_approach.total_net_income) %></b></td>
                                                        <td></td>
                                                    </tr>
                                                    <tr class="odd">
                                                        <td>Cap Rate Range </td>
                                                        <td class="percentage-cell"><%= toPercentage(evaluation_income_approach.monthly_capitalization_rate || 0) %></td>
                                                        <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.annual_capitalization_rate || 0) %></span></td>
                                                        <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach?.sq_ft_capitalization_rate || evaluation_income_approach.high_capitalization_rate) %></span></td>
                                                    </tr>
                                                    <% let sq_feet = 'sq_feet'; %>
                                                    <tr>
                                                        <td>Indicated Value</td>
                                                        <td class="percentage-cell"><%= evaluation_income_approach.indicated_range_monthly ? toCurrency(evaluation_income_approach.indicated_range_monthly) : getNotAvailableLabel() %></td>
                                                        <td class="percentage-cell"><span class="contents"><%= evaluation_income_approach.indicated_range_annual ? toCurrency(evaluation_income_approach.indicated_range_annual) : getNotAvailableLabel() %></span></td>
                                                        <td class="percentage-cell">
                                                            <span class="contents">
                                                                <%= evaluation_income_approach['indicated_range_sq_feet'] ? toCurrency(evaluation_income_approach['indicated_range_sq_feet']) : getNotAvailableLabel() %>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                    <tr class="odd">
                                                        <td>Indicated Value PSF</td>
                                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_monthly) %></td>
                                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_annual) %></td>
                                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_sq_feet) %></td>
                                                        <td></td>
                                                        <td></td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                                <% const capNotes = evaluation_income_approach?.cap_rate_notes || '';
                                                    let displayOnThisPage = false;
                                                    const capNotesLength = capNotes?.length || 0;
                                                    let startLen = 0;
                                                    const decreaseRows = 20;
                                                    let capNotesLimit = ((remainingPageLengthForCAPRate - decreaseRows) - (capNotesLength ? (capNotesLength/120) : 0)) * 120;
                                                    const remainingLinesForThisPage = remainingPageLengthForCAPRate - decreaseRows;
                                                    if (capNotesLength <= capNotesLimit) { %>
                                                        <p class="regular-description">
                                                            <span class="type income_type">
                                                                CAP Rate Notes:
                                                            </span>
                                                            <span class="text income_text">
                                                                <%- capNotes.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                            </span>
                                                        </p>
                                                    </div>
                                                <!-- </div> -->
                                                <%- watermark %>
                                        </div>
                                        <% } else {
                                            let limit = label.length ? 4600 : 4800;
                                            let count = Math.ceil(capNotesLength / limit);

                                            for (let i = 0; i < count; i++) {
                                                if(remainingLinesForThisPage > 2 && !displayOnThisPage){
                                                    displayOnThisPage = true;
                                                    const capNotesData = capNotes.substring(0, remainingLinesForThisPage*120);
                                                    startLen += remainingLinesForThisPage*120; %>
                                                                <p class="regular-description">
                                                                    <span class="type income_type">
                                                                        CAP Rate Notes:
                                                                    </span>
                                                                    <span class="text income_text">
                                                                        <%- capNotesData.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                                    </span>
                                                                </p>
                                                            </div>
                                                        </div>
                                                        <%- watermark %>
                                                    </div>
                                                    <% }
                                                    let chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                                    let lastSpace = chunk.lastIndexOf(' ');
                                                    if (lastSpace !== -1 && chunk.length - lastSpace < 10) {
                                                        limit -= (chunk.length - lastSpace);
                                                        chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                                    }
                                                    const data = chunk; %>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="new-page valuations_page_3">
                                                        <div class="page-header">
                                                            <%- chapter %>
                                                        </div>
                                                        <div class="description">
                                                            <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                                                            <p class="label"><%= label %></p>
                                                            <p class="regular-description">
                                                                <span class="type income_type">
                                                                    CAP Rate Notes:
                                                                </span>
                                                                <span class="text income_text">
                                                                    <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                                                </span>
                                                            </p>
                                                        </div>
                                                        <%- watermark %>
                                                    </div>
                                                    <% startLen += limit;
                                                    limit = 4700;
                                                    endLength = startLen + limit;
                                                } 
                                            } %>
                                            </div>
                                            <%
                                            } else{ %>
                                                </div>
                                                <%- watermark %>
                                                </div>
                                            <% }
                                        %>
                                <!-- </div>
                            </div> -->
                            <% } 
                            startLen = exendLength; 
                            limit = 4700; 
                            exendLength = startLen + limit; 
                        }
                    } %>
                <% }else{ %>
                    </table>
                    <%- watermark %>
                    </div>
                    </div>
                <% } %>
                <% }else{ %>
                </div>
                <%- watermark %>
            </div>
                <% } %>
            <!-- </div> -->
            <!-- </div> -->
            <% }else{
                let count = 1;
                let endLength = 4500;
                
                if (countIS <= 7) {
                    const countChars = 7 - countIS;
                    const remove = countChars * 160;
                    endLength += remove;
                }
                
                let notes = evaluation_income_approach?.income_notes?.trim();
                const length = notes.length;
                
                if (length > endLength) {
                    count = length / endLength;
                }
                
                let startLen = 0;
                let limit = endLength;
                let displayVacancy = false;
                
                for (let i = 0; i <= Math.ceil(count); i++) {
                    if(i){
                        const add = countIS * 160;
                        limit += add;
                    }
                    const segment = notes.substring(startLen, startLen + limit);
                    if (segment.length > 0) {
                        let checkString = segment;
                        const lastDot = checkString.lastIndexOf(' ');
                        const endPart = checkString.substring(lastDot);
                        const chars = endPart.length;
                
                        if (chars < 10) {
                            limit -= chars;
                            endLength -= chars;
                        }
                
                        const data = notes.substring(startLen, startLen + limit);
                
                        if (i !== 0) { 
                %>
                            <div class="new-page valuations_page_3" data-type="income-approach">
                                <div class="page-header">
                                    <%- chapter %>
                                </div>
                
                                <div class="description">
                                    <p class="title">Income <span class="subtitle">Approach</span></p>
                                    <p class="label"><%= label %></p>
                                    <% if(!displayVacancy){ %>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            Income Notes:
                                        </span>
                                        <span class="text income_text">
                                            <% notes = notes.replace(data, '').trim(); %>
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                    <% } %>
                                    <% if (data.length < limit && !displayVacancy) {
                                        displayVacancy = true; %>
                                    <table>
                                        <tbody>
                                            <tr>
                                                <td style="width:40%">
                                                    <p>
                                                        <span class="regular-description"><span>Vacancy :</span></span>
                                                        <span class="bold"><%= toPercentage(evaluation_income_approach.vacancy) %> of Gross Income</span>
                                                    </p>
                                                </td>
                                                <td class="noBorder" style="text-align:left;">
                                                    <p class="bold">
                                                        $(<%= numberFormat(Math.abs(evaluation_income_approach.vacant_amount) || 0, 2) %>)
                                                    </p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <%
                                        const pendingRows = (limit - data.length) / 120;
                                        if(pendingRows > 10){ 
                                            showOe = false;
                                        %>
                                            <table class="space-table">
                                                <thead>
                                                <% if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                                                    <tr>
                                                        <th class="type-col">Other Income</th>
                                                        <th class="amount-col">Monthly Income</th>
                                                        <th class="amount-col">Annual Income</th>
                                                        <th>Total SF</th>
                                                        <th>Comments</th>
                                                    </tr>
                                                <% } %>
                                                </thead>
                                                <tbody>
                                                    <% 
                                                    let trOtherClass = '';
                                                    if (evaluation_income_approach.otherIncomeSources) {
                                                        for (let i = 0; i < evaluation_income_approach.otherIncomeSources.length; i++) {
                                                        const otherIncomeSources = evaluation_income_approach.otherIncomeSources[i];
                                                        trOtherClass = i % 2 === 0 ? 'odd' : '';
                                                    %>
                                                    <tr class="<%= trOtherClass %>">
                                                        <td> 
                                                            <%= otherIncomeSources.type %>
                                                        </td>
                                                        <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.monthly_income || 0) %></span></td>
                                                        <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.annual_income || 0) %></span></td>
                                                        <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><%= getArrayValue('square_feet', otherIncomeSources) ? to_area(getArrayValue('square_feet', otherIncomeSources)) : getArrayValue('square_feet', otherIncomeSources) %></td>
                                                        <td><%= getArrayValue('comments', otherIncomeSources, 'None') %></td>
                                                    </tr>
                                                    <% } } 
                                                    if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                                                    <tr class="bold <%= (trOtherClass === '') ? 'odd' : '' %>">
                                                        <td>Total and Average</td>
                                                        <td><span><%= toCurrency(evaluation_income_approach.other_total_monthly_income || 0) %></span></td>
                                                        <td><span><%= toCurrency(evaluation_income_approach.other_total_annual_income || 0) %></span></td>
                                                        <td><%= to_area(evaluation_income_approach.other_total_sq_ft || 0) %></td>
                                                        <td></td>
                                                    </tr>
                                                    <% } %>
                                                </tbody>
                                                <tbody>
                                                    <tr>
                                                        <td colspan="2">
                                                            <p class="regular-description">
                                                                <span>Adjusted Gross : </span>
                                                            </p>
                                                        </td>
                                                        <td colspan="4" class="noBorder">
                                                            <p class="bold">
                                                                <%= toCurrency(evaluation_income_approach.adjusted_gross_amount) %>
                                                            </p>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                                <% 
                                                    const remainingPageLength = pendingRows - countOIS;
                                                    if(remainingPageLength > countOe){
                                                        showOe = false;
                                                        if(oes.length){
                                                %>
                                                    <thead>
                                                        <tr>
                                                            <th>Operation Expenses</th>
                                                            <th class="amount-col">Amounts</th>
                                                            <th class="amount-gross-col">% of Adjusted Gross</th>
                                                            <th class="amount-sf-col">$/SF</th>
                                                            <th>Comments</th>
                                                            <th></th>
                                                        </tr>
                                                    </thead>
                                                    <% } %>
                                                    <tbody>
                                                    <% let total_sf_price = 0; %>
                                                    <% if (oes && oes.length) { %>
                                                        <% oes.forEach((oe, i) => { 
                                                            trClass = i % 2 === 0 ? 'odd' : ''; 
                                                            const isLast = (i + 1) === countOe;
                                                            const annual_amount = oe.annual_amount || 0;
                                                            const building_size = evaluation.building_size;
                                                            let price_per_sf = 0;
                                                            if (annual_amount && building_size > 0) {
                                                                price_per_sf = annual_amount / building_size;
                                                            }
                                                            total_sf_price += Number(price_per_sf.toFixed(2));
                                                            %>
                                                        <tr class="<%= trClass %>">
                                                        <td><%= getArrayValue('name', oe, '-') %></td>
                                                        <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('annual_amount', oe, 0, true) %></span></td>
                                                        <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= toPercentage(getArrayValue('percentage_of_gross', oe)) %></span></td>
                                                        <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('total_per_sq_ft', oe, 0, true) %></span></td>
                                                        <td colspan="2"><%= getArrayValue('comments', oe, 'None') %></td>
                                                        </tr>
                                                    <% }) %>
                                                <% }
                                                if(oes.length){ %>
                                                    <tr class="bold <%= !trClass ? 'odd' : '' %>">
                                                        <td>Total Expenses</td>
                                                        <td><span><%= toCurrency(evaluation_income_approach.total_oe_annual_amount) %></span></td>
                                                        <td><%= toPercentage(evaluation_income_approach.total_oe_gross) %></td>
                                                        <td><span><%= toCurrency(evaluation_income_approach.total_oe_per_square_feet) %></span></td>
                                                        <td colspan="2"></td>
                                                    </tr>
                                                <% } %>
                                                </tbody>
                                                <% }else{
                                                    showOe = true;
                                                } %>
                                            </table>
                                        <% 
                                        }
                                    %>
                                    <% } %>
                                </div>
                                <%- watermark %>
                            </div>
                <%
                        } else {
                %>
                            <tr>
                                <td colspan="6">
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            Income Notes:
                                        </span>
                                        <span class="text income_text">
                                            <% notes = notes.replace(data, '').trim(); %>
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <p>
                                        <span class="regular-description"><span>Vacancy :</span></span>
                                        <span class="bold"><%= toPercentage(evaluation_income_approach.vacancy) %> of Gross Income</span>
                                    </p>
                                </td>
                                <td class="noBorder" style="text-align:left;">
                                    <p class="bold">
                                        $(<%= numberFormat(Math.abs(evaluation_income_approach.vacant_amount) || 0, 2) %>)
                                    </p>
                                </td>
                            </tr>
                            <% if(!scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                                <tr>
                                    <td colspan="2">
                                    <p class="regular-description">
                                        <span><%= (evaluation.comp_type === 'land_only') ? 'Adjusted Gross' : 'Effective Income' %> : </span>
                                    </p>
                                    </td>
                                    <td colspan="4" class="noBorder">
                                        <p class="bold">
                                            <%= toCurrency(evaluation_income_approach.adjusted_gross_amount) %>
                                        </p>
                                    </td>
                                </tr>
                            <% } %>
                            </tbody>
                        </table>
                        </div>
                        <%- watermark %>
                    </div>
                <%
                        }
                        endLength = limit;
                    }
                }
            } 
            if(showExpenseNotes){ %>
            <!-- </div> -->
            <div class="new-page valuations_page_3">
                <div class="page-header">
                    <%- chapter %>
                </div>
                <div class="description">
                    <p class="title">Income <span class="subtitle">Approach</span></p>
                    <p class="label"><%= label %></p>
                    <table class="space-table">
                        <thead>
                        <% if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                            <tr>
                                <th class="type-col">Other Income</th>
                                <th class="amount-col">Monthly Income</th>
                                <th class="amount-col">Annual Income</th>
                                <th>Total SF</th>
                                <th>Comments</th>
                            </tr>
                        <% } %>
                        </thead>
                        <tbody>
                            <% 
                            let trOtherClass = '';
                            if (scenario.res_evaluation_income_approach.otherIncomeSources) {
                                for (let i = 0; i < scenario.res_evaluation_income_approach.otherIncomeSources.length; i++) {
                                const otherIncomeSources = scenario.res_evaluation_income_approach.otherIncomeSources[i];
                                trOtherClass = i % 2 === 0 ? 'odd' : '';
                            %>
                            <tr class="<%= trOtherClass %>">
                                <td> 
                                    <%= otherIncomeSources.type %>
                                </td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.monthly_income || 0) %></span></td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><span><%= toCurrency(otherIncomeSources.annual_income || 0) %></span></td>
                                <td class="<%= (i + 1 === countOIS) ? 'total-sum' : '' %>"><%= getArrayValue('square_feet', otherIncomeSources) ? to_area(getArrayValue('square_feet', otherIncomeSources)) : getArrayValue('square_feet', otherIncomeSources) %></td>
                                <td><%= getArrayValue('comments', otherIncomeSources, 'None') %></td>
                            </tr>
                            <% } }
                            if(scenario.res_evaluation_income_approach.otherIncomeSources.length) { %>
                            <tr class="bold <%= (trOtherClass === '') ? 'odd' : '' %>">
                                <td>Total and Average</td>
                                <td><span><%= toCurrency(evaluation_income_approach.other_total_monthly_income || 0) %></span></td>
                                <td><span><%= toCurrency(evaluation_income_approach.other_total_annual_income || 0) %></span></td>
                                <td><%= to_area(evaluation_income_approach.other_total_sq_ft || 0) %></td>
                                <td></td>
                            </tr>
                            <% } %>
                        </tbody>
                        <tbody>
                            <tr>
                                <td colspan="2">
                                <p class="regular-description">
                                    <span><%= (evaluation.comp_type === 'land_only') ? 'Adjusted Gross' : 'Effective Income' %> : </span>
                                </p>
                                </td>
                                <td colspan="4" class="noBorder">
                                    <p class="bold">
                                        <%= toCurrency(evaluation_income_approach.adjusted_gross_amount) %>
                                    </p>
                                </td>
                            </tr>
                        </tbody>
                    <% if(showOe && oes.length){ %>
                        <!-- <table class="space-table"> -->
                            <thead>
                                <tr>
                                    <th>Operation Expenses</th>
                                    <th class="amount-col">Amounts</th>
                                    <th class="amount-gross-col">% of Adjusted Gross</th>
                                    <th class="amount-sf-col">$/SF</th>
                                    <th>Comments</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            <% let total_sf_price = 0; %>
                            <% if (oes && oes.length) { %>
                                <% oes.forEach((oe, i) => { 
                                    trClass = i % 2 === 0 ? 'odd' : ''; 
                                    const isLast = (i + 1) === countOe;
                                    const annual_amount = oe.annual_amount || 0;
                                    const building_size = evaluation.building_size;
                                    let price_per_sf = 0;
                                    if (annual_amount && building_size > 0) {
                                        price_per_sf = annual_amount / building_size;
                                    }
                                    total_sf_price += Number(price_per_sf.toFixed(2));
                                %>
                                <tr class="<%= trClass %>">
                                    <td><%= getArrayValue('name', oe, '-') %></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('annual_amount', oe, 0, true) %></span></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= toPercentage(getArrayValue('percentage_of_gross', oe)) %></span></td>
                                    <td class="<%= isLast ? 'total-sum' : '' %>"><span><%= getArrayValue('total_per_sq_ft', oe, 0, true) %></span></td>
                                    <td colspan="2"><%= getArrayValue('comments', oe, 'None') %></td>
                                </tr>
                                <% }) %>
                            <% } %>
                            <tr class="bold <%= !trClass ? 'odd' : '' %>">
                                <td>Total Expenses</td>
                                <td><span><%= toCurrency(evaluation_income_approach.total_oe_annual_amount) %></span></td>
                                <td><%= toPercentage(evaluation_income_approach.total_oe_gross) %></td>
                                <td><span><%= toCurrency(evaluation_income_approach.total_oe_per_square_feet) %></span></td>
                                <td colspan="2"></td>
                            </tr>
                            </tbody>
                        </table>
                    <% }else{ %>
                    </table>
                    <% 
                        }
                        let expenseNotes = evaluation_income_approach?.expense_notes?.trim() || '';
                        let exlength = expenseNotes?.length;
                        let exendLength = 5000;
                        let limit = 5000;
                        let count = exlength > limit ? exlength / limit : 1;
                        let startLen = 0;
                        for (let i = 0; i <= count; i++) {
                            const segment = expenseNotes.substring(startLen, startLen + limit);
                            if (segment.length > 0) {
                                const lastDot = segment.lastIndexOf(' ');
                                const endPart = segment.substring(lastDot);
                                const chars = endPart.length;
                                if (chars < 10) {
                                    limit -= chars;
                                    exendLength -= chars;
                                }
                            const data = expenseNotes.substring(startLen, startLen + limit);
                            if (i !== 0) {
                            %>
                                <div class="new-page valuations_page_3">
                                    <div class="page-header">
                                        <%- chapter %>
                                    </div>
                                    <div class="description">
                                        <p class="title">Income <span class="subtitle">Approach</span></p>
                                        <p class="label"><%= label %></p>
                                        <p class="regular-description">
                                            <span class="type income_type">
                                                Expense Notes:
                                            </span>
                                            <span class="text income_text">
                                                <% expenseNotes = expenseNotes.replace(data, '').trim(); %>
                                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                            </span>
                                        </p>
                                    <!-- </div> -->
                                <!-- </div> -->
                                <% } else { %>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            Expense Notes:
                                        </span>
                                        <span class="text income_text">
                                            <% expenseNotes = expenseNotes.replace(data, '').trim(); %>
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                    <!-- </div> -->
                                    <!-- </div> -->
                                <% }
                                exendLength = limit; 
                                const spaceLeft = ((exendLength - exlength) / 150) - countOe;
                                if (i === Math.floor(count) && spaceLeft > 10) { 
                                    // No action needed, condition met
                                } else if (count === 1 && spaceLeft > 10) { 
                                    // No action needed, condition met
                                } else { %>
                                </div>
                                <%- watermark %>
                                </div>
                            <% }
                            }
                        } %>
                    <%
                        let spaceLeft = ((exendLength - exlength) / 150) -  countOe;
                        if(spaceLeft > 10){
                            showCAP = false %>
                            <div>
                                <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                        
                                <p class="main-description">
                                    Recent sales indicate acceptable capitalization rates ranging from
                                    <%= evaluation_income_approach.monthly_capitalization_rate %>%
                                    - <%= evaluation_income_approach.sq_ft_capitalization_rate %>%, thus utilizing the
                                    direct capitalization method of evaluation the author has assumed a capitalization rate
                                    of <%= evaluation_income_approach.annual_capitalization_rate %>% based on the property's location,
                                    condition, and tenant mix.
                                </p>
                                <table class="cap-rate-table">
                                    <tbody>
                                    <tr>
                                        <td>Net Operating Value</td>
                                        <td></td>
                                        <td><b><%= toCurrency(evaluation_income_approach.total_net_income) %></b></td>
                                        <td></td>
                                    </tr>
                                    <tr class="odd">
                                        <td>Cap Rate Range</td>
                                        <td class="percentage-cell"><%= toPercentage(evaluation_income_approach.monthly_capitalization_rate || 0) %></td>
                                        <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.annual_capitalization_rate || 0) %></span></td>
                                        <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.sq_ft_capitalization_rate || evaluation_income_approach.high_capitalization_rate) %></span></td>
                                    </tr>
                                    <tr>
                                        <td>Indicated Value</td>
                                        <td class="percentage-cell"><%= evaluation_income_approach.indicated_range_monthly ? toCurrency(evaluation_income_approach.indicated_range_monthly) : getNotAvailableLabel() %></td>
                                        <td class="percentage-cell"><span class="contents"><%= evaluation_income_approach.indicated_range_annual ? toCurrency(evaluation_income_approach.indicated_range_annual) : getNotAvailableLabel() %></span></td>
                                        <td class="percentage-cell">
                                            <span class="contents">
                                                <%= evaluation_income_approach?.indicated_range_sq_feet ? toCurrency(evaluation_income_approach?.indicated_range_sq_feet) : getNotAvailableLabel() %>
                                        </span>
                                        </td>
                                    </tr>
                                    <tr class="odd">
                                        <td>Indicated Value PSF</td>
                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_monthly) %></td>
                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_annual) %></td>
                                        <td><%= toCurrency(evaluation_income_approach?.indicated_psf_sq_feet) %></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <% 
                                    let capNotes = evaluation_income_approach?.cap_rate_notes || '';
                                    const capNotesLength = capNotes?.length || 0;
                                    let capNotesLimit = 3600;
                                    if(showOe){
                                        oes.length ? capNotesLimit = capNotesLimit - ((countOe+3 + (label ? 2 : 0))*120) : capNotesLimit = capNotesLimit;
                                    }
                                    if(count < 2){
                                        spaceLeft = (exlength / 150) + 10;
                                        capNotesLimit = capNotesLimit - (spaceLeft * 120);
                                    }
                                    if (capNotesLength <= capNotesLimit) { %>
                                %>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            CAP Rate Notes:
                                        </span>
                                        <span class="text income_text">
                                            <%- capNotes.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                </div>
                            </div>
                                <%- watermark %>
                        </div>
                            <% } else {
                                let limit = label.length ? 4600 : 4800;
                                let count = Math.ceil(capNotesLength / limit);
                                let startLen = 0;

                                for (let i = 0; i < count; i++) {
                                    if(!i){
                                        if(showOe){
                                            countOe ? limit = limit - ((countOe + 3 + (label ? 2 : 0)) * 120) : limit = limit;
                                        }
                                        let exNotesCount = exlength > 5000 ? exlength / 5000 : 1;
                                        if(exNotesCount < 2){
                                            spaceLeft = (exlength / 120) + 10;
                                            limit = limit - (spaceLeft * 120);

                                            if(capNotes.length >= startLen + limit){
                                                count++;
                                            }
                                        }
                                    }
                                    let chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                    let lastSpace = chunk.lastIndexOf(' ');
                                    if (lastSpace !== -1 && chunk.length - lastSpace < 10) {
                                        limit -= (chunk.length - lastSpace);
                                        chunk = capNotes?.trim().substring(startLen, startLen + limit);
                                    }
                                    const data = chunk;

                                    if (i !== 0 && capNotes.trim().length > 0) {
                                %>
                                <div class="new-page valuations_page_3">
                                    <div class="page-header">
                                        <%- chapter %>
                                    </div>
                                    <div class="description">
                                        <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                                        <p class="label"><%= label %></p>
                                        <p class="regular-description">
                                            <span class="type income_type">
                                                CAP Rate Notes:
                                            </span>
                                            <span class="text income_text">
                                                <% capNotes = capNotes.replace(data, '').trim(); %>
                                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                            </span>
                                        </p>
                                    </div>
                                    <%- watermark %>
                                </div>
                                <% } else { %>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            CAP Rate Notes:
                                        </span>
                                        <span class="text income_text">
                                            <% capNotes = capNotes.replace(data, '').trim(); %>
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                </div>
                                </div>
                                <%- watermark %>
                            </div>
                            <% }
                                    limit = 5000;
                                    endLength = limit;
                                } 
                            } %>
                        <% } else{
                    %>
                <!-- </div> -->
            <!-- </div> -->
            <%  
                } }else if(showExpenseNotes){
                    const expenseNotes = evaluation_income_approach?.expense_notes?.trim();
                    let exlength = expenseNotes.length;
                    let limit = 5000;
                    let exendLength = limit;
                    let count = exlength > limit ? exlength / limit : 1;
                    let startLen = 0;
                    for (let i = 0; i <= count; i++) {
                        const segment = expenseNotes.substring(startLen, startLen + limit);
                        if (segment.length > 0) {
                            const lastDot = segment.lastIndexOf(' ');
                            const endPart = segment.substring(lastDot);
                            const chars = endPart.length;
                            if (chars < 10) {
                                limit -= chars;
                                exendLength -= chars;
                            }
                            const data = expenseNotes.substring(startLen, startLen + limit);
                            if (i !== 0) {
                            %>
                                <div class="new-page valuations_page_3">
                                    <div class="page-header">
                                        <%- chapter %>
                                    </div>
                                    <div class="description">
                                        <p class="title">Income <span class="subtitle">Approach</span></p>
                                        <p class="label"><%= label %></p>
                                        <p class="regular-description">
                                            <span class="type income_type">
                                                Expense Notes:
                                            </span>
                                            <span class="text income_text">
                                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                            </span>
                                        </p>
                                    </div>
                                    <%- watermark %>
                                </div>
                                <% } else { %>
                                    <p class="regular-description">
                                        <span class="type income_type">
                                            Expense Notes:
                                        </span>
                                        <span class="text income_text">
                                            <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                        </span>
                                    </p>
                                    <%- watermark %>
                                </div>
                                </div>
                                <% } 
                                startLen = exendLength; 
                                limit = 4700; 
                                exendLength = startLen + limit; 
                            }
                        } %>
            <% } 
            if(showCAP) { %>
            <div class="new-page valuations_page_3">
                <div class="page-header">
                    <%- chapter %>
                </div>
                <div class="description">
                    <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                    <p class="label"><%= label %></p>
                    <p class="main-description">
                        Recent sales indicate acceptable capitalization rates ranging from
                        <%= evaluation_income_approach.monthly_capitalization_rate %>%
                        - <%= evaluation_income_approach.sq_ft_capitalization_rate %>%, thus utilizing the
                        direct capitalization method of evaluation the author has assumed a capitalization rate
                        of <%= evaluation_income_approach.annual_capitalization_rate %>% based on the property's location,
                        condition, and tenant mix.
                    </p>
                    
                    <table class="cap-rate-table">
                        <tbody>
                        <tr>
                            <td>Net Operating Value</td>
                            <td></td>
                            <td><b><%= toCurrency(evaluation_income_approach.total_net_income) %></b></td>
                            <td></td>
                        </tr>
                        <tr class="odd">
                            <td>Cap Rate Range</td>
                            <td class="percentage-cell"><%= toPercentage(evaluation_income_approach.monthly_capitalization_rate) %></td>
                            <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.annual_capitalization_rate) %></span></td>
                            <td class="percentage-cell"><span class="contents"><%= toPercentage(evaluation_income_approach.sq_ft_capitalization_rate) %></span></td>
                        </tr>
                        <tr>
                            <td>Indicated Value</td>
                            <td class="percentage-cell"><%= evaluation_income_approach.indicated_range_monthly ? toCurrency(evaluation_income_approach.indicated_range_monthly) : getNotAvailableLabel() %></td>
                            <td class="percentage-cell"><span class="contents"><%= evaluation_income_approach.indicated_range_annual ? toCurrency(evaluation_income_approach.indicated_range_annual) : getNotAvailableLabel() %></span></td>
                            <td class="percentage-cell">
                                <span class="contents">
                                    <%= evaluation_income_approach?.indicated_range_sq_feet ? toCurrency(evaluation_income_approach?.indicated_range_sq_feet) : getNotAvailableLabel() %>
                                </span>
                            </td>
                        </tr>
                            <tr class="odd">
                                <td>Indicated Value PSF</td>
                                <td><%= toCurrency(evaluation_income_approach?.indicated_psf_monthly) %></td>
                                <td><%= toCurrency(evaluation_income_approach?.indicated_psf_annual) %></td>
                                <td><%= toCurrency(evaluation_income_approach?.indicated_psf_sq_feet) %></td>
                                <td></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>

                    <% let capNotes = evaluation_income_approach?.cap_rate_notes || '';
                        const capNotesLength = capNotes?.length || 0;
                        if (capNotesLength <= 3600) { %>
                            <p class="regular-description">
                                <span class="type income_type">
                                    CAP Rate Notes:
                                </span>
                                <span class="text income_text">
                                    <%- capNotes.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                </span>
                            </p>
                </div>
                    <%- watermark %>
            </div>
                <% } else {
                    let count = Math.ceil(capNotesLength / 3600);
                    let startLen = 0;
                    let limit = label.length ? 4800 : 5000;

                    for (let i = 0; i < count; i++) {
                        let chunk = capNotes?.trim().substring(startLen, startLen + limit);
                        let lastSpace = chunk.lastIndexOf(' ');
                        if (lastSpace !== -1 && chunk.length - lastSpace < 10) {
                            limit -= (chunk.length - lastSpace);
                            chunk = capNotes?.trim().substring(startLen, startLen + limit);
                        }
                        const data = chunk;

                        if (i !== 0 && data.trim().length > 0) {
                    %>
                    <div class="new-page valuations_page_3">
                        <div class="page-header">
                            <%- chapter %>
                        </div>
                        <div class="description">
                            <p class="title">Cap <span class="subtitle">Rate Analysis</span></p>
                            <p class="label"><%= label %></p>
                            <p class="regular-description">
                                <span class="type income_type">
                                    CAP Rate Notes:
                                </span>
                                <span class="text income_text">
                                    <% capNotes = capNotes.replace(data, '').trim(); %>
                                    <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                                </span>
                            </p>
                        </div>
                        <%- watermark %>
                    </div>
                    <% } else { 
                        if (data.trim().length > 0) { %>
                        <p class="regular-description">
                            <span class="type income_type">
                                CAP Rate Notes:
                            </span>
                            <span class="text income_text">
                                <% capNotes = capNotes.replace(data, '').trim(); %>
                                <%- data.replace(/^<p[^>]*>/i, '').replace(/<br>/g, '').replace(/<p><\/p>/g, '').replace(/<p>/g, '<p class="regular-description"><span class="text income_text">').replace(/<\/p>/g, '</span></p>').replace(/<\/p>$/i, '') %>
                            </span>
                        </p>
                    </div>
                    <%- watermark %>
                </div>
                <% }
                    }
                        limit = 5000;
                        endLength = limit;
                    } 
                }
            }  
        }
    }
} 
} %>