<%
let paras = [];
for(let index = 0; index < evaluation.res_evaluation_scenarios.length; index++){
    const scenario = evaluation.res_evaluation_scenarios[index];
    if(scenario.has_cost_approach){
    let label = '';
    if (evaluation && evaluation.res_evaluation_scenarios && evaluation.res_evaluation_scenarios.length > 1 && label === '') {
        label = evaluation.res_evaluation_scenarios[index].name;
    }
    const evaluation_cost_approach = scenario?.evaluation_cost_approach;
    const comparatives = evaluation_cost_approach?.comp_data;
    if(evaluation_cost_approach){
        const notes = evaluation_cost_approach.notes ? evaluation_cost_approach.notes : '';
        let notesLength = notes.length;
        let count = 1;
        if (notesLength > 2300) {
            count = Math.ceil(notesLength / 2300);
        }
        let startLen = 0;
        let endLength = 2300;
        let limit = 2300;
        for (let loop = 0; loop <= count; loop++) {
            const trimmedNotes = notes.replace(/<p><br><\/p>/g, '').trim();
            if (!loop || trimmedNotes.substr(startLen, limit).length) {
        %>
        <%
        let stateName='';
        const {state} = evaluation;
        stateName = state?.toUpperCase();
        <!-- const matchState = states.find((obj) => obj?.code === state); -->
        <!-- if (!matchState)  -->
        <!-- { -->
        <!-- stateName = state; -->
        <!-- } else { -->
        <!-- stateName = matchState?.name; -->
        <!-- } -->
        %>
            <div class="new-page valuations_page_3" data-type="cost-approach">
                <div class="page-header" style="<%= (loop > 0 && loop <= 5) ? 'padding-bottom:5rem ; margin-left: 50rem;' : '' %>">
                    <%- chapter %>
                </div>

                    <% if (loop === 0) { %>
                        <div class="description">
                            <p class="title">Cost <span class="subtitle">Approach (Land Value)</span></p>
                            <p class="label"><%= label %></p>
                            <p class="regular-description">In the cost approach the author derives a final estimate of value by working on
                                two fronts. The first is to find an estimate of value for the land itself (utilizing the direct sales
                                comparison approach), and the second is to evaluate the replacement cost of the structure and site
                                improvements.
                            </p>
                        </div>
                        <div class="description">
                            <p class="title">Land <span class="subtitle">Valuation</span></p>
                        </div>
                    <% } %>
                    <div class="description">
                    <% if (loop === 0) { %>
                        <table class="comps-table">
                            <thead>
                                <tr>
                                <th></th>
                                <th>Subject Property</th>
                                <% if (
                                    evaluation_cost_approach &&
                                    Array.isArray(evaluation_cost_approach.comp_data) &&
                                    evaluation_cost_approach.comp_data.length > 0
                                ) { %>
                                    <% evaluation_cost_approach.comp_data.forEach((comp, i) => { %>
                                    <th>Comparable #<%= i + 1 %></th>
                                    <% }) %>
                                <% } %>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td></td>
                                    <% let url = ''; %>
                                    <% if (evaluation.coverImage) {
                                        url = evaluation.coverImage;
                                    } else {
                                        url = '/images/default-placeholder.png';
                                    } %>
                                    <td>
                                        <img width="150" height="80" src="<%= url %>" class="image-added"/>
                                    </td>
                                    
                                    <% let comp_image_url = ''; %>
                                    <% if (
                                        evaluation_cost_approach &&
                                        Array.isArray(evaluation_cost_approach.comp_data) &&
                                        evaluation_cost_approach.comp_data.length > 0
                                    ) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => { 
                                            const leaseComp = comp?.comp_details;
                                            if (leaseComp?.property_image_url) {
                                                const url = leaseComp?.property_image_url;
                                                comp_image_url = evaluation.baseUrl+url;
                                            }else {
                                                comp_image_url = '/images/default-placeholder.png';
                                            }
                                        %>
                                        <td>
                                            <img width="150" height="80" src="<%= comp_image_url %>" />
                                        </td>
                                        <% }) %>
                                    <% } %>
                                </tr>
                                <tr>
                                    <td class="blue bold">Location</td>
                                    <td>
                                        <div style="white-space: initial;">
                                        <%= evaluation.street_address %>, <br/>
                                        <%= evaluation.city %>, <%=stateName %> <%= evaluation.zipcode %>
                                        </div>
                                    </td>
                                    
                                    <% if (
                                        evaluation_cost_approach &&
                                        Array.isArray(evaluation_cost_approach.comp_data) &&
                                        evaluation_cost_approach.comp_data.length > 0
                                    ) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => { 
                                            const leaseComp = comp.comp_details;
                                            let fullStateName='';
                                            const {state} = leaseComp;
                                            fullStateName = state?.toUpperCase();
                                            <!-- const matchState = states.find((obj) => obj?.code === state); -->
                                            <!-- if (!matchState)  -->
                                            <!-- { -->
                                            <!-- fullStateName = state; -->
                                            <!-- } else { -->
                                            <!-- fullStateName = matchState?.name; -->
                                            <!-- } -->
                                            if (leaseComp && leaseComp.street_address) { %>
                                            <td>
                                                <div style="white-space: initial;">
                                                    <%= leaseComp.street_address %>, <br/>
                                                    <%= leaseComp.city %>, <%= fullStateName %> <%= leaseComp.zipcode %>
                                                </div>
                                            </td>
                                            <% } else { %>
                                                <td>Address Not Provided</td>
                                            <% } %>
                                        <% }) %>
                                    <% } %>
                                </tr>
                                <tr class="odd">
                                    <td>Date Sold</td>
                                    <td></td>
                                    <% if (
                                        evaluation_cost_approach &&
                                        Array.isArray(evaluation_cost_approach.comp_data) &&
                                        evaluation_cost_approach.comp_data.length > 0
                                    ) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => { 
                                            const compData = comp.comp_details;
                                            let sale_status = '';
                                            if (compData?.sale_status === 'Pending' && compData?.type === 'sale') {
                                                sale_status = (formatDate(compData.date_sold, true) || getNotAvailableLabel()) + '( P )';
                                            }
                                        %>
                                         <td>
                                            <%= sale_status !== '' ? sale_status : (formatDate(compData?.date_sold, true) || getNotAvailableLabel()) %>
                                        </td>
                                        <% }); %>
                                    <% }; %>
                                </tr>
                                <% 
                                let rowIndex = 0;
                                evaluation_cost_approach?.comparison_attributes.forEach(attr => { 
                                    rowIndex++;
                                    const key = attr.comparison_key;
                                    const name = attr.comparison_value;
                                %>
                                <tr class="<%= rowIndex % 2 === 0 ? 'odd' : '' %>">
                                    <td><%= name %></td>
                                    <!-- Subject property cell -->
                                    <td>
                                        <% 
                                        let subjectValue = evaluation[key];
                                        if(key === 'building_size'){
                                            subjectValue = numberFormat(evaluation[key]); 
                                        }
                                        else if (key === 'services') {
                                            subjectValue = evaluation.utilities_select;
                                        }
                                        else if (key === 'city_county') {
                                        const city = evaluation?.city || 'N/A';
                                        const county = evaluation?.county || 'N/A';
                                        subjectValue = `${city}, ${county}`;
                                        }
                                        else if(key === 'city_state'){
                                            subjectValue = evaluation.city +', '+ stateName;
                                        }
                                        else if(key === 'heating_and_cooling'){
                                               subjectValue = evaluation?.heating_cooling || 'N/A';
                                        } 
                                        else if(key === 'basement_sf'){
                                            const resZoning = evaluation?.res_zonings;
                                            const totalBasementSqFt = resZoning.reduce((sum, item) => {
                                            return sum + (item?.basement_finished_sq_ft || 0) + (item?.basement_unfinished_sq_ft || 0);
                                            }, 0);
                                            subjectValue = numberFormat(totalBasementSqFt); 
                                        } 
                                        else if(key === 'year_built_remodeled'){
                                            const year_built = evaluation.year_built ? evaluation.year_built : getNotAvailableLabel(); 
                                            const year_remodeled = evaluation.year_remodeled ? evaluation.year_remodeled : getNotAvailableLabel(); 
                                            subjectValue =  year_built+' / ' + year_remodeled;
                                        }
                                        else if(key === 'condition'){
                                       const condition = evaluation.condition;
                                        const matchCondition = conditionOptions.find(obj => obj?.code === condition);
                                        const conditionValue =
                                        matchCondition?.name === '--Select--'
                                            ? 'N/A'
                                            : !matchCondition
                                            ? condition
                                            : matchCondition.name || 'N/A';
                                        subjectValue = conditionValue;
                                        }
                                          else if (key === 'topography') {
                                            const topography = evaluation.topography || '';
                                            const matchTopography = topographyOptions.find(obj => obj?.code === topography);
                                            const topographyValue = matchTopography?.name === '--Select--'
                                                ? getNotAvailableLabel()
                                                : !matchTopography
                                                    ? topography
                                                    : matchTopography.name || getNotAvailableLabel();
                                            subjectValue = topographyValue;
                                        }
                                        else if(key === 'frontage'){
                                            const frontage = evaluation?.frontage || '';
                                            const matchFrontage = frontageOptions.find(obj => obj?.code === frontage);
                                            const frontageValue = matchFrontage?.name === '--Select--'
                                            ? 'N/A'
                                            : !matchFrontage
                                                ? frontage
                                                : matchFrontage.name || 'N/A';
                                            subjectValue = frontageValue; 
                                        }  
                                        else if (key === 'land_size_sf') {
                                            const landSizeSfValue =
                                                evaluation.land_dimension === 'SF'
                                                ? evaluation.land_size
                                                : evaluation.land_dimension === 'ACRE'
                                                ? evaluation.land_size * 43560 : 0;
                                            subjectValue = numberFormat(landSizeSfValue); // Optional: round to 2 decimal places
                                        }
                                        else if (key === 'gross_living_area') {
                                        const resZonings = Array.isArray(evaluation?.res_zonings) ? evaluation.res_zonings : [];
                                        const totalGrossLivingSqFt = resZonings.reduce((sum, item) => {
                                            const val = parseFloat(item?.gross_living_sq_ft);
                                            return sum + (Number.isFinite(val) ? val : 0);
                                        }, 0);
                                        subjectValue = totalGrossLivingSqFt > 0
                                            ? (typeof numberFormat === 'function' ? numberFormat(totalGrossLivingSqFt) + ' SF' : totalGrossLivingSqFt + ' SF')
                                            : 'N/A';
                                        }
                                        else if (key === 'land_size_acre') {
                                            const landSizeAcreValue =
                                                evaluation.land_dimension === 'SF'
                                                ? evaluation.land_size / 43560
                                                : evaluation.land_dimension === 'ACRE'
                                                ? evaluation.land_size : 0;
                                            subjectValue = landSizeAcreValue ? numberFormat(landSizeAcreValue,3) : getNotAvailableLabel(); // Optional: round to 2 decimal places
                                        }
                                         else if (key === 'other_amenities') {
                                        const amenities = evaluation?.res_evaluation_amenities;
                                        const result = Array.isArray(amenities) && amenities.length > 0
                                            ? amenities
                                                .map(item => item?.additional_amenities)
                                                .filter(Boolean)
                                                .join(', ')
                                            : 'N/A';
                                            subjectValue = result + ", " + evaluation?.other_amenities;
                                        }
                                        else if(key === 'building_size_land_size'){
                                            let landSize = getNotAvailableLabel();
                                            if (
                                                evaluation.land_size &&
                                                evaluation.land_dimension == 'SF'
                                            ) {
                                                landSize =
                                                numberFormat(evaluation.land_size) + ' SF';
                                            } else if (
                                                evaluation.land_size &&
                                                evaluation.land_dimension == 'ACRE'
                                            ) {
                                                landSize =
                                                numberFormat(evaluation.land_size, 3) +
                                                ' AC';
                                            }
                                            const buildingSize = evaluation.building_size ? numberFormat(evaluation.building_size) + ' SF' : getNotAvailableLabel(); 
                                            subjectValue = buildingSize + ' / ' + landSize; 
                                        }
                                        if (typeof subjectValue === 'undefined' || subjectValue === null || subjectValue === '') {
                                            subjectValue = '';
                                        }
                                        %>
                                        <%= subjectValue %>
                                    </td>
                                    <!-- Comps cells -->
                                    <%
                                    if (Array.isArray(comparatives) && comparatives.length > 0) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => {
                                        const leaseComp = comp.comp_details;
                                        let fullStateName='';
                                        const {state} = leaseComp;
                                        fullStateName = state?.toUpperCase();
                                        <!-- const matchState = states.find((obj) => obj?.code === state); -->
                                        <!-- if (!matchState)  -->
                                        <!-- { -->
                                        <!-- fullStateName = state; -->
                                        <!-- } else { -->
                                        <!-- fullStateName = matchState?.name; -->
                                        <!-- } -->
                                        let value = leaseComp ? leaseComp[key] : null;
                                        if(key === 'building_size'){
                                            value = numberFormat(leaseComp[key]); 
                                        }
                                        else if(key === 'date_sold'){
                                            value = formatDate(leaseComp.date_sold, true);
                                        }
                                        else if(key === 'city_state'){
                                            value = leaseComp.city +', '+ fullStateName;
                                        }
                                        else if(key === 'heating_and_cooling'){
                                            value = leaseComp?.heating_cooling || 'N/A';
                                        }
                                        else if(key === 'basement_sf'){
                                            const resZoning = leaseComp?.res_zonings;
                                            const totalBasementSqFt = resZoning.reduce((sum, item) => {
                                            return sum + (item?.basement_finished_sq_ft || 0) + (item?.basement_unfinished_sq_ft || 0);
                                            }, 0);
                                            value = numberFormat(totalBasementSqFt); 
                                        } 
                                        else if(key === 'frontage'){
                                            const frontage = leaseComp?.frontage || '';
                                            const matchFrontage = frontageOptions.find(obj => obj?.code === frontage);
                                            const frontageValue = matchFrontage?.name === '--Select--'
                                            ? 'N/A'
                                            : !matchFrontage
                                                ? frontage
                                                : matchFrontage.name || 'N/A';
                                            value = frontageValue; 
                                        }
                                        else if (key === 'price_per_unit') {
                                            value = leaseComp?.total_units ? toCurrency((leaseComp.sale_price / leaseComp.total_units) || 0) : '';
                                        }
                                          else if (key === 'other_amenities') {
                                            const amenities = leaseComp?.res_comp_amenities;
                                            const result = Array.isArray(amenities) && amenities.length > 0
                                                ? amenities
                                                    .map(item => item?.additional_amenities)
                                                    .filter(Boolean)
                                                    .join(', ')
                                                : 'N/A';
                                              value = result + ", " + leaseComp?.other_amenities;
                                            }
                                        else if (key === 'land_size_sf') {
                                            const landSizeAcreValue =
                                                leaseComp.land_dimension === 'SF'
                                                ? leaseComp.land_size
                                                : leaseComp.land_dimension === 'ACRE'
                                                    ? leaseComp.land_size * 43560
                                                    : 0;
                                            value = numberFormat(landSizeAcreValue); // Optional: round to 2 decimal places
                                        }
                                        else if (key === 'land_size_acre') {
                                            const landSizeAcreValue =
                                                leaseComp.land_dimension === 'SF'
                                                ? leaseComp.land_size / 43560
                                                : leaseComp.land_dimension === 'ACRE'
                                                    ? leaseComp.land_size
                                                    : 0;
                                            value = landSizeAcreValue ? numberFormat(landSizeAcreValue, 3) : getNotAvailableLabel();
                                        }
                                        else if (key === 'dollar_per_bed') {
                                            const dollarPerBed =
                                            leaseComp.lease_rate === 0 || leaseComp.total_beds === 0
                                            ? 0
                                            : leaseComp.lease_rate_unit === 'monthly'
                                              ? (leaseComp.lease_rate / leaseComp.total_beds) / 12
                                              : leaseComp.lease_rate / leaseComp.total_beds;;
                                            value = toCurrency(dollarPerBed); // Optional: round to 2 decimal places
                                        }
                                        else if (key === 'price_sf_per_year') {
                                            value = toCurrency(leaseComp.price_square_foot || 0); 
                                        }
                                        else if (key === 'cap_rate') {
                                            value = toPercentage(leaseComp.cap_rate || 0); 
                                        }
                                        else if (key === 'city_county') {
                                            const city = leaseComp?.city || 'N/A';
                                            const county = leaseComp?.county || 'N/A';
                                            value = `${city}, ${county}`;
                                        }
                                        else if (key === 'gross_living_area') {
                                        const resZonings = Array.isArray(leaseComp?.res_zonings) ? leaseComp.res_zonings : [];
                                        const totalGrossLivingSqFt = resZonings.reduce((sum, item) => {
                                            const val = parseFloat(item?.gross_living_sq_ft);
                                            return sum + (Number.isFinite(val) ? val : 0);
                                        }, 0);
                                        value = totalGrossLivingSqFt > 0
                                            ? (typeof numberFormat === 'function' ? numberFormat(totalGrossLivingSqFt) + ' SF' : totalGrossLivingSqFt + ' SF')
                                            : 'N/A';
                                        }
                                        else if (key === 'price_per_sf_land') {
                                            let newValue = 0;
                                            if (leaseComp.land_dimension === 'SF') {
                                                if (leaseComp.land_size === null || leaseComp.land_size === 0) {
                                                    newValue = 0; // If land_size is null or 0, show $0.00
                                                } else {
                                                    newValue = leaseComp.sale_price / leaseComp.land_size;
                                                }
                                                } else {
                                                    if (leaseComp.land_size === null || leaseComp.land_size === 0) {
                                                        newValue = 0; // If land_size is null or 0, show $0.00
                                                    } else {
                                                        newValue = leaseComp.sale_price / (leaseComp.land_size * 43560); // Assuming this part was cut off
                                                    }
                                                }
                                                value = toCurrency(newValue);
                                        }
                                        else if (key === 'price_per_acre') {
                                            let landSizeAcre = 0;
                
                                            if (leaseComp?.land_dimension === 'SF') {
                                                landSizeAcre = leaseComp?.land_size ? parseFloat((leaseComp?.sale_price / leaseComp?.land_size).toFixed(2)) * 43560 : 0;
                                            } else {
                                                landSizeAcre = leaseComp?.land_size ? parseFloat((leaseComp?.sale_price / leaseComp?.land_size).toFixed(2)) : 0;
                                            }
                                            value = toCurrency(landSizeAcre);
                                        }else if (key === 'sale_price') {
                                            value = toCurrency(leaseComp.sale_price);
                                        }else if (key === 'services') {
                                            value = leaseComp.utilities_select;
                                        }else if (key === 'net_operating_income') {
                                            value = toCurrency(leaseComp.net_operating_income);
                                        }else if (key === 'beds') {
                                            value = leaseComp.total_beds ?
                                            leaseComp.total_beds.toLocaleString(2) // Show total beds for 'beds'
                                            : ''
                                        }
                                        else if(key === 'year_built_remodeled'){
                                            const year_built = leaseComp.year_built ? leaseComp.year_built : getNotAvailableLabel(); 
                                            const year_remodeled = leaseComp.year_remodeled ? leaseComp.year_remodeled : getNotAvailableLabel(); 
                                            value =  year_built+' / ' + year_remodeled;
                                        }
                                        else if(key === 'condition'){
                                            const condition = leaseComp.condition || '';
                                            const matchCondition = conditionOptions.find(obj => obj?.code === condition);
                                            const conditionValue =
                                            matchCondition?.name === '--Select--'
                                                ? getNotAvailableLabel()
                                                : !matchCondition
                                                ? condition
                                                : matchCondition.name || getNotAvailableLabel();
                                            value = conditionValue;
                                        }
                                        else if (key === 'topography') {
                                            const topography = leaseComp.topography || '';
                                            const matchTopography = topographyOptions.find(obj => obj?.code === topography);
                                            const topographyValue = matchTopography?.name === '--Select--'
                                                ? getNotAvailableLabel()
                                                : !matchTopography
                                                    ? topography
                                                    : matchTopography.name || getNotAvailableLabel();
                                            value = topographyValue;
                                        }
                                        else if(key === 'price_per_sf'){
                                            value = toCurrency(leaseComp.price_square_foot); 
                                        }
                                        else if(key === 'building_size_land_size'){
                                            let landSize = getNotAvailableLabel();
                                            if (leaseComp.land_size) {
                                                if (
                                                    evaluation.land_dimension == 'SF' &&
                                                    leaseComp.land_dimension == 'ACRE'
                                                ) {
                                                    landSize = numberFormat(leaseComp.land_size * 43560) + ' SF';
                                                } else if (
                                                    evaluation.land_dimension == 'ACRE' &&
                                                    leaseComp.land_dimension == 'SF'
                                                ) {
                                                    landSize = numberFormat((leaseComp.land_size / 43560), 3) +' AC';
                                                } else {
                                                    if (leaseComp.land_dimension == 'SF') {
                                                        landSize = numberFormat(leaseComp.land_size) + ' SF';
                                                    } else if (leaseComp.land_dimension == 'ACRE') {
                                                        landSize = numberFormat(leaseComp.land_size, 3) + ' AC';
                                                    }
                                                }
                                            }
                                            const buildingSize = leaseComp.building_size ? numberFormat(leaseComp.building_size) + ' SF' : getNotAvailableLabel(); 
                                            value = buildingSize + ' / ' + landSize; 
                                        }
                                        if (!value || value === '') {
                                            value = getNotAvailableLabel();
                                        }
                                        %>
                                        <td><%= value %></td>
                                        <% }) %>
                                    <% } %>
                                </tr>
                                <% }) %>
                                <tr>
                                    <td class="blue bold">Comparison Criteria</td>
                                    <td></td>
                                    <% if (
                                        evaluation_cost_approach &&
                                        Array.isArray(evaluation_cost_approach.comp_data) &&
                                        evaluation_cost_approach.comp_data.length > 0
                                    ) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => { %>
                                        <td></td>
                                        <% }) %>
                                    <% } %>
                                </tr>
                                <% 
                                let criteriaIndex = 0;
                                const adjustments = evaluation_cost_approach?.cost_subject_property_adjustments;
                                if (Array.isArray(adjustments)) {
                                    adjustments.forEach(adjustment => { %>
                                    <tr class="<%= criteriaIndex % 2 === 0 ? 'odd' : '' %>">
                                        <td><%= adjustment.adj_value %></td>
                                        <td></td>
                                        <% if (
                                            evaluation_cost_approach &&
                                            Array.isArray(evaluation_cost_approach.comp_data) &&
                                            evaluation_cost_approach.comp_data.length > 0
                                        ) { %>
                                            <% evaluation_cost_approach.comp_data.forEach((comp, i) => { 
                                                const leaseComp = comp;
                                                let matched = null;

                                                if (leaseComp && Array.isArray(leaseComp.comps_adjustments)) {
                                                    matched = leaseComp.comps_adjustments.find(ca => ca.adj_key === adjustment.adj_key);
                                                }

                                                let perclass = '';
                                                if(matched.adj_value > 0){
                                                    perclass = 'plus';
                                                }else if(matched.adj_value < 0){
                                                    perclass = 'minus';
                                                }
                                            %>
                                            <td class='<%= perclass %>'>
                                                <% if (matched) { %>
                                                    <% if (evaluation.comp_adjustment_mode === 'Dollar') { %>
                                                    <%= toCurrency( matched.adj_value) %>
                                                    <% } else { %>
                                                    <%= toPercentage( matched.adj_value) %>
                                                    <% } %>
                                                <% } else { %>
                                                    <%= getNotAvailableLabel() %>
                                                <% } %>
                                            </td>
                                            <% }) %>
                                        <% } %>
                                    </tr>
                                <% criteriaIndex++; }) 
                                } %>
                                <tr>
                                    <td class="blue bold">Overall Adjustment</td>
                                    <td></td>
                                    <% if (
                                        evaluation_cost_approach &&
                                        Array.isArray(evaluation_cost_approach.comp_data) &&
                                        evaluation_cost_approach.comp_data.length > 0
                                    ) { %>
                                        <% evaluation_cost_approach.comp_data.forEach((comp, i) => { 
                                            const leaseComp = comp;
                                            const totalAdjustment = leaseComp?.total_adjustment ?? 0;
                                    %>
                                        <td>
                                            <% if (evaluation.comp_adjustment_mode === 'Dollar') { %>
                                            <%= toCurrency(totalAdjustment) %>
                                            <% } else { %>
                                            <%= toPercentage(totalAdjustment) %>
                                            <% } %>
                                        </td>
                                    <% }) %>
                                <% } %>
                                </tr>
                                <tr class="odd">
                                    <td>
                                        <%= evaluation.land_dimension === "ACRE" ? "Average Adjusted $/ACRE" : "Average Adjusted $/SF" %>
                                    </td>
                                    <td>
                                        <%= toCurrency(evaluation_cost_approach.averaged_adjusted_psf) %>
                                    </td>
                                
                                    <% if (Array.isArray(comparatives) || typeof comparatives === 'object') {
                                        comparatives.forEach((comp) => {
                                            if (comp.adjusted_psf != null) { %>
                                            <td>
                                                <%= toCurrency(comp.adjusted_psf) %>
                                            </td>
                                        <% } else { %>
                                            <td>$0.00 PSF</td>
                                        <% } %>
                                    <% 
                                            });
                                        }
                                    %>
                                </tr>
                                <tr>
                                    <td>Weighting</td>
                                    <td class="<%= evaluation_cost_approach.weight != 100 ? 'blue' : '' %>">
                                        <%= toPercentage(evaluation_cost_approach.weight) %>
                                    </td>
                                    <%
                                        const costComparatives = evaluation_cost_approach.comp_data;
                                        if (Array.isArray(costComparatives) || typeof costComparatives === 'object') {
                                            costComparatives.forEach((comp) => {
                                    %>
                                        <td>
                                            <%= typeof comp.weight !== 'undefined' ? toPercentage(comp.weight) : toPercentage(0) %>
                                        </td>
                                    <% 
                                            });
                                        }
                                    %>
                                </tr>
                                <tr class="odd">
                                    <td>Adjusted Comp Value</td>
                                    <td>
                                        <%= evaluation_cost_approach.land_value ? toCurrency(evaluation_cost_approach.land_value) : getNotAvailableLabel() %>
                                    </td>
                                    <%
                                        if (Array.isArray(costComparatives) || typeof costComparatives === 'object') {
                                            costComparatives.forEach(() => {
                                    %>
                                        <td></td>
                                    <% 
                                            });
                                        }
                                    %>
                                </tr>
                            </tbody>
                        </table>
                    <% } %>
                    <%
                        // Split notes into paragraphs
                        let string = trimmedNotes.substr(startLen, limit);
                        paras = string.split('<p>');
                        let chars_per_line = 115;
                        if (theme === 'nai' || theme === 'nai_portland') chars_per_line = 120;
                        let lineSpacing = 1.9;
                        let fontSize = 13;
                        let pageHeight = 203; // mm
                        let mmToInch = 0.0393701;
                        let pointsToInch = 1 / 72;
                        let fontHeightInInches = fontSize * pointsToInch;
                        let lineSpacingInInches = fontHeightInInches * lineSpacing;
                        let pageHeightInInches = pageHeight * mmToInch;
                        let lines = Math.floor(pageHeightInInches / lineSpacingInInches);
                        let total_page_lines = 0;
                        let check_para_count = 0;
                        lines = 30;
                        if (loop === 0) {
                            lines = 3;
                            if (evaluation.getLeaseComps && evaluation_cost_approach.cost_subject_property_adjustments) {
                                const labels = Object.keys(JSON.parse(evaluation_cost_approach.cost_subject_property_adjustments || '{}')).length;
                                if (labels < 8) {
                                    lines += 8 - labels;
                                } else {
                                    lines -= labels - 8;
                                }
                            }
                        }
                        if (paras.length > 12) {
                            lines = 16;
                            if (loop === 0) lines = 2;
                            if (loop > 0) lines = 20;
                        }
                        let p_counts_total = 0;
                        let selected_lines = 0;
                        for (let j = 0; j < paras.length; j++) {
                            if (paras[j]) {
                                let p_counts = paras[j].trim().length;
                                let total_lines = p_counts / chars_per_line;
                                total_page_lines += Math.ceil(total_lines);
                                p_counts_total += p_counts;
                            }
                            if (total_page_lines <= lines) {
                                check_para_count = j;
                            }
                        }
                        if (total_page_lines >= lines) {
                            let overflow_lines = total_page_lines - lines;
                            let para_length = paras.length - 1;
                            let last_p_length = paras[para_length].length;
                            if (check_para_count < para_length) {
                                let char_limit = 0;
                                for (let k = 0; k <= check_para_count; k++) {
                                    let check_p_length = paras[k].length + 3;
                                    char_limit += check_p_length;
                                    let total_lines = check_p_length / chars_per_line;
                                    selected_lines += Math.ceil(total_lines);
                                }
                                if (selected_lines < lines) {
                                    let check_p_len = paras[check_para_count + 1].length + 3;
                                    let get_lines = lines - selected_lines;
                                    let chars = get_lines * chars_per_line;
                                    char_limit += chars;
                                }
                                limit = char_limit;
                                endLength = startLen + limit;
                            }
                        }
                        let check_string = trimmedNotes.substr(startLen, limit);
                        let last_dot = check_string.lastIndexOf(' ');
                        let end_part = check_string.substr(last_dot);
                        let chars = end_part.length;
                        if (chars < 10) {
                            limit -= chars;
                            endLength -= chars;
                        }
                        let data = trimmedNotes.substr(startLen, limit);
                        if (loop !== 0) {
                            if (data.startsWith('>')) {
                                data = data.substr(1);
                            } else if (data.startsWith('p>')) {
                                data = data.substr(2);
                            } else if (data.startsWith('<p>')) {
                                data = data.substr(3);
                            }
                            data = '<p>' + data + '</p>';
                        }
                    %>
                    <p><span class="<%= (loop === 0) ? 'nots' : '' %>"><%= (loop === 0) ? 'Notes - ' : '' %></span><%- data.trim().substr(3) %></p>
                    <%- watermark %>
                </div>
            </div>
        <%
            }
            if (!paras) {
                limit = 0;
            } else if (paras.length > 12) {
                limit = 2300;
            } else {
                limit = 3800;
            }
            startLen = endLength;
            endLength = startLen + limit;
            if (notesLength > startLen && count > loop) {
                count++;
            }
        } %>
    <div class="new-page valuations_page_3">
        <div class="page-header">
            <%- chapter %>
        </div>
        <div class="description">
            <p class="title">Cost Comparison <span class="subtitle">Approach</span></p>
            <p class="label"><%= label %></p>
            <p class="regular-description">
                The below cost comparables for the subject property have been adjusted based on the following criteria noted by the author.
            </p>

            <% if (
                evaluation_cost_approach &&
                Array.isArray(evaluation_cost_approach.comp_data) &&
                evaluation_cost_approach.comp_data.length > 0
            ) { %>
            <% evaluation_cost_approach.comp_data.forEach((comp, i) => { %>
                <table class="comparable-table">
                <tr>
                    <td class="comparable-number">Comparable #<%= i + 1 %></td>
                    <td></td>
                </tr>
                <tr>
                    <td width="20%">
                    <% 
                        let imgUrl = '/images/default-placeholder.png';
                        const leaseComp = comp.comp_details;
                        if (leaseComp?.property_image_url) {
                            const url = leaseComp?.property_image_url;
                            imgUrl = evaluation.baseUrl+url;
                        }
                    %>
                    <img width="210" height="120" src="<%= imgUrl %>" class="image-added" />
                    </td>
                    <td width="80%" class="comparable-info">
                    <p class="comparable-title"><%= leaseComp?.street_address || '' %></p>
                    <p class="comparable-description"><%- leaseComp?.summary || '' %></p>
                    <p class="comparable-description"><%- comp.adjustment_note || '' %></p>
                    </td>
                </tr>
                </table>
            <% }); %>
            <% } %>
        </div>
        <%- watermark %>
    </div>
    <div class="new-page valuations_page_3 cost_map" data-type="cost_map">
        <%
        const locations = [];
        // Default map settings
        locations.push({ lat: evaluation.map_pin_lat, lng: evaluation.map_pin_lng, color: 'red' });
        let comps = [];
        let zoom = 20;
        let area_map_zoom = evaluation_cost_approach?.area_map_zoom ? evaluation_cost_approach.area_map_zoom : 12;
        const map_type = evaluation_cost_approach?.map_type ?  evaluation_cost_approach.map_type : 'roadmap';
        const map_center_lat_position = evaluation_cost_approach?.map_center_lat
            ? evaluation_cost_approach.map_center_lat
            : evaluation.map_pin_lat;
        const map_center_lng_position = evaluation_cost_approach?.map_center_lng
            ? evaluation_cost_approach.map_center_lng
            : evaluation.map_pin_lng;

        if (area_map_zoom) {
            zoom = area_map_zoom - 2;
        }

        const colors = [
            { color: 'blue' },
            { color: 'green' }, { color: 'yellow' },
            { color: 'purple' }, { color: 'orange' }
        ]; 
        if (Array.isArray(comparatives) && comparatives.length > 0) {
            let leaseComps = evaluation_cost_approach.comp_data;
            leaseComps.forEach((comp, index) => {
                let { map_pin_lat, map_pin_lng } = comp.comp_details;
                const color = colors[index % colors.length];
                if (!map_pin_lat) {
                    map_pin_lat = evaluation?.map_pin_lat;
                }
                if (!map_pin_lng) {
                    map_pin_lng = evaluation?.map_pin_lng;
                }
                locations.push({ lat: map_pin_lat, lng: map_pin_lng, color });
            });
        } %>
        <% // Construct the URL with markers
        const markers = locations
            .map((location) => `markers=size:small|color:${location.color.color}%7C${location.lat},${location.lng}`)
            .join('&');

        const url = `https://maps.googleapis.com/maps/api/staticmap?center=${map_center_lat_position},${map_center_lng_position}&zoom=${zoom}&scale=2&size=600x400&maptype=${map_type}&${markers}&key=${googleApiKey}`;

        %>
        
        <div class="page-header">
            <%- chapter %>
        </div>
        
        <div class="description">
            <p class="title">Cost <span class="subtitle">Comparison Map</span></p>
            <p class="label"><%= label %></p>
        </div>
        
        <div id="cost_map">
            <img style="width: 100%; height: 130mm;" src="<%= url %>">
        </div>        
        <div id="map-landmarks">
        <span class="label">Key</span>
            <div class="map-landmark">
                <div class="el">
                    <div class="list subject-text">
                        <span class="img">
                        <img src="https://maps.google.com/mapfiles/ms/icons/pink-dot.png" />
                        </span>
                        <strong>Subject Property: </strong>
                        <% 
                            const state = evaluation?.state;
                           let address = evaluation.street_address?.trim() || '';
                            if (evaluation.city?.trim()) address += `, ${evaluation.city.trim()}`;
                             if (state?.trim()) address += `, ${state.trim().toUpperCase()}`;
                        %>
                        <span class="ellip"><%= address %></span>
                    </div>
        
                    <% let n = 1; 
                    if (Array.isArray(comparatives) && comparatives.length > 0) {
                        let leaseComps = evaluation_cost_approach.comp_data;
                        leaseComps.forEach(comp => { 
                            const compDetails = comp.comp_details;
                            const {state} = compDetails;
                            const color = colors[n - 1]?.color || '6b94ff';
                            let address = compDetails.street_address?.trim() || '';
                            if (compDetails.city?.trim()) address += `, ${compDetails.city.trim()}`;
                            if (state?.trim()) address += `, ${state.trim().toUpperCase()}`;
                        %>
                        <div class="list">
                            <span class="img">
                                <img src="https://maps.google.com/mapfiles/ms/icons/<%= color %>-dot.png" />
                            </span>
                            <strong>Comp #<%= n %>:</strong>
                            <span class="ellip"><%= address %></span>
                        </div>
                        <% if (n % 3 === 0) { %></div><div class="el"><% } %>
                    <% n++; });
                    } %>
                </div>
            </div>
        </div>
        <%- watermark %>
    </div>
    <%
    const comments = evaluation_cost_approach.comments;
    let commentLength = notes?.length || 0;
    let commentCount = commentLength > 2300 ? Math.ceil(commentLength / 2300) : 1;
    let commentStartLen = 0;
    let commentEndLength = 2300;
    let commentLimit = 2300;
    
    for (let loop = 0; loop < commentCount; loop++) {
        let cleanedNotes = comments?.replace(/<p><br><\/p>/g, '').trim() || '';
        if (!loop || cleanedNotes.substr(commentStartLen, commentLimit).length > 0) {
    %>
    <div class="new-page valuations_page_3 side_graphic">
        <div class="page-header">
            <%- chapter %>
        </div>
        <%- section %>
        <div class="description">
            <% if (loop === 0) { %>
                <p class="title">Cost <span class="subtitle land-improvement-value">Approach (Improvement Value)</span></p>
                <p class="label"><%= label %></p>
                <p class="regular-description">The authors utilize replacement costs to estimate cost of new construction based on various information from: local contractors, ongoing construction projects or nationally recognized cost estimate books.</p>
                <table class="type-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Cost PSF</th>
                            <th>Total SF</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong><%= evaluation.street_address %></strong></td>
                            <td></td>
                            <td></td>
                            <td></td>
                        </tr>
                        <% const improvements = evaluation_cost_approach?.cost_improvements || []; %>
                        <% let lastClass = ''; %>
                        <% improvements.forEach((imp, i) => { %>
                            <% lastClass = (i % 2 === 0) ? 'odd' : ''; %>
                            <%
                            const typeCode = getInputValue(imp, 'type');
                            const typeName = getSubOptionNameByCode(zoneOptions, typeCode);
                            %>
                            <tr class="<%= lastClass %>">
                                <td><%= typeName %> - <%= to_area(imp['sf_area']) %></td>
                                <td><%= imp['adjusted_psf'] ? toCurrency(imp['adjusted_psf']) : '' %></td>
                                <td><%= imp['sf_area'] ? to_area(imp['sf_area']) : '' %></td>
                                <td class="<%= (i + 1) === improvements.length ? 'total-sum' : '' %>"><%= imp['structure_cost'] ? toCurrency(imp['structure_cost']) : ' ' %></td>
                            </tr>
                        <% }); %>
                        <tr class="<%= lastClass === 'odd' ? '' : 'odd' %>">
                            <td class="pad-left-10">Total</td>
                            <td></td>
                            <td></td>
                            <td><%= toCurrency(evaluation_cost_approach.overall_replacement_cost) %></td>
                        </tr>
                    </tbody>
                    <thead>
                        <tr><th colspan="4">&nbsp;</th></tr>
                        <tr>
                            <th colspan="3">Improvement Valuation</th>
                            <th>Total Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="bold">Total Overall Replacement</td>
                            <td class="bold"><%= toCurrency(evaluation_cost_approach.overall_replacement_cost) %></td>
                        </tr>
                        <tr class="odd">
                            <td colspan="3">Depreciation ( <%= (evaluation_cost_approach.total_depreciation_percentage * 100).toFixed(2) %>% )</td>
                            <td class="underline"><%= toCurrency(evaluation_cost_approach.total_depreciation) %></td>
                        </tr>
                        <tr>
                            <td colspan="3">Total Depreciated Cost</td>
                            <td><%= toCurrency(evaluation_cost_approach.total_depreciated_cost) %></td>
                        </tr>
                        <tr class="odd">
                            <td colspan="3">Estimated Land Value</td>
                            <td class="underline"><%= toCurrency(evaluation_cost_approach.land_value) %></td>
                        </tr>
                        <tr>
                            <td colspan="3">Total Cost Valuation</td>
                            <td class="blue bold"><%= toCurrency(evaluation_cost_approach.total_cost_valuation) %> @ <%= toPsf(evaluation_cost_approach.indicated_value_psf) %></td>
                        </tr>
                    </tbody>
                </table>
            <% } %>
            <% if (comments) { %>
                <% let string = comments.substr(commentStartLen, commentLimit); %>
                <% let one_line_char_limit = ['default', 'stockman'].includes(theme) ? (label ? 80 : 95) : (label ? 90 : 105); %>
                <% if (loop === 0) {
                    const improvements = evaluation_cost_approach?.cost_improvements || [];
                    const max_lines = 18;
                    const total_char = (max_lines - improvements.length) * one_line_char_limit;
                    commentLimit = total_char;
                    commentEndLength = commentLimit;
                } %>
                <% let check_string = cleanedNotes.substr(commentStartLen, commentLimit);
                    let last_dot = check_string.lastIndexOf(' ');
                    let chars = check_string.length - last_dot;
                    if (chars < 10) {
                        commentLimit -= chars;
                        commentEndLength -= chars;
                    }
                    let data = cleanedNotes.substr(commentStartLen, commentLimit);
                    if (loop !== 0) {
                        if (data.startsWith('>')) data = data.substring(1);
                        if (data.startsWith('p>')) data = data.substring(2);
                        if (data.startsWith('<p>')) data = data.substring(3);
                        data = '<p>' + data + '</p>';
                    }
                %>
                <p><span class="nots"><%= loop === 0 ? 'Notes - ' : '' %></span><%- data.trim() %></p>
                <%- watermark %>
            <% } %>
        </div>
    </div>
    <%
        commentLimit = ['default', 'stockman'].includes(theme) ? 3110 : 3510;
        commentStartLen = commentEndLength;
        commentEndLength = commentStartLen + commentLimit;
        if (commentLength > commentStartLen && commentCount > loop) commentCount++;
        } %>
    <% } 
    }
}
} %>