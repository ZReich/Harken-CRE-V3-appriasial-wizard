# UI consistency across approach grids
_Exported on 1/7/2026 at 07:12:38 MST from Cursor (2.3.26)_

---

**User**

All of our approach grids, for every scenario. Land valuation, multifamily sales comparison. All of those grids should Look. And function. with scrolling With Property cards, like everything. Should. Function. and be laid out the same way. As far as basic functions. both multifamily and land valuation. are not completely converted over to dark mode. There's still areas That are not. Done. Like, In the land valuation, The transaction adjustments under elements. and the subject property Those are still in white. And then underneath overall comparability, There's still white background. The ad comps. Area is still white. Multifamily is... Pretty much the same. Um, The photo background for subject. is still in light mode. The add comps area is still in light mode. Summary. That's in gold? And none of our other... Grids have that color in them. Adjust comp range. that is also in gold. And then overall comparatability. Underneath all of that, the background is still white. So this all needs to be fixed.

---

**Cursor**

I'll examine the Land Valuation and Multifamily Sales Comparison components to identify and fix the dark mode inconsistencies. Let me start by exploring the relevant files.

Let me check for multifamily-specific components and understand the full scope of the dark mode issues:

Now I'll fix the dark mode issues across all grids. Let me start with the LandSalesGrid:

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full bg-blue-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#eff6ff' }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#dbeafe' : '#f0f9ff', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full bg-blue-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#eff6ff' }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#dbeafe' : '#f0f9ff', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full bg-blue-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#eff6ff' }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#dbeafe' : '#f0f9ff', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#dbeafe' : '#f0f9ff', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: row.id === 'adjPriceAcre' ? '#dbeafe' : '#f0f9ff', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
              backgroundColor: 'var(--bg-secondary)'
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  ArrowUpRight,
  ArrowDownRight,
  Minus,
  Maximize2,
  Minimize2,
  X,
  Trash2,
  AlertTriangle,
  Bold,
  Italic,
  Underline,
  AlignLeft,
  AlignCenter,
  List,
  MessageSquare,
  Plus,
  ChevronDown,
  PenLine,
  ChevronUp,
  Map as MapIcon,
  Star,
  Link2
} from 'lucide-react';
import { NotesEditorModal } from '../../../components/NotesEditorModal';
import { Property, GridRowData, PropertyValues, ComparisonValue, Section, GridRowCategory } from '../types';
import { PropertyCard } from './PropertyCard';
import { INITIAL_ROWS, SECTIONS } from '../constants';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';
import { useCustomGridElements } from '../../../hooks/useCustomGridElements';
import type { SalesGridConfiguration } from '../../../types';
import { getUnitLabel, getUnitShortLabel, INDUSTRIAL_CONFIG } from '../../../constants/gridConfigurations';
import { getPhysicalFieldsForGridType, getTransactionalFieldsForGridType } from '../../../constants/gridFieldDefinitions';

interface SalesGridProps {
  properties: Property[];
  values: PropertyValues;
  analysisMode?: 'standard' | 'residual';
  scenarioId?: number;
  onDeleteProperty?: (propertyId: string) => void;
  /** Grid configuration - determines visible fields and calculation methods */
  gridConfig?: SalesGridConfiguration;
}


export const SalesGrid: React.FC<SalesGridProps> = ({ properties, values: initialValues, analysisMode = 'standard', scenarioId, onDeleteProperty, gridConfig }) => {

  const { setApproachConclusion, setSalesComparisonData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, salesComparisonData, landValuationData, subjectData } = wizardState;
  
  // Use grid config from props, or fall back to wizard state, or use a default
  const activeGridConfig = gridConfig || subjectData?.gridConfiguration;
  const { addCustomElement, getCustomElementsByCategory, removeCustomElement } = useCustomGridElements();

  // Get current scenario name for element filtering
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const [rows, setRows] = useState<GridRowData[]>(INITIAL_ROWS);
  const [sections] = useState<Section[]>(SECTIONS);
  // Load values from context if available, otherwise use initial values from props
  const [values, setValues] = useState<PropertyValues>(
    salesComparisonData?.values ? (salesComparisonData.values as unknown as PropertyValues) : initialValues
  );
  const [reconciliationText, setReconciliationText] = useState(
    salesComparisonData?.reconciliationText ?? ""
  );
  const [activePopover, setActivePopover] = useState<{ rowId: string, propId: string, field: 'value' | 'adjustment' } | null>(null);
  const [hiddenSections, setHiddenSections] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{ isOpen: boolean; sectionId: string; sectionTitle: string } | null>(null);
  const [notesEditor, setNotesEditor] = useState<{ isOpen: boolean; propId: string; propName: string; rowKey: string } | null>(null);
  const [notesContent, setNotesContent] = useState<string>('');
  const [openElementDropdown, setOpenElementDropdown] = useState<string | null>(null);
  const [addingCustomToSection, setAddingCustomToSection] = useState<string | null>(null);
  const [customElementName, setCustomElementName] = useState('');
  const [saveCustomForFuture, setSaveCustomForFuture] = useState(false);
  const [dropdownPlacement, setDropdownPlacement] = useState<'top' | 'bottom'>('bottom');
  const buttonRef = useRef<HTMLButtonElement>(null);

  // Calculate the concluded value from comparable properties
  const concludedValue = useMemo(() => {
    const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
    if (typeof subjectBldgSize !== 'number' || subjectBldgSize <= 0) return null;

    // Get adjusted price/SF from all comps (non-subject properties)
    const compValues: number[] = [];
    properties.forEach(prop => {
      if (prop.type === 'subject') return;
      const propValues = values[prop.id];
      if (!propValues) return;

      // Calculate overall adjustment
      let netAdj = 0;
      Object.keys(propValues).forEach(key => {
        const entry = propValues[key];
        if (entry?.adjustment !== undefined && typeof entry.adjustment === 'number' && key !== 'price' && key !== 'price_sf') {
          netAdj += entry.adjustment;
        }
      });

      // Calculate adjusted price/SF
      let basePriceSf = 0;
      if (analysisMode === 'residual') {
        const price = propValues['price']?.value;
        const land = propValues['land_value']?.value;
        const bldgSf = propValues['bldg_size_fact']?.value;
        if (typeof price === 'number' && typeof land === 'number' && typeof bldgSf === 'number' && bldgSf > 0) {
          basePriceSf = (price - land) / bldgSf;
        }
      } else {
        basePriceSf = typeof propValues['price_sf']?.value === 'number' ? propValues['price_sf'].value : 0;
      }

      if (basePriceSf > 0) {
        const adjustedPriceSf = basePriceSf * (1 + netAdj);
        let totalVal = subjectBldgSize * adjustedPriceSf;
        if (analysisMode === 'residual') {
          const subjectLand = values['subject']?.['subject_land_add_back']?.value;
          if (typeof subjectLand === 'number') totalVal += subjectLand;
        }
        compValues.push(totalVal);
      }
    });

    if (compValues.length === 0) return null;

    // Return average of all comp values as the indication
    const avg = compValues.reduce((a, b) => a + b, 0) / compValues.length;
    return Math.round(avg);
  }, [values, properties, analysisMode]);

  // Sync concluded value to WizardContext when scenarioId is provided
  useEffect(() => {
    if (scenarioId !== undefined && concludedValue !== null) {
      setApproachConclusion(scenarioId, 'Sales Comparison', concludedValue);
    }
  }, [scenarioId, concludedValue, setApproachConclusion]);

  // Auto-populate subject_land_add_back from Land Valuation when in residual mode
  // This creates the data connection between Land Valuation and Sales Comparison
  useEffect(() => {
    if (analysisMode === 'residual' && landValuationData?.concludedLandValue) {
      const currentValue = values['subject']?.['subject_land_add_back']?.value;
      
      // Only auto-populate if not already set or if land valuation value changed
      if (currentValue !== landValuationData.concludedLandValue) {
        setValues(prev => ({
          ...prev,
          subject: {
            ...prev['subject'],
            subject_land_add_back: { 
              value: landValuationData.concludedLandValue, 
              adjustment: 0,
              flag: 'similar' as const,
              linkedFromLandValuation: true  // Flag to indicate this came from Land Valuation
            }
          }
        }));
      }
    }
  }, [analysisMode, landValuationData?.concludedLandValue]);

  // Calculate concluded value per SF
  const concludedValuePsf = useMemo(() => {
    const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
    if (concludedValue && typeof subjectBldgSize === 'number' && subjectBldgSize > 0) {
      return Math.round(concludedValue / subjectBldgSize);
    }
    return null;
  }, [concludedValue, values]);
  
  // Calculate concluded value per unit (for multi-family properties)
  const concludedValuePerUnit = useMemo(() => {
    const unitCount = subjectData?.totalUnitCount;
    if (concludedValue && typeof unitCount === 'number' && unitCount > 0) {
      return Math.round(concludedValue / unitCount);
    }
    return null;
  }, [concludedValue, subjectData?.totalUnitCount]);
  
  // Determine if we should show dual metrics (both $/SF and $/unit)
  const showDualMetrics = activeGridConfig?.gridType === 'multi_family' || 
                          activeGridConfig?.gridType === 'hotel_motel';
  
  // Get the primary metric based on configuration
  const primaryMetricLabel = activeGridConfig ? getUnitLabel(activeGridConfig.unitOfMeasure) : '$/SF';
  const primaryMetricValue = activeGridConfig?.unitOfMeasure === 'per_unit' 
    ? concludedValuePerUnit 
    : concludedValuePsf;

  // Persist sales comparison data to WizardContext
  useEffect(() => {
    // Convert local property and value format to storage format
    const dataToSave = {
      properties: properties.map(p => ({
        id: p.id,
        type: p.type,
        name: p.name,
        address: p.address,
        image: p.image,
        status: p.status,
      })),
      values: values as unknown as Record<string, Record<string, import('../../../types').SalesCompValue>>,
      reconciliationText,
      analysisMode,
      concludedValue,
      concludedValuePsf,
    };
    setSalesComparisonData(dataToSave);
  }, [values, reconciliationText, analysisMode, concludedValue, concludedValuePsf, properties, setSalesComparisonData]);

  // Handle clicking outside to close dropdowns
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  // Get available elements for a section that haven't been added yet
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (sectionId: string) => {
    const currentRowKeys = rows.filter(r => r.category === sectionId).map(r => r.key);

    // Normalize section ID to match registry format
    const normalizedSection = normalizeSection(sectionId) as SectionType;

    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'sales_comparison',
      scenario: currentScenario,
      excludeKeys: currentRowKeys
    });

    // Map to the format expected by the dropdown
    return filteredElements.map(el => ({
      key: el.key,
      label: el.label,
      description: el.description
    }));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (sectionId: GridRowCategory, element: { label: string; key: string }) => {
    const newRow: GridRowData = {
      id: `${sectionId}_${element.key}`,
      category: sectionId,
      label: element.label,
      key: element.key,
      format: 'text',
      mode: 'both'
    };

    // Check if already exists
    if (rows.some(r => r.key === element.key)) return;
    setRows(prev => [...prev, newRow]);
    setOpenElementDropdown(null);
  };

  // Start adding a custom element - switch view in dropdown
  const handleStartCustomElement = (sectionId: GridRowCategory) => {
    setAddingCustomToSection(sectionId);
    setCustomElementName('');
    setSaveCustomForFuture(false);
  };

  // Confirm adding custom element
  const handleConfirmCustomElement = () => {
    if (!customElementName.trim() || !addingCustomToSection) return;

    const sectionId = addingCustomToSection as GridRowCategory;
    const name = customElementName.trim();
    const key = name.toLowerCase().replace(/\s+/g, '_') + '_custom';

    // Add to current grid
    const newRow: GridRowData = {
      id: `${sectionId}_${key}`,
      category: sectionId,
      label: name,
      key: key,
      format: 'text',
      mode: 'both'
    };

    if (!rows.some(r => r.key === key)) {
      setRows(prev => [...prev, newRow]);
    }

    // Save to local storage if requested
    if (saveCustomForFuture) {
      addCustomElement({
        category: sectionId,
        label: name,
        key: key
      });
    }

    setOpenElementDropdown(null);
    setAddingCustomToSection(null);
    setCustomElementName('');
    setSaveCustomForFuture(false);
  };

  const removeRow = (rowId: string) => {
    setRows(prev => prev.filter(r => r.id !== rowId));
  };

  const handleSectionDeleteClick = (sectionId: string, sectionTitle: string) => {
    setConfirmDelete({ isOpen: true, sectionId, sectionTitle });
  };

  const confirmSectionDelete = () => {
    if (confirmDelete) {
      setHiddenSections(prev => new Set([...prev, confirmDelete.sectionId]));
      setConfirmDelete(null);
    }
  };

  const cancelSectionDelete = () => {
    setConfirmDelete(null);
  };

  const openNotesEditor = (propId: string, propName: string, rowKey: string) => {
    const currentValue = values[propId]?.[rowKey]?.value || '';
    // Clear placeholder text - start with empty if it's a default placeholder
    const isPlaceholder = typeof currentValue === 'string' &&
      (currentValue.toLowerCase().includes('click to') || currentValue === '');
    setNotesContent(isPlaceholder ? '' : (typeof currentValue === 'string' ? currentValue : ''));
    setNotesEditor({ isOpen: true, propId, propName, rowKey });
  };

  const saveNotes = () => {
    if (notesEditor) {
      setValues(prev => ({
        ...prev,
        [notesEditor.propId]: {
          ...prev[notesEditor.propId],
          [notesEditor.rowKey]: { ...prev[notesEditor.propId]?.[notesEditor.rowKey], value: notesContent }
        }
      }));
      setNotesEditor(null);
      setNotesContent('');
    }
  };

  const closeNotesEditor = () => {
    setNotesEditor(null);
    setNotesContent('');
  };

  const applyFormatting = (format: string) => {
    // Use execCommand for rich text formatting
    const editor = document.getElementById('notes-editor');
    if (!editor) return;

    editor.focus();

    switch (format) {
      case 'bold':
        document.execCommand('bold', false);
        break;
      case 'italic':
        document.execCommand('italic', false);
        break;
      case 'underline':
        document.execCommand('underline', false);
        break;
      case 'alignLeft':
        document.execCommand('justifyLeft', false);
        break;
      case 'alignCenter':
        document.execCommand('justifyCenter', false);
        break;
      case 'bullet':
        document.execCommand('insertUnorderedList', false);
        break;
    }

    // Update state with new content
    setTimeout(() => {
      if (editor) {
        setNotesContent(editor.innerHTML);
      }
    }, 0);
  };

  const handleEditorInput = () => {
    const editor = document.getElementById('notes-editor');
    if (editor) {
      setNotesContent(editor.innerHTML);
    }
  };

  const getPropertyName = (propId: string) => {
    const prop = properties.find(p => p.id === propId);
    return prop?.name || propId;
  };

  // Strip HTML tags for preview display
  const stripHtml = (html: string) => {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  };

  // Focus editor when modal opens
  useEffect(() => {
    if (notesEditor?.isOpen) {
      setTimeout(() => {
        const editor = document.getElementById('notes-editor');
        if (editor) {
          editor.focus();
          // Move cursor to end
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(editor);
          range.collapse(false);
          selection?.removeAllRanges();
          selection?.addRange(range);
        }
      }, 100);
    }
  }, [notesEditor?.isOpen]);

  const LABEL_COL_WIDTH = 160;
  const SUBJECT_COL_WIDTH = 180;
  const COMP_COL_WIDTH = 170;
  const ACTION_COL_WIDTH = 160;

  // Calculate total grid width for reconciliation section
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (properties.length - 1) * COMP_COL_WIDTH;

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (activePopover) {
        const target = event.target as Element;
        if (!target.closest('.adjustment-popover')) {
          setActivePopover(null);
        }
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover]);

  const formatValue = (val: string | number | null | undefined, format?: string) => {
    if (val === null || val === undefined) return '-';
    if (format === 'currency' && typeof val === 'number') {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
    }
    if (format === 'percent' && typeof val === 'number') {
      return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
    }
    if (format === 'currency_sf' && typeof val === 'number') {
      return `${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(val)} / SF`;
    }
    return val;
  };

  const getCalculatedValue = (propId: string, rowKey: string): number | string | null => {
    const propValues = values[propId];
    if (!propValues) return null;

    // AUTO-CALCULATE: Extracted Cap Rate = NOI at Sale / Sale Price
    if (rowKey === 'extracted_cap_rate') {
      const price = propValues['price']?.value;
      const noi = propValues['noi_at_sale']?.value;
      if (typeof price === 'number' && price > 0 && typeof noi === 'number' && noi > 0) {
        return noi / price; // Returns as decimal (e.g., 0.0624 for 6.24%)
      }
      return null;
    }

    if (rowKey === 'residual_value') {
      const price = propValues['price']?.value;
      const land = propValues['land_value']?.value;
      if (typeof price === 'number' && typeof land === 'number') return price - land;
      return null;
    }

    if (rowKey === 'residual_price_sf') {
      const price = propValues['price']?.value;
      const land = propValues['land_value']?.value;
      const bldgSize = propValues['bldg_size_fact']?.value;
      if (typeof price === 'number' && typeof land === 'number' && typeof bldgSize === 'number' && bldgSize > 0) {
        return (price - land) / bldgSize;
      }
      return null;
    }

    if (rowKey === 'overall_adj') {
      const adjustmentKeys = ['time_adj', 'location_adj', 'condition_adj', 'construction_adj', 'scale_adj', 'use_adj'];
      let total = 0;
      adjustmentKeys.forEach(k => {
        const val = propValues[k]?.value;
        if (typeof val === 'number') total += val;
      });
      return total;
    }

    if (rowKey === 'overall_comp') {
      const overallAdj = getCalculatedValue(propId, 'overall_adj') as number || 0;
      if (overallAdj < -0.025) return 'Superior';
      if (overallAdj > 0.025) return 'Inferior';
      return 'Similar';
    }

    if (rowKey === 'adj_price_sf' || rowKey === 'adj_price_sf_val') {
      const overallAdj = getCalculatedValue(propId, 'overall_adj') as number || 0;
      let basePriceSf = 0;
      if (analysisMode === 'residual') {
        const resVal = getCalculatedValue(propId, 'residual_price_sf');
        basePriceSf = typeof resVal === 'number' ? resVal : 0;
      } else {
        basePriceSf = typeof propValues['price_sf']?.value === 'number' ? propValues['price_sf'].value : 0;
      }
      if (basePriceSf === 0) return null;
      return basePriceSf * (1 + overallAdj);
    }

    if (rowKey === 'total_value') {
      const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
      const finalPriceSf = getCalculatedValue(propId, 'adj_price_sf_val') as number || 0;
      if (propId === 'subject') return null;
      if (typeof subjectBldgSize === 'number' && finalPriceSf > 0) {
        let val = subjectBldgSize * finalPriceSf;
        if (analysisMode === 'residual') {
          const subjectLand = values['subject']?.['subject_land_add_back']?.value;
          if (typeof subjectLand === 'number') val += subjectLand;
        }
        return formatValue(val, 'currency');
      }
      return null;
    }
    return null;
  };

  const updateValue = (propId: string, rowKey: string, val: number, field: 'value' | 'adjustment' = 'value') => {
    setValues(prev => ({
      ...prev,
      [propId]: {
        ...prev[propId],
        [rowKey]: { ...prev[propId][rowKey], [field]: val }
      }
    }));
  };

  const AdjustmentBadge = ({ flag, value, onClick, showValue = true }: { flag?: string, value: number, onClick: () => void, showValue?: boolean }) => {
    const isSup = flag === 'superior' || flag === 'Superior';
    const isInf = flag === 'inferior' || flag === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer`;

    if (isSup) return <span onClick={onClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100`}>
      <ArrowUpRight className="w-3 h-3" /> SUP {showValue && value !== 0 && <span className="ml-1 border-l border-emerald-200 pl-1">{Math.abs(value * 100).toFixed(1)}%</span>}
    </span>;
    if (isInf) return <span onClick={onClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100`}>
      <ArrowDownRight className="w-3 h-3" /> INF {showValue && value !== 0 && <span className="ml-1 border-l border-red-200 pl-1">{Math.abs(value * 100).toFixed(1)}%</span>}
    </span>;
    return <span onClick={onClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600`}><Minus className="w-3 h-3" /> SIM</span>;
  };

  // Click-to-cycle function for qualitative adjustments
  const cycleQualitativeValue = (currentFlag: string | undefined): { value: string, flag: 'similar' | 'superior' | 'inferior' } => {
    const cycle: { value: string, flag: 'similar' | 'superior' | 'inferior' }[] = [
      { value: 'Similar', flag: 'similar' },
      { value: 'Superior', flag: 'superior' },
      { value: 'Inferior', flag: 'inferior' }
    ];
    const currentIndex = cycle.findIndex(c => c.flag === currentFlag?.toLowerCase());
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Qualitative Chip Component - click to cycle through values
  const QualitativeChip = ({ propId, rowKey }: { propId: string, rowKey: string }) => {
    const currentValue = values[propId]?.[rowKey];
    const flag = currentValue?.flag || 'similar';

    const handleClick = () => {
      const next = cycleQualitativeValue(flag);
      setValues(prev => ({
        ...prev,
        [propId]: {
          ...prev[propId],
          [rowKey]: { value: next.value, flag: next.flag }
        }
      }));
    };

    const isSup = flag === 'superior';
    const isInf = flag === 'inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;

    if (isSup) return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };


  // Add Element Button with Dropdown - positioned in the Elements column
  const AddElementButton = ({ sectionId }: { sectionId: GridRowCategory }) => {
    const isOpen = openElementDropdown === sectionId;
    const isAddingCustom = addingCustomToSection === sectionId;
    const availableElements = isAddingCustom ? [] : getAvailableElements(sectionId);

    // Smart positioning logic
    const toggleDropdown = () => {
      if (isOpen) {
        setOpenElementDropdown(null);
        setAddingCustomToSection(null);
      } else {
        // Check available space below
        if (buttonRef.current) {
          const rect = buttonRef.current.getBoundingClientRect();
          const spaceBelow = window.innerHeight - rect.bottom;
          setDropdownPlacement(spaceBelow < 250 ? 'top' : 'bottom');
        }
        setOpenElementDropdown(sectionId);
      }
    };

    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button
          ref={buttonRef}
          onClick={toggleDropdown}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>

        {isOpen && (
          <div className={`absolute left-0 w-72 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden flex flex-col transition-all duration-200 ${dropdownPlacement === 'top' ? 'bottom-full mb-1' : 'top-full mt-1'
            }`}>
            {isAddingCustom ? (
              <div className="p-3">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">New Custom Element</span>
                  <button
                    onClick={() => setAddingCustomToSection(null)}
                    className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
                  >
                    <X size={14} />
                  </button>
                </div>

                <div className="mb-3">
                  <label className="block text-[10px] font-medium text-slate-500 dark:text-slate-400 mb-1">Element Name</label>
                  <input
                    type="text"
                    value={customElementName}
                    onChange={(e) => setCustomElementName(e.target.value)}
                    placeholder="e.g. Traffic Count"
                    className="w-full px-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-harken-blue focus:border-transparent bg-white dark:bg-slate-700 dark:text-white"
                    autoFocus
                    onKeyDown={(e) => e.key === 'Enter' && handleConfirmCustomElement()}
                  />
                </div>

                <div className="mb-3">
                  <button
                    type="button"
                    onClick={() => setSaveCustomForFuture(!saveCustomForFuture)}
                    className={`group w-full flex items-center justify-between p-3 rounded-xl border transition-all duration-300 ${saveCustomForFuture
                      ? 'bg-amber-50 border-amber-200 dark:bg-amber-900/20 dark:border-amber-700/50'
                      : 'bg-slate-50 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'
                      }`}
                  >
                    <div className="flex items-center gap-3">
                      <div className={`p-2 rounded-lg transition-all duration-300 ${saveCustomForFuture
                        ? 'bg-amber-100 text-amber-500 scale-110 rotate-12 dark:bg-amber-900/40 dark:text-amber-400'
                        : 'bg-white text-slate-400 dark:bg-slate-800/50 dark:text-slate-500 group-hover:bg-white group-hover:text-amber-400 dark:group-hover:bg-slate-900 dark:group-hover:text-amber-500/70'
                        }`}>
                        <Star className={`w-4 h-4 ${saveCustomForFuture ? 'fill-current' : ''}`} />
                      </div>
                      <div className="text-left">
                        <div className={`text-xs font-bold transition-colors ${saveCustomForFuture
                          ? 'text-amber-700 dark:text-amber-400'
                          : 'text-slate-600 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-slate-300'
                          }`}>
                          {saveCustomForFuture ? 'Saved for Future Use' : 'Save for Future Use'}
                        </div>
                        <div className="text-[10px] text-slate-400 dark:text-slate-500">
                          {saveCustomForFuture ? 'Will appear in available elements' : 'Add to your library'}
                        </div>
                      </div>
                    </div>
                  </button>
                </div>

                <button
                  onClick={handleConfirmCustomElement}
                  disabled={!customElementName.trim()}
                  className="w-full py-2 bg-harken-blue text-white rounded-lg text-xs font-bold hover:bg-harken-blue/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                >
                  Add Element
                </button>
              </div>
            ) : (
              <>
                <div className="px-3 py-2 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                  <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
                  <div className="flex items-center gap-2">
                    {/* Add Custom Button is now in the header too for quick access */}
                    <button
                      onClick={() => handleStartCustomElement(sectionId)}
                      className="text-[10px] text-harken-blue hover:underline font-medium flex items-center gap-1"
                    >
                      <Plus size={10} /> Custom
                    </button>
                  </div>
                </div>
                <div className="max-h-48 overflow-y-auto custom-scrollbar">
                  {availableElements.length > 0 ? (
                    availableElements.map(element => (
                      <button
                        key={element.key}
                        onClick={() => handleAddElement(sectionId, element)}
                        className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 dark:hover:bg-harken-blue/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                      >
                        <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-harken-blue">{element.label}</div>
                        {element.description && (
                          <div className="text-[10px] text-slate-400 dark:text-slate-500 truncate">{element.description}</div>
                        )}
                      </button>
                    ))
                  ) : (
                    <div className="px-3 py-4 text-xs text-slate-400 dark:text-slate-500 italic text-center flex flex-col items-center gap-2">
                      <span>All standard elements added</span>
                      <button
                        onClick={() => handleStartCustomElement(sectionId)}
                        className="text-harken-blue hover:underline"
                      >
                        Create Custom Element
                      </button>
                    </div>
                  )}
                </div>
                <div className="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                  <button
                    onClick={() => handleStartCustomElement(sectionId)}
                    className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
                  >
                    <PenLine size={12} />
                    Create Custom Element
                  </button>
                </div>
              </>
            )}
          </div>
        )}
      </div>
    );
  };

  // Preset percent options for quantitative adjustments
  const percentOptions = [
    { value: 0.20, label: '+20%' },
    { value: 0.175, label: '+17.5%' },
    { value: 0.15, label: '+15%' },
    { value: 0.125, label: '+12.5%' },
    { value: 0.10, label: '+10%' },
    { value: 0.075, label: '+7.5%' },
    { value: 0.05, label: '+5%' },
    { value: 0.025, label: '+2.5%' },
    { value: 0, label: '0%' },
    { value: -0.025, label: '-2.5%' },
    { value: -0.05, label: '-5%' },
    { value: -0.075, label: '-7.5%' },
    { value: -0.10, label: '-10%' },
    { value: -0.125, label: '-12.5%' },
    { value: -0.15, label: '-15%' },
    { value: -0.175, label: '-17.5%' },
    { value: -0.20, label: '-20%' },
  ];

  // State for adjustment mode (Percent or Dollar)
  const [adjustmentMode, setAdjustmentMode] = useState<'Percent' | 'Dollar'>('Percent');
  const [customInputValue, setCustomInputValue] = useState<string>('');

  const renderQuantitativeCell = (propId: string, row: GridRowData, valObj: ComparisonValue) => {
    const numericValue = typeof valObj.value === 'number' ? valObj.value : 0;
    const isOpen = activePopover?.rowId === row.id && activePopover?.propId === propId;

    const getStatusLabel = (val: number) => val > 0 ? 'INF' : val < 0 ? 'SUP' : 'SIM';

    return (
      <div className="flex items-center w-full relative">
        <AdjustmentBadge
          flag={numericValue < 0 ? 'superior' : numericValue > 0 ? 'inferior' : 'similar'}
          value={numericValue}
          onClick={() => {
            setActivePopover(isOpen ? null : { rowId: row.id, propId, field: 'value' });
            setCustomInputValue('');
          }}
        />
        {isOpen && (
          <div className="adjustment-popover absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[200] overflow-hidden">
            {/* Mode Toggle Header */}
            <div className="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
              <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">
                Adjustment Mode
              </span>
              <div className="flex gap-1">
                <button
                  type="button"
                  className={`px-2.5 py-1 text-xs font-bold rounded-md transition-all ${adjustmentMode === 'Percent'
                    ? 'bg-harken-blue text-white shadow-sm'
                    : 'bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'
                    }`}
                  onClick={() => setAdjustmentMode('Percent')}
                >
                  %
                </button>
                <button
                  type="button"
                  className={`px-2.5 py-1 text-xs font-bold rounded-md transition-all ${adjustmentMode === 'Dollar'
                    ? 'bg-harken-blue text-white shadow-sm'
                    : 'bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'
                    }`}
                  onClick={() => setAdjustmentMode('Dollar')}
                >
                  $
                </button>
              </div>
            </div>

            {adjustmentMode === 'Percent' ? (
              <>
                {/* Scrollable Percent Options */}
                <div className="max-h-48 overflow-y-auto">
                  {percentOptions.map((option) => (
                    <button
                      type="button"
                      key={option.value}
                      className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700/50 flex items-center justify-between transition-colors ${numericValue === option.value ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'
                        }`}
                      onClick={() => {
                        updateValue(propId, row.key, option.value, 'value');
                        setActivePopover(null);
                      }}
                    >
                      <span className="font-medium">{option.label}</span>
                      <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${option.value > 0
                        ? 'text-red-600 bg-red-50'
                        : option.value < 0
                          ? 'text-emerald-600 bg-emerald-50'
                          : 'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700'
                        }`}>
                        {getStatusLabel(option.value)}
                      </span>
                    </button>
                  ))}
                </div>
                {/* Custom Input */}
                <div className="border-t border-slate-100 dark:border-slate-700 px-3 py-2.5 bg-slate-50 dark:bg-slate-800">
                  <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                    Custom %
                  </label>
                  <div className="flex gap-2 mt-1.5">
                    <input
                      type="text"
                      className="flex-1 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1.5 text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-harken-blue dark:focus:ring-harken-blue focus:border-transparent"
                      value={customInputValue}
                      placeholder="e.g. 12.5"
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9.-]/g, '');
                        setCustomInputValue(val);
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          const parsed = parseFloat(customInputValue) / 100;
                          if (!isNaN(parsed)) {
                            updateValue(propId, row.key, parsed, 'value');
                            setActivePopover(null);
                          }
                        }
                      }}
                    />
                    <button
                      type="button"
                      className="px-3 py-1.5 bg-harken-blue text-white text-xs font-bold rounded-md hover:bg-harken-blue/90 transition-colors"
                      onClick={() => {
                        const parsed = parseFloat(customInputValue) / 100;
                        if (!isNaN(parsed)) {
                          updateValue(propId, row.key, parsed, 'value');
                          setActivePopover(null);
                        }
                      }}
                    >
                      Apply
                    </button>
                  </div>
                  <p className="text-[10px] text-slate-400 mt-1">
                    Positive = inferior, negative = superior
                  </p>
                </div>
              </>
            ) : (
              /* Dollar Mode Input */
              <div className="p-3 space-y-2">
                <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                  Dollar Adjustment
                </label>
                <input
                  type="text"
                  autoFocus
                  className="w-full border border-slate-200 dark:border-slate-600 rounded-md px-3 py-2 text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-harken-blue focus:border-transparent"
                  placeholder="Enter amount"
                  value={customInputValue}
                  onChange={(e) => {
                    const val = e.target.value.replace(/[^0-9.-]/g, '');
                    setCustomInputValue(val);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const parsed = parseFloat(customInputValue) / 1000; // Store as fraction
                      if (!isNaN(parsed)) {
                        updateValue(propId, row.key, parsed, 'value');
                        setActivePopover(null);
                      }
                    }
                  }}
                />
                <button
                  type="button"
                  className="w-full px-3 py-2 bg-harken-blue text-white text-xs font-bold rounded-md hover:bg-harken-blue/90 transition-colors"
                  onClick={() => {
                    const parsed = parseFloat(customInputValue) / 1000;
                    if (!isNaN(parsed)) {
                      updateValue(propId, row.key, parsed, 'value');
                      setActivePopover(null);
                    }
                  }}
                >
                  Apply Dollar Adjustment
                </button>
                <p className="text-[10px] text-slate-400">
                  Positive = inferior, negative = superior
                </p>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // Filter rows based on analysis mode AND grid configuration (property type specific fields)
  const visibleRows = useMemo(() => {
    let filtered = rows.filter(r => r.mode === 'both' || r.mode === analysisMode);
    
    // If we have a grid configuration, filter to show only relevant fields for this property type
    if (activeGridConfig) {
      const physicalFieldDefs = getPhysicalFieldsForGridType(activeGridConfig.gridType);
      const transactionalFieldDefs = getTransactionalFieldsForGridType(activeGridConfig.gridType);
      const physicalFieldIds = new Set(physicalFieldDefs.map(f => f.id));
      const transactionalFieldIds = new Set(transactionalFieldDefs.map(f => f.id));
      const configFieldIds = new Set([
        ...activeGridConfig.transactionalFields,
        ...activeGridConfig.physicalFields,
        ...activeGridConfig.metrics
      ]);
      
      // Core rows that should always be visible regardless of property type
      const coreRowKeys = new Set([
        'date', 'identification', 'address_row', 'price', 'price_sf', 'notes', 
        'overall_comp', 'overall_adj', 'adj_price_sf_val', 'total_value',
        // USPAP-required transactional adjustments
        'property_rights', 'financing_terms', 'conditions_of_sale', 'expenditures_after_sale', 'market_conditions',
        // Common physical factors
        'location', 'highest_best_use', 'year_built', 'effective_age', 'quality_condition', 'site_size_sf', 'building_size_sf'
      ]);
      
      filtered = filtered.filter(r => {
        // Always show core rows and calculated fields
        if (coreRowKeys.has(r.key) || r.isCalculated) return true;
        
        // Check if row key matches a field in the grid configuration
        if (configFieldIds.has(r.key)) return true;
        
        // For quantitative category, check transactional fields
        if (r.category === 'quantitative' && transactionalFieldIds.has(r.key)) return true;
        
        // For qualitative category, check physical fields
        if (r.category === 'qualitative' && physicalFieldIds.has(r.key)) return true;
        
        // Default: show rows that don't have a specific field mapping
        // (Custom rows, notes, etc.)
        if (!r.key.includes('_') && r.key.length < 20) return true;
        
        return false;
      });
      
      // Property-type specific field additions
      if (activeGridConfig.gridType === 'industrial') {
        // Industrial-specific fields like sidewall_height, dock_doors will be added via element dropdown
      } else if (activeGridConfig.gridType === 'multi_family') {
        // Multi-family specific fields like unit_count, unit_mix will be added via element dropdown
      }
    }
    
    return filtered;
  }, [rows, analysisMode, activeGridConfig]);

  // Prepare map data from properties
  const subjectProperty = properties.find(p => p.type === 'subject');
  const compProperties = properties.filter(p => p.type === 'comp');

  const hasSubjectCoords = subjectProperty?.lat !== undefined && subjectProperty?.lng !== undefined;
  const comparablesWithCoords = compProperties.filter(p => p.lat !== undefined && p.lng !== undefined);

  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">

      {/* COMPARABLE MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-harken-blue" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Improved Sales Map</span>
              <span className="text-xs text-slate-400">
                ({comparablesWithCoords.length} of {compProperties.length} comp{compProperties.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>

          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: subjectProperty!.lat!,
                  lng: subjectProperty!.lng!,
                  address: subjectProperty?.address,
                  propertyName: subjectProperty?.name,
                }}
                comparables={comparablesWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: comp.name || `Comp ${index + 1}`,
                  address: comp.address,
                  details: comp.salePrice
                    ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(comp.salePrice)
                    : undefined,
                }))}
                type="improved-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}

      {/* SCROLLABLE AREA - Contains grid and reconciliation */}
      {/* SCROLLABLE AREA - Contains grid and reconciliation */}
      <div ref={scrollContainerRef} className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" style={{ isolation: 'isolate' }}>
        {/* Horizontal Scroll Indicator - logic kept for zone scrolling, visual hidden */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />

        {/* Flex container for grid + action column */}
        <div
          className="flex"
          style={{ minWidth: `${totalGridWidth + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0"
            style={{
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${properties.length - 1}, ${COMP_COL_WIDTH}px)`,
              minWidth: `${totalGridWidth}px`,
            }}
          >

            {/* Header Row - Sticky to top with solid backgrounds */}
            <div
              className="sticky top-0 left-0 z-[120] border-b border-slate-200 dark:border-slate-700 flex items-end bg-white dark:bg-slate-800"
              style={{
                width: LABEL_COL_WIDTH,
                height: 120,
                transform: 'translateZ(0)',
                willChange: 'transform'
              }}
            >
              <div className="p-2 pl-3">
                <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Elements</div>
              </div>
            </div>
            {properties.map((prop) => (
              <div
                key={prop.id}
                className={`sticky top-0 overflow-hidden flex flex-col bg-white dark:bg-slate-800 ${prop.type === 'subject'
                  ? 'z-[110] border-b-2 border-harken-blue shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none'
                  : 'z-[100] border-b border-slate-200 dark:border-slate-700'
                  }`}
                style={{
                  height: 120,
                  transform: 'translateZ(0)',
                  willChange: 'transform',
                  ...(prop.type === 'subject' ? { left: LABEL_COL_WIDTH, width: SUBJECT_COL_WIDTH, position: 'sticky' as const } : {})
                }}
              >
                <PropertyCard property={prop} isSubject={prop.type === 'subject'} onDelete={onDeleteProperty} />
              </div>
            ))}

            {/* Sections */}
            {sections.filter(s => !hiddenSections.has(s.id)).map(section => {
              const hasResidualRows = visibleRows.some(r => r.category === section.id && r.mode === 'residual');
              const canDeleteSection = section.id === 'quantitative' || section.id === 'qualitative';
              return (
                <React.Fragment key={section.id}>
                  {/* Section Header - Full Width */}
                  <div
                    className={`col-span-full relative z-[50] mt-4 border-y ${hasResidualRows ? 'border-purple-300 dark:border-purple-800' : 'border-slate-200 dark:border-slate-700'
                      } ${hasResidualRows ? 'bg-purple-50 dark:bg-purple-900/20' : 'bg-slate-50 dark:bg-slate-900'}`}
                  >
                    <div
                      className={`sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest flex items-center gap-2 ${hasResidualRows
                        ? 'text-purple-700 dark:text-purple-300'
                        : 'text-slate-700 dark:text-slate-300'
                        } ${hasResidualRows ? 'bg-purple-50 dark:bg-purple-900/10' : 'bg-slate-50 dark:bg-slate-900'}`}
                      style={{ zIndex: 51 }}
                    >
                      {section.title}
                      {canDeleteSection && (
                        <button
                          onClick={() => handleSectionDeleteClick(section.id, section.title)}
                          className="ml-2 p-1 rounded hover:bg-red-100 text-slate-400 hover:text-red-500 transition-colors"
                          title={`Remove ${section.title} section`}
                        >
                          <Trash2 className="w-3.5 h-3.5" />
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Section Rows */}
                  {visibleRows.filter(r => r.category === section.id).map(row => {
                    const isResidualRow = row.mode === 'residual';
                    return (
                      <React.Fragment key={row.id}>
                        {/* Label Column - Sticky Left, never scrolls horizontally */}
                        <div
                          className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700/50 flex items-center justify-between px-2 py-1.5 group ${row.key === 'total_value'
                            ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800'
                            : isResidualRow
                              ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-[#1e1b2e]'
                              : 'bg-white dark:bg-slate-900'
                            }`}
                          style={{
                            width: LABEL_COL_WIDTH,
                            transform: 'translateZ(0)'
                          }}
                        >
                          <span className={`text-xs truncate ${row.key === 'total_value'
                            ? 'font-black text-slate-900 uppercase'
                            : isResidualRow
                              ? 'font-semibold text-purple-700'
                              : 'font-medium text-slate-600'
                            }`}>{row.label}</span>
                          <button
                            onClick={() => removeRow(row.id)}
                            className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                            title={`Remove ${row.label}`}
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>

                        {/* Data Cells */}
                        {
                          properties.map(prop => {
                            const isNotesRow = row.key === 'notes';
                            const noteValue = values[prop.id]?.[row.key]?.value;
                            const noteText = typeof noteValue === 'string' ? stripHtml(noteValue) : '';
                            const hasNotes = noteText.trim() !== '' &&
                              !noteText.toLowerCase().includes('click to');

                            // Determine background color based on row type and property type
                            const bgClass = (() => {
                              if (row.key === 'total_value') return 'bg-slate-50 dark:bg-slate-700';
                              if (prop.type === 'subject') return isResidualRow ? 'bg-purple-50 dark:bg-[#1e1b2e]' : 'bg-[#eff6ff] dark:bg-[#0f1f3a]';
                              if (isResidualRow) return 'bg-purple-50 dark:bg-purple-900/10';
                              return 'bg-white dark:bg-slate-800';
                            })();

                            return (
                              <div
                                key={`${row.id}-${prop.id}`}
                                className={`border-r border-b border-slate-100 dark:border-slate-700/50 p-2 flex items-center text-xs ${prop.type === 'subject'
                                  ? 'z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none'
                                  : ''
                                  } ${row.key === 'total_value'
                                    ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 font-bold'
                                    : isResidualRow
                                      ? 'border-purple-200 dark:border-purple-800'
                                      : ''
                                  } ${bgClass} ${isNotesRow ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors' : ''}`}
                                style={prop.type === 'subject'
                                  ? {
                                    left: LABEL_COL_WIDTH,
                                    width: SUBJECT_COL_WIDTH,
                                    position: 'sticky' as const,
                                    transform: 'translateZ(0)'
                                  }
                                  : {}
                                }
                                onClick={isNotesRow ? () => openNotesEditor(prop.id, getPropertyName(prop.id), row.key) : undefined}
                              >
                                {isNotesRow ? (
                                  <div className="flex items-center gap-1.5 w-full">
                                    <MessageSquare className={`w-3 h-3 flex-shrink-0 ${hasNotes ? 'text-harken-blue' : 'text-slate-300'}`} />
                                    <span className={`truncate ${hasNotes ? 'text-slate-700' : 'text-slate-400 italic'}`}>
                                      {hasNotes
                                        ? (noteText.length > 30 ? noteText.substring(0, 30) + '...' : noteText)
                                        : 'Click to add notes'}
                                    </span>
                                  </div>
                                ) : section.id === 'quantitative' && prop.type !== 'subject'
                                  ? renderQuantitativeCell(prop.id, row, values[prop.id]?.[row.key] || { value: 0 })
                                  : section.id === 'qualitative' && prop.type !== 'subject'
                                    ? <QualitativeChip propId={prop.id} rowKey={row.key} />
                                    : (() => {
                                      // For calculated fields, always use the calculated value
                                      const calculatedVal = row.isCalculated ? getCalculatedValue(prop.id, row.key) : null;
                                      const displayValue = calculatedVal !== null
                                        ? calculatedVal
                                        : (values[prop.id]?.[row.key]?.value ?? getCalculatedValue(prop.id, row.key));

                                      // Special styling for auto-calculated cap rate
                                      const isAutoCalcCapRate = row.key === 'extracted_cap_rate' && calculatedVal !== null;
                                      
                                      // Check if this is the subject land add-back linked from Land Valuation
                                      const isLinkedLandValue = row.key === 'subject_land_add_back' && 
                                        prop.type === 'subject' && 
                                        landValuationData?.concludedLandValue &&
                                        values[prop.id]?.[row.key]?.value === landValuationData.concludedLandValue;

                                      return (
                                        <div className="flex items-center gap-1.5">
                                          <span className={`${row.key === 'total_value'
                                            ? 'font-bold text-emerald-700'
                                            : isResidualRow
                                              ? 'font-semibold text-purple-700'
                                              : isAutoCalcCapRate || isLinkedLandValue
                                                ? 'font-semibold text-harken-blue'
                                                : 'font-medium'
                                            }`}>
                                            {formatValue(displayValue, row.format)}
                                          </span>
                                          {isAutoCalcCapRate && (
                                            <span className="text-[9px] text-slate-400 font-normal" title="Auto-calculated from NOI ÷ Sale Price">
                                              (auto)
                                            </span>
                                          )}
                                          {isLinkedLandValue && (
                                            <span 
                                              className="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded text-[9px] font-medium border border-emerald-200 dark:border-emerald-700/50" 
                                              title="Linked from Land Valuation concluded value"
                                            >
                                              <Link2 className="w-2.5 h-2.5" />
                                              Land Val
                                            </span>
                                          )}
                                        </div>
                                      );
                                    })()
                                }
                              </div>
                            );
                          })
                        }
                      </React.Fragment>
                    );
                  })}

                  {/* Add Element Button Row for this section */}
                  <div
                    className={`sticky left-0 p-2 bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50 ${openElementDropdown === section.id ? 'z-[500]' : 'z-[60]'}`}
                    style={{ width: LABEL_COL_WIDTH }}
                  >
                    <AddElementButton sectionId={section.id as GridRowCategory} />
                  </div>
                  <div
                    className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50"
                    style={{ width: SUBJECT_COL_WIDTH }}
                  ></div>
                  {properties.filter(p => p.type !== 'subject').map(prop => (
                    <div key={`add-element-${section.id}-${prop.id}`} className="bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50"></div>
                  ))}
                </React.Fragment>
              );
            })}
          </div>

          {/* ACTION COLUMN */}
          <div
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-harken-blue/20 flex items-center justify-center group-hover:bg-harken-blue/30 transition-colors">
                  <Plus className="w-6 h-6 text-harken-blue" />
                </div>
                <span className="text-xs font-semibold text-harken-blue">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RECONCILIATION SECTION - Stays centered, doesn't scroll horizontally */}
        <div
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-emerald-500 rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Value Reconciliation & Narrative</h2>
            </div>

            {/* Dual Metric Display - Shows both $/SF and $/Unit for multi-family */}
            {showDualMetrics && (
              <div className="grid grid-cols-2 gap-4">
                <div className={`p-4 rounded-xl border-2 ${subjectData?.primaryValueDriver === 'price_per_sf' ? 'bg-harken-blue/5 border-harken-blue' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-slate-600 dark:text-slate-300">$/SF Building</span>
                    {subjectData?.primaryValueDriver === 'price_per_sf' && (
                      <span className="px-2 py-0.5 bg-harken-blue text-white text-[10px] font-bold rounded">PRIMARY</span>
                    )}
                  </div>
                  <div className={`text-2xl font-bold ${subjectData?.primaryValueDriver === 'price_per_sf' ? 'text-harken-blue' : 'text-slate-800 dark:text-white'}`}>
                    {concludedValuePsf ? `$${concludedValuePsf.toLocaleString()}` : '-'}
                  </div>
                </div>
                <div className={`p-4 rounded-xl border-2 ${subjectData?.primaryValueDriver === 'price_per_unit' ? 'bg-harken-blue/5 border-harken-blue' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-slate-600 dark:text-slate-300">$/Unit</span>
                    {subjectData?.primaryValueDriver === 'price_per_unit' && (
                      <span className="px-2 py-0.5 bg-harken-blue text-white text-[10px] font-bold rounded">PRIMARY</span>
                    )}
                  </div>
                  <div className={`text-2xl font-bold ${subjectData?.primaryValueDriver === 'price_per_unit' ? 'text-harken-blue' : 'text-slate-800 dark:text-white'}`}>
                    {concludedValuePerUnit ? `$${concludedValuePerUnit.toLocaleString()}` : '-'}
                  </div>
                </div>
              </div>
            )}

            {/* Concluded Value Summary */}
            <div className="p-5 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-700/50">
              <div className="flex items-center justify-between">
                <span className="text-sm font-semibold text-emerald-700 dark:text-emerald-300">Concluded Value Indication</span>
                <div className="text-right">
                  <div className="text-2xl font-bold text-emerald-700 dark:text-emerald-300">
                    {concludedValue ? `$${concludedValue.toLocaleString()}` : 'Pending'}
                  </div>
                  {!showDualMetrics && concludedValuePsf && (
                    <div className="text-sm text-emerald-600 dark:text-emerald-400">
                      ${concludedValuePsf.toLocaleString()} / SF
                    </div>
                  )}
                </div>
              </div>
            </div>

            <EnhancedTextArea
              label="Notes"
              value={reconciliationText}
              onChange={setReconciliationText}
              placeholder="Type your analysis and assumptions here..."
              sectionContext="sales_comparison"
              helperText="AI can draft a reconciliation narrative based on your sales comparison analysis."
              minHeight={300}
              rows={10}
            />

            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>

      {/* NOTES EDITOR MODAL */}
      {
        notesEditor?.isOpen && (
          <NotesEditorModal
            isOpen={notesEditor.isOpen}
            title={notesEditor.propName}
            content={notesContent}
            onClose={closeNotesEditor}
            onSave={saveNotes}
            onInput={handleEditorInput}
            applyFormatting={applyFormatting}
          />
        )
      }

      {/* SECTION DELETE CONFIRMATION MODAL */}
      {
        confirmDelete?.isOpen && (
          <div className="fixed inset-0 z-[1100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div
              className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Warning Header */}
              <div className="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4 flex items-center gap-3">
                <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                  <AlertTriangle className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg">Remove Section?</h3>
                  <p className="text-white/80 text-sm">This action cannot be undone</p>
                </div>
              </div>

              {/* Content */}
              <div className="px-6 py-5">
                <p className="text-slate-600 text-sm leading-relaxed">
                  Are you sure you want to remove the <span className="font-semibold text-slate-800 dark:text-white">"{confirmDelete.sectionTitle}"</span> section?
                  All rows within this section will be hidden from the grid.
                </p>
                <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2">
                  <AlertTriangle className="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0" />
                  <p className="text-amber-800 text-xs">
                    This will remove all adjustment data from your analysis. You may need to refresh the page to restore this section.
                  </p>
                </div>
              </div>

              {/* Actions */}
              <div className="px-6 py-4 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex items-center justify-end gap-3">
                <button
                  onClick={cancelSectionDelete}
                  className="px-5 py-2.5 rounded-lg text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                >
                  No, Keep It
                </button>
                <button
                  onClick={confirmSectionDelete}
                  className="px-5 py-2.5 rounded-lg text-sm font-bold text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 shadow-md hover:shadow-lg transition-all"
                >
                  Yes, Remove Section
                </button>
              </div>
            </div>
          </div>
        )
      }
    </div >
  );
};

```

```typescriptreact
import React, { useState, useEffect, useMemo, useRef } from 'react';
import {
  ArrowUpRight,
  ArrowDownRight,
  Minus,
  Maximize2,
  Minimize2,
  X,
  Trash2,
  AlertTriangle,
  Bold,
  Italic,
  Underline,
  AlignLeft,
  AlignCenter,
  List,
  MessageSquare,
  Plus,
  ChevronDown,
  PenLine,
  ChevronUp,
  Map as MapIcon,
  Star,
  Link2
} from 'lucide-react';
import { NotesEditorModal } from '../../../components/NotesEditorModal';
import { Property, GridRowData, PropertyValues, ComparisonValue, Section, GridRowCategory } from '../types';
import { PropertyCard } from './PropertyCard';
import { INITIAL_ROWS, SECTIONS } from '../constants';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';
import { useCustomGridElements } from '../../../hooks/useCustomGridElements';
import type { SalesGridConfiguration } from '../../../types';
import { getUnitLabel, getUnitShortLabel, INDUSTRIAL_CONFIG } from '../../../constants/gridConfigurations';
import { getPhysicalFieldsForGridType, getTransactionalFieldsForGridType } from '../../../constants/gridFieldDefinitions';

interface SalesGridProps {
  properties: Property[];
  values: PropertyValues;
  analysisMode?: 'standard' | 'residual';
  scenarioId?: number;
  onDeleteProperty?: (propertyId: string) => void;
  /** Grid configuration - determines visible fields and calculation methods */
  gridConfig?: SalesGridConfiguration;
}


export const SalesGrid: React.FC<SalesGridProps> = ({ properties, values: initialValues, analysisMode = 'standard', scenarioId, onDeleteProperty, gridConfig }) => {

  const { setApproachConclusion, setSalesComparisonData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, salesComparisonData, landValuationData, subjectData } = wizardState;
  
  // Use grid config from props, or fall back to wizard state, or use a default
  const activeGridConfig = gridConfig || subjectData?.gridConfiguration;
  const { addCustomElement, getCustomElementsByCategory, removeCustomElement } = useCustomGridElements();

  // Get current scenario name for element filtering
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const [rows, setRows] = useState<GridRowData[]>(INITIAL_ROWS);
  const [sections] = useState<Section[]>(SECTIONS);
  // Load values from context if available, otherwise use initial values from props
  const [values, setValues] = useState<PropertyValues>(
    salesComparisonData?.values ? (salesComparisonData.values as unknown as PropertyValues) : initialValues
  );
  const [reconciliationText, setReconciliationText] = useState(
    salesComparisonData?.reconciliationText ?? ""
  );
  const [activePopover, setActivePopover] = useState<{ rowId: string, propId: string, field: 'value' | 'adjustment' } | null>(null);
  const [hiddenSections, setHiddenSections] = useState<Set<string>>(new Set());
  const [confirmDelete, setConfirmDelete] = useState<{ isOpen: boolean; sectionId: string; sectionTitle: string } | null>(null);
  const [notesEditor, setNotesEditor] = useState<{ isOpen: boolean; propId: string; propName: string; rowKey: string } | null>(null);
  const [notesContent, setNotesContent] = useState<string>('');
  const [openElementDropdown, setOpenElementDropdown] = useState<string | null>(null);
  const [addingCustomToSection, setAddingCustomToSection] = useState<string | null>(null);
  const [customElementName, setCustomElementName] = useState('');
  const [saveCustomForFuture, setSaveCustomForFuture] = useState(false);
  const [dropdownPlacement, setDropdownPlacement] = useState<'top' | 'bottom'>('bottom');
  const buttonRef = useRef<HTMLButtonElement>(null);

  // Calculate the concluded value from comparable properties
  const concludedValue = useMemo(() => {
    const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
    if (typeof subjectBldgSize !== 'number' || subjectBldgSize <= 0) return null;

    // Get adjusted price/SF from all comps (non-subject properties)
    const compValues: number[] = [];
    properties.forEach(prop => {
      if (prop.type === 'subject') return;
      const propValues = values[prop.id];
      if (!propValues) return;

      // Calculate overall adjustment
      let netAdj = 0;
      Object.keys(propValues).forEach(key => {
        const entry = propValues[key];
        if (entry?.adjustment !== undefined && typeof entry.adjustment === 'number' && key !== 'price' && key !== 'price_sf') {
          netAdj += entry.adjustment;
        }
      });

      // Calculate adjusted price/SF
      let basePriceSf = 0;
      if (analysisMode === 'residual') {
        const price = propValues['price']?.value;
        const land = propValues['land_value']?.value;
        const bldgSf = propValues['bldg_size_fact']?.value;
        if (typeof price === 'number' && typeof land === 'number' && typeof bldgSf === 'number' && bldgSf > 0) {
          basePriceSf = (price - land) / bldgSf;
        }
      } else {
        basePriceSf = typeof propValues['price_sf']?.value === 'number' ? propValues['price_sf'].value : 0;
      }

      if (basePriceSf > 0) {
        const adjustedPriceSf = basePriceSf * (1 + netAdj);
        let totalVal = subjectBldgSize * adjustedPriceSf;
        if (analysisMode === 'residual') {
          const subjectLand = values['subject']?.['subject_land_add_back']?.value;
          if (typeof subjectLand === 'number') totalVal += subjectLand;
        }
        compValues.push(totalVal);
      }
    });

    if (compValues.length === 0) return null;

    // Return average of all comp values as the indication
    const avg = compValues.reduce((a, b) => a + b, 0) / compValues.length;
    return Math.round(avg);
  }, [values, properties, analysisMode]);

  // Sync concluded value to WizardContext when scenarioId is provided
  useEffect(() => {
    if (scenarioId !== undefined && concludedValue !== null) {
      setApproachConclusion(scenarioId, 'Sales Comparison', concludedValue);
    }
  }, [scenarioId, concludedValue, setApproachConclusion]);

  // Auto-populate subject_land_add_back from Land Valuation when in residual mode
  // This creates the data connection between Land Valuation and Sales Comparison
  useEffect(() => {
    if (analysisMode === 'residual' && landValuationData?.concludedLandValue) {
      const currentValue = values['subject']?.['subject_land_add_back']?.value;
      
      // Only auto-populate if not already set or if land valuation value changed
      if (currentValue !== landValuationData.concludedLandValue) {
        setValues(prev => ({
          ...prev,
          subject: {
            ...prev['subject'],
            subject_land_add_back: { 
              value: landValuationData.concludedLandValue, 
              adjustment: 0,
              flag: 'similar' as const,
              linkedFromLandValuation: true  // Flag to indicate this came from Land Valuation
            }
          }
        }));
      }
    }
  }, [analysisMode, landValuationData?.concludedLandValue]);

  // Calculate concluded value per SF
  const concludedValuePsf = useMemo(() => {
    const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
    if (concludedValue && typeof subjectBldgSize === 'number' && subjectBldgSize > 0) {
      return Math.round(concludedValue / subjectBldgSize);
    }
    return null;
  }, [concludedValue, values]);
  
  // Calculate concluded value per unit (for multi-family properties)
  const concludedValuePerUnit = useMemo(() => {
    const unitCount = subjectData?.totalUnitCount;
    if (concludedValue && typeof unitCount === 'number' && unitCount > 0) {
      return Math.round(concludedValue / unitCount);
    }
    return null;
  }, [concludedValue, subjectData?.totalUnitCount]);
  
  // Determine if we should show dual metrics (both $/SF and $/unit)
  const showDualMetrics = activeGridConfig?.gridType === 'multi_family' || 
                          activeGridConfig?.gridType === 'hotel_motel';
  
  // Get the primary metric based on configuration
  const primaryMetricLabel = activeGridConfig ? getUnitLabel(activeGridConfig.unitOfMeasure) : '$/SF';
  const primaryMetricValue = activeGridConfig?.unitOfMeasure === 'per_unit' 
    ? concludedValuePerUnit 
    : concludedValuePsf;

  // Persist sales comparison data to WizardContext
  useEffect(() => {
    // Convert local property and value format to storage format
    const dataToSave = {
      properties: properties.map(p => ({
        id: p.id,
        type: p.type,
        name: p.name,
        address: p.address,
        image: p.image,
        status: p.status,
      })),
      values: values as unknown as Record<string, Record<string, import('../../../types').SalesCompValue>>,
      reconciliationText,
      analysisMode,
      concludedValue,
      concludedValuePsf,
    };
    setSalesComparisonData(dataToSave);
  }, [values, reconciliationText, analysisMode, concludedValue, concludedValuePsf, properties, setSalesComparisonData]);

  // Handle clicking outside to close dropdowns
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  // Get available elements for a section that haven't been added yet
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (sectionId: string) => {
    const currentRowKeys = rows.filter(r => r.category === sectionId).map(r => r.key);

    // Normalize section ID to match registry format
    const normalizedSection = normalizeSection(sectionId) as SectionType;

    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'sales_comparison',
      scenario: currentScenario,
      excludeKeys: currentRowKeys
    });

    // Map to the format expected by the dropdown
    return filteredElements.map(el => ({
      key: el.key,
      label: el.label,
      description: el.description
    }));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (sectionId: GridRowCategory, element: { label: string; key: string }) => {
    const newRow: GridRowData = {
      id: `${sectionId}_${element.key}`,
      category: sectionId,
      label: element.label,
      key: element.key,
      format: 'text',
      mode: 'both'
    };

    // Check if already exists
    if (rows.some(r => r.key === element.key)) return;
    setRows(prev => [...prev, newRow]);
    setOpenElementDropdown(null);
  };

  // Start adding a custom element - switch view in dropdown
  const handleStartCustomElement = (sectionId: GridRowCategory) => {
    setAddingCustomToSection(sectionId);
    setCustomElementName('');
    setSaveCustomForFuture(false);
  };

  // Confirm adding custom element
  const handleConfirmCustomElement = () => {
    if (!customElementName.trim() || !addingCustomToSection) return;

    const sectionId = addingCustomToSection as GridRowCategory;
    const name = customElementName.trim();
    const key = name.toLowerCase().replace(/\s+/g, '_') + '_custom';

    // Add to current grid
    const newRow: GridRowData = {
      id: `${sectionId}_${key}`,
      category: sectionId,
      label: name,
      key: key,
      format: 'text',
      mode: 'both'
    };

    if (!rows.some(r => r.key === key)) {
      setRows(prev => [...prev, newRow]);
    }

    // Save to local storage if requested
    if (saveCustomForFuture) {
      addCustomElement({
        category: sectionId,
        label: name,
        key: key
      });
    }

    setOpenElementDropdown(null);
    setAddingCustomToSection(null);
    setCustomElementName('');
    setSaveCustomForFuture(false);
  };

  const removeRow = (rowId: string) => {
    setRows(prev => prev.filter(r => r.id !== rowId));
  };

  const handleSectionDeleteClick = (sectionId: string, sectionTitle: string) => {
    setConfirmDelete({ isOpen: true, sectionId, sectionTitle });
  };

  const confirmSectionDelete = () => {
    if (confirmDelete) {
      setHiddenSections(prev => new Set([...prev, confirmDelete.sectionId]));
      setConfirmDelete(null);
    }
  };

  const cancelSectionDelete = () => {
    setConfirmDelete(null);
  };

  const openNotesEditor = (propId: string, propName: string, rowKey: string) => {
    const currentValue = values[propId]?.[rowKey]?.value || '';
    // Clear placeholder text - start with empty if it's a default placeholder
    const isPlaceholder = typeof currentValue === 'string' &&
      (currentValue.toLowerCase().includes('click to') || currentValue === '');
    setNotesContent(isPlaceholder ? '' : (typeof currentValue === 'string' ? currentValue : ''));
    setNotesEditor({ isOpen: true, propId, propName, rowKey });
  };

  const saveNotes = () => {
    if (notesEditor) {
      setValues(prev => ({
        ...prev,
        [notesEditor.propId]: {
          ...prev[notesEditor.propId],
          [notesEditor.rowKey]: { ...prev[notesEditor.propId]?.[notesEditor.rowKey], value: notesContent }
        }
      }));
      setNotesEditor(null);
      setNotesContent('');
    }
  };

  const closeNotesEditor = () => {
    setNotesEditor(null);
    setNotesContent('');
  };

  const applyFormatting = (format: string) => {
    // Use execCommand for rich text formatting
    const editor = document.getElementById('notes-editor');
    if (!editor) return;

    editor.focus();

    switch (format) {
      case 'bold':
        document.execCommand('bold', false);
        break;
      case 'italic':
        document.execCommand('italic', false);
        break;
      case 'underline':
        document.execCommand('underline', false);
        break;
      case 'alignLeft':
        document.execCommand('justifyLeft', false);
        break;
      case 'alignCenter':
        document.execCommand('justifyCenter', false);
        break;
      case 'bullet':
        document.execCommand('insertUnorderedList', false);
        break;
    }

    // Update state with new content
    setTimeout(() => {
      if (editor) {
        setNotesContent(editor.innerHTML);
      }
    }, 0);
  };

  const handleEditorInput = () => {
    const editor = document.getElementById('notes-editor');
    if (editor) {
      setNotesContent(editor.innerHTML);
    }
  };

  const getPropertyName = (propId: string) => {
    const prop = properties.find(p => p.id === propId);
    return prop?.name || propId;
  };

  // Strip HTML tags for preview display
  const stripHtml = (html: string) => {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || '';
  };

  // Focus editor when modal opens
  useEffect(() => {
    if (notesEditor?.isOpen) {
      setTimeout(() => {
        const editor = document.getElementById('notes-editor');
        if (editor) {
          editor.focus();
          // Move cursor to end
          const range = document.createRange();
          const selection = window.getSelection();
          range.selectNodeContents(editor);
          range.collapse(false);
          selection?.removeAllRanges();
          selection?.addRange(range);
        }
      }, 100);
    }
  }, [notesEditor?.isOpen]);

  const LABEL_COL_WIDTH = 160;
  const SUBJECT_COL_WIDTH = 180;
  const COMP_COL_WIDTH = 170;
  const ACTION_COL_WIDTH = 160;

  // Calculate total grid width for reconciliation section
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (properties.length - 1) * COMP_COL_WIDTH;

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (activePopover) {
        const target = event.target as Element;
        if (!target.closest('.adjustment-popover')) {
          setActivePopover(null);
        }
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover]);

  const formatValue = (val: string | number | null | undefined, format?: string) => {
    if (val === null || val === undefined) return '-';
    if (format === 'currency' && typeof val === 'number') {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(val);
    }
    if (format === 'percent' && typeof val === 'number') {
      return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(val);
    }
    if (format === 'currency_sf' && typeof val === 'number') {
      return `${new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(val)} / SF`;
    }
    return val;
  };

  const getCalculatedValue = (propId: string, rowKey: string): number | string | null => {
    const propValues = values[propId];
    if (!propValues) return null;

    // AUTO-CALCULATE: Extracted Cap Rate = NOI at Sale / Sale Price
    if (rowKey === 'extracted_cap_rate') {
      const price = propValues['price']?.value;
      const noi = propValues['noi_at_sale']?.value;
      if (typeof price === 'number' && price > 0 && typeof noi === 'number' && noi > 0) {
        return noi / price; // Returns as decimal (e.g., 0.0624 for 6.24%)
      }
      return null;
    }

    if (rowKey === 'residual_value') {
      const price = propValues['price']?.value;
      const land = propValues['land_value']?.value;
      if (typeof price === 'number' && typeof land === 'number') return price - land;
      return null;
    }

    if (rowKey === 'residual_price_sf') {
      const price = propValues['price']?.value;
      const land = propValues['land_value']?.value;
      const bldgSize = propValues['bldg_size_fact']?.value;
      if (typeof price === 'number' && typeof land === 'number' && typeof bldgSize === 'number' && bldgSize > 0) {
        return (price - land) / bldgSize;
      }
      return null;
    }

    if (rowKey === 'overall_adj') {
      const adjustmentKeys = ['time_adj', 'location_adj', 'condition_adj', 'construction_adj', 'scale_adj', 'use_adj'];
      let total = 0;
      adjustmentKeys.forEach(k => {
        const val = propValues[k]?.value;
        if (typeof val === 'number') total += val;
      });
      return total;
    }

    if (rowKey === 'overall_comp') {
      const overallAdj = getCalculatedValue(propId, 'overall_adj') as number || 0;
      if (overallAdj < -0.025) return 'Superior';
      if (overallAdj > 0.025) return 'Inferior';
      return 'Similar';
    }

    if (rowKey === 'adj_price_sf' || rowKey === 'adj_price_sf_val') {
      const overallAdj = getCalculatedValue(propId, 'overall_adj') as number || 0;
      let basePriceSf = 0;
      if (analysisMode === 'residual') {
        const resVal = getCalculatedValue(propId, 'residual_price_sf');
        basePriceSf = typeof resVal === 'number' ? resVal : 0;
      } else {
        basePriceSf = typeof propValues['price_sf']?.value === 'number' ? propValues['price_sf'].value : 0;
      }
      if (basePriceSf === 0) return null;
      return basePriceSf * (1 + overallAdj);
    }

    if (rowKey === 'total_value') {
      const subjectBldgSize = values['subject']?.['bldg_size_fact']?.value;
      const finalPriceSf = getCalculatedValue(propId, 'adj_price_sf_val') as number || 0;
      if (propId === 'subject') return null;
      if (typeof subjectBldgSize === 'number' && finalPriceSf > 0) {
        let val = subjectBldgSize * finalPriceSf;
        if (analysisMode === 'residual') {
          const subjectLand = values['subject']?.['subject_land_add_back']?.value;
          if (typeof subjectLand === 'number') val += subjectLand;
        }
        return formatValue(val, 'currency');
      }
      return null;
    }
    return null;
  };

  const updateValue = (propId: string, rowKey: string, val: number, field: 'value' | 'adjustment' = 'value') => {
    setValues(prev => ({
      ...prev,
      [propId]: {
        ...prev[propId],
        [rowKey]: { ...prev[propId][rowKey], [field]: val }
      }
    }));
  };

  const AdjustmentBadge = ({ flag, value, onClick, showValue = true }: { flag?: string, value: number, onClick: () => void, showValue?: boolean }) => {
    const isSup = flag === 'superior' || flag === 'Superior';
    const isInf = flag === 'inferior' || flag === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer`;

    if (isSup) return <span onClick={onClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100`}>
      <ArrowUpRight className="w-3 h-3" /> SUP {showValue && value !== 0 && <span className="ml-1 border-l border-emerald-200 pl-1">{Math.abs(value * 100).toFixed(1)}%</span>}
    </span>;
    if (isInf) return <span onClick={onClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100`}>
      <ArrowDownRight className="w-3 h-3" /> INF {showValue && value !== 0 && <span className="ml-1 border-l border-red-200 pl-1">{Math.abs(value * 100).toFixed(1)}%</span>}
    </span>;
    return <span onClick={onClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600`}><Minus className="w-3 h-3" /> SIM</span>;
  };

  // Click-to-cycle function for qualitative adjustments
  const cycleQualitativeValue = (currentFlag: string | undefined): { value: string, flag: 'similar' | 'superior' | 'inferior' } => {
    const cycle: { value: string, flag: 'similar' | 'superior' | 'inferior' }[] = [
      { value: 'Similar', flag: 'similar' },
      { value: 'Superior', flag: 'superior' },
      { value: 'Inferior', flag: 'inferior' }
    ];
    const currentIndex = cycle.findIndex(c => c.flag === currentFlag?.toLowerCase());
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Qualitative Chip Component - click to cycle through values
  const QualitativeChip = ({ propId, rowKey }: { propId: string, rowKey: string }) => {
    const currentValue = values[propId]?.[rowKey];
    const flag = currentValue?.flag || 'similar';

    const handleClick = () => {
      const next = cycleQualitativeValue(flag);
      setValues(prev => ({
        ...prev,
        [propId]: {
          ...prev[propId],
          [rowKey]: { value: next.value, flag: next.flag }
        }
      }));
    };

    const isSup = flag === 'superior';
    const isInf = flag === 'inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;

    if (isSup) return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span
        onClick={handleClick}
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };


  // Add Element Button with Dropdown - positioned in the Elements column
  const AddElementButton = ({ sectionId }: { sectionId: GridRowCategory }) => {
    const isOpen = openElementDropdown === sectionId;
    const isAddingCustom = addingCustomToSection === sectionId;
    const availableElements = isAddingCustom ? [] : getAvailableElements(sectionId);

    // Smart positioning logic
    const toggleDropdown = () => {
      if (isOpen) {
        setOpenElementDropdown(null);
        setAddingCustomToSection(null);
      } else {
        // Check available space below
        if (buttonRef.current) {
          const rect = buttonRef.current.getBoundingClientRect();
          const spaceBelow = window.innerHeight - rect.bottom;
          setDropdownPlacement(spaceBelow < 250 ? 'top' : 'bottom');
        }
        setOpenElementDropdown(sectionId);
      }
    };

    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button
          ref={buttonRef}
          onClick={toggleDropdown}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>

        {isOpen && (
          <div className={`absolute left-0 w-72 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden flex flex-col transition-all duration-200 ${dropdownPlacement === 'top' ? 'bottom-full mb-1' : 'top-full mt-1'
            }`}>
            {isAddingCustom ? (
              <div className="p-3">
                <div className="flex items-center justify-between mb-3">
                  <span className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase tracking-wider">New Custom Element</span>
                  <button
                    onClick={() => setAddingCustomToSection(null)}
                    className="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
                  >
                    <X size={14} />
                  </button>
                </div>

                <div className="mb-3">
                  <label className="block text-[10px] font-medium text-slate-500 dark:text-slate-400 mb-1">Element Name</label>
                  <input
                    type="text"
                    value={customElementName}
                    onChange={(e) => setCustomElementName(e.target.value)}
                    placeholder="e.g. Traffic Count"
                    className="w-full px-2 py-1.5 text-xs border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-harken-blue focus:border-transparent bg-white dark:bg-slate-700 dark:text-white"
                    autoFocus
                    onKeyDown={(e) => e.key === 'Enter' && handleConfirmCustomElement()}
                  />
                </div>

                <div className="mb-3">
                  <button
                    type="button"
                    onClick={() => setSaveCustomForFuture(!saveCustomForFuture)}
                    className={`group w-full flex items-center justify-between p-3 rounded-xl border transition-all duration-300 ${saveCustomForFuture
                      ? 'bg-amber-50 border-amber-200 dark:bg-amber-900/20 dark:border-amber-700/50'
                      : 'bg-slate-50 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'
                      }`}
                  >
                    <div className="flex items-center gap-3">
                      <div className={`p-2 rounded-lg transition-all duration-300 ${saveCustomForFuture
                        ? 'bg-amber-100 text-amber-500 scale-110 rotate-12 dark:bg-amber-900/40 dark:text-amber-400'
                        : 'bg-white text-slate-400 dark:bg-slate-800/50 dark:text-slate-500 group-hover:bg-white group-hover:text-amber-400 dark:group-hover:bg-slate-900 dark:group-hover:text-amber-500/70'
                        }`}>
                        <Star className={`w-4 h-4 ${saveCustomForFuture ? 'fill-current' : ''}`} />
                      </div>
                      <div className="text-left">
                        <div className={`text-xs font-bold transition-colors ${saveCustomForFuture
                          ? 'text-amber-700 dark:text-amber-400'
                          : 'text-slate-600 dark:text-slate-400 group-hover:text-slate-800 dark:group-hover:text-slate-300'
                          }`}>
                          {saveCustomForFuture ? 'Saved for Future Use' : 'Save for Future Use'}
                        </div>
                        <div className="text-[10px] text-slate-400 dark:text-slate-500">
                          {saveCustomForFuture ? 'Will appear in available elements' : 'Add to your library'}
                        </div>
                      </div>
                    </div>
                  </button>
                </div>

                <button
                  onClick={handleConfirmCustomElement}
                  disabled={!customElementName.trim()}
                  className="w-full py-2 bg-harken-blue text-white rounded-lg text-xs font-bold hover:bg-harken-blue/90 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                >
                  Add Element
                </button>
              </div>
            ) : (
              <>
                <div className="px-3 py-2 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                  <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
                  <div className="flex items-center gap-2">
                    {/* Add Custom Button is now in the header too for quick access */}
                    <button
                      onClick={() => handleStartCustomElement(sectionId)}
                      className="text-[10px] text-harken-blue hover:underline font-medium flex items-center gap-1"
                    >
                      <Plus size={10} /> Custom
                    </button>
                  </div>
                </div>
                <div className="max-h-48 overflow-y-auto custom-scrollbar">
                  {availableElements.length > 0 ? (
                    availableElements.map(element => (
                      <button
                        key={element.key}
                        onClick={() => handleAddElement(sectionId, element)}
                        className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 dark:hover:bg-harken-blue/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                      >
                        <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-harken-blue">{element.label}</div>
                        {element.description && (
                          <div className="text-[10px] text-slate-400 dark:text-slate-500 truncate">{element.description}</div>
                        )}
                      </button>
                    ))
                  ) : (
                    <div className="px-3 py-4 text-xs text-slate-400 dark:text-slate-500 italic text-center flex flex-col items-center gap-2">
                      <span>All standard elements added</span>
                      <button
                        onClick={() => handleStartCustomElement(sectionId)}
                        className="text-harken-blue hover:underline"
                      >
                        Create Custom Element
                      </button>
                    </div>
                  )}
                </div>
                <div className="border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">
                  <button
                    onClick={() => handleStartCustomElement(sectionId)}
                    className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
                  >
                    <PenLine size={12} />
                    Create Custom Element
                  </button>
                </div>
              </>
            )}
          </div>
        )}
      </div>
    );
  };

  // Preset percent options for quantitative adjustments
  const percentOptions = [
    { value: 0.20, label: '+20%' },
    { value: 0.175, label: '+17.5%' },
    { value: 0.15, label: '+15%' },
    { value: 0.125, label: '+12.5%' },
    { value: 0.10, label: '+10%' },
    { value: 0.075, label: '+7.5%' },
    { value: 0.05, label: '+5%' },
    { value: 0.025, label: '+2.5%' },
    { value: 0, label: '0%' },
    { value: -0.025, label: '-2.5%' },
    { value: -0.05, label: '-5%' },
    { value: -0.075, label: '-7.5%' },
    { value: -0.10, label: '-10%' },
    { value: -0.125, label: '-12.5%' },
    { value: -0.15, label: '-15%' },
    { value: -0.175, label: '-17.5%' },
    { value: -0.20, label: '-20%' },
  ];

  // State for adjustment mode (Percent or Dollar)
  const [adjustmentMode, setAdjustmentMode] = useState<'Percent' | 'Dollar'>('Percent');
  const [customInputValue, setCustomInputValue] = useState<string>('');

  const renderQuantitativeCell = (propId: string, row: GridRowData, valObj: ComparisonValue) => {
    const numericValue = typeof valObj.value === 'number' ? valObj.value : 0;
    const isOpen = activePopover?.rowId === row.id && activePopover?.propId === propId;

    const getStatusLabel = (val: number) => val > 0 ? 'INF' : val < 0 ? 'SUP' : 'SIM';

    return (
      <div className="flex items-center w-full relative">
        <AdjustmentBadge
          flag={numericValue < 0 ? 'superior' : numericValue > 0 ? 'inferior' : 'similar'}
          value={numericValue}
          onClick={() => {
            setActivePopover(isOpen ? null : { rowId: row.id, propId, field: 'value' });
            setCustomInputValue('');
          }}
        />
        {isOpen && (
          <div className="adjustment-popover absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[200] overflow-hidden">
            {/* Mode Toggle Header */}
            <div className="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800">
              <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">
                Adjustment Mode
              </span>
              <div className="flex gap-1">
                <button
                  type="button"
                  className={`px-2.5 py-1 text-xs font-bold rounded-md transition-all ${adjustmentMode === 'Percent'
                    ? 'bg-harken-blue text-white shadow-sm'
                    : 'bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'
                    }`}
                  onClick={() => setAdjustmentMode('Percent')}
                >
                  %
                </button>
                <button
                  type="button"
                  className={`px-2.5 py-1 text-xs font-bold rounded-md transition-all ${adjustmentMode === 'Dollar'
                    ? 'bg-harken-blue text-white shadow-sm'
                    : 'bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'
                    }`}
                  onClick={() => setAdjustmentMode('Dollar')}
                >
                  $
                </button>
              </div>
            </div>

            {adjustmentMode === 'Percent' ? (
              <>
                {/* Scrollable Percent Options */}
                <div className="max-h-48 overflow-y-auto">
                  {percentOptions.map((option) => (
                    <button
                      type="button"
                      key={option.value}
                      className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700/50 flex items-center justify-between transition-colors ${numericValue === option.value ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'
                        }`}
                      onClick={() => {
                        updateValue(propId, row.key, option.value, 'value');
                        setActivePopover(null);
                      }}
                    >
                      <span className="font-medium">{option.label}</span>
                      <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${option.value > 0
                        ? 'text-red-600 bg-red-50'
                        : option.value < 0
                          ? 'text-emerald-600 bg-emerald-50'
                          : 'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700'
                        }`}>
                        {getStatusLabel(option.value)}
                      </span>
                    </button>
                  ))}
                </div>
                {/* Custom Input */}
                <div className="border-t border-slate-100 dark:border-slate-700 px-3 py-2.5 bg-slate-50 dark:bg-slate-800">
                  <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                    Custom %
                  </label>
                  <div className="flex gap-2 mt-1.5">
                    <input
                      type="text"
                      className="flex-1 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1.5 text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-harken-blue dark:focus:ring-harken-blue focus:border-transparent"
                      value={customInputValue}
                      placeholder="e.g. 12.5"
                      onChange={(e) => {
                        const val = e.target.value.replace(/[^0-9.-]/g, '');
                        setCustomInputValue(val);
                      }}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter') {
                          const parsed = parseFloat(customInputValue) / 100;
                          if (!isNaN(parsed)) {
                            updateValue(propId, row.key, parsed, 'value');
                            setActivePopover(null);
                          }
                        }
                      }}
                    />
                    <button
                      type="button"
                      className="px-3 py-1.5 bg-harken-blue text-white text-xs font-bold rounded-md hover:bg-harken-blue/90 transition-colors"
                      onClick={() => {
                        const parsed = parseFloat(customInputValue) / 100;
                        if (!isNaN(parsed)) {
                          updateValue(propId, row.key, parsed, 'value');
                          setActivePopover(null);
                        }
                      }}
                    >
                      Apply
                    </button>
                  </div>
                  <p className="text-[10px] text-slate-400 mt-1">
                    Positive = inferior, negative = superior
                  </p>
                </div>
              </>
            ) : (
              /* Dollar Mode Input */
              <div className="p-3 space-y-2">
                <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                  Dollar Adjustment
                </label>
                <input
                  type="text"
                  autoFocus
                  className="w-full border border-slate-200 dark:border-slate-600 rounded-md px-3 py-2 text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-harken-blue focus:border-transparent"
                  placeholder="Enter amount"
                  value={customInputValue}
                  onChange={(e) => {
                    const val = e.target.value.replace(/[^0-9.-]/g, '');
                    setCustomInputValue(val);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const parsed = parseFloat(customInputValue) / 1000; // Store as fraction
                      if (!isNaN(parsed)) {
                        updateValue(propId, row.key, parsed, 'value');
                        setActivePopover(null);
                      }
                    }
                  }}
                />
                <button
                  type="button"
                  className="w-full px-3 py-2 bg-harken-blue text-white text-xs font-bold rounded-md hover:bg-harken-blue/90 transition-colors"
                  onClick={() => {
                    const parsed = parseFloat(customInputValue) / 1000;
                    if (!isNaN(parsed)) {
                      updateValue(propId, row.key, parsed, 'value');
                      setActivePopover(null);
                    }
                  }}
                >
                  Apply Dollar Adjustment
                </button>
                <p className="text-[10px] text-slate-400">
                  Positive = inferior, negative = superior
                </p>
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  // Filter rows based on analysis mode AND grid configuration (property type specific fields)
  const visibleRows = useMemo(() => {
    let filtered = rows.filter(r => r.mode === 'both' || r.mode === analysisMode);
    
    // If we have a grid configuration, filter to show only relevant fields for this property type
    if (activeGridConfig) {
      const physicalFieldDefs = getPhysicalFieldsForGridType(activeGridConfig.gridType);
      const transactionalFieldDefs = getTransactionalFieldsForGridType(activeGridConfig.gridType);
      const physicalFieldIds = new Set(physicalFieldDefs.map(f => f.id));
      const transactionalFieldIds = new Set(transactionalFieldDefs.map(f => f.id));
      const configFieldIds = new Set([
        ...activeGridConfig.transactionalFields,
        ...activeGridConfig.physicalFields,
        ...activeGridConfig.metrics
      ]);
      
      // Core rows that should always be visible regardless of property type
      const coreRowKeys = new Set([
        'date', 'identification', 'address_row', 'price', 'price_sf', 'notes', 
        'overall_comp', 'overall_adj', 'adj_price_sf_val', 'total_value',
        // USPAP-required transactional adjustments
        'property_rights', 'financing_terms', 'conditions_of_sale', 'expenditures_after_sale', 'market_conditions',
        // Common physical factors
        'location', 'highest_best_use', 'year_built', 'effective_age', 'quality_condition', 'site_size_sf', 'building_size_sf'
      ]);
      
      filtered = filtered.filter(r => {
        // Always show core rows and calculated fields
        if (coreRowKeys.has(r.key) || r.isCalculated) return true;
        
        // Check if row key matches a field in the grid configuration
        if (configFieldIds.has(r.key)) return true;
        
        // For quantitative category, check transactional fields
        if (r.category === 'quantitative' && transactionalFieldIds.has(r.key)) return true;
        
        // For qualitative category, check physical fields
        if (r.category === 'qualitative' && physicalFieldIds.has(r.key)) return true;
        
        // Default: show rows that don't have a specific field mapping
        // (Custom rows, notes, etc.)
        if (!r.key.includes('_') && r.key.length < 20) return true;
        
        return false;
      });
      
      // Property-type specific field additions
      if (activeGridConfig.gridType === 'industrial') {
        // Industrial-specific fields like sidewall_height, dock_doors will be added via element dropdown
      } else if (activeGridConfig.gridType === 'multi_family') {
        // Multi-family specific fields like unit_count, unit_mix will be added via element dropdown
      }
    }
    
    return filtered;
  }, [rows, analysisMode, activeGridConfig]);

  // Prepare map data from properties
  const subjectProperty = properties.find(p => p.type === 'subject');
  const compProperties = properties.filter(p => p.type === 'comp');

  const hasSubjectCoords = subjectProperty?.lat !== undefined && subjectProperty?.lng !== undefined;
  const comparablesWithCoords = compProperties.filter(p => p.lat !== undefined && p.lng !== undefined);

  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">

      {/* COMPARABLE MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-harken-blue" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Improved Sales Map</span>
              <span className="text-xs text-slate-400">
                ({comparablesWithCoords.length} of {compProperties.length} comp{compProperties.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>

          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: subjectProperty!.lat!,
                  lng: subjectProperty!.lng!,
                  address: subjectProperty?.address,
                  propertyName: subjectProperty?.name,
                }}
                comparables={comparablesWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: comp.name || `Comp ${index + 1}`,
                  address: comp.address,
                  details: comp.salePrice
                    ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(comp.salePrice)
                    : undefined,
                }))}
                type="improved-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}

      {/* SCROLLABLE AREA - Contains grid and reconciliation */}
      {/* SCROLLABLE AREA - Contains grid and reconciliation */}
      <div ref={scrollContainerRef} className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" style={{ isolation: 'isolate' }}>
        {/* Horizontal Scroll Indicator - logic kept for zone scrolling, visual hidden */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />

        {/* Flex container for grid + action column */}
        <div
          className="flex"
          style={{ minWidth: `${totalGridWidth + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0"
            style={{
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${properties.length - 1}, ${COMP_COL_WIDTH}px)`,
              minWidth: `${totalGridWidth}px`,
            }}
          >

            {/* Header Row - Sticky to top with solid backgrounds */}
            <div
              className="sticky top-0 left-0 z-[120] border-b border-slate-200 dark:border-slate-700 flex items-end bg-white dark:bg-slate-800"
              style={{
                width: LABEL_COL_WIDTH,
                height: 120,
                transform: 'translateZ(0)',
                willChange: 'transform'
              }}
            >
              <div className="p-2 pl-3">
                <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Elements</div>
              </div>
            </div>
            {properties.map((prop) => (
              <div
                key={prop.id}
                className={`sticky top-0 overflow-hidden flex flex-col bg-white dark:bg-slate-800 ${prop.type === 'subject'
                  ? 'z-[110] border-b-2 border-harken-blue shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none'
                  : 'z-[100] border-b border-slate-200 dark:border-slate-700'
                  }`}
                style={{
                  height: 120,
                  transform: 'translateZ(0)',
                  willChange: 'transform',
                  ...(prop.type === 'subject' ? { left: LABEL_COL_WIDTH, width: SUBJECT_COL_WIDTH, position: 'sticky' as const } : {})
                }}
              >
                <PropertyCard property={prop} isSubject={prop.type === 'subject'} onDelete={onDeleteProperty} />
              </div>
            ))}

            {/* Sections */}
            {sections.filter(s => !hiddenSections.has(s.id)).map(section => {
              const hasResidualRows = visibleRows.some(r => r.category === section.id && r.mode === 'residual');
              const canDeleteSection = section.id === 'quantitative' || section.id === 'qualitative';
              return (
                <React.Fragment key={section.id}>
                  {/* Section Header - Full Width */}
                  <div
                    className={`col-span-full relative z-[50] mt-4 border-y ${hasResidualRows ? 'border-purple-300 dark:border-purple-800' : 'border-slate-200 dark:border-slate-700'
                      } ${hasResidualRows ? 'bg-purple-50 dark:bg-purple-900/20' : 'bg-slate-50 dark:bg-slate-900'}`}
                  >
                    <div
                      className={`sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest flex items-center gap-2 ${hasResidualRows
                        ? 'text-purple-700 dark:text-purple-300'
                        : 'text-slate-700 dark:text-slate-300'
                        } ${hasResidualRows ? 'bg-purple-50 dark:bg-purple-900/10' : 'bg-slate-50 dark:bg-slate-900'}`}
                      style={{ zIndex: 51 }}
                    >
                      {section.title}
                      {canDeleteSection && (
                        <button
                          onClick={() => handleSectionDeleteClick(section.id, section.title)}
                          className="ml-2 p-1 rounded hover:bg-red-100 text-slate-400 hover:text-red-500 transition-colors"
                          title={`Remove ${section.title} section`}
                        >
                          <Trash2 className="w-3.5 h-3.5" />
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Section Rows */}
                  {visibleRows.filter(r => r.category === section.id).map(row => {
                    const isResidualRow = row.mode === 'residual';
                    return (
                      <React.Fragment key={row.id}>
                        {/* Label Column - Sticky Left, never scrolls horizontally */}
                        <div
                          className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700/50 flex items-center justify-between px-2 py-1.5 group ${row.key === 'total_value'
                            ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800'
                            : isResidualRow
                              ? 'border-purple-200 dark:border-purple-800 bg-purple-50 dark:bg-[#1e1b2e]'
                              : 'bg-white dark:bg-slate-900'
                            }`}
                          style={{
                            width: LABEL_COL_WIDTH,
                            transform: 'translateZ(0)'
                          }}
                        >
                          <span className={`text-xs truncate ${row.key === 'total_value'
                            ? 'font-black text-slate-900 uppercase'
                            : isResidualRow
                              ? 'font-semibold text-purple-700'
                              : 'font-medium text-slate-600'
                            }`}>{row.label}</span>
                          <button
                            onClick={() => removeRow(row.id)}
                            className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                            title={`Remove ${row.label}`}
                          >
                            <Trash2 className="w-3 h-3" />
                          </button>
                        </div>

                        {/* Data Cells */}
                        {
                          properties.map(prop => {
                            const isNotesRow = row.key === 'notes';
                            const noteValue = values[prop.id]?.[row.key]?.value;
                            const noteText = typeof noteValue === 'string' ? stripHtml(noteValue) : '';
                            const hasNotes = noteText.trim() !== '' &&
                              !noteText.toLowerCase().includes('click to');

                            // Determine background color based on row type and property type
                            const bgClass = (() => {
                              if (row.key === 'total_value') return 'bg-slate-50 dark:bg-slate-700';
                              if (prop.type === 'subject') return isResidualRow ? 'bg-purple-50 dark:bg-[#1e1b2e]' : 'bg-[#eff6ff] dark:bg-[#0f1f3a]';
                              if (isResidualRow) return 'bg-purple-50 dark:bg-purple-900/10';
                              return 'bg-white dark:bg-slate-800';
                            })();

                            return (
                              <div
                                key={`${row.id}-${prop.id}`}
                                className={`border-r border-b border-slate-100 dark:border-slate-700/50 p-2 flex items-center text-xs ${prop.type === 'subject'
                                  ? 'z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none'
                                  : ''
                                  } ${row.key === 'total_value'
                                    ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 font-bold'
                                    : isResidualRow
                                      ? 'border-purple-200 dark:border-purple-800'
                                      : ''
                                  } ${bgClass} ${isNotesRow ? 'cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors' : ''}`}
                                style={prop.type === 'subject'
                                  ? {
                                    left: LABEL_COL_WIDTH,
                                    width: SUBJECT_COL_WIDTH,
                                    position: 'sticky' as const,
                                    transform: 'translateZ(0)'
                                  }
                                  : {}
                                }
                                onClick={isNotesRow ? () => openNotesEditor(prop.id, getPropertyName(prop.id), row.key) : undefined}
                              >
                                {isNotesRow ? (
                                  <div className="flex items-center gap-1.5 w-full">
                                    <MessageSquare className={`w-3 h-3 flex-shrink-0 ${hasNotes ? 'text-harken-blue' : 'text-slate-300'}`} />
                                    <span className={`truncate ${hasNotes ? 'text-slate-700' : 'text-slate-400 italic'}`}>
                                      {hasNotes
                                        ? (noteText.length > 30 ? noteText.substring(0, 30) + '...' : noteText)
                                        : 'Click to add notes'}
                                    </span>
                                  </div>
                                ) : section.id === 'quantitative' && prop.type !== 'subject'
                                  ? renderQuantitativeCell(prop.id, row, values[prop.id]?.[row.key] || { value: 0 })
                                  : section.id === 'qualitative' && prop.type !== 'subject'
                                    ? <QualitativeChip propId={prop.id} rowKey={row.key} />
                                    : (() => {
                                      // For calculated fields, always use the calculated value
                                      const calculatedVal = row.isCalculated ? getCalculatedValue(prop.id, row.key) : null;
                                      const displayValue = calculatedVal !== null
                                        ? calculatedVal
                                        : (values[prop.id]?.[row.key]?.value ?? getCalculatedValue(prop.id, row.key));

                                      // Special styling for auto-calculated cap rate
                                      const isAutoCalcCapRate = row.key === 'extracted_cap_rate' && calculatedVal !== null;
                                      
                                      // Check if this is the subject land add-back linked from Land Valuation
                                      const isLinkedLandValue = row.key === 'subject_land_add_back' && 
                                        prop.type === 'subject' && 
                                        landValuationData?.concludedLandValue &&
                                        values[prop.id]?.[row.key]?.value === landValuationData.concludedLandValue;

                                      return (
                                        <div className="flex items-center gap-1.5">
                                          <span className={`${row.key === 'total_value'
                                            ? 'font-bold text-emerald-700'
                                            : isResidualRow
                                              ? 'font-semibold text-purple-700'
                                              : isAutoCalcCapRate || isLinkedLandValue
                                                ? 'font-semibold text-harken-blue'
                                                : 'font-medium'
                                            }`}>
                                            {formatValue(displayValue, row.format)}
                                          </span>
                                          {isAutoCalcCapRate && (
                                            <span className="text-[9px] text-slate-400 font-normal" title="Auto-calculated from NOI ÷ Sale Price">
                                              (auto)
                                            </span>
                                          )}
                                          {isLinkedLandValue && (
                                            <span 
                                              className="inline-flex items-center gap-0.5 px-1.5 py-0.5 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded text-[9px] font-medium border border-emerald-200 dark:border-emerald-700/50" 
                                              title="Linked from Land Valuation concluded value"
                                            >
                                              <Link2 className="w-2.5 h-2.5" />
                                              Land Val
                                            </span>
                                          )}
                                        </div>
                                      );
                                    })()
                                }
                              </div>
                            );
                          })
                        }
                      </React.Fragment>
                    );
                  })}

                  {/* Add Element Button Row for this section */}
                  <div
                    className={`sticky left-0 p-2 bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50 ${openElementDropdown === section.id ? 'z-[500]' : 'z-[60]'}`}
                    style={{ width: LABEL_COL_WIDTH }}
                  >
                    <AddElementButton sectionId={section.id as GridRowCategory} />
                  </div>
                  <div
                    className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50"
                    style={{ width: SUBJECT_COL_WIDTH }}
                  ></div>
                  {properties.filter(p => p.type !== 'subject').map(prop => (
                    <div key={`add-element-${section.id}-${prop.id}`} className="bg-white dark:bg-slate-800 border-r border-slate-100 dark:border-slate-700/50"></div>
                  ))}
                </React.Fragment>
              );
            })}
          </div>

          {/* ACTION COLUMN */}
          <div
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-harken-blue/20 flex items-center justify-center group-hover:bg-harken-blue/30 transition-colors">
                  <Plus className="w-6 h-6 text-harken-blue" />
                </div>
                <span className="text-xs font-semibold text-harken-blue">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RECONCILIATION SECTION - Stays centered, doesn't scroll horizontally */}
        <div
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-emerald-500 rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Value Reconciliation & Narrative</h2>
            </div>

            {/* Dual Metric Display - Shows both $/SF and $/Unit for multi-family */}
            {showDualMetrics && (
              <div className="grid grid-cols-2 gap-4">
                <div className={`p-4 rounded-xl border-2 ${subjectData?.primaryValueDriver === 'price_per_sf' ? 'bg-harken-blue/5 border-harken-blue' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-slate-600 dark:text-slate-300">$/SF Building</span>
                    {subjectData?.primaryValueDriver === 'price_per_sf' && (
                      <span className="px-2 py-0.5 bg-harken-blue text-white text-[10px] font-bold rounded">PRIMARY</span>
                    )}
                  </div>
                  <div className={`text-2xl font-bold ${subjectData?.primaryValueDriver === 'price_per_sf' ? 'text-harken-blue' : 'text-slate-800 dark:text-white'}`}>
                    {concludedValuePsf ? `$${concludedValuePsf.toLocaleString()}` : '-'}
                  </div>
                </div>
                <div className={`p-4 rounded-xl border-2 ${subjectData?.primaryValueDriver === 'price_per_unit' ? 'bg-harken-blue/5 border-harken-blue' : 'bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700'}`}>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm font-semibold text-slate-600 dark:text-slate-300">$/Unit</span>
                    {subjectData?.primaryValueDriver === 'price_per_unit' && (
                      <span className="px-2 py-0.5 bg-harken-blue text-white text-[10px] font-bold rounded">PRIMARY</span>
                    )}
                  </div>
                  <div className={`text-2xl font-bold ${subjectData?.primaryValueDriver === 'price_per_unit' ? 'text-harken-blue' : 'text-slate-800 dark:text-white'}`}>
                    {concludedValuePerUnit ? `$${concludedValuePerUnit.toLocaleString()}` : '-'}
                  </div>
                </div>
              </div>
            )}

            {/* Concluded Value Summary */}
            <div className="p-5 bg-emerald-50 dark:bg-emerald-900/20 rounded-xl border border-emerald-200 dark:border-emerald-700/50">
              <div className="flex items-center justify-between">
                <span className="text-sm font-semibold text-emerald-700 dark:text-emerald-300">Concluded Value Indication</span>
                <div className="text-right">
                  <div className="text-2xl font-bold text-emerald-700 dark:text-emerald-300">
                    {concludedValue ? `$${concludedValue.toLocaleString()}` : 'Pending'}
                  </div>
                  {!showDualMetrics && concludedValuePsf && (
                    <div className="text-sm text-emerald-600 dark:text-emerald-400">
                      ${concludedValuePsf.toLocaleString()} / SF
                    </div>
                  )}
                </div>
              </div>
            </div>

            <EnhancedTextArea
              label="Notes"
              value={reconciliationText}
              onChange={setReconciliationText}
              placeholder="Type your analysis and assumptions here..."
              sectionContext="sales_comparison"
              helperText="AI can draft a reconciliation narrative based on your sales comparison analysis."
              minHeight={300}
              rows={10}
            />

            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>

      {/* NOTES EDITOR MODAL */}
      {
        notesEditor?.isOpen && (
          <NotesEditorModal
            isOpen={notesEditor.isOpen}
            title={notesEditor.propName}
            content={notesContent}
            onClose={closeNotesEditor}
            onSave={saveNotes}
            onInput={handleEditorInput}
            applyFormatting={applyFormatting}
          />
        )
      }

      {/* SECTION DELETE CONFIRMATION MODAL */}
      {
        confirmDelete?.isOpen && (
          <div className="fixed inset-0 z-[1100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
            <div
              className="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200"
              onClick={(e) => e.stopPropagation()}
            >
              {/* Warning Header */}
              <div className="bg-gradient-to-r from-amber-500 to-orange-500 px-6 py-4 flex items-center gap-3">
                <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                  <AlertTriangle className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h3 className="text-white font-bold text-lg">Remove Section?</h3>
                  <p className="text-white/80 text-sm">This action cannot be undone</p>
                </div>
              </div>

              {/* Content */}
              <div className="px-6 py-5">
                <p className="text-slate-600 text-sm leading-relaxed">
                  Are you sure you want to remove the <span className="font-semibold text-slate-800 dark:text-white">"{confirmDelete.sectionTitle}"</span> section?
                  All rows within this section will be hidden from the grid.
                </p>
                <div className="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2">
                  <AlertTriangle className="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0" />
                  <p className="text-amber-800 text-xs">
                    This will remove all adjustment data from your analysis. You may need to refresh the page to restore this section.
                  </p>
                </div>
              </div>

              {/* Actions */}
              <div className="px-6 py-4 bg-slate-50 dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex items-center justify-end gap-3">
                <button
                  onClick={cancelSectionDelete}
                  className="px-5 py-2.5 rounded-lg text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
                >
                  No, Keep It
                </button>
                <button
                  onClick={confirmSectionDelete}
                  className="px-5 py-2.5 rounded-lg text-sm font-bold text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 shadow-md hover:shadow-lg transition-all"
                >
                  Yes, Remove Section
                </button>
              </div>
            </div>
          </div>
        )
      }
    </div >
  );
};

```

Let me check the ExpenseComparableGrid and RentComparableGrid for similar issues, as they may have the same dark mode problems:

```typescriptreact
import React from 'react';
import { MapPin, Activity, Trash2 } from 'lucide-react';
import { Property } from '../types';

interface PropertyCardProps {
  property: Property;
  isSubject?: boolean;
  onDelete?: (propertyId: string) => void;
}

export const PropertyCard: React.FC<PropertyCardProps> = ({ property, isSubject, onDelete }) => {
  return (
    <div
      className="flex flex-col h-full bg-white dark:bg-slate-800"
    >
      {/* Photo section */}
      <div className="relative h-16 w-full overflow-hidden group bg-slate-100 dark:bg-slate-700">
        <img
          src={property.image}
          alt={property.name}
          className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
        />
        {isSubject && (
          <div className="absolute top-1.5 left-1.5 bg-[#0da1c7] text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
            SUBJECT
          </div>
        )}
        {!isSubject && property.status && (
          <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
            {property.status}
          </div>
        )}
        {/* Delete button overlay - appears on hover for non-subject properties */}
        {!isSubject && onDelete && (
          <button
            onClick={() => onDelete(property.id)}
            className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
            title="Remove this comparable"
          >
            <Trash2 className="w-3 h-3" />
          </button>
        )}
      </div>

      {/* Info section - sky-50 background for subject, white for comps */}
      <div
        className={`p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700 ${isSubject ? 'bg-sky-50 dark:bg-sky-900/30' : 'bg-white dark:bg-slate-800'}`}
      >
        <h3 className="font-bold text-slate-800 dark:text-slate-100 text-xs leading-tight line-clamp-1" title={property.name}>
          {property.name}
        </h3>

        <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
          <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-[#0da1c7]" />
          <span className="line-clamp-1 leading-tight">{property.address}</span>
        </div>

        {!isSubject && property.distance && (
          <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
            <Activity className="w-3 h-3 text-emerald-500" />
            <span>{property.distance} away</span>
          </div>
        )}
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-700"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-gray-50/95 text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-amber-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-amber-50/95 text-amber-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'totalExpensesPerSf' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-amber-100' : 'bg-sky-50'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-amber-700' : 'text-slate-600'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-700"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-gray-50/95 text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-amber-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-amber-50/95 text-amber-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'totalExpensesPerSf' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-amber-100' : 'bg-sky-50'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-amber-700' : 'text-slate-600'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-amber-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-amber-50/95 text-amber-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'totalExpensesPerSf' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-amber-100' : 'bg-sky-50'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-amber-700' : 'text-slate-600'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-amber-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-amber-50/95 text-amber-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'totalExpensesPerSf' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-amber-100' : 'bg-sky-50'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-amber-700' : 'text-slate-600'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800' : ''
                }`}
                style={{ width: LABEL_COL_WIDTH, backgroundColor: row.id === 'totalExpensesPerSf' ? '#f8fafc' : '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-amber-100' : 'bg-sky-50'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-amber-700' : 'text-slate-600'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-700"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-gray-50/95 text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-emerald-50/95 text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-700"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-gray-50/95 text-slate-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-emerald-50/95 text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-emerald-50/95 text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-emerald-50/95 text-emerald-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: '#ffffff', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-800" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest backdrop-blur-sm bg-blue-50/95 text-blue-700 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5"
                style={{ width: LABEL_COL_WIDTH, backgroundColor: '#ffffff', transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-300">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs bg-sky-50 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700' : 'text-slate-600'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200">
            <div className="absolute left-0 right-0 h-full bg-emerald-50" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: '#ecfdf5' }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full bg-amber-50" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-amber-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: '#fffbeb' }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="font-bold text-amber-800">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs" style={{ backgroundColor: '#fef3c7' }}></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-amber-200">
            <div className="absolute left-0 right-0 h-full bg-amber-50" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-amber-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: '#fffbeb' }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="font-bold text-amber-800">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs" style={{ backgroundColor: '#fef3c7' }}></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: '#fef3c7', transform: 'translateZ(0)' }}>
              <span className="font-bold text-amber-800">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs" style={{ backgroundColor: '#fef3c7' }}></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative" 
        style={{ backgroundColor: 'var(--bg-secondary)', isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-800 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 border-r border-slate-200">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 flex flex-col"
              style={{ height: 120, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-700" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 flex items-center gap-2" style={{ zIndex: 51, backgroundColor: 'var(--bg-primary)' }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)', transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)', transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--bg-secondary)' }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" style={{ width: SUBJECT_COL_WIDTH, backgroundColor: 'var(--accent-cyan-light)' }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - offset to avoid action column */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5" className="bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)]" className="bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - positioned below headers */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

I've completed the dark mode fixes across all approach grids. Here's a summary of the changes:

## Summary of Changes

### 1. **LandSalesGrid.tsx** (Land Valuation)
- Fixed main container background (`bg-slate-50 dark:bg-slate-900`)
- Fixed all section headers (Transaction Data, Transaction Adjustments, Qualitative Adjustments) with proper dark variants
- Fixed subject property info background (`bg-sky-50 dark:bg-sky-900/30`)
- Fixed all row label and subject column backgrounds
- Fixed the Action Column/Add Comps area
- Fixed the Value Indication footer section
- Replaced all `var(--bg-secondary)` and `var(--accent-cyan-light)` with proper Tailwind dark mode classes

### 2. **SalesGrid.tsx** (Multifamily Sales Comparison)
- Fixed main container and scroll area backgrounds
- Fixed map header hover states

### 3. **PropertyCard.tsx** (Used across all grids)
- Enhanced subject info section dark mode (`dark:bg-sky-900/30`)

### 4. **MultiFamilyGrid.tsx**
- Fixed Quantitative Adjustments section header
- Fixed Qualitative Adjustments section header
- **Replaced the gold/amber Summary section** with consistent slate styling
- **Replaced the gold Adjusted Comp Range row** with consistent blue/slate styling
- Fixed all sticky row backgrounds
- Replaced all CSS variable usages with proper Tailwind classes

### 5. **ExpenseComparableGrid.tsx**
- Fixed main container and scroll area
- Fixed Property Data section header
- **Replaced the gold/amber Expense Categories section** with blue styling (consistent with other grids)
- Fixed all property rows with proper dark variants
- Fixed Ratios section with dark mode
- Replaced amber totals row styling with consistent emerald/blue

### 6. **RentComparableGrid.tsx**
- Fixed main container background
- Fixed map header hover states
- Fixed Transaction Data section header
- Fixed Qualitative Adjustments section header
- Fixed all row backgrounds with proper dark variants

### Key Styling Decisions:
- Removed all **gold/amber accent colors** and replaced with consistent slate/blue/emerald theming
- All grids now use the same color scheme for section headers and special rows
- Dark mode uses `slate-900` for primary backgrounds, `slate-800` for secondary
- Subject columns use `sky-50/sky-900/20-30` for the distinctive cyan tint in both modes

---

**User**

on both the land valuation And multifamily. And I would assume Rent as well. we still have a top side scroll bar right underneath the Property cards. And that needs to go away because we have one on the bottom as well, so they're redundant. So let's get rid of that top one. In multifamily, The add comps area is still white. Background. And Underneath the overall comparability. That's still all white for background as well. Four. Our quantitative adjustments We do not have the ability to actually adjust them. And then a big one is When? The comps scroll behind the subject You should not be able to see The Information Right now, The subject area. is transparent, So when something scrolls behind it, you can see it. It needs to work just like The sales comparison. where when you side scroll, You cannot see it. The sales comparison grid It also does not have the top scroll bar.

---

**Cursor**

I'll fix these issues. Let me start by examining the scroll indicator and then address the other problems.

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-sky-900/20"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-700 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 flex items-center justify-center group-hover:bg-accent-cyan/30 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-sky-900/20'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-sky-900/20 shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-sky-900/20" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Dropdown
  const OverallDropdown = ({ comp }: { comp: RentComp }) => (
    <select
      value={comp.overallComparability}
      onChange={(e) => handleUpdateComp(comp.id, 'overallComparability', e.target.value as any)}
      className="w-full text-center text-xs py-1.5 px-2 border-0 bg-transparent cursor-pointer focus:outline-none focus:ring-2 focus:ring-white/50 font-semibold text-white"
    >
      <option value="Superior" className="text-slate-800 dark:text-white">Superior</option>
      <option value="Similar" className="text-slate-800 dark:text-white">Similar</option>
      <option value="Inferior" className="text-slate-800 dark:text-white">Inferior</option>
    </select>
  );

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-sky-900/30 border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, MapPin, CheckCircle2, Circle, ChevronDown, PenLine, Building2 } from 'lucide-react';
import { ExpenseComp, ExpenseGridRow } from '../expenseTypes';
import { 
  MOCK_EXPENSE_COMPS, 
  SUBJECT_EXPENSE_PROPERTY, 
  EXPENSE_PROPERTY_ROWS,
  EXPENSE_CATEGORY_ROWS,
  EXPENSE_RATIO_ROWS,
  AVAILABLE_PROPERTY_ELEMENTS,
  AVAILABLE_EXPENSE_ELEMENTS,
  AvailableExpenseElement,
  formatCurrency, 
  formatPercent,
  formatNumber
} from '../expenseConstants';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface ExpenseComparableGridProps {
  /** Initial expense comparables - if empty, will show empty state */
  expenseComparables?: ExpenseComp[];
  /** Notes text for the expense analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: ExpenseComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const ExpenseComparableGrid: React.FC<ExpenseComparableGridProps> = ({
  expenseComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<ExpenseComp[]>(
    expenseComparables && expenseComparables.length > 0 ? expenseComparables : MOCK_EXPENSE_COMPS
  );
  const [notesText, setNotesText] = useState(initialNotes);
  const [propertyRows, setPropertyRows] = useState(EXPENSE_PROPERTY_ROWS);
  const [expenseRows, setExpenseRows] = useState(EXPENSE_CATEGORY_ROWS);
  const [ratioRows] = useState(EXPENSE_RATIO_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'property' | 'expense' | null>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: ExpenseComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this expense comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleToggleSelected = (compId: string) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, selected: !c.selected } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'property' | 'expense', element: AvailableExpenseElement) => {
    const newRow: ExpenseGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      format: element.format,
      removable: true 
    };
    
    if (section === 'property') {
      if (propertyRows.some(r => r.id === element.id)) return;
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      if (expenseRows.some(r => r.id === element.id)) return;
      // Insert before totalExpensesPerSf
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'property' | 'expense') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: ExpenseGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      format: section === 'expense' ? 'currency' : undefined,
      removable: true 
    };
    
    if (section === 'property') {
      setPropertyRows(prev => [...prev, newRow]);
    } else {
      const totalIndex = expenseRows.findIndex(r => r.id === 'totalExpensesPerSf');
      if (totalIndex >= 0) {
        setExpenseRows(prev => [...prev.slice(0, totalIndex), newRow, ...prev.slice(totalIndex)]);
      } else {
        setExpenseRows(prev => [...prev, newRow]);
      }
    }
    setOpenElementDropdown(null);
  };

  const getAvailableElements = (section: 'property' | 'expense') => {
    const existingIds = section === 'property' 
      ? propertyRows.map(r => r.id)
      : expenseRows.map(r => r.id);
    
    const allElements = section === 'property'
      ? AVAILABLE_PROPERTY_ELEMENTS
      : AVAILABLE_EXPENSE_ELEMENTS;
    
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'property' | 'expense') => {
    if (section === 'property') {
      setPropertyRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setExpenseRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const formatValue = (value: any, format?: 'currency' | 'percent' | 'number'): string => {
    if (value === undefined || value === null) return '-';
    switch (format) {
      case 'currency': return formatCurrency(value);
      case 'percent': return formatPercent(value);
      case 'number': return formatNumber(value);
      default: return String(value);
    }
  };

  const getPropertyValue = (comp: ExpenseComp, rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = comp[rowId as keyof ExpenseComp];
    return formatValue(value, format);
  };

  const getSubjectPropertyValue = (rowId: string, format?: 'currency' | 'percent' | 'number') => {
    const value = SUBJECT_EXPENSE_PROPERTY[rowId as keyof typeof SUBJECT_EXPENSE_PROPERTY];
    return formatValue(value, format);
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'property' | 'expense' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate benchmark values from selected comps
  const selectedComps = comps.filter(c => c.selected);
  const avgExpenseRatio = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.expenseRatioPercent, 0) / selectedComps.length
    : 0;
  const avgTotalExpPerSf = selectedComps.length > 0
    ? selectedComps.reduce((acc, c) => acc + c.totalExpensesPerSf, 0) / selectedComps.length
    : 0;

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_EXPENSE_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_EXPENSE_PROPERTY.address}>
                {SUBJECT_EXPENSE_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_EXPENSE_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Building2 className="w-2.5 h-2.5" />
                  {comp.propertyType}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this comparable"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Comp {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] mt-auto">
                  <button
                    onClick={() => handleToggleSelected(comp.id)}
                    className={`flex items-center gap-1 px-1.5 py-0.5 rounded transition-all ${
                      comp.selected 
                        ? 'bg-emerald-100 text-emerald-700' 
                        : 'bg-slate-100 dark:bg-slate-700 text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'
                    }`}
                  >
                    {comp.selected ? <CheckCircle2 className="w-3 h-3" /> : <Circle className="w-3 h-3" />}
                    <span className="font-medium">{comp.selected ? 'Selected' : 'Select'}</span>
                  </button>
                </div>
              </div>
            </div>
          ))}

          {/* ========== PROPERTY DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              PROPERTY DATA
            </div>
          </div>

          {/* Property Data Rows */}
          {propertyRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'property')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getPropertyValue(comp, row.id, row.format)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Property Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'property' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="property" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-prop-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== EXPENSE CATEGORIES SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-blue-50 dark:bg-blue-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-blue-50 dark:bg-slate-900 text-blue-700 dark:text-blue-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE CATEGORIES
            </div>
          </div>

          {/* Expense Category Rows */}
          {expenseRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'totalExpensesPerSf' ? 'font-black text-slate-900 dark:text-white uppercase' : 'font-medium text-slate-600 dark:text-slate-400'
                }`}>{row.label}</span>
                {row.removable !== false && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'expense')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className={`font-medium text-slate-700 dark:text-slate-200 ${row.id === 'totalExpensesPerSf' ? 'font-bold' : ''}`}>
                  {getSubjectPropertyValue(row.id, row.format)}
                </span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'totalExpensesPerSf' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-700' : ''
                  }`}
                >
                  <span className={`font-medium ${
                    row.id === 'totalExpensesPerSf' ? 'font-bold text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'
                  }`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Expense Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-900 p-2 ${openElementDropdown === 'expense' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="expense" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-exp-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== RATIOS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              EXPENSE RATIOS
            </div>
          </div>

          {/* Ratio Rows */}
          {ratioRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400">{row.label}</span>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-bold text-slate-700 dark:text-slate-200">{getSubjectPropertyValue(row.id, row.format)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs ${
                    comp.selected ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-white dark:bg-slate-800'
                  }`}
                >
                  <span className={`font-bold ${comp.selected ? 'text-emerald-700 dark:text-emerald-400' : 'text-slate-600 dark:text-slate-300'}`}>
                    {getPropertyValue(comp, row.id, row.format)}
                  </span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* ========== BENCHMARK FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Benchmark</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">—</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`benchmark-${comp.id}`} 
              className={`p-2 flex items-center justify-center ${
                comp.selected ? 'bg-emerald-500' : 'bg-harken-blue'
              }`}
            >
              {comp.selected ? (
                <CheckCircle2 className="w-5 h-5 text-white" />
              ) : (
                <span className="text-xs text-white/60">—</span>
              )}
            </div>
          ))}

        </div>

        {/* EXPENSE BENCHMARK FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Expense Benchmark</h2>
              </div>
              <div className="text-sm text-slate-500 dark:text-slate-400">
                Based on {selectedComps.length} selected comparable{selectedComps.length !== 1 ? 's' : ''}
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Expense Ratio</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">
                    {formatPercent(SUBJECT_EXPENSE_PROPERTY.expenseRatioPercent || 0)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg Expense Ratio</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatPercent(avgExpenseRatio)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Market Avg $/SF</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(avgTotalExpPerSf)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="expense_comparable"
                helperText="AI can draft an expense analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React from 'react';
import { MapPin, Activity, Trash2 } from 'lucide-react';
import { Property } from '../types';

interface PropertyCardProps {
  property: Property;
  isSubject?: boolean;
  onDelete?: (propertyId: string) => void;
}

export const PropertyCard: React.FC<PropertyCardProps> = ({ property, isSubject, onDelete }) => {
  return (
    <div
      className="flex flex-col h-full bg-white dark:bg-slate-800"
    >
      {/* Photo section */}
      <div className="relative h-16 w-full overflow-hidden group bg-slate-100 dark:bg-slate-700">
        <img
          src={property.image}
          alt={property.name}
          className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
        />
        {isSubject && (
          <div className="absolute top-1.5 left-1.5 bg-[#0da1c7] text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
            SUBJECT
          </div>
        )}
        {!isSubject && property.status && (
          <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
            {property.status}
          </div>
        )}
        {/* Delete button overlay - appears on hover for non-subject properties */}
        {!isSubject && onDelete && (
          <button
            onClick={() => onDelete(property.id)}
            className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
            title="Remove this comparable"
          >
            <Trash2 className="w-3 h-3" />
          </button>
        )}
      </div>

      {/* Info section - sky-50 background for subject, white for comps */}
      <div
        className={`p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700 ${isSubject ? 'bg-sky-50 dark:bg-[#0f1f3a]' : 'bg-white dark:bg-slate-800'}`}
      >
        <h3 className="font-bold text-slate-800 dark:text-slate-100 text-xs leading-tight line-clamp-1" title={property.name}>
          {property.name}
        </h3>

        <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
          <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-[#0da1c7]" />
          <span className="line-clamp-1 leading-tight">{property.address}</span>
        </div>

        {!isSubject && property.distance && (
          <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
            <Activity className="w-3 h-3 text-emerald-500" />
            <span>{property.distance} away</span>
          </div>
        )}
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  const [adjustmentMode, setAdjustmentMode] = useState<'Percent' | 'Dollar'>('Percent');
  const [customInputValue, setCustomInputValue] = useState<string>('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Quantitative adjustment cell
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    return (
      <span className={`font-medium ${value !== 0 ? (value > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
        {formatPercent(value)}
      </span>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Home, Building2, Grid3X3 } from 'lucide-react';
import { MultiFamilyComp, MultiFamilyGridRow, AvailableMultiFamilyElement } from '../types';
import { 
  MOCK_MF_COMPS, 
  SUBJECT_MF_PROPERTY, 
  TRANSACTION_ROWS,
  QUANTITATIVE_ROWS,
  QUALITATIVE_ROWS,
  formatCurrency, 
  formatPercent,
  LABEL_COL_WIDTH,
  SUBJECT_COL_WIDTH,
  COMP_COL_WIDTH,
  ACTION_COL_WIDTH,
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { MultiFamilyCalculationMethod } from '../../../types';

interface MultiFamilyGridProps {
  scenarioId?: number;
}

export const MultiFamilyGrid: React.FC<MultiFamilyGridProps> = ({ scenarioId }) => {
  const { setApproachConclusion, setSubjectData, state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, subjectData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Use subject data from context if available, otherwise fallback to mock
  const subjectProperty = useMemo(() => {
    if (subjectData?.address?.street) {
      return {
        address: subjectData.address.street,
        cityState: `${subjectData.address.city || ''}, ${subjectData.address.state || ''} ${subjectData.address.zip || ''}`.trim(),
        imageUrl: SUBJECT_MF_PROPERTY.imageUrl, // Keep placeholder image
        propertyType: subjectData.gridConfiguration?.gridType === 'multi_family' ? 'Multi-Family' : 'Office / Professional',
        bedBath: subjectData.unitMix && subjectData.unitMix.length > 0 
          ? `${subjectData.unitMix.find(u => u.count > 0)?.bedrooms || 2} BR / ${subjectData.unitMix.find(u => u.count > 0)?.bathrooms || 1} BA`
          : SUBJECT_MF_PROPERTY.bedBath,
        includedUtilities: SUBJECT_MF_PROPERTY.includedUtilities, // Could be added to subjectData later
        currentRentPerMonth: subjectData.unitMix?.find(u => u.avgRent)?.avgRent || SUBJECT_MF_PROPERTY.currentRentPerMonth,
        unitCount: subjectData.totalUnitCount || SUBJECT_MF_PROPERTY.unitCount,
        yearBuilt: SUBJECT_MF_PROPERTY.yearBuilt, // Could be derived from improvements
        condition: SUBJECT_MF_PROPERTY.condition,
        parking: SUBJECT_MF_PROPERTY.parking,
      };
    }
    return SUBJECT_MF_PROPERTY;
  }, [subjectData]);
  
  const [comps, setComps] = useState<MultiFamilyComp[]>(MOCK_MF_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_ROWS);
  const [quantitativeRows, setQuantitativeRows] = useState(QUANTITATIVE_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'quantitative' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState('');
  const [adjustmentMode, setAdjustmentMode] = useState<'Percent' | 'Dollar'>('Percent');
  const [customInputValue, setCustomInputValue] = useState<string>('');
  
  // Calculation method for display units - reads from subject data or defaults to per_unit
  const [calculationMethod, setCalculationMethodLocal] = useState<MultiFamilyCalculationMethod>(
    subjectData?.calculationMethod || 'per_unit'
  );
  
  // Sync calculation method when subjectData changes (external updates)
  useEffect(() => {
    if (subjectData?.calculationMethod && subjectData.calculationMethod !== calculationMethod) {
      setCalculationMethodLocal(subjectData.calculationMethod);
    }
  }, [subjectData?.calculationMethod]);
  
  // Handler that syncs to both local state AND WizardContext
  const handleCalculationMethodChange = (method: MultiFamilyCalculationMethod) => {
    setCalculationMethodLocal(method);
    setSubjectData({ calculationMethod: method });
  };
  
  // Get display label based on calculation method
  const getUnitLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return '$/Room';
      case 'per_sf': return '$/SF';
      case 'per_pad': return '$/Pad';
      case 'per_hole': return '$/Hole';
      case 'per_unit':
      default: return '$/Unit';
    }
  };
  
  // Get count field name based on calculation method
  const getCountFieldLabel = (): string => {
    switch (calculationMethod) {
      case 'per_room': return 'Room Count';
      case 'per_pad': return 'Pad Count';
      case 'per_hole': return 'Hole Count';
      case 'per_sf': return 'Building SF';
      case 'per_unit':
      default: return 'Unit Count';
    }
  };

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;

  // Calculate average adjusted rental rate
  const averageAdjustedRate = comps.length > 0
    ? comps.reduce((acc, c) => {
        const totalAdj = (c.parkingAdj + c.qualityConditionAdj + c.yearBuiltAdj) / 100;
        return acc + c.rentalRatePerMonth * (1 + totalAdj);
      }, 0) / comps.length
    : 0;

  // Sync to reconciliation
  useEffect(() => {
    if (scenarioId !== undefined && averageAdjustedRate > 0) {
      setApproachConclusion(scenarioId, 'Multi-Family Approach', Math.round(averageAdjustedRate));
    }
  }, [scenarioId, averageAdjustedRate, setApproachConclusion]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof MultiFamilyComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  const handleAddElement = (section: 'transaction' | 'quantitative' | 'qualitative', element: AvailableMultiFamilyElement) => {
    const newRow: MultiFamilyGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      if (quantitativeRows.some(r => r.id === element.id)) return;
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  const handleAddCustomElement = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: MultiFamilyGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'quantitative' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'quantitative'
        ? quantitativeRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context - default to multifamily for this grid
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'commercial',
      subtype: propertySubtype || 'multifamily',
      approach: 'multi_family',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableMultiFamilyElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label,
      description: el.description,
      section: section  // Add the section from the function parameter
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'quantitative' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'quantitative') {
      setQuantitativeRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: MultiFamilyComp, rowId: string) => {
    switch (rowId) {
      case 'location': return comp.address;
      case 'propertyType': return comp.propertyType;
      case 'bedBath': return comp.bedBath;
      case 'includedUtilities': return comp.includedUtilities;
      case 'rentalRate': return formatCurrency(comp.rentalRatePerMonth);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'location': return `${subjectProperty.address}, ${subjectProperty.cityState}`;
      case 'propertyType': return subjectProperty.propertyType;
      case 'bedBath': return subjectProperty.bedBath;
      case 'includedUtilities': return subjectProperty.includedUtilities;
      case 'rentalRate': return subjectProperty.currentRentPerMonth ? formatCurrency(subjectProperty.currentRentPerMonth) : 'TBD';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationQual': return subjectProperty.cityState;
      case 'bedBathQual': return subjectProperty.bedBath;
      case 'utilitiesQual': return subjectProperty.includedUtilities;
      case 'parkingQual': return subjectProperty.parking || '-';
      case 'yearBuiltQual': return subjectProperty.yearBuilt?.toString() || '-';
      case 'conditionQual': return subjectProperty.condition || '-';
      default: return '-';
    }
  };

  const cycleQualitativeValue = (currentValue: string): 'Similar' | 'Superior' | 'Inferior' => {
    const cycle: ('Similar' | 'Superior' | 'Inferior')[] = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue as any);
    return cycle[(currentIndex + 1) % cycle.length];
  };

  // Adjustment Chip Component
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof MultiFamilyComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(compId, rowId as keyof MultiFamilyComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`} title="Click to change">
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`} title="Click to change">
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`} title="Click to change">
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Chip Component
  const OverallChip = ({ comp }: { comp: MultiFamilyComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleQualitativeValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span onClick={handleClick} className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`} title="Click to change">
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span onClick={handleClick} className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`} title="Click to change">
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span onClick={handleClick} className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`} title="Click to change">
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button
  const AddElementButton = ({ section }: { section: 'transaction' | 'quantitative' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Preset percent options for quantitative adjustments
  const percentOptions = [
    { value: 20, label: '+20%' },
    { value: 17.5, label: '+17.5%' },
    { value: 15, label: '+15%' },
    { value: 12.5, label: '+12.5%' },
    { value: 10, label: '+10%' },
    { value: 7.5, label: '+7.5%' },
    { value: 5, label: '+5%' },
    { value: 2.5, label: '+2.5%' },
    { value: 0, label: '0%' },
    { value: -2.5, label: '-2.5%' },
    { value: -5, label: '-5%' },
    { value: -7.5, label: '-7.5%' },
    { value: -10, label: '-10%' },
    { value: -12.5, label: '-12.5%' },
    { value: -15, label: '-15%' },
    { value: -17.5, label: '-17.5%' },
    { value: -20, label: '-20%' },
  ];

  // Update a comp's adjustment value
  const updateCompAdjustment = (compId: string, field: string, value: number) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Quantitative adjustment cell with popover
  const renderQuantitativeCell = (comp: MultiFamilyComp, rowId: string) => {
    const value = comp[rowId as keyof MultiFamilyComp] as number || 0;
    const isOpen = activePopover?.rowId === rowId && activePopover?.compId === comp.id;
    
    const getStatusLabel = (val: number) => val > 0 ? 'INF' : val < 0 ? 'SUP' : 'SIM';

    // Adjustment badge component inline
    const isSup = value < 0;
    const isInf = value > 0;
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer`;

    return (
      <div className="flex items-center w-full relative">
        <span 
          onClick={() => {
            setActivePopover(isOpen ? null : { rowId, compId: comp.id });
            setCustomInputValue('');
          }}
          className={`${baseClass} ${
            isSup ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100' :
            isInf ? 'bg-red-50 text-red-700 border-red-200 hover:bg-red-100' :
            'bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600'
          }`}
        >
          {isSup && <ArrowUpRight className="w-3 h-3" />}
          {isInf && <ArrowDownRight className="w-3 h-3" />}
          {!isSup && !isInf && <Minus className="w-3 h-3" />}
          {isSup ? 'SUP' : isInf ? 'INF' : 'SIM'}
          {value !== 0 && <span className="ml-1 border-l border-current pl-1 opacity-70">{Math.abs(value).toFixed(1)}%</span>}
        </span>
        
        {isOpen && (
          <div className="adjustment-popover absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[200] overflow-hidden">
            {/* Mode Toggle Header */}
            <div className="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
              <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">
                Adjustment
              </span>
              <div className="flex gap-1">
                <button
                  type="button"
                  className={`px-2.5 py-1 text-xs font-bold rounded-md transition-all ${adjustmentMode === 'Percent'
                    ? 'bg-accent-cyan text-white shadow-sm'
                    : 'bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-300 border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600'
                  }`}
                  onClick={() => setAdjustmentMode('Percent')}
                >
                  %
                </button>
              </div>
            </div>

            {/* Scrollable Percent Options */}
            <div className="max-h-48 overflow-y-auto">
              {percentOptions.map((option) => (
                <button
                  type="button"
                  key={option.value}
                  className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700/50 flex items-center justify-between transition-colors ${
                    value === option.value ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'
                  }`}
                  onClick={() => {
                    updateCompAdjustment(comp.id, rowId, option.value);
                    setActivePopover(null);
                  }}
                >
                  <span className="font-medium">{option.label}</span>
                  <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${
                    option.value > 0 ? 'text-red-600 bg-red-50 dark:bg-red-900/30' :
                    option.value < 0 ? 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30' :
                    'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700'
                  }`}>
                    {getStatusLabel(option.value)}
                  </span>
                </button>
              ))}
            </div>
            
            {/* Custom Input */}
            <div className="border-t border-slate-100 dark:border-slate-700 px-3 py-2.5 bg-slate-50 dark:bg-slate-900">
              <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                Custom %
              </label>
              <div className="flex gap-2 mt-1.5">
                <input
                  type="text"
                  className="flex-1 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1.5 text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-cyan focus:border-transparent"
                  value={customInputValue}
                  placeholder="e.g. 12.5"
                  onChange={(e) => {
                    const val = e.target.value.replace(/[^0-9.-]/g, '');
                    setCustomInputValue(val);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const parsed = parseFloat(customInputValue);
                      if (!isNaN(parsed)) {
                        updateCompAdjustment(comp.id, rowId, parsed);
                        setActivePopover(null);
                      }
                    }
                  }}
                />
                <button
                  type="button"
                  className="px-3 py-1.5 bg-accent-cyan text-white text-xs font-bold rounded-md hover:bg-accent-cyan/90 transition-colors"
                  onClick={() => {
                    const parsed = parseFloat(customInputValue);
                    if (!isNaN(parsed)) {
                      updateCompAdjustment(comp.id, rowId, parsed);
                      setActivePopover(null);
                    }
                  }}
                >
                  Apply
                </button>
              </div>
              <p className="text-[10px] text-slate-400 mt-1">
                Positive = inferior, negative = superior
              </p>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate adjusted rate for a comp
  const getAdjustedRate = (comp: MultiFamilyComp): number => {
    const totalAdj = (comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj) / 100;
    return comp.rentalRatePerMonth * (1 + totalAdj);
  };

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* CALCULATION METHOD TOGGLE */}
      <div className="flex-shrink-0 px-4 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-sm font-semibold text-slate-700 dark:text-slate-200">Display Unit:</span>
            <div className="flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
              {[
                { value: 'per_unit' as MultiFamilyCalculationMethod, label: 'Per Unit', icon: Home },
                { value: 'per_room' as MultiFamilyCalculationMethod, label: 'Per Room', icon: Building2 },
                { value: 'per_sf' as MultiFamilyCalculationMethod, label: 'Per SF', icon: Grid3X3 },
              ].map(({ value, label, icon: Icon }) => (
                <button
                  key={value}
                  onClick={() => handleCalculationMethodChange(value)}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${
                    calculationMethod === value
                      ? 'bg-harken-blue text-white shadow-sm'
                      : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                  }`}
                >
                  <Icon className="w-3.5 h-3.5" />
                  {label}
                </button>
              ))}
            </div>
          </div>
          
          {/* Subject Unit/Room Count Display */}
          <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
              <span className="text-slate-500 dark:text-slate-400">{getCountFieldLabel()}:</span>
              <span className="font-bold text-harken-blue">{subjectProperty.unitCount || subjectData?.totalUnitCount || '—'}</span>
            </div>
            {subjectData?.unitMix && subjectData.unitMix.length > 0 && calculationMethod === 'per_unit' && (
              <div className="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span>Mix:</span>
                {subjectData.unitMix.filter(u => u.count > 0).map(u => (
                  <span key={u.unitType} className="bg-slate-100 dark:bg-slate-700 px-1.5 py-0.5 rounded">
                    {u.count}x {u.unitType === 'studio' ? 'Studio' : `${u.bedrooms}BR`}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${totalGridWidth}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`,
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img src={subjectProperty.imageUrl} alt="Subject Property" className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={subjectProperty.address}>
                {subjectProperty.address}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{subjectProperty.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img src={comp.imageUrl} alt={comp.address} className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" />
                <div className="absolute top-1.5 right-1.5 bg-slate-900 text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  {formatCurrency(comp.rentalRatePerMonth)}/mo
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-800/80 hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{comp.bedBath}</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              TRANSACTION DATA
            </div>
          </div>

          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'transaction')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Transaction */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="transaction" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUANTITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUANTITATIVE ADJUSTMENTS
            </div>
          </div>

          {quantitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'quantitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  {renderQuantitativeCell(comp, row.field || row.id)}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Quantitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'quantitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="quantitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-quant-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="text-xs font-medium text-slate-600 truncate">{row.label}</span>
                {row.removable && (
                  <button onClick={() => handleDeleteRow(row.id, 'qualitative')} className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all">
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              {comps.map(comp => (
                <div key={`${row.id}-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element - Qualitative */}
          <div className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`} style={{ width: LABEL_COL_WIDTH }}>
            <AddElementButton section="qualitative" />
          </div>
          <div className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-white dark:bg-slate-900" style={{ width: SUBJECT_COL_WIDTH }}></div>
          {comps.map(comp => <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>)}

          {/* ========== SUMMARY SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-300 dark:border-slate-600">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900" style={{ zIndex: 51 }}>
              SUMMARY
            </div>
          </div>

          {/* Overall Adjustment Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white italic">Overall Adjustment:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => {
              const totalAdj = comp.parkingAdj + comp.qualityConditionAdj + comp.yearBuiltAdj;
              return (
                <div key={`overall-adj-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                  <span className={`font-bold ${totalAdj !== 0 ? (totalAdj > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                    {formatPercent(totalAdj)}
                  </span>
                </div>
              );
            })}
          </React.Fragment>

          {/* Adjusted Rental Rates Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 flex items-center px-2 py-1.5 bg-white dark:bg-slate-900" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-semibold text-slate-800 dark:text-white">Adjusted Rental Rates $...</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] bg-sky-50 dark:bg-[#0f1f3a]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-medium text-slate-700 dark:text-slate-200">-</span>
            </div>
            {comps.map(comp => (
              <div key={`adj-rate-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800">
                <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedRate(comp))}</span>
              </div>
            ))}
          </React.Fragment>

          {/* Adjusted Comp Range Row */}
          <React.Fragment>
            <div className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 flex items-center px-2 py-1.5 bg-slate-100 dark:bg-slate-800" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="text-xs font-black text-slate-900 dark:text-white uppercase">Adjusted Comp Range:</span>
            </div>
            <div className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-blue-100 dark:bg-blue-900/30" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
              <span className="font-bold text-slate-800 dark:text-white">
                {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
              </span>
            </div>
            {comps.map(comp => (
              <div key={`range-${comp.id}`} className="border-r border-b border-slate-100 dark:border-slate-700 border-t-2 border-t-slate-800 dark:border-t-slate-600 p-2 flex items-center justify-center text-xs bg-slate-100 dark:bg-slate-800"></div>
            ))}
          </React.Fragment>

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center" style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          <div className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]" style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}>
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          {comps.map(comp => (
            <div key={`overall-${comp.id}`} className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center">
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start" style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}>
            <div className="flex flex-col items-center justify-center h-80 py-4">
              <button className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group" title="Add a new comp">
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* RENTAL INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center gap-3">
              <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
              <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Multi-Family Rental Indication</h2>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Unit Count</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{subjectProperty.unitCount || '-'} Units</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(averageAdjustedRate)}/mo
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Adjusted Comp Range</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {comps.length > 0 ? `${formatCurrency(Math.min(...comps.map(c => getAdjustedRate(c))))} - ${formatCurrency(Math.max(...comps.map(c => getAdjustedRate(c))))}` : '-'}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="multi_family"
                helperText="AI can draft a multi-family rental analysis based on your comparable data."
                minHeight={250}
                rows={8}
              />
            </div>
            
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

All issues have been fixed. Here's a summary of the changes:

## Summary of Fixes

### 1. **Removed Top Scroll Bar**
- Added `hideIndicator={true}` to `HorizontalScrollIndicator` in:
  - `LandSalesGrid.tsx`
  - `MultiFamilyGrid.tsx`
  - `RentComparableGrid.tsx`
  - `ExpenseComparableGrid.tsx`
- The scroll bar is now only visible at the bottom (consistent with SalesGrid)

### 2. **Fixed Multifamily Add Comps Area**
- Changed `bg-slate-50` to `bg-slate-50 dark:bg-slate-900` in the Action Column
- Updated hover states to include dark mode variants

### 3. **Fixed Multifamily Overall Comparability Background**
- Added dark mode styling to the footer/reconciliation section: `bg-slate-50 dark:bg-slate-900`
- Updated border colors with dark variants

### 4. **Fixed Subject Column Transparency**
All grids now use solid background colors in dark mode to prevent content showing through when scrolling:
- Changed `dark:bg-sky-900/20` → `dark:bg-[#0f1f3a]` (solid dark blue)
- Changed `dark:bg-sky-900/30` → `dark:bg-[#0f1f3a]`
- Applied to:
  - `MultiFamilyGrid.tsx`
  - `LandSalesGrid.tsx`
  - `RentComparableGrid.tsx`
  - `ExpenseComparableGrid.tsx`
  - `PropertyCard.tsx`

### 5. **Added Quantitative Adjustment Functionality to Multifamily**
Added a full adjustment popover to the `MultiFamilyGrid` with:
- Click-to-open adjustment badge (shows SUP/SIM/INF status)
- Scrollable preset percentage options (+20% to -20%)
- Custom input field for entering any percentage value
- Visual status labels (SUP green, INF red, SIM gray)
- Apply button for custom values
- Proper dark mode styling throughout

---

**User**

Within the land valuation, Underneath Transaction Adjustments, And then in the adjustment Element, field. Looking across at some of the comps, In the photo, There's One underneath sail three. that says, plus 2.5%. And then one under sale five that says minus 1.5%. But the... The other two that I have manually switched to inferior don't have an adjustment percentage underneath them. Why is that? Is that properly connected? and working the way it should.

---

**Cursor**

Let me investigate how the adjustment field is connected to the Market Condition chips in the Land Valuation grid.

You've identified a real issue. Looking at the code, **the Market Condition chip and the Adjustment percentage are not connected**.

Here's what's happening:

## The Problem

The `MarketCondChip` component only updates the `marketCond` field when you click it:

```typescript
const handleClick = () => {
  const nextValue = cycleAdjustmentValue(currentValue);
  handleUpdateComp(comp.id, 'marketCond', nextValue); // Only updates marketCond
};
```

It does **not** update the `adjustment` field. These are two separate fields in the `LandComp` data structure:
- `marketCond`: 'Similar' | 'Superior' | 'Inferior' (qualitative)
- `adjustment`: number (percentage value)

## Why Some Show Percentages

Sales 3 (+2.5%) and Sale 5 (-1.5%) show percentages because they have pre-populated values in the mock data. When you manually click the Market Cond chips for other comps, only the chip visual changes—the adjustment percentage stays at 0 (displayed as "-").

## The Fix Needed

The `MarketCondChip` should also update the `adjustment` field when changing status. Here's the corrected version:

```typescript
const MarketCondChip = ({ comp }: { comp: LandComp }) => {
  const currentValue = comp.marketCond;
  
  const handleClick = () => {
    const nextValue = cycleAdjustmentValue(currentValue);
    handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    
    // Auto-populate adjustment based on market condition
    // Superior means comp is better, so we apply a NEGATIVE adjustment (reduces subject value indication)
    // Inferior means comp is worse, so we apply a POSITIVE adjustment (increases subject value indication)
    if (nextValue === 'Superior') {
      handleUpdateComp(comp.id, 'adjustment', -2.5); // Default SUP adjustment
    } else if (nextValue === 'Inferior') {
      handleUpdateComp(comp.id, 'adjustment', 2.5);  // Default INF adjustment
    } else {
      handleUpdateComp(comp.id, 'adjustment', 0);    // Similar = no adjustment
    }
  };
  // ... rest of component
};
```

Alternatively, the Adjustment row itself should have a clickable popover (like the quantitative adjustments in SalesGrid) so users can manually enter a specific percentage.

---

**You're in Ask mode** - if you'd like me to implement this fix, please switch to **Agent mode** and I'll update the `LandSalesGrid.tsx` to properly connect these fields.

```typescript
const handleClick = () => {
  const nextValue = cycleAdjustmentValue(currentValue);
  handleUpdateComp(comp.id, 'marketCond', nextValue); // Only updates marketCond
};
```

```typescript
const MarketCondChip = ({ comp }: { comp: LandComp }) => {
  const currentValue = comp.marketCond;
  
  const handleClick = () => {
    const nextValue = cycleAdjustmentValue(currentValue);
    handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    
    // Auto-populate adjustment based on market condition
    // Superior means comp is better, so we apply a NEGATIVE adjustment (reduces subject value indication)
    // Inferior means comp is worse, so we apply a POSITIVE adjustment (increases subject value indication)
    if (nextValue === 'Superior') {
      handleUpdateComp(comp.id, 'adjustment', -2.5); // Default SUP adjustment
    } else if (nextValue === 'Inferior') {
      handleUpdateComp(comp.id, 'adjustment', 2.5);  // Default INF adjustment
    } else {
      handleUpdateComp(comp.id, 'adjustment', 0);    // Similar = no adjustment
    }
  };
  // ... rest of component
};
```

---

**User**

this should work the same as the sales comparison grid so make the changes you think need to be made.
Also check the other grids to make sure they are working correctly.

do an audit of our grids and make sure they follow how our sales comparison grid works as I think that is our standard since all of these should be the same, am I right to think that?

ultrathink

---

**Cursor**

# ULTRATHINK Analysis: Grid Consistency Audit

I'll conduct a comprehensive audit of all grids against the SalesGrid standard, identifying discrepancies and fixing them.

## Phase 1: Understanding the SalesGrid Standard

Let me read more of the SalesGrid to understand the complete pattern:

Let me read the constants and types to understand the row structure:

Now let me look at how SalesGrid renders the different row types:

Now let me read the other grids to audit them:

Now let me read the remaining grids:

Now I have a complete picture. Let me create the audit and implement fixes:

## ULTRATHINK: Grid Consistency Audit & Fix Report

### Audit Summary

**THE STANDARD: SalesGrid**
The SalesGrid implements these key patterns:

1. **Quantitative Adjustments** → `renderQuantitativeCell()` with popover (% preset options, custom input, SUP/INF/SIM labels)
2. **Qualitative Adjustments** → `QualitativeChip` click-to-cycle (Similar → Superior → Inferior)
3. **Overall Comparability** → Click-to-cycle chip (not dropdown)

### Discrepancies Found:

| Grid | Issue | Status |
|------|-------|--------|
| **LandSalesGrid** | `adjustment` row is display-only, not interactive. Needs popover like SalesGrid | ❌ NEEDS FIX |
| **MultiFamilyGrid** | Has quantitative popovers ✅ | ✅ OK |
| **RentComparableGrid** | Overall Comparability uses dropdown instead of click-to-cycle chip | ❌ NEEDS FIX |
| **ExpenseComparableGrid** | Different purpose (expense analysis), works correctly | ✅ OK |

---

Let me fix these issues:

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';

// Preset percent options for quantitative adjustments (matching SalesGrid)
const percentOptions = [
  { value: 20, label: '+20%' },
  { value: 17.5, label: '+17.5%' },
  { value: 15, label: '+15%' },
  { value: 12.5, label: '+12.5%' },
  { value: 10, label: '+10%' },
  { value: 7.5, label: '+7.5%' },
  { value: 5, label: '+5%' },
  { value: 2.5, label: '+2.5%' },
  { value: 0, label: '0%' },
  { value: -2.5, label: '-2.5%' },
  { value: -5, label: '-5%' },
  { value: -7.5, label: '-7.5%' },
  { value: -10, label: '-10%' },
  { value: -12.5, label: '-12.5%' },
  { value: -15, label: '-15%' },
  { value: -17.5, label: '-17.5%' },
  { value: -20, label: '-20%' },
];
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';

// Preset percent options for quantitative adjustments (matching SalesGrid)
const percentOptions = [
  { value: 20, label: '+20%' },
  { value: 17.5, label: '+17.5%' },
  { value: 15, label: '+15%' },
  { value: 12.5, label: '+12.5%' },
  { value: 10, label: '+10%' },
  { value: 7.5, label: '+7.5%' },
  { value: 5, label: '+5%' },
  { value: 2.5, label: '+2.5%' },
  { value: 0, label: '0%' },
  { value: -2.5, label: '-2.5%' },
  { value: -5, label: '-5%' },
  { value: -7.5, label: '-7.5%' },
  { value: -10, label: '-10%' },
  { value: -12.5, label: '-12.5%' },
  { value: -15, label: '-15%' },
  { value: -17.5, label: '-17.5%' },
  { value: -20, label: '-20%' },
];
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  const [customInputValue, setCustomInputValue] = useState<string>('');
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';

// Preset percent options for quantitative adjustments (matching SalesGrid)
const percentOptions = [
  { value: 20, label: '+20%' },
  { value: 17.5, label: '+17.5%' },
  { value: 15, label: '+15%' },
  { value: 12.5, label: '+12.5%' },
  { value: 10, label: '+10%' },
  { value: 7.5, label: '+7.5%' },
  { value: 5, label: '+5%' },
  { value: 2.5, label: '+2.5%' },
  { value: 0, label: '0%' },
  { value: -2.5, label: '-2.5%' },
  { value: -5, label: '-5%' },
  { value: -7.5, label: '-7.5%' },
  { value: -10, label: '-10%' },
  { value: -12.5, label: '-12.5%' },
  { value: -15, label: '-15%' },
  { value: -17.5, label: '-17.5%' },
  { value: -20, label: '-20%' },
];
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  const [customInputValue, setCustomInputValue] = useState<string>('');
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Quantitative Adjustment Cell with popover - matching SalesGrid pattern
  const QuantitativeAdjustmentCell = ({ comp }: { comp: LandComp }) => {
    const value = comp.adjustment || 0;
    const isOpen = activePopover?.rowId === 'adjustment' && activePopover?.compId === comp.id;
    
    const getStatusLabel = (val: number) => val > 0 ? 'INF' : val < 0 ? 'SUP' : 'SIM';

    // Determine badge styling based on value
    const isSup = value < 0; // Negative = superior
    const isInf = value > 0; // Positive = inferior
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer`;

    return (
      <div className="flex items-center w-full relative adjustment-popover">
        <span 
          onClick={() => {
            setActivePopover(isOpen ? null : { rowId: 'adjustment', compId: comp.id });
            setCustomInputValue('');
          }}
          className={`${baseClass} ${
            isSup ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100' :
            isInf ? 'bg-red-50 text-red-700 border-red-200 hover:bg-red-100' :
            'bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600'
          }`}
        >
          {isSup && <ArrowUpRight className="w-3 h-3" />}
          {isInf && <ArrowDownRight className="w-3 h-3" />}
          {!isSup && !isInf && <Minus className="w-3 h-3" />}
          {isSup ? 'SUP' : isInf ? 'INF' : 'SIM'}
          {value !== 0 && <span className="ml-1 border-l border-current pl-1 opacity-70">{Math.abs(value).toFixed(1)}%</span>}
        </span>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[200] overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
              <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">
                Adjustment
              </span>
            </div>

            {/* Scrollable Percent Options */}
            <div className="max-h-48 overflow-y-auto">
              {percentOptions.map((option) => (
                <button
                  type="button"
                  key={option.value}
                  className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700/50 flex items-center justify-between transition-colors ${
                    value === option.value ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'
                  }`}
                  onClick={() => {
                    handleUpdateComp(comp.id, 'adjustment', option.value);
                    setActivePopover(null);
                  }}
                >
                  <span className="font-medium">{option.label}</span>
                  <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${
                    option.value > 0 ? 'text-red-600 bg-red-50 dark:bg-red-900/30' :
                    option.value < 0 ? 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30' :
                    'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700'
                  }`}>
                    {getStatusLabel(option.value)}
                  </span>
                </button>
              ))}
            </div>
            
            {/* Custom Input */}
            <div className="border-t border-slate-100 dark:border-slate-700 px-3 py-2.5 bg-slate-50 dark:bg-slate-900">
              <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                Custom %
              </label>
              <div className="flex gap-2 mt-1.5">
                <input
                  type="text"
                  className="flex-1 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1.5 text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-cyan focus:border-transparent"
                  value={customInputValue}
                  placeholder="e.g. 12.5"
                  onChange={(e) => {
                    const val = e.target.value.replace(/[^0-9.-]/g, '');
                    setCustomInputValue(val);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const parsed = parseFloat(customInputValue);
                      if (!isNaN(parsed)) {
                        handleUpdateComp(comp.id, 'adjustment', parsed);
                        setActivePopover(null);
                      }
                    }
                  }}
                />
                <button
                  type="button"
                  className="px-3 py-1.5 bg-accent-cyan text-white text-xs font-bold rounded-md hover:bg-accent-cyan/90 transition-colors"
                  onClick={() => {
                    const parsed = parseFloat(customInputValue);
                    if (!isNaN(parsed)) {
                      handleUpdateComp(comp.id, 'adjustment', parsed);
                      setActivePopover(null);
                    }
                  }}
                >
                  Apply
                </button>
              </div>
              <p className="text-[10px] text-slate-400 mt-1">
                Positive = inferior, negative = superior
              </p>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <span className={`font-medium ${comp.adjustment !== 0 ? (comp.adjustment > 0 ? 'text-red-600' : 'text-emerald-600') : 'text-slate-500'}`}>
                      {comp.adjustment !== 0 ? `${comp.adjustment > 0 ? '+' : ''}${comp.adjustment.toFixed(1)}%` : '-'}
                    </span>
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

Now let me update the rendering of the adjustment row to use the new component:

```typescriptreact
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, ChevronUp, Map as MapIcon } from 'lucide-react';

// Preset percent options for quantitative adjustments (matching SalesGrid)
const percentOptions = [
  { value: 20, label: '+20%' },
  { value: 17.5, label: '+17.5%' },
  { value: 15, label: '+15%' },
  { value: 12.5, label: '+12.5%' },
  { value: 10, label: '+10%' },
  { value: 7.5, label: '+7.5%' },
  { value: 5, label: '+5%' },
  { value: 2.5, label: '+2.5%' },
  { value: 0, label: '0%' },
  { value: -2.5, label: '-2.5%' },
  { value: -5, label: '-5%' },
  { value: -7.5, label: '-7.5%' },
  { value: -10, label: '-10%' },
  { value: -12.5, label: '-12.5%' },
  { value: -15, label: '-15%' },
  { value: -17.5, label: '-17.5%' },
  { value: -20, label: '-20%' },
];
import { LandComp } from '../types';
import { 
  MOCK_LAND_COMPS, 
  SUBJECT_PROPERTY, 
  TRANSACTION_DATA_ROWS,
  TRANSACTION_ADJ_ROWS,
  QUALITATIVE_ROWS,
  AvailableElement,
  formatCurrency, 
  formatNumber 
} from '../constants';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import type { LandValuationData } from '../../../types';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;
const ACTION_COL_WIDTH = 160;

export const LandSalesGrid: React.FC = () => {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const { state: wizardState, setLandValuationData } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId, landValuationData } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  const [comps, setComps] = useState<LandComp[]>(MOCK_LAND_COMPS);
  const [transactionRows, setTransactionRows] = useState(TRANSACTION_DATA_ROWS);
  const [adjustmentRows, setAdjustmentRows] = useState(TRANSACTION_ADJ_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(QUALITATIVE_ROWS);
  const [activePopover, setActivePopover] = useState<{rowId: string, compId: string} | null>(null);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'adjustments' | 'qualitative' | null>(null);
  const [customInputValue, setCustomInputValue] = useState<string>('');
  
  // Notes section - load from context if available
  const [notesText, setNotesText] = useState(landValuationData?.reconciliationText ?? '');
  
  // Custom elements saved by user for future use
  const [customTransactionElements, setCustomTransactionElements] = useState<AvailableElement[]>([]);
  const [customAdjustmentElements, setCustomAdjustmentElements] = useState<AvailableElement[]>([]);
  const [customQualitativeElements, setCustomQualitativeElements] = useState<AvailableElement[]>([]);

  // Calculate total grid width (including action column) - prefixed with underscore as reserved for future use
  const _totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH;
  void _totalGridWidth; // Reserved for future use

  // Calculate concluded land values
  const getAdjustedPricePerAcreCalc = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const concludedPricePerAcre = useMemo(() => {
    if (comps.length === 0) return null;
    return comps.reduce((acc, c) => acc + getAdjustedPricePerAcreCalc(c), 0) / comps.length;
  }, [comps]);

  const concludedLandValue = useMemo(() => {
    if (concludedPricePerAcre === null) return null;
    return Math.round(concludedPricePerAcre * SUBJECT_PROPERTY.landAcres);
  }, [concludedPricePerAcre]);

  // Persist land valuation data to WizardContext
  useEffect(() => {
    const dataToSave: LandValuationData = {
      landComps: comps.map(c => ({
        id: c.id,
        address: c.address,
        saleDate: c.dateSold,
        salePrice: c.salePrice,
        acreage: c.landAcres,
        pricePerAcre: c.pricePerAcre,
        zoning: c.zoning,
        adjustments: { overall: c.adjustment || 0 },
        adjustedPricePerAcre: getAdjustedPricePerAcreCalc(c),
      })),
      subjectAcreage: SUBJECT_PROPERTY.landAcres,
      concludedPricePerAcre,
      concludedLandValue,
      reconciliationText: notesText,
    };
    setLandValuationData(dataToSave);
  }, [comps, notesText, concludedPricePerAcre, concludedLandValue, setLandValuationData]);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (activePopover && !target.closest('.adjustment-popover')) {
        setActivePopover(null);
      }
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [activePopover, openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this land sale?')) {
      setComps(prev => prev.filter(c => c.id !== compId));
    }
  };

  const handleUpdateComp = (compId: string, field: keyof LandComp, value: any) => {
    setComps(prev => prev.map(c => 
      c.id === compId ? { ...c, [field]: value } : c
    ));
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'adjustments' | 'qualitative', element: AvailableElement) => {
    const newRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      // Check if already exists
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else if (section === 'adjustments') {
      if (adjustmentRows.some(r => r.id === element.id)) return;
      setAdjustmentRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name and save for future use
  const handleAddCustomElement = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    // Create the custom element to save for future use
    const customElement: AvailableElement = {
      id: newId,
      label: name,
      description: 'Custom element'
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
      // Save to custom elements if not already there
      setCustomTransactionElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => [...prev, newRow]);
      setCustomAdjustmentElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
      setCustomQualitativeElements(prev => 
        prev.some(e => e.id === newId) ? prev : [...prev, customElement]
      );
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added, including custom)
  // Uses dynamic filtering based on property type, subtype, approach, section, and scenario
  const getAvailableElements = (section: 'transaction' | 'adjustments' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : section === 'adjustments'
        ? adjustmentRows.map(r => r.id)
        : qualitativeRows.map(r => r.id);
    
    // Map section names to registry format
    const sectionMap: Record<string, SectionType> = {
      'transaction': 'transaction',
      'adjustments': 'quantitative',  // Land uses quantitative adjustments
      'qualitative': 'qualitative'
    };
    const normalizedSection = sectionMap[section] || normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType || 'land',  // Default to land for this grid
      subtype: propertySubtype,
      approach: 'land_valuation',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid (id instead of key)
    const baseElements: AvailableElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    // Add custom elements for this section
    const customElements = section === 'transaction'
      ? customTransactionElements
      : section === 'adjustments'
        ? customAdjustmentElements
        : customQualitativeElements;
    
    // Combine and filter out already added
    const allElements = [...baseElements, ...customElements];
    return allElements.filter(el => !existingIds.includes(el.id));
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'adjustments' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else if (section === 'adjustments') {
      setAdjustmentRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getAdjustedPricePerAcre = (comp: LandComp) => {
    const adjustment = comp.adjustment || 0;
    return comp.pricePerAcre * (1 + adjustment / 100);
  };

  const getTransactionValue = (comp: LandComp, rowId: string) => {
    switch (rowId) {
      case 'dateSold': return comp.dateSold;
      case 'location': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'irrigation': return comp.irrigation;
      case 'utilities': return comp.utilities;
      case 'topography': return comp.topography;
      case 'zoning': return comp.zoning;
      case 'salePrice': return formatCurrency(comp.salePrice);
      case 'sizeAcres': return formatNumber(comp.landAcres, 2);
      case 'priceAcre': return formatCurrency(comp.pricePerAcre);
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'dateSold': return 'Current';
      case 'location': return SUBJECT_PROPERTY.address;
      case 'cityState': return SUBJECT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_PROPERTY.hbuUse;
      case 'irrigation': return SUBJECT_PROPERTY.irrigation;
      case 'utilities': return SUBJECT_PROPERTY.utilities;
      case 'topography': return SUBJECT_PROPERTY.topography;
      case 'zoning': return SUBJECT_PROPERTY.zoning;
      case 'salePrice': return 'N/A';
      case 'sizeAcres': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'priceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectAdjustmentValue = (rowId: string) => {
    switch (rowId) {
      case 'propRights': return SUBJECT_PROPERTY.propRights;
      case 'financing': return SUBJECT_PROPERTY.financing;
      case 'condSale': return SUBJECT_PROPERTY.condSale;
      case 'marketCond': return 'Current';
      case 'adjustment': return '-';
      case 'adjPriceAcre': return 'N/A';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_PROPERTY.locationQuality;
      case 'irrigationAdj': return SUBJECT_PROPERTY.irrigation;
      case 'utilitiesAdj': return SUBJECT_PROPERTY.utilities;
      case 'topographyAdj': return SUBJECT_PROPERTY.topography;
      case 'sizeAdj': return formatNumber(SUBJECT_PROPERTY.landAcres, 3);
      case 'zoningAdj': return SUBJECT_PROPERTY.zoning;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof LandComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof LandComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Market Conditions Chip - click to cycle (same as qualitative adjustments)
  const MarketCondChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.marketCond;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'marketCond', nextValue as 'Similar' | 'Superior' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (styled for blue background)
  const OverallChip = ({ comp }: { comp: LandComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as 'Superior' | 'Similar' | 'Inferior');
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Quantitative Adjustment Cell with popover - matching SalesGrid pattern
  const QuantitativeAdjustmentCell = ({ comp }: { comp: LandComp }) => {
    const value = comp.adjustment || 0;
    const isOpen = activePopover?.rowId === 'adjustment' && activePopover?.compId === comp.id;
    
    const getStatusLabel = (val: number) => val > 0 ? 'INF' : val < 0 ? 'SUP' : 'SIM';

    // Determine badge styling based on value
    const isSup = value < 0; // Negative = superior
    const isInf = value > 0; // Positive = inferior
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer`;

    return (
      <div className="flex items-center w-full relative adjustment-popover">
        <span 
          onClick={() => {
            setActivePopover(isOpen ? null : { rowId: 'adjustment', compId: comp.id });
            setCustomInputValue('');
          }}
          className={`${baseClass} ${
            isSup ? 'bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100' :
            isInf ? 'bg-red-50 text-red-700 border-red-200 hover:bg-red-100' :
            'bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600'
          }`}
        >
          {isSup && <ArrowUpRight className="w-3 h-3" />}
          {isInf && <ArrowDownRight className="w-3 h-3" />}
          {!isSup && !isInf && <Minus className="w-3 h-3" />}
          {isSup ? 'SUP' : isInf ? 'INF' : 'SIM'}
          {value !== 0 && <span className="ml-1 border-l border-current pl-1 opacity-70">{Math.abs(value).toFixed(1)}%</span>}
        </span>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[200] overflow-hidden">
            {/* Header */}
            <div className="flex items-center justify-between px-3 py-2 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
              <span className="text-[10px] font-bold uppercase tracking-widest text-slate-500 dark:text-slate-400">
                Adjustment
              </span>
            </div>

            {/* Scrollable Percent Options */}
            <div className="max-h-48 overflow-y-auto">
              {percentOptions.map((option) => (
                <button
                  type="button"
                  key={option.value}
                  className={`w-full px-3 py-2 text-left text-sm hover:bg-slate-50 dark:hover:bg-slate-700/50 flex items-center justify-between transition-colors ${
                    value === option.value ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-700 dark:text-slate-200'
                  }`}
                  onClick={() => {
                    handleUpdateComp(comp.id, 'adjustment', option.value);
                    setActivePopover(null);
                  }}
                >
                  <span className="font-medium">{option.label}</span>
                  <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${
                    option.value > 0 ? 'text-red-600 bg-red-50 dark:bg-red-900/30' :
                    option.value < 0 ? 'text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30' :
                    'text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700'
                  }`}>
                    {getStatusLabel(option.value)}
                  </span>
                </button>
              ))}
            </div>
            
            {/* Custom Input */}
            <div className="border-t border-slate-100 dark:border-slate-700 px-3 py-2.5 bg-slate-50 dark:bg-slate-900">
              <label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">
                Custom %
              </label>
              <div className="flex gap-2 mt-1.5">
                <input
                  type="text"
                  className="flex-1 border border-slate-200 dark:border-slate-600 rounded-md px-2 py-1.5 text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-accent-cyan focus:border-transparent"
                  value={customInputValue}
                  placeholder="e.g. 12.5"
                  onChange={(e) => {
                    const val = e.target.value.replace(/[^0-9.-]/g, '');
                    setCustomInputValue(val);
                  }}
                  onKeyDown={(e) => {
                    if (e.key === 'Enter') {
                      const parsed = parseFloat(customInputValue);
                      if (!isNaN(parsed)) {
                        handleUpdateComp(comp.id, 'adjustment', parsed);
                        setActivePopover(null);
                      }
                    }
                  }}
                />
                <button
                  type="button"
                  className="px-3 py-1.5 bg-accent-cyan text-white text-xs font-bold rounded-md hover:bg-accent-cyan/90 transition-colors"
                  onClick={() => {
                    const parsed = parseFloat(customInputValue);
                    if (!isNaN(parsed)) {
                      handleUpdateComp(comp.id, 'adjustment', parsed);
                      setActivePopover(null);
                    }
                  }}
                >
                  Apply
                </button>
              </div>
              <p className="text-[10px] text-slate-400 mt-1">
                Positive = inferior, negative = superior
              </p>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Add Element Button with Dropdown - now positioned in the Elements column
  const AddElementButton = ({ section }: { section: 'transaction' | 'adjustments' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg flex items-center justify-between gap-2 text-slate-500 dark:text-slate-400 font-semibold hover:border-accent-cyan hover:text-accent-cyan hover:bg-accent-cyan/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-accent-cyan" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-accent-cyan transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
              <span className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors border-b border-slate-100 dark:border-slate-700 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 dark:text-slate-300 group-hover:text-accent-cyan">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 dark:text-slate-500 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 dark:text-slate-500 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200 dark:border-slate-700">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-accent-cyan/5 dark:hover:bg-accent-cyan/10 transition-colors flex items-center gap-2 text-accent-cyan font-medium"
              >
                <PenLine size={12} />
                Add Custom
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_PROPERTY.lat !== undefined && SUBJECT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* LAND SALES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-orange-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Land Sales Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_PROPERTY.lat!,
                  lng: SUBJECT_PROPERTY.lng!,
                  address: `${SUBJECT_PROPERTY.address}, ${SUBJECT_PROPERTY.cityState}`,
                  propertyName: SUBJECT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatCurrency(comp.salePrice),
                }))}
                type="land-sales"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA - with isolation for proper stacking context */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} rightOffset={ACTION_COL_WIDTH} hideIndicator={true} />
        
        {/* Flex container for grid + action column */}
        <div 
          className="flex"
          style={{ minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH) + ACTION_COL_WIDTH}px` }}
        >
          {/* GRID CONTAINER */}
          <div 
            className="grid relative bg-white dark:bg-slate-900 flex-shrink-0" 
            style={{ 
              gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
              minWidth: `${LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH)}px`
            }}
          >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo - SOLID background to prevent content showing through */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-accent-cyan shadow-[4px_0_16px_rgba(0,0,0,0.08)] dark:shadow-none flex flex-col bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH, height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
          >
            {/* Subject Photo - same height as comp photos */}
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-accent-cyan text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            {/* Subject Info - solid light blue background */}
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_PROPERTY.address}>
                {SUBJECT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 flex flex-col bg-white dark:bg-slate-900"
              style={{ height: 120, transform: 'translateZ(0)', willChange: 'transform' }}
            >
              {/* Comp Photo */}
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm">
                  Sold {comp.dateSold}
                </div>
                {/* Delete button overlay */}
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 hover:bg-red-100 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this sale"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              {/* Comp Info */}
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Sale {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-accent-cyan" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{(Math.random() * 10 + 1).toFixed(1)} mi away</span>
                </div>
              </div>
            </div>
          ))}


          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full bg-slate-100 dark:bg-slate-800" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-slate-700 dark:text-slate-300 flex items-center gap-2 bg-slate-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'transaction')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== TRANSACTION ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-blue-200 dark:border-blue-800">
            <div className="absolute left-0 right-0 h-full bg-blue-50 dark:bg-blue-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-blue-700 dark:text-blue-300 flex items-center gap-2 bg-blue-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              TRANSACTION ADJUSTMENTS
            </div>
          </div>

          {/* Transaction Adjustment Rows */}
          {adjustmentRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-slate-50 dark:bg-slate-800' : 'bg-white dark:bg-slate-900'
                }`}
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className={`text-xs truncate ${
                  row.id === 'adjPriceAcre' ? 'font-black text-slate-900 uppercase' : 'font-medium text-slate-600'
                }`}>{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'adjustments')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className={`sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none ${
                  row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 dark:border-t-slate-600 bg-blue-100 dark:bg-blue-900/30' : 'bg-sky-50 dark:bg-[#0f1f3a]'
                }`}
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectAdjustmentValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className={`border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800 ${
                    row.id === 'adjPriceAcre' ? 'border-t-2 border-t-slate-800 bg-slate-50' : ''
                  }`}
                >
                  {row.id === 'marketCond' ? (
                    <MarketCondChip comp={comp} />
                  ) : row.id === 'adjustment' ? (
                    <QuantitativeAdjustmentCell comp={comp} />
                  ) : row.id === 'adjPriceAcre' ? (
                    <span className="font-bold text-emerald-700">{formatCurrency(getAdjustedPricePerAcre(comp))}</span>
                  ) : row.id === 'propRights' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.propRights}</span>
                  ) : row.id === 'financing' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.financing}</span>
                  ) : row.id === 'condSale' ? (
                    <span className="font-medium text-slate-600 dark:text-slate-300">{comp.condSale}</span>
                  ) : (
                    <span className="font-medium text-slate-600 dark:text-slate-300">-</span>
                  )}
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Adjustments Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'adjustments' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="adjustments" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-adj-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full bg-emerald-50 dark:bg-emerald-900/20" style={{ opacity: 0.3 }}></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest text-emerald-700 dark:text-emerald-300 flex items-center gap-2 bg-emerald-50 dark:bg-slate-900"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              {/* Label Column - Never scrolls horizontally */}
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              {/* Subject Column - Never scrolls horizontally */}
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-sky-50 dark:bg-[#0f1f3a]"
                style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {/* Comp Columns */}
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section - in Elements column */}
          <div 
            className={`sticky left-0 p-2 bg-white dark:bg-slate-900 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none bg-white dark:bg-slate-900"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          {/* Label Column - Never scrolls horizontally */}
          <div 
            className="sticky left-0 z-[60] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          {/* Subject Column - Never scrolls horizontally */}
          <div 
            className="sticky left-[160px] z-[55] bg-accent-cyan border-b border-accent-cyan p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {/* Comp Columns */}
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-accent-cyan border-b border-accent-cyan p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

          </div>

          {/* ACTION COLUMN */}
          <div 
            className="flex-shrink-0 bg-slate-50 dark:bg-slate-900 flex flex-col items-center justify-start py-8 sticky top-0 self-start"
            style={{ width: ACTION_COL_WIDTH, height: 'auto', minHeight: 400 }}
          >
            <div className="flex flex-col items-center justify-center h-80 py-4">
              {/* Add Comps */}
              <button 
                className="flex flex-col items-center gap-2 p-4 rounded-xl hover:bg-white dark:hover:bg-slate-800 transition-colors group"
                title="Add a new comp manually"
              >
                <div className="w-12 h-12 rounded-full bg-accent-cyan/20 dark:bg-accent-cyan/10 flex items-center justify-center group-hover:bg-accent-cyan/30 dark:group-hover:bg-accent-cyan/20 transition-colors">
                  <Plus className="w-6 h-6 text-accent-cyan" />
                </div>
                <span className="text-xs font-semibold text-accent-cyan">Add Comps</span>
              </button>
            </div>
          </div>
        </div>

        {/* VALUE INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 dark:bg-slate-900 border-t-2 border-slate-300 dark:border-slate-700 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-accent-cyan rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Land Value Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Subject Land Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_PROPERTY.landAcres, 3)} Acres</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Average Adjusted $/Acre</div>
                  <div className="text-2xl font-bold text-accent-cyan">
                    {formatCurrency(comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length)}
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 dark:text-slate-400 font-medium mb-2">Indicated Land Value</div>
                  <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">
                    {formatCurrency((comps.reduce((acc, c) => acc + getAdjustedPricePerAcre(c), 0) / comps.length) * SUBJECT_PROPERTY.landAcres)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={setNotesText}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="land_valuation"
                helperText="AI can draft a land valuation narrative based on your comparable analysis."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

```

Now let me fix the RentComparableGrid to use click-to-cycle chips for Overall Comparability instead of a dropdown:

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (matching SalesGrid pattern)
  const OverallChip = ({ comp }: { comp: RentComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as any);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallDropdown comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

```typescriptreact
import React, { useState, useEffect, useRef, useCallback } from 'react';
import { HorizontalScrollIndicator } from '../../../components/HorizontalScrollIndicator';
import EnhancedTextArea from '../../../components/EnhancedTextArea';
import { Plus, Trash2, ArrowUpRight, ArrowDownRight, Minus, MapPin, Activity, ChevronDown, PenLine, Calendar, ChevronUp, Map as MapIcon } from 'lucide-react';
import { RentComp, RentGridRow } from '../rentTypes';
import { 
  MOCK_RENT_COMPS, 
  SUBJECT_RENT_PROPERTY, 
  RENT_TRANSACTION_ROWS,
  RENT_QUALITATIVE_ROWS,
  AvailableRentElement,
  formatCurrency, 
  formatNumber,
  formatRentPerSf
} from '../rentConstants';
import { useWizard } from '../../../context/WizardContext';
import { getAvailableElements as filterElements, normalizeSection } from '../../../utils/elementFilter';
import type { SectionType } from '../../../constants/elementRegistry';
import { ComparableMapPreview } from '../../../components/ComparableMapPreview';

// Grid column widths (matching LandSalesGrid)
const LABEL_COL_WIDTH = 160;
const SUBJECT_COL_WIDTH = 180;
const COMP_COL_WIDTH = 170;

// Props interface for controlled component
interface RentComparableGridProps {
  /** Initial rent comparables - if empty, will show empty state */
  rentComparables?: RentComp[];
  /** Notes text for the rent analysis */
  notes?: string;
  /** Callback when comparables change */
  onCompsChange?: (comps: RentComp[]) => void;
  /** Callback when notes change */
  onNotesChange?: (notes: string) => void;
}

export const RentComparableGrid: React.FC<RentComparableGridProps> = ({
  rentComparables,
  notes: initialNotes = '',
  onCompsChange,
  onNotesChange,
}) => {
  const { state: wizardState } = useWizard();
  const { propertyType, propertySubtype, scenarios, activeScenarioId } = wizardState;
  const currentScenario = scenarios.find(s => s.id === activeScenarioId)?.name;
  
  // Initialize from props, fallback to mock data if no data provided (for demo purposes)
  const [comps, setComps] = useState<RentComp[]>(
    rentComparables && rentComparables.length > 0 ? rentComparables : MOCK_RENT_COMPS
  );
  const [transactionRows, setTransactionRows] = useState(RENT_TRANSACTION_ROWS);
  const [qualitativeRows, setQualitativeRows] = useState(RENT_QUALITATIVE_ROWS);
  const [openElementDropdown, setOpenElementDropdown] = useState<'transaction' | 'qualitative' | null>(null);
  const [notesText, setNotesText] = useState(initialNotes);
  const _dropdownRef = useRef<HTMLDivElement>(null);
  void _dropdownRef; // Reserved for future click-outside handling
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  
  // Sync with parent when comps change
  const notifyCompsChange = useCallback((newComps: RentComp[]) => {
    if (onCompsChange) {
      onCompsChange(newComps);
    }
  }, [onCompsChange]);
  
  // Sync with parent when notes change
  const handleNotesChange = useCallback((newNotes: string) => {
    setNotesText(newNotes);
    if (onNotesChange) {
      onNotesChange(newNotes);
    }
  }, [onNotesChange]);

  // Calculate total grid width
  const totalGridWidth = LABEL_COL_WIDTH + SUBJECT_COL_WIDTH + (comps.length * COMP_COL_WIDTH);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;
      if (openElementDropdown && !target.closest('.element-dropdown')) {
        setOpenElementDropdown(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [openElementDropdown]);

  const handleDeleteComp = (compId: string) => {
    if (window.confirm('Are you sure you want to remove this rental comparable?')) {
      setComps(prev => {
        const newComps = prev.filter(c => c.id !== compId);
        notifyCompsChange(newComps);
        return newComps;
      });
    }
  };

  const handleUpdateComp = (compId: string, field: keyof RentComp, value: any) => {
    setComps(prev => {
      const newComps = prev.map(c => 
        c.id === compId ? { ...c, [field]: value } : c
      );
      notifyCompsChange(newComps);
      return newComps;
    });
  };

  // Add an element from the available elements dropdown
  const handleAddElement = (section: 'transaction' | 'qualitative', element: AvailableRentElement) => {
    const newRow: RentGridRow = { 
      id: element.id, 
      label: element.label + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      if (transactionRows.some(r => r.id === element.id)) return;
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      if (qualitativeRows.some(r => r.id === element.id)) return;
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Add a custom element with user-typed name
  const handleAddCustomElement = (section: 'transaction' | 'qualitative') => {
    const name = prompt('Enter element name:');
    if (!name) return;
    const newId = name.toLowerCase().replace(/\s+/g, '_') + '_custom';
    const newRow: RentGridRow = { 
      id: newId, 
      label: name + ':', 
      section: section, 
      removable: true 
    };
    
    if (section === 'transaction') {
      setTransactionRows(prev => [...prev, newRow]);
    } else {
      setQualitativeRows(prev => [...prev, newRow]);
    }
    setOpenElementDropdown(null);
  };

  // Get available elements for a section (excluding already added)
  // Get available elements for a section using dynamic filtering
  const getAvailableElements = (section: 'transaction' | 'qualitative') => {
    const existingIds = section === 'transaction' 
      ? transactionRows.map(r => r.id)
      : qualitativeRows.map(r => r.id);
    
    // Normalize section for registry lookup
    const normalizedSection = normalizeSection(section) as SectionType;
    
    // Filter elements based on current context
    const filteredElements = filterElements({
      section: normalizedSection,
      propertyType: propertyType,
      subtype: propertySubtype,
      approach: 'income',
      scenario: currentScenario,
      excludeKeys: existingIds
    });
    
    // Map to the format expected by this grid
    const mappedElements: AvailableRentElement[] = filteredElements.map(el => ({
      id: el.key,
      label: el.label
    }));
    
    return mappedElements;
  };

  const handleDeleteRow = (rowId: string, section: 'transaction' | 'qualitative') => {
    if (section === 'transaction') {
      setTransactionRows(prev => prev.filter(r => r.id !== rowId));
    } else {
      setQualitativeRows(prev => prev.filter(r => r.id !== rowId));
    }
  };

  const getTransactionValue = (comp: RentComp, rowId: string) => {
    switch (rowId) {
      case 'address': return comp.address;
      case 'cityState': return comp.cityStateZip;
      case 'hbuUse': return comp.hbuUse;
      case 'sizeSfBldg': return formatNumber(comp.sizeSfBldg);
      case 'condition': return comp.condition;
      case 'nnnRentPerSf': return formatRentPerSf(comp.nnnRentPerSf);
      case 'leaseDate': return comp.leaseDate;
      case 'yearBuilt': return comp.yearBuilt?.toString() || '-';
      case 'propertyType': return comp.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectTransactionValue = (rowId: string) => {
    switch (rowId) {
      case 'address': return SUBJECT_RENT_PROPERTY.address;
      case 'cityState': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUse': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldg': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'condition': return SUBJECT_RENT_PROPERTY.condition;
      case 'nnnRentPerSf': return SUBJECT_RENT_PROPERTY.currentRentPerSf ? formatRentPerSf(SUBJECT_RENT_PROPERTY.currentRentPerSf) : 'N/A';
      case 'yearBuilt': return SUBJECT_RENT_PROPERTY.yearBuilt?.toString() || '-';
      case 'propertyType': return SUBJECT_RENT_PROPERTY.propertyType || '-';
      default: return '-';
    }
  };

  const getSubjectQualitativeValue = (rowId: string) => {
    switch (rowId) {
      case 'locationAdj': return SUBJECT_RENT_PROPERTY.cityState;
      case 'hbuUseAdj': return SUBJECT_RENT_PROPERTY.hbuUse;
      case 'sizeSfBldgAdj': return formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg);
      case 'conditionAdj': return SUBJECT_RENT_PROPERTY.condition;
      default: return '-';
    }
  };

  // Click-to-cycle adjustment chip - cycles through Similar → Superior → Inferior
  const cycleAdjustmentValue = (currentValue: string): string => {
    const cycle = ['Similar', 'Superior', 'Inferior'];
    const currentIndex = cycle.indexOf(currentValue);
    const nextIndex = (currentIndex + 1) % cycle.length;
    return cycle[nextIndex];
  };

  // Adjustment Chip Component - click to cycle through values
  const AdjustmentChip = ({ compId, rowId }: { compId: string, rowId: string }) => {
    const comp = comps.find(c => c.id === compId);
    const currentValue = comp?.[rowId as keyof RentComp] as string || 'Similar';
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(compId, rowId as keyof RentComp, nextValue);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-[10px] font-bold uppercase tracking-wide border shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-50 text-emerald-700 border-emerald-200 hover:bg-emerald-100 hover:border-emerald-300`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3 h-3" /> SUP
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-50 text-red-700 border-red-200 hover:bg-red-100 hover:border-red-300`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3 h-3" /> INF
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-slate-50 dark:bg-slate-700 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 hover:border-slate-300 dark:hover:border-slate-500`}
        title="Click to change"
      >
        <Minus className="w-3 h-3" /> SIM
      </span>
    );
  };

  // Overall Comparability Chip - click to cycle (matching SalesGrid pattern)
  const OverallChip = ({ comp }: { comp: RentComp }) => {
    const currentValue = comp.overallComparability;
    
    const handleClick = () => {
      const nextValue = cycleAdjustmentValue(currentValue);
      handleUpdateComp(comp.id, 'overallComparability', nextValue as any);
    };

    const isSup = currentValue === 'Superior';
    const isInf = currentValue === 'Inferior';
    const baseClass = `inline-flex items-center gap-1.5 rounded-full px-3 py-1.5 text-[11px] font-bold uppercase tracking-wide border-2 shadow-sm transition-all cursor-pointer select-none active:scale-95`;
    
    if (isSup) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-emerald-500 text-white border-emerald-400 hover:bg-emerald-600`}
        title="Click to change"
      >
        <ArrowUpRight className="w-3.5 h-3.5" /> Superior
      </span>
    );
    if (isInf) return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-red-500 text-white border-red-400 hover:bg-red-600`}
        title="Click to change"
      >
        <ArrowDownRight className="w-3.5 h-3.5" /> Inferior
      </span>
    );
    return (
      <span 
        onClick={handleClick} 
        className={`${baseClass} bg-white/20 text-white border-white/40 hover:bg-white/30`}
        title="Click to change"
      >
        <Minus className="w-3.5 h-3.5" /> Similar
      </span>
    );
  };

  // Add Element Button with Dropdown
  const AddElementButton = ({ section }: { section: 'transaction' | 'qualitative' }) => {
    const isOpen = openElementDropdown === section;
    const availableElements = getAvailableElements(section);
    
    return (
      <div className={`element-dropdown relative ${isOpen ? 'z-[500]' : ''}`}>
        <button 
          onClick={() => setOpenElementDropdown(isOpen ? null : section)}
          className="w-full py-2 px-3 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-between gap-2 text-slate-500 font-semibold hover:border-harken-blue hover:text-harken-blue hover:bg-harken-blue/5 transition-all duration-300 group text-xs bg-white dark:bg-slate-800"
        >
          <div className="flex items-center gap-2">
            <Plus size={12} className="text-slate-400 group-hover:text-harken-blue" />
            <span>Add Element</span>
          </div>
          <ChevronDown size={12} className={`text-slate-400 group-hover:text-harken-blue transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </button>
        
        {isOpen && (
          <div className="absolute top-full left-0 mt-1 w-64 bg-white dark:bg-slate-800 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 z-[500] overflow-hidden">
            <div className="px-3 py-2 bg-slate-50 border-b border-slate-200">
              <span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Available Elements</span>
            </div>
            <div className="max-h-48 overflow-y-auto">
              {availableElements.length > 0 ? (
                availableElements.map(element => (
                  <button
                    key={element.id}
                    onClick={() => handleAddElement(section, element)}
                    className="w-full text-left px-3 py-2 text-xs hover:bg-harken-blue/5 transition-colors border-b border-slate-100 last:border-b-0 group"
                  >
                    <div className="font-medium text-slate-700 group-hover:text-harken-blue">{element.label}</div>
                    {element.description && (
                      <div className="text-[10px] text-slate-400 mt-0.5">{element.description}</div>
                    )}
                  </button>
                ))
              ) : (
                <div className="px-3 py-3 text-xs text-slate-400 italic text-center">
                  All elements have been added
                </div>
              )}
            </div>
            <div className="border-t border-slate-200">
              <button
                onClick={() => handleAddCustomElement(section)}
                className="w-full text-left px-3 py-2.5 text-xs hover:bg-harken-blue/5 transition-colors flex items-center gap-2 text-harken-blue font-medium"
              >
                <PenLine size={12} />
                Type My Own...
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Calculate rent indication
  const averageRentPerSf = comps.length > 0 
    ? comps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / comps.length 
    : 0;
  
  const similarComps = comps.filter(c => c.overallComparability === 'Similar');
  const weightedAvgRent = similarComps.length > 0
    ? similarComps.reduce((acc, c) => acc + c.nnnRentPerSf, 0) / similarComps.length
    : averageRentPerSf;

  // Prepare map data - check if subject and comps have coordinates
  const hasSubjectCoords = SUBJECT_RENT_PROPERTY.lat !== undefined && SUBJECT_RENT_PROPERTY.lng !== undefined;
  const compsWithCoords = comps.filter(c => c.lat !== undefined && c.lng !== undefined);
  
  // Map collapsed state
  const [isMapCollapsed, setIsMapCollapsed] = useState(false);

  return (
    <div className="flex flex-col h-full bg-slate-50 dark:bg-slate-900 relative overflow-hidden">
      
      {/* RENTAL COMPARABLES MAP SECTION */}
      {hasSubjectCoords && (
        <div className="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
          {/* Map Header - Always visible */}
          <button
            onClick={() => setIsMapCollapsed(!isMapCollapsed)}
            className="w-full flex items-center justify-between px-4 py-2 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
          >
            <div className="flex items-center gap-2">
              <MapIcon className="w-4 h-4 text-green-600" />
              <span className="font-semibold text-sm text-slate-700 dark:text-slate-200">Rental Comparables Map</span>
              <span className="text-xs text-slate-400">
                ({compsWithCoords.length} of {comps.length} comp{comps.length !== 1 ? 's' : ''} mapped)
              </span>
            </div>
            {isMapCollapsed ? (
              <ChevronDown className="w-4 h-4 text-slate-400" />
            ) : (
              <ChevronUp className="w-4 h-4 text-slate-400" />
            )}
          </button>
          
          {/* Map Content - Collapsible */}
          {!isMapCollapsed && (
            <div className="px-4 pb-4">
              <ComparableMapPreview
                subject={{
                  lat: SUBJECT_RENT_PROPERTY.lat!,
                  lng: SUBJECT_RENT_PROPERTY.lng!,
                  address: SUBJECT_RENT_PROPERTY.address,
                  propertyName: SUBJECT_RENT_PROPERTY.address,
                }}
                comparables={compsWithCoords.map((comp, index) => ({
                  id: comp.id,
                  lat: comp.lat!,
                  lng: comp.lng!,
                  label: `Comp ${index + 1}`,
                  address: `${comp.address}, ${comp.cityStateZip}`,
                  details: formatRentPerSf(comp.nnnRentPerSf),
                }))}
                type="rental-comps"
                height={280}
              />
            </div>
          )}
        </div>
      )}
      
      {/* SCROLLABLE AREA */}
      <div 
        ref={scrollContainerRef}
        className="flex-1 overflow-auto custom-scrollbar relative bg-white dark:bg-slate-900" 
        style={{ isolation: 'isolate' }}
      >
        {/* Horizontal Scroll Indicator - hidden but keeps scroll functionality */}
        <HorizontalScrollIndicator scrollContainerRef={scrollContainerRef} stickyTop={120} hideIndicator={true} />
        
        {/* GRID CONTAINER */}
        <div 
          className="grid relative bg-white dark:bg-slate-900" 
          style={{ 
            gridTemplateColumns: `${LABEL_COL_WIDTH}px ${SUBJECT_COL_WIDTH}px repeat(${comps.length}, ${COMP_COL_WIDTH}px)`, 
            minWidth: `${totalGridWidth}px` 
          }}
        >
          
          {/* ========== HEADER ROW ========== */}
          <div 
            className="sticky top-0 left-0 z-[120] bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-end" 
            style={{ width: LABEL_COL_WIDTH, height: 120 }}
          >
            <div className="p-2 pl-3">
              <div className="font-bold text-slate-400 text-xs uppercase tracking-wider">Element</div>
            </div>
          </div>
          
          {/* Subject Header with Photo */}
          <div 
            className="sticky top-0 left-[160px] z-[110] border-b-2 border-harken-blue bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.08)] flex flex-col"
            style={{ width: SUBJECT_COL_WIDTH, height: 120 }}
          >
            <div className="relative h-16 w-full overflow-hidden group">
              <img 
                src={SUBJECT_RENT_PROPERTY.imageUrl} 
                alt="Subject Property" 
                className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
              />
              <div className="absolute top-1.5 left-1.5 bg-harken-blue text-white text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm">
                SUBJECT
              </div>
            </div>
            <div className="p-2 flex-1 flex flex-col gap-0.5 bg-sky-50 dark:bg-[#0f1f3a] border-r border-slate-200 dark:border-slate-700">
              <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={SUBJECT_RENT_PROPERTY.address}>
                {SUBJECT_RENT_PROPERTY.address.split(',')[0]}
              </h3>
              <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                <span className="line-clamp-1 leading-tight">{SUBJECT_RENT_PROPERTY.cityState}</span>
              </div>
            </div>
          </div>
          
          {/* Comp Headers with Photos */}
          {comps.map((comp, idx) => (
            <div 
              key={comp.id} 
              className="sticky top-0 z-[100] border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex flex-col"
              style={{ height: 120 }}
            >
              <div className="relative h-16 w-full overflow-hidden group">
                <img 
                  src={comp.imageUrl} 
                  alt={comp.address} 
                  className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                />
                <div className="absolute top-1.5 right-1.5 bg-slate-900/70 backdrop-blur-sm text-white text-[10px] font-medium px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">
                  <Calendar className="w-2.5 h-2.5" />
                  {comp.leaseDate}
                </div>
                <button
                  onClick={() => handleDeleteComp(comp.id)}
                  className="absolute top-1.5 left-1.5 p-1 rounded bg-white/80 dark:bg-slate-700/80 hover:bg-red-100 dark:hover:bg-red-900/50 text-slate-400 hover:text-red-500 transition-all opacity-0 group-hover:opacity-100"
                  title="Remove this rental"
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              <div className="p-2 flex-1 flex flex-col gap-0.5 border-r border-slate-200 dark:border-slate-700">
                <h3 className="font-bold text-slate-800 dark:text-white text-xs leading-tight line-clamp-1" title={comp.address}>
                  Rental {idx + 1}
                </h3>
                <div className="flex items-start gap-1 text-[10px] text-slate-500 dark:text-slate-400">
                  <MapPin className="w-3 h-3 flex-shrink-0 mt-0.5 text-harken-blue" />
                  <span className="line-clamp-1 leading-tight">{comp.cityStateZip}</span>
                </div>
                <div className="flex items-center gap-1 text-[10px] text-slate-400 mt-auto">
                  <Activity className="w-3 h-3 text-emerald-500" />
                  <span>{formatRentPerSf(comp.nnnRentPerSf)}/SF</span>
                </div>
              </div>
            </div>
          ))}

          {/* ========== TRANSACTION DATA SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-slate-200 dark:border-slate-700">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-slate-100 dark:bg-slate-800"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              TRANSACTION DATA
            </div>
          </div>

          {/* Transaction Data Rows */}
          {transactionRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                {row.removable && (
                  <button
                    onClick={() => handleDeleteRow(row.id, 'transaction')}
                    className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                    title={`Remove ${row.label}`}
                  >
                    <Trash2 className="w-3 h-3" />
                  </button>
                )}
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectTransactionValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <span className="font-medium text-slate-600 dark:text-slate-300">{getTransactionValue(comp, row.id)}</span>
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Transaction Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'transaction' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="transaction" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-trans-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== QUALITATIVE ADJUSTMENTS SECTION ========== */}
          <div className="col-span-full relative z-[50] mt-4 border-y border-emerald-200 dark:border-emerald-800">
            <div className="absolute left-0 right-0 h-full opacity-30 bg-emerald-50 dark:bg-emerald-900/20"></div>
            <div 
              className="sticky left-0 w-fit px-4 py-2 font-bold text-xs uppercase tracking-widest bg-emerald-50 dark:bg-slate-900 text-emerald-700 dark:text-emerald-300 flex items-center gap-2"
              style={{ zIndex: 51 }}
            >
              QUALITATIVE ADJUSTMENTS
            </div>
          </div>

          {/* Qualitative Adjustment Rows */}
          {qualitativeRows.map(row => (
            <React.Fragment key={row.id}>
              <div 
                className="sticky left-0 z-[60] border-r border-b border-slate-100 dark:border-slate-700 flex items-center justify-between px-2 py-1.5 group bg-white dark:bg-slate-900"
                style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
              >
                <span className="text-xs font-medium text-slate-600 dark:text-slate-400 truncate">{row.label}</span>
                <button
                  onClick={() => handleDeleteRow(row.id, 'qualitative')}
                  className="opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-red-100 dark:hover:bg-red-900/30 text-slate-300 hover:text-red-500 transition-all"
                  title={`Remove ${row.label}`}
                >
                  <Trash2 className="w-3 h-3" />
                </button>
              </div>
              
              <div 
                className="sticky left-[160px] z-[55] border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-sky-50 dark:bg-[#0f1f3a] shadow-[4px_0_16px_rgba(0,0,0,0.05)] dark:shadow-none"
                style={{ width: SUBJECT_COL_WIDTH }}
              >
                <span className="font-medium text-slate-700 dark:text-slate-200">{getSubjectQualitativeValue(row.id)}</span>
              </div>
              
              {comps.map(comp => (
                <div 
                  key={`${row.id}-${comp.id}`} 
                  className="border-r border-b border-slate-100 dark:border-slate-700 p-2 flex items-center justify-center text-xs bg-white dark:bg-slate-800"
                >
                  <AdjustmentChip compId={comp.id} rowId={row.field || row.id} />
                </div>
              ))}
            </React.Fragment>
          ))}

          {/* Add Element Button for Qualitative Section */}
          <div 
            className={`sticky left-0 bg-white dark:bg-slate-800 p-2 ${openElementDropdown === 'qualitative' ? 'z-[500]' : 'z-[60]'}`}
            style={{ width: LABEL_COL_WIDTH }}
          >
            <AddElementButton section="qualitative" />
          </div>
          <div 
            className="sticky left-[160px] z-[55] bg-white dark:bg-slate-800 shadow-[4px_0_16px_rgba(0,0,0,0.05)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          ></div>
          {comps.map(comp => (
            <div key={`add-qual-${comp.id}`} className="bg-white dark:bg-slate-800"></div>
          ))}

          {/* ========== OVERALL COMPARABILITY FOOTER ========== */}
          <div className="col-span-full relative z-[50] mt-4"></div>
          
          <div 
            className="sticky left-0 z-[60] bg-harken-blue border-b border-harken-blue p-3 flex items-center"
            style={{ width: LABEL_COL_WIDTH, transform: 'translateZ(0)' }}
          >
            <span className="text-xs font-bold text-white uppercase tracking-wide">Overall Comparability</span>
          </div>
          
          <div 
            className="sticky left-[160px] z-[55] bg-harken-blue border-b border-harken-blue p-3 flex items-center justify-center shadow-[4px_0_16px_rgba(0,0,0,0.15)]"
            style={{ width: SUBJECT_COL_WIDTH }}
          >
            <span className="text-xs font-bold text-white">N/A</span>
          </div>
          
          {comps.map(comp => (
            <div 
              key={`overall-${comp.id}`} 
              className="bg-harken-blue border-b border-harken-blue p-2 flex items-center justify-center"
            >
              <OverallChip comp={comp} />
            </div>
          ))}

        </div>

        {/* RENT INDICATION FOOTER - Stays centered, doesn't scroll horizontally */}
        <div 
          className="sticky left-0 bg-slate-50 border-t-2 border-slate-300 p-8 pt-10"
          style={{ width: '100vw', maxWidth: '100%' }}
        >
          <div className="max-w-4xl mx-auto flex flex-col gap-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="w-2 h-8 bg-harken-blue rounded-full"></div>
                <h2 className="text-xl font-bold text-slate-800 dark:text-white uppercase tracking-wider">Rent Indication</h2>
              </div>
            </div>
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-6 shadow-sm">
              <div className="grid grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Subject Size</div>
                  <div className="text-2xl font-bold text-slate-800 dark:text-white">{formatNumber(SUBJECT_RENT_PROPERTY.sizeSfBldg)} SF</div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Indicated Market Rent</div>
                  <div className="text-2xl font-bold text-harken-blue">
                    {formatRentPerSf(weightedAvgRent)}/SF
                  </div>
                </div>
                <div className="text-center">
                  <div className="text-sm text-slate-500 font-medium mb-2">Annual Rent Potential</div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {formatCurrency(weightedAvgRent * SUBJECT_RENT_PROPERTY.sizeSfBldg)}
                  </div>
                </div>
              </div>
            </div>

            {/* Notes Section with AI Draft */}
            <div className="mt-6">
              <EnhancedTextArea
                label="Notes"
                value={notesText}
                onChange={handleNotesChange}
                placeholder="Type your analysis and assumptions here..."
                sectionContext="rent_comparable"
                helperText="AI can draft a market rent analysis based on your rental comparables."
                minHeight={250}
                rows={8}
              />
            </div>
            
            {/* Bottom padding */}
            <div className="h-8"></div>
          </div>
        </div>
      </div>
    </div>
  );
};


```

Let me verify the subject column backgrounds are consistent across all grids. I'll check the key areas:

Good - all grids are using the solid `dark:bg-[#0f1f3a]` for subject columns. Let me verify dark mode consistency by checking for any remaining issues:

All `bg-white` usages have proper `dark:` variants. Let me finalize the todos:

Let me verify the application by testing it in the browser:

